/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-11-13 10:58:02 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.util.Set;

public final class tech_005fsupport_005fmanagement_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");

    // Kiểm tra đăng nhập
    String username = (String) session.getAttribute("username");
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    String userRole = (String) session.getAttribute("userRole");
    
    if (username == null || isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect(request.getContextPath() + "/login.jsp");
        return;
    }
    
    // Kiểm tra quyền: chỉ người có quyền manage_tech_support_requests mới truy cập được
    @SuppressWarnings("unchecked")
    Set<String> userPermissions = (Set<String>) session.getAttribute("userPermissions");
    if (userPermissions == null || !userPermissions.contains("manage_tech_support_requests")) {
        response.sendRedirect(request.getContextPath() + "/error/403.jsp");
        return;
    }

      out.write("\r\n");
      out.write("<!DOCTYPE html>\r\n");
      out.write("<html>\r\n");
      out.write("<head>\r\n");
      out.write("    <meta charset=\"UTF-8\">\r\n");
      out.write("    <title>Quản Lý Yêu Cầu | HL Generator</title>\r\n");
      out.write("    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>\r\n");
      out.write("    \r\n");
      out.write("    <!-- bootstrap 3.0.2 -->\r\n");
      out.write("    <link href=\"css/bootstrap.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- font Awesome -->\r\n");
      out.write("    <link href=\"css/font-awesome.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Ionicons -->\r\n");
      out.write("    <link href=\"css/ionicons.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- DATA TABLES -->\r\n");
      out.write("    <link href=\"css/datatables/dataTables.bootstrap.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Theme style -->\r\n");
      out.write("    <link href=\"css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("\r\n");
      out.write("    <style>\r\n");
      out.write("        /* Đảm bảo hamburger menu button có thể click được */\r\n");
      out.write("        .navbar-btn.sidebar-toggle {\r\n");
      out.write("            display: block !important;\r\n");
      out.write("            visibility: visible !important;\r\n");
      out.write("            opacity: 1 !important;\r\n");
      out.write("            cursor: pointer !important;\r\n");
      out.write("            pointer-events: auto !important;\r\n");
      out.write("            z-index: 1050 !important;\r\n");
      out.write("            position: relative !important;\r\n");
      out.write("        }\r\n");
      out.write("        .navbar-btn.sidebar-toggle .icon-bar {\r\n");
      out.write("            display: block !important;\r\n");
      out.write("            visibility: visible !important;\r\n");
      out.write("            opacity: 1 !important;\r\n");
      out.write("            background-color: #fff !important;\r\n");
      out.write("        }\r\n");
      out.write("        .navbar-btn.sidebar-toggle:hover {\r\n");
      out.write("            opacity: 0.8 !important;\r\n");
      out.write("        }\r\n");
      out.write("        .navbar-btn.sidebar-toggle:active {\r\n");
      out.write("            opacity: 0.6 !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .ticket-filters {\r\n");
      out.write("            background: #f5f5f5;\r\n");
      out.write("            padding: 15px;\r\n");
      out.write("            border-radius: 5px;\r\n");
      out.write("            margin-bottom: 20px;\r\n");
      out.write("        }\r\n");
      out.write("        .filter-group {\r\n");
      out.write("            margin-bottom: 10px;\r\n");
      out.write("        }\r\n");
      out.write("        .badge-urgent { background-color: #d9534f !important; }\r\n");
      out.write("        .badge-high { background-color: #d9534f !important; }\r\n");
      out.write("        .badge-medium { background-color: #5bc0de !important; }\r\n");
      out.write("        .badge-low { background-color: #5cb85c !important; }\r\n");
      out.write("        \r\n");
      out.write("        .badge-open { background-color: #f0ad4e !important; }\r\n");
      out.write("        .badge-in_progress { background-color: #337ab7 !important; }\r\n");
      out.write("        .badge-processed { background-color: #5bc0de !important; }\r\n");
      out.write("        .badge-resolved { background-color: #5cb85c !important; }\r\n");
      out.write("        .badge-closed { background-color: #5cb85c !important; }\r\n");
      out.write("        \r\n");
      out.write("        .ticket-actions {\r\n");
      out.write("            white-space: nowrap;\r\n");
      out.write("        }\r\n");
      out.write("        .ticket-actions .btn {\r\n");
      out.write("            padding: 2px 8px;\r\n");
      out.write("            font-size: 12px;\r\n");
      out.write("            margin-right: 3px;\r\n");
      out.write("        }\r\n");
      out.write("        .modal-lg {\r\n");
      out.write("            width: 900px;\r\n");
      out.write("        }\r\n");
      out.write("        .history-item {\r\n");
      out.write("            border-left: 3px solid #3c8dbc;\r\n");
      out.write("            padding-left: 10px;\r\n");
      out.write("            margin-bottom: 10px;\r\n");
      out.write("        }\r\n");
      out.write("        .form-horizontal .control-label {\r\n");
      out.write("            text-align: left;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Phân trang DataTables */\r\n");
      out.write("        .dataTables_length {\r\n");
      out.write("            display: none !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate {\r\n");
      out.write("            margin-top: 15px;\r\n");
      out.write("            text-align: center;\r\n");
      out.write("            float: none !important;\r\n");
      out.write("            display: block !important;\r\n");
      out.write("            visibility: visible !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate .paginate_button {\r\n");
      out.write("            padding: 6px 12px;\r\n");
      out.write("            margin: 0 2px;\r\n");
      out.write("            border: 1px solid #ddd;\r\n");
      out.write("            border-radius: 4px;\r\n");
      out.write("            background: #fff;\r\n");
      out.write("            color: #333 !important;\r\n");
      out.write("            cursor: pointer;\r\n");
      out.write("            display: inline-block !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {\r\n");
      out.write("            background: #f5f5f5;\r\n");
      out.write("            border-color: #999;\r\n");
      out.write("            color: #333 !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate .paginate_button.current {\r\n");
      out.write("            background: #3c8dbc !important;\r\n");
      out.write("            color: #fff !important;\r\n");
      out.write("            border-color: #3c8dbc !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {\r\n");
      out.write("            background: #357abd !important;\r\n");
      out.write("            color: #fff !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {\r\n");
      out.write("            opacity: 0.5;\r\n");
      out.write("            cursor: not-allowed;\r\n");
      out.write("            background: #f5f5f5 !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper .dataTables_info {\r\n");
      out.write("            margin-top: 15px;\r\n");
      out.write("            padding-top: 8px;\r\n");
      out.write("            float: left;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .dataTables_wrapper::after {\r\n");
      out.write("            content: \"\";\r\n");
      out.write("            display: table;\r\n");
      out.write("            clear: both;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Đảm bảo phân trang luôn hiển thị, kể cả khi chỉ có 1 trang */\r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate.paging_full_numbers {\r\n");
      out.write("            display: block !important;\r\n");
      out.write("            visibility: visible !important;\r\n");
      out.write("            opacity: 1 !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Đảm bảo không có CSS nào ẩn phân trang */\r\n");
      out.write("        .dataTables_wrapper .dataTables_paginate[style*=\"display: none\"] {\r\n");
      out.write("            display: block !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Fix tràn chữ trong sidebar */\r\n");
      out.write("        .sidebar-menu li a {\r\n");
      out.write("            overflow: hidden;\r\n");
      out.write("            text-overflow: ellipsis;\r\n");
      out.write("            white-space: nowrap;\r\n");
      out.write("            word-wrap: break-word;\r\n");
      out.write("            max-width: 100%;\r\n");
      out.write("            font-size: 13px !important;\r\n");
      out.write("            padding: 10px 5px 10px 15px !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .sidebar-menu li a span {\r\n");
      out.write("            display: inline-block;\r\n");
      out.write("            max-width: calc(100% - 30px);\r\n");
      out.write("            overflow: hidden;\r\n");
      out.write("            text-overflow: ellipsis;\r\n");
      out.write("            white-space: nowrap;\r\n");
      out.write("            vertical-align: top;\r\n");
      out.write("            font-size: 13px !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .sidebar-menu li a i {\r\n");
      out.write("            margin-right: 8px;\r\n");
      out.write("            width: 20px;\r\n");
      out.write("            text-align: center;\r\n");
      out.write("            flex-shrink: 0;\r\n");
      out.write("            font-size: 14px !important;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Đảm bảo sidebar có đủ không gian */\r\n");
      out.write("        .left-side {\r\n");
      out.write("            overflow-x: hidden;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .sidebar {\r\n");
      out.write("            overflow-x: hidden;\r\n");
      out.write("            overflow-y: auto;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Giảm font-size cho logo trong sidebar nếu có */\r\n");
      out.write("        .sidebar .logo {\r\n");
      out.write("            font-size: 16px !important;\r\n");
      out.write("            padding: 15px 10px !important;\r\n");
      out.write("            white-space: nowrap;\r\n");
      out.write("            overflow: hidden;\r\n");
      out.write("            text-overflow: ellipsis;\r\n");
      out.write("        }\r\n");
      out.write("    </style>\r\n");
      out.write("</head>\r\n");
      out.write("<body class=\"skin-black\">\r\n");
      out.write("    <!-- header logo -->\r\n");
      out.write("    <header class=\"header\">\r\n");
      out.write("        <a href=\"headtech.jsp\" class=\"logo\">\r\n");
      out.write("            Quản Lý Yêu Cầu\r\n");
      out.write("        </a>\r\n");
      out.write("        <nav class=\"navbar navbar-static-top\" role=\"navigation\">\r\n");
      out.write("            <a href=\"#\" class=\"navbar-btn sidebar-toggle\" data-toggle=\"offcanvas\" role=\"button\">\r\n");
      out.write("                <span class=\"sr-only\">Toggle navigation</span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("            </a>\r\n");
      out.write("            <div class=\"navbar-right\">\r\n");
      out.write("                <ul class=\"nav navbar-nav\">\r\n");
      out.write("                    <li class=\"dropdown user user-menu\">\r\n");
      out.write("                        <a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\">\r\n");
      out.write("                            <i class=\"fa fa-user\"></i>\r\n");
      out.write("                            <span>");
      out.print( username );
      out.write(" <i class=\"caret\"></i></span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                        <ul class=\"dropdown-menu dropdown-custom dropdown-menu-right\">\r\n");
      out.write("                            <li class=\"dropdown-header text-center\">Tài khoản</li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"profile.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-user fa-fw pull-right\"></i>\r\n");
      out.write("                                    Hồ sơ\r\n");
      out.write("                                </a>\r\n");
      out.write("                                <a href=\"settings.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-cog fa-fw pull-right\"></i>\r\n");
      out.write("                                    Cài đặt\r\n");
      out.write("                                </a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                            <li class=\"divider\"></li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"logout\"><i class=\"fa fa-ban fa-fw pull-right\"></i> Đăng xuất</a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                        </ul>\r\n");
      out.write("                    </li>\r\n");
      out.write("                </ul>\r\n");
      out.write("            </div>\r\n");
      out.write("        </nav>\r\n");
      out.write("    </header>\r\n");
      out.write("    \r\n");
      out.write("    <div class=\"wrapper row-offcanvas row-offcanvas-left\">\r\n");
      out.write("\t\t");
      org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, "partials/sidebar.jsp", out, false);
      out.write("\r\n");
      out.write("\r\n");
      out.write("        <aside class=\"right-side\">\r\n");
      out.write("            <section class=\"content-header\">\r\n");
      out.write("                <h1>\r\n");
      out.write("                    Quản Lý Yêu Cầu\r\n");
      out.write("                    <small>Xử lý yêu cầu hỗ trợ từ khách hàng</small>\r\n");
      out.write("                </h1>\r\n");
      out.write("                <ol class=\"breadcrumb\">\r\n");
      out.write("                    <li><a href=\"headtech.jsp\"><i class=\"fa fa-dashboard\"></i> Trang chủ</a></li>\r\n");
      out.write("                    <li class=\"active\">Yêu cầu hỗ trợ</li>\r\n");
      out.write("                </ol>\r\n");
      out.write("            </section>\r\n");
      out.write("\r\n");
      out.write("            <!-- Main content -->\r\n");
      out.write("            <section class=\"content\">\r\n");
      out.write("                <!-- Alert for forwarded tickets -->\r\n");
      out.write("                <div id=\"forwardedAlert\" class=\"alert alert-info\" style=\"display: none;\">\r\n");
      out.write("                    <i class=\"fa fa-info-circle\"></i>\r\n");
      out.write("                    <strong>Thông báo:</strong> Có yêu cầu hỗ trợ mới được chuyển tiếp từ bộ phận khác.\r\n");
      out.write("                </div>\r\n");
      out.write("\r\n");
      out.write("                <!-- Tickets Table -->\r\n");
      out.write("                <div class=\"row\">\r\n");
      out.write("                    <div class=\"col-xs-12\">\r\n");
      out.write("                        <div class=\"box\">\r\n");
      out.write("                            <div class=\"box-header\">\r\n");
      out.write("                                <h3 class=\"box-title\">Danh sách yêu cầu hỗ trợ kỹ thuật</h3>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"box-body table-responsive\">\r\n");
      out.write("                                <table id=\"ticketsTable\" class=\"table table-bordered table-striped table-hover\">\r\n");
      out.write("                                    <thead>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <th style=\"width: 80px;\">Mã Ticket</th>\r\n");
      out.write("                                            <th>Khách hàng</th>\r\n");
      out.write("                                            <th>Tiêu đề</th>\r\n");
      out.write("                                            <th style=\"width: 100px;\">Danh mục</th>\r\n");
      out.write("                                            <th style=\"width: 100px;\">Độ ưu tiên</th>\r\n");
      out.write("                                            <th style=\"width: 100px;\">Trạng thái</th>\r\n");
      out.write("                                            <th style=\"width: 120px;\">Ngày tạo</th>\r\n");
      out.write("                                            <th style=\"width: 150px;\">Thao tác</th>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </thead>\r\n");
      out.write("                                    <tbody id=\"ticketsTableBody\">\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <td colspan=\"8\" class=\"text-center\">Đang tải dữ liệu...</td>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </tbody>\r\n");
      out.write("                                </table>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("            </section>\r\n");
      out.write("\r\n");
      out.write("            <div class=\"footer-main\">\r\n");
      out.write("                Copyright &copy Hệ thống quản lý kỹ thuật - HL Generator, 2025\r\n");
      out.write("            </div>\r\n");
      out.write("        </aside>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal Chi tiết Ticket -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"ticketDetailModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-lg\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\">Chi tiết yêu cầu hỗ trợ kỹ thuật</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\">\r\n");
      out.write("                    <form class=\"form-horizontal\" id=\"ticketDetailForm\">\r\n");
      out.write("                        <input type=\"hidden\" id=\"detail_ticket_id\">\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Mã Ticket:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_ticket_number\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Khách hàng:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_customer\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Email:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_email\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Tiêu đề:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_subject\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Hợp đồng & Sản phẩm -->\r\n");
      out.write("                        <div class=\"form-group\" id=\"detail_contract_product_group\" style=\"display: none;\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Hợp đồng & Sản phẩm:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <div id=\"detail_contract_product\" style=\"background: linear-gradient(135deg, #e7f3ff 0%, #d6e9f5 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #3c8dbc; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\"></div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Mô tả chi tiết vấn đề -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Mô tả chi tiết vấn đề:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <textarea class=\"form-control\" id=\"detail_description\" rows=\"4\" readonly style=\"background: #f9f9f9; border: 1px solid #e0e0e0; white-space: pre-wrap; word-wrap: break-word;\"></textarea>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Danh mục:</label>\r\n");
      out.write("                            <div class=\"col-sm-3\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_category\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            \r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Độ ưu tiên:</label>\r\n");
      out.write("                            <div class=\"col-sm-3\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_priority\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Trạng thái:</label>\r\n");
      out.write("                            <div class=\"col-sm-3\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_status\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            \r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Ngày tạo:</label>\r\n");
      out.write("                            <div class=\"col-sm-3\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_created\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Ngày mong muốn hoàn thành:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"detail_deadline\" style=\"color: #2c3e50; font-size: 14px;\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </form>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Đóng</button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal Tạo Work Order -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"createWorkOrderModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-lg\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\">Tạo đơn hàng công việc</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\">\r\n");
      out.write("                    <form class=\"form-horizontal\" id=\"createWorkOrderForm\">\r\n");
      out.write("                        <input type=\"hidden\" id=\"work_order_ticket_id\">\r\n");
      out.write("                        <input type=\"hidden\" id=\"work_order_customer_id\">\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Thông tin từ Ticket -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Mã Ticket:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"work_order_ticket_number\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Khách hàng:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"work_order_customer_name\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <hr>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Thông tin Work Order -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Tiêu đề:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <input type=\"text\" class=\"form-control\" id=\"work_order_title\" readonly>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Hợp đồng & Sản phẩm -->\r\n");
      out.write("                        <div class=\"form-group\" id=\"work_order_contract_product_group\" style=\"display: none;\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Hợp đồng & Sản phẩm:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <div id=\"work_order_contract_product\" style=\"background: linear-gradient(135deg, #e7f3ff 0%, #d6e9f5 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #3c8dbc; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\"></div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Mô tả chi tiết vấn đề -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Mô tả chi tiết vấn đề:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <textarea class=\"form-control\" id=\"work_order_description\" rows=\"4\" readonly style=\"background: #f9f9f9; border: 1px solid #e0e0e0; white-space: pre-wrap; word-wrap: break-word;\"></textarea>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Ngày mong muốn hoàn thành:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <p class=\"form-control-static\" id=\"work_order_deadline\" style=\"color: #2c3e50; font-size: 14px;\"></p>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Độ ưu tiên:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <input type=\"text\" class=\"form-control\" id=\"work_order_priority_display\" readonly>\r\n");
      out.write("                                <input type=\"hidden\" id=\"work_order_priority\">\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Trạng thái:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <input type=\"text\" class=\"form-control\" id=\"work_order_status_display\" value=\"Đang xử lý\" readonly>\r\n");
      out.write("                                <input type=\"hidden\" id=\"work_order_status\" value=\"in_progress\">\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label class=\"col-sm-3 control-label\">Giờ ước tính:</label>\r\n");
      out.write("                            <div class=\"col-sm-9\">\r\n");
      out.write("                                <input type=\"number\" class=\"form-control\" id=\"work_order_estimated_hours\" step=\"0.1\" min=\"0.1\" max=\"100\" placeholder=\"Số giờ ước tính (VD: 2.5)\">\r\n");
      out.write("                                <small class=\"help-block\">Thời gian dự kiến hoàn thành (giờ) - Tối thiểu: 0.1h, Tối đa: 100h</small>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                    </form>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <button type=\"button\" class=\"btn btn-success\" id=\"btnConfirmCreateWorkOrder\">\r\n");
      out.write("                        <i class=\"fa fa-plus\"></i> Tạo đơn hàng\r\n");
      out.write("                    </button>\r\n");
      out.write("                    <button type=\"button\" class=\"btn btn-default\" data-dismiss=\"modal\">Hủy</button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- jQuery 2.0.2 -->\r\n");
      out.write("    <script src=\"http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js\"></script>\r\n");
      out.write("    <script src=\"js/jquery.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Bootstrap -->\r\n");
      out.write("    <script src=\"js/bootstrap.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- DATA TABES SCRIPT -->\r\n");
      out.write("    <script src=\"js/plugins/datatables/jquery.dataTables.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <script src=\"js/plugins/datatables/dataTables.bootstrap.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Director App -->\r\n");
      out.write("    <script src=\"js/Director/app.js\" type=\"text/javascript\"></script>\r\n");
      out.write("\r\n");
      out.write("    <script>\r\n");
      out.write("        var ctx = '");
      out.print( request.getContextPath() );
      out.write("';\r\n");
      out.write("        var allTickets = [];\r\n");
      out.write("        var filteredTickets = [];\r\n");
      out.write("        var autoRefreshInterval = null; // Store interval ID for auto-refresh\r\n");
      out.write("        \r\n");
      out.write("        $(document).ready(function() {\r\n");
      out.write("            loadTickets();\r\n");
      out.write("            \r\n");
      out.write("            // Sync ticket status for completed work orders on page load (one-time)\r\n");
      out.write("            syncTicketStatusForCompletedWorkOrders();\r\n");
      out.write("            \r\n");
      out.write("            // Auto-refresh tickets every 30 seconds to keep status updated\r\n");
      out.write("            autoRefreshInterval = setInterval(function() {\r\n");
      out.write("                console.log('Auto-refreshing tickets...');\r\n");
      out.write("                loadTickets(true); // Silent mode for auto-refresh\r\n");
      out.write("            }, 30000); // 30 seconds\r\n");
      out.write("            \r\n");
      out.write("            // Stop auto-refresh when page is hidden (tab is not active)\r\n");
      out.write("            $(document).on('visibilitychange', function() {\r\n");
      out.write("                if (document.hidden) {\r\n");
      out.write("                    if (autoRefreshInterval) {\r\n");
      out.write("                        clearInterval(autoRefreshInterval);\r\n");
      out.write("                        autoRefreshInterval = null;\r\n");
      out.write("                        console.log('Auto-refresh paused (tab hidden)');\r\n");
      out.write("                    }\r\n");
      out.write("                } else {\r\n");
      out.write("                    // Resume auto-refresh when tab becomes visible\r\n");
      out.write("                    if (!autoRefreshInterval) {\r\n");
      out.write("                        loadTickets(true); // Load immediately (silent mode)\r\n");
      out.write("                        autoRefreshInterval = setInterval(function() {\r\n");
      out.write("                            console.log('Auto-refreshing tickets...');\r\n");
      out.write("                            loadTickets(true); // Silent mode for auto-refresh\r\n");
      out.write("                        }, 30000);\r\n");
      out.write("                        console.log('Auto-refresh resumed (tab visible)');\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Check if there's a forwarded ticket in localStorage\r\n");
      out.write("            var forwardedTicket = localStorage.getItem('forwardedTicket');\r\n");
      out.write("            if(forwardedTicket) {\r\n");
      out.write("                try {\r\n");
      out.write("                    var ticket = JSON.parse(forwardedTicket);\r\n");
      out.write("                    // Thêm ticket được chuyển tiếp vào danh sách\r\n");
      out.write("                    allTickets.push(ticket);\r\n");
      out.write("                    filteredTickets = allTickets;\r\n");
      out.write("                    renderTable();\r\n");
      out.write("                    // Xóa thông tin đã xử lý\r\n");
      out.write("                    localStorage.removeItem('forwardedTicket');\r\n");
      out.write("                    // Auto-open the ticket detail modal after data is loaded\r\n");
      out.write("                    setTimeout(function() {\r\n");
      out.write("                        viewTicketDetail(ticket.id);\r\n");
      out.write("                    }, 1000);\r\n");
      out.write("                } catch(e) {\r\n");
      out.write("                    console.log('Error parsing forwarded ticket:', e);\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Confirm create work order\r\n");
      out.write("            $('#btnConfirmCreateWorkOrder').click(function() {\r\n");
      out.write("                confirmCreateWorkOrder();\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Real-time validation for estimated hours\r\n");
      out.write("            $('#work_order_estimated_hours').on('input', function() {\r\n");
      out.write("                var value = $(this).val();\r\n");
      out.write("                if (value && value.trim() !== '') {\r\n");
      out.write("                    var numValue = parseFloat(value);\r\n");
      out.write("                    if (!isNaN(numValue)) {\r\n");
      out.write("                        if (numValue <= 0) {\r\n");
      out.write("                            $(this).css('border-color', '#d9534f');\r\n");
      out.write("                        } else if (numValue > 100) {\r\n");
      out.write("                            $(this).css('border-color', '#d9534f');\r\n");
      out.write("                        } else {\r\n");
      out.write("                            $(this).css('border-color', '');\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                } else {\r\n");
      out.write("                    $(this).css('border-color', '');\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        function loadTickets(silent) {\r\n");
      out.write("            // silent: if true, don't show console logs (for auto-refresh)\r\n");
      out.write("            // Gọi API mới để lấy danh sách ticket technical\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: ctx + '/api/tech-support?action=list',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                cache: false, // Prevent caching\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success) {\r\n");
      out.write("                        // Store previous ticket count for comparison\r\n");
      out.write("                        var previousCount = allTickets.length;\r\n");
      out.write("                        var previousResolvedCount = allTickets.filter(function(t) { return t.status === 'resolved' || t.status === 'closed'; }).length;\r\n");
      out.write("                        \r\n");
      out.write("                        // Tất cả ticket đã được lọc ở backend (chỉ technical)\r\n");
      out.write("                        var newTickets = response.data || [];\r\n");
      out.write("                        var newResolvedCount = newTickets.filter(function(t) { return t.status === 'resolved' || t.status === 'closed'; }).length;\r\n");
      out.write("                        \r\n");
      out.write("                        // Check if any ticket status changed\r\n");
      out.write("                        var statusChanged = false;\r\n");
      out.write("                        if (allTickets.length > 0) {\r\n");
      out.write("                            for (var i = 0; i < newTickets.length; i++) {\r\n");
      out.write("                                var newTicket = newTickets[i];\r\n");
      out.write("                                var oldTicket = allTickets.find(function(t) { return t.id == newTicket.id; });\r\n");
      out.write("                                if (oldTicket && oldTicket.status !== newTicket.status) {\r\n");
      out.write("                                    statusChanged = true;\r\n");
      out.write("                                    if (!silent) {\r\n");
      out.write("                                        console.log('Ticket #' + newTicket.id + ' status changed: ' + oldTicket.status + ' -> ' + newTicket.status);\r\n");
      out.write("                                    }\r\n");
      out.write("                                    break;\r\n");
      out.write("                                }\r\n");
      out.write("                            }\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        allTickets = newTickets;\r\n");
      out.write("                        filteredTickets = allTickets;\r\n");
      out.write("                        renderTable();\r\n");
      out.write("                        \r\n");
      out.write("                        if (!silent) {\r\n");
      out.write("                            console.log('Đã tải ' + allTickets.length + ' ticket kỹ thuật');\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Show notification if status changed or new resolved tickets\r\n");
      out.write("                        if (statusChanged || newResolvedCount > previousResolvedCount) {\r\n");
      out.write("                            if (!silent) {\r\n");
      out.write("                                // Show a subtle notification that data was updated\r\n");
      out.write("                                var notification = $('<div class=\"alert alert-info alert-dismissible\" style=\"position: fixed; top: 60px; right: 20px; z-index: 9999; min-width: 300px; display: none;\">' +\r\n");
      out.write("                                    '<button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button>' +\r\n");
      out.write("                                    '<i class=\"fa fa-refresh\"></i> <strong>Đã cập nhật:</strong> Trạng thái ticket đã thay đổi.' +\r\n");
      out.write("                                    '</div>');\r\n");
      out.write("                                $('body').append(notification);\r\n");
      out.write("                                notification.fadeIn();\r\n");
      out.write("                                setTimeout(function() {\r\n");
      out.write("                                    notification.fadeOut(function() {\r\n");
      out.write("                                        $(this).remove();\r\n");
      out.write("                                    });\r\n");
      out.write("                                }, 3000);\r\n");
      out.write("                            }\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Debug: Kiểm tra customerId trong tickets\r\n");
      out.write("                        if (allTickets.length > 0 && !silent) {\r\n");
      out.write("                            console.log('Sample ticket có customerId:', allTickets[0].customerId);\r\n");
      out.write("                            console.log('Sample ticket object:', allTickets[0]);\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Hiển thị thông báo nếu có ticket mới (only for initial load or manual refresh)\r\n");
      out.write("                        if (!silent) {\r\n");
      out.write("                            var openTickets = allTickets.filter(function(t) {\r\n");
      out.write("                                return t.status === 'open' || t.status === 'in_progress';\r\n");
      out.write("                            });\r\n");
      out.write("                            \r\n");
      out.write("                            if (openTickets.length > 0) {\r\n");
      out.write("                                $('#forwardedAlert').show();\r\n");
      out.write("                                $('#forwardedAlert').html('<i class=\"fa fa-info-circle\"></i> <strong>Thông báo:</strong> Có ' + openTickets.length + ' yêu cầu hỗ trợ kỹ thuật cần xử lý.');\r\n");
      out.write("                                setTimeout(function() {\r\n");
      out.write("                                    $('#forwardedAlert').fadeOut();\r\n");
      out.write("                                }, 8000);\r\n");
      out.write("                            }\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        if (!silent) {\r\n");
      out.write("                            console.error('Lỗi tải danh sách ticket:', response.message);\r\n");
      out.write("                            showError('Không thể tải danh sách yêu cầu hỗ trợ: ' + response.message);\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    if (!silent) {\r\n");
      out.write("                        console.error('Không thể tải danh sách ticket:', error);\r\n");
      out.write("                        showError('Lỗi kết nối server');\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        \r\n");
      out.write("        function renderTable() {\r\n");
      out.write("            var tbody = $('#ticketsTableBody');\r\n");
      out.write("            tbody.empty();\r\n");
      out.write("            \r\n");
      out.write("            if(!filteredTickets || filteredTickets.length === 0) {\r\n");
      out.write("                tbody.append('<tr><td colspan=\"8\" class=\"text-center\">Không có dữ liệu</td></tr>');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("             filteredTickets.forEach(function(ticket) {\r\n");
      out.write("                 var userRole = '");
      out.print( userRole );
      out.write("';\r\n");
      out.write("                 var actionButtons = '<button class=\"btn btn-info btn-view\" data-id=\"' + ticket.id + '\"><i class=\"fa fa-eye\"></i> Xem</button>';\r\n");
      out.write("                 \r\n");
      out.write("                 // Chỉ hiển thị nút \"Tạo WO\" cho head_technician và admin\r\n");
      out.write("                 if (userRole === 'head_technician' || userRole === 'admin') {\r\n");
      out.write("                     // Check if ticket has work order (async check, will update button later)\r\n");
      out.write("                     var hasWorkOrder = false;\r\n");
      out.write("                     if (ticket.customerId && ticket.subject) {\r\n");
      out.write("                         // Will check async and disable button if work order exists\r\n");
      out.write("                         actionButtons += '<button class=\"btn btn-success btn-create-work-order\" data-id=\"' + ticket.id + '\" data-customer-id=\"' + (ticket.customerId || '') + '\" data-subject=\"' + (ticket.subject || '').replace(/\"/g, '&quot;') + '\"><i class=\"fa fa-plus\"></i> Tạo WO</button>';\r\n");
      out.write("                     } else {\r\n");
      out.write("                         actionButtons += '<button class=\"btn btn-success btn-create-work-order\" data-id=\"' + ticket.id + '\"><i class=\"fa fa-plus\"></i> Tạo WO</button>';\r\n");
      out.write("                     }\r\n");
      out.write("                 }\r\n");
      out.write("                 \r\n");
      out.write("                 var row = '<tr>' +\r\n");
      out.write("                     '<td><strong>' + (ticket.ticketNumber || '#' + ticket.id) + '</strong></td>' +\r\n");
      out.write("                     '<td>' + (ticket.customerName || 'N/A') + '</td>' +\r\n");
      out.write("                     '<td>' + (ticket.subject || '') + '</td>' +\r\n");
      out.write("                     '<td>' + getCategoryBadge(ticket.category) + '</td>' +\r\n");
      out.write("                     '<td>' + getPriorityBadge(ticket.priority) + '</td>' +\r\n");
      out.write("                     '<td>' + getStatusBadge(ticket.status) + '</td>' +\r\n");
      out.write("                     '<td>' + formatDate(ticket.createdAt) + '</td>' +\r\n");
      out.write("                     '<td class=\"ticket-actions\">' + actionButtons + '</td>' +\r\n");
      out.write("                 '</tr>';\r\n");
      out.write("                 tbody.append(row);\r\n");
      out.write("             });\r\n");
      out.write("             \r\n");
      out.write("             // Check work orders for tickets (async, after rendering)\r\n");
      out.write("             setTimeout(function() {\r\n");
      out.write("                 $('.btn-create-work-order').each(function() {\r\n");
      out.write("                     var $btn = $(this);\r\n");
      out.write("                     var ticketId = $btn.data('id');\r\n");
      out.write("                     var customerId = $btn.data('customer-id');\r\n");
      out.write("                     var subject = $btn.data('subject');\r\n");
      out.write("                     \r\n");
      out.write("                     if (customerId && subject) {\r\n");
      out.write("                         $.ajax({\r\n");
      out.write("                             url: ctx + '/api/work-orders?action=checkByTicket',\r\n");
      out.write("                             type: 'GET',\r\n");
      out.write("                             data: {\r\n");
      out.write("                                 ticketId: ticketId,\r\n");
      out.write("                                 title: subject,\r\n");
      out.write("                                 customerId: customerId\r\n");
      out.write("                             },\r\n");
      out.write("                             dataType: 'json',\r\n");
      out.write("                             success: function(response) {\r\n");
      out.write("                                 if (response && response.success && response.exists) {\r\n");
      out.write("                                     $btn.prop('disabled', true);\r\n");
      out.write("                                     $btn.html('<i class=\"fa fa-check\"></i> Đã có WO');\r\n");
      out.write("                                     $btn.removeClass('btn-success').addClass('btn-default');\r\n");
      out.write("                                     $btn.attr('title', 'Ticket này đã có work order: ' + (response.workOrderNumber || 'N/A'));\r\n");
      out.write("                                 }\r\n");
      out.write("                             },\r\n");
      out.write("                             error: function() {\r\n");
      out.write("                                 // Silently fail, allow button to work\r\n");
      out.write("                             }\r\n");
      out.write("                         });\r\n");
      out.write("                     }\r\n");
      out.write("                 });\r\n");
      out.write("             }, 500);\r\n");
      out.write("            \r\n");
      out.write("            // Bind view button\r\n");
      out.write("            $('.btn-view').click(function() {\r\n");
      out.write("                var id = $(this).data('id');\r\n");
      out.write("                viewTicketDetail(id);\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Bind create work order button\r\n");
      out.write("            $('.btn-create-work-order').click(function() {\r\n");
      out.write("                var id = $(this).data('id');\r\n");
      out.write("                showCreateWorkOrderModal(id);\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Khởi tạo DataTable với phân trang\r\n");
      out.write("            initializeDataTable();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        var ticketsDataTable = null;\r\n");
      out.write("        \r\n");
      out.write("        function initializeDataTable() {\r\n");
      out.write("            // Kiểm tra xem DataTables đã được load chưa\r\n");
      out.write("            if (typeof $.fn.DataTable === 'undefined') {\r\n");
      out.write("                console.error('DataTables library is not loaded');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Kiểm tra và destroy DataTable nếu đã tồn tại\r\n");
      out.write("            if ($.fn.DataTable.isDataTable('#ticketsTable')) {\r\n");
      out.write("                try {\r\n");
      out.write("                    $('#ticketsTable').DataTable().destroy();\r\n");
      out.write("                    ticketsDataTable = null;\r\n");
      out.write("                } catch(e) {\r\n");
      out.write("                    console.log('Error destroying DataTable:', e);\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Nếu biến ticketsDataTable vẫn còn, reset nó\r\n");
      out.write("            if (ticketsDataTable) {\r\n");
      out.write("                ticketsDataTable = null;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Khởi tạo DataTable\r\n");
      out.write("            try {\r\n");
      out.write("                ticketsDataTable = $('#ticketsTable').DataTable({\r\n");
      out.write("                    \"language\": {\r\n");
      out.write("                        \"url\": \"//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json\"\r\n");
      out.write("                    },\r\n");
      out.write("                    \"pageLength\": 8, // Hiển thị 8 bản ghi mỗi trang\r\n");
      out.write("                    \"lengthChange\": false, // Ẩn dropdown \"records per page\"\r\n");
      out.write("                    \"paging\": true, // Bật phân trang\r\n");
      out.write("                    \"pagingType\": \"full_numbers\", // Hiển thị số trang đầy đủ (Previous, 1, 2, 3, ..., Next)\r\n");
      out.write("                    \"info\": true, // Hiển thị thông tin \"Showing X to Y of Z entries\"\r\n");
      out.write("                    \"dom\": '<\"top\"lf>rt<\"bottom\"ip><\"clear\">', // Cấu trúc DOM: top (length, filter), table, bottom (info, pagination)\r\n");
      out.write("                    \"order\": [[6, \"desc\"]], // Sắp xếp theo Ngày tạo (column 6) giảm dần\r\n");
      out.write("                    \"columnDefs\": [\r\n");
      out.write("                        { \"orderable\": false, \"targets\": 7 } // Không sort cột Thao tác (cột cuối cùng)\r\n");
      out.write("                    ],\r\n");
      out.write("                    \"drawCallback\": function(settings) {\r\n");
      out.write("                        // Đảm bảo phân trang luôn hiển thị\r\n");
      out.write("                        var wrapper = $(this).closest('.dataTables_wrapper');\r\n");
      out.write("                        var paginate = wrapper.find('.dataTables_paginate');\r\n");
      out.write("                        if (paginate.length) {\r\n");
      out.write("                            paginate.css({\r\n");
      out.write("                                'display': 'block',\r\n");
      out.write("                                'visibility': 'visible',\r\n");
      out.write("                                'opacity': '1'\r\n");
      out.write("                            }).show();\r\n");
      out.write("                            \r\n");
      out.write("                            // Đảm bảo tất cả các nút phân trang đều hiển thị\r\n");
      out.write("                            paginate.find('.paginate_button').each(function() {\r\n");
      out.write("                                $(this).css({\r\n");
      out.write("                                    'display': 'inline-block',\r\n");
      out.write("                                    'visibility': 'visible'\r\n");
      out.write("                                }).show();\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                    },\r\n");
      out.write("                    \"initComplete\": function(settings, json) {\r\n");
      out.write("                        // Sau khi khởi tạo xong, đảm bảo phân trang hiển thị\r\n");
      out.write("                        var wrapper = $(this).closest('.dataTables_wrapper');\r\n");
      out.write("                        var paginate = wrapper.find('.dataTables_paginate');\r\n");
      out.write("                        if (paginate.length) {\r\n");
      out.write("                            paginate.removeAttr('style');\r\n");
      out.write("                            paginate.css({\r\n");
      out.write("                                'display': 'block',\r\n");
      out.write("                                'visibility': 'visible',\r\n");
      out.write("                                'opacity': '1'\r\n");
      out.write("                            }).show();\r\n");
      out.write("                            \r\n");
      out.write("                            // Đảm bảo tất cả các nút phân trang đều hiển thị\r\n");
      out.write("                            paginate.find('.paginate_button').each(function() {\r\n");
      out.write("                                $(this).css({\r\n");
      out.write("                                    'display': 'inline-block',\r\n");
      out.write("                                    'visibility': 'visible'\r\n");
      out.write("                                }).show();\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Force show pagination after a short delay\r\n");
      out.write("                        setTimeout(function() {\r\n");
      out.write("                            var paginate = wrapper.find('.dataTables_paginate');\r\n");
      out.write("                            if (paginate.length) {\r\n");
      out.write("                                paginate.css({\r\n");
      out.write("                                    'display': 'block !important',\r\n");
      out.write("                                    'visibility': 'visible !important',\r\n");
      out.write("                                    'opacity': '1 !important'\r\n");
      out.write("                                }).show();\r\n");
      out.write("                                \r\n");
      out.write("                                // Force show all pagination buttons\r\n");
      out.write("                                paginate.find('.paginate_button').each(function() {\r\n");
      out.write("                                    $(this).css({\r\n");
      out.write("                                        'display': 'inline-block',\r\n");
      out.write("                                        'visibility': 'visible'\r\n");
      out.write("                                    }).show();\r\n");
      out.write("                                });\r\n");
      out.write("                            }\r\n");
      out.write("                        }, 200);\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("                console.log('DataTable initialized successfully');\r\n");
      out.write("            } catch(e) {\r\n");
      out.write("                console.error('Error initializing DataTable:', e);\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function getCategoryBadge(category) {\r\n");
      out.write("            var labels = {\r\n");
      out.write("                'technical': 'Kỹ thuật',\r\n");
      out.write("                'billing': 'Thanh toán',\r\n");
      out.write("                'general': 'Chung',\r\n");
      out.write("                'complaint': 'Khiếu nại'\r\n");
      out.write("            };\r\n");
      out.write("            var colors = {\r\n");
      out.write("                'technical': 'info',\r\n");
      out.write("                'billing': 'success',\r\n");
      out.write("                'general': 'default',\r\n");
      out.write("                'complaint': 'danger'\r\n");
      out.write("            };\r\n");
      out.write("            return '<span class=\"label label-' + (colors[category] || 'default') + '\">' + \r\n");
      out.write("                   (labels[category] || category) + '</span>';\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function getPriorityBadge(priority) {\r\n");
      out.write("            var labels = {\r\n");
      out.write("                'urgent': 'Khẩn cấp',\r\n");
      out.write("                'high': 'Cao',\r\n");
      out.write("                'medium': 'Trung bình',\r\n");
      out.write("                'low': 'Thấp'\r\n");
      out.write("            };\r\n");
      out.write("            var badge = priority ? 'badge-' + priority : '';\r\n");
      out.write("            return '<span class=\"badge ' + badge + '\">' + (labels[priority] || 'N/A') + '</span>';\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function getStatusBadge(status) {\r\n");
      out.write("            var labels = {\r\n");
      out.write("                'open': 'Chờ xử lý',\r\n");
      out.write("                'in_progress': 'Đang xử lý',\r\n");
      out.write("                'processed': 'Đã xử lý',\r\n");
      out.write("                'resolved': 'Đã giải quyết',\r\n");
      out.write("                'closed': 'Đã giải quyết'\r\n");
      out.write("            };\r\n");
      out.write("            // Nếu status là closed, hiển thị như resolved\r\n");
      out.write("            var displayStatus = (status === 'closed') ? 'resolved' : status;\r\n");
      out.write("            var badge = displayStatus ? 'badge-' + displayStatus : '';\r\n");
      out.write("            return '<span class=\"badge ' + badge + '\">' + (labels[status] || 'N/A') + '</span>';\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function formatDate(dateStr) {\r\n");
      out.write("            if(!dateStr) return '';\r\n");
      out.write("            try {\r\n");
      out.write("                var date = new Date(dateStr);\r\n");
      out.write("                return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');\r\n");
      out.write("            } catch(e) {\r\n");
      out.write("                return dateStr;\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function viewTicketDetail(id) {\r\n");
      out.write("            // Load fresh data from server\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: ctx + '/api/tech-support?action=get',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { id: id },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        displayTicketDetail(response.data);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Fallback to cached data\r\n");
      out.write("                        var ticket = allTickets.find(function(t) { return t.id == id; });\r\n");
      out.write("                        if (ticket) {\r\n");
      out.write("                            displayTicketDetail(ticket);\r\n");
      out.write("                        } else {\r\n");
      out.write("                            alert('Không thể tải chi tiết ticket');\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function() {\r\n");
      out.write("                    // Fallback to cached data\r\n");
      out.write("                    var ticket = allTickets.find(function(t) { return t.id == id; });\r\n");
      out.write("                    if (ticket) {\r\n");
      out.write("                        displayTicketDetail(ticket);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Không thể tải chi tiết ticket');\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function displayTicketDetail(ticket) {\r\n");
      out.write("            $('#detail_ticket_id').val(ticket.id);\r\n");
      out.write("            $('#detail_ticket_number').text(ticket.ticketNumber || '#' + ticket.id);\r\n");
      out.write("            $('#detail_customer').text(ticket.customerName || 'N/A');\r\n");
      out.write("            $('#detail_email').text(ticket.customerEmail || 'N/A');\r\n");
      out.write("            $('#detail_subject').text(ticket.subject || '');\r\n");
      out.write("            \r\n");
      out.write("            // Tách thông tin hợp đồng và sản phẩm từ description\r\n");
      out.write("            var description = ticket.description || '';\r\n");
      out.write("            var contractInfo = '';\r\n");
      out.write("            var productInfo = '';\r\n");
      out.write("            var cleanDescription = description;\r\n");
      out.write("            \r\n");
      out.write("            // Tìm thông tin hợp đồng: [Hợp đồng: ...]\r\n");
      out.write("            var contractMatch = description.match(/\\[Hợp đồng:([^\\]]+)\\]/);\r\n");
      out.write("            if (contractMatch) {\r\n");
      out.write("                contractInfo = contractMatch[1].trim();\r\n");
      out.write("                cleanDescription = cleanDescription.replace(/\\[Hợp đồng:[^\\]]+\\]\\s*/g, '').trim();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Tìm thông tin sản phẩm: [Sản phẩm: ...]\r\n");
      out.write("            var productMatch = description.match(/\\[Sản phẩm:([^\\]]+)\\]/);\r\n");
      out.write("            if (productMatch) {\r\n");
      out.write("                productInfo = productMatch[1].trim();\r\n");
      out.write("                cleanDescription = cleanDescription.replace(/\\[Sản phẩm:[^\\]]+\\]\\s*/g, '').trim();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị hợp đồng & sản phẩm\r\n");
      out.write("            var contractProductHtml = '';\r\n");
      out.write("            if (contractInfo || productInfo) {\r\n");
      out.write("                $('#detail_contract_product_group').show();\r\n");
      out.write("                if (contractInfo) {\r\n");
      out.write("                    contractProductHtml += '<div style=\"margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(60, 141, 188, 0.2);\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"display: flex; align-items: flex-start; gap: 10px;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex-shrink: 0; color: #3c8dbc; font-size: 18px; margin-top: 2px;\"><i class=\"fa fa-file-text-o\"></i></div>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex: 1; min-width: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<strong style=\"display: block; margin-bottom: 5px; color: #2c3e50; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\">HỢP ĐỒNG</strong>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; white-space: normal; font-size: 14px; color: #34495e; line-height: 1.5; max-width: 100%;\">' + escapeHtml(contractInfo) + '</div>';\r\n");
      out.write("                    contractProductHtml += '</div></div></div>';\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                if (productInfo) {\r\n");
      out.write("                    contractProductHtml += '<div style=\"padding-top: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"display: flex; align-items: flex-start; gap: 10px;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex-shrink: 0; color: #27ae60; font-size: 18px; margin-top: 2px;\"><i class=\"fa fa-cube\"></i></div>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex: 1; min-width: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<strong style=\"display: block; margin-bottom: 5px; color: #2c3e50; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\">SẢN PHẨM</strong>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; white-space: normal; font-size: 14px; color: #34495e; line-height: 1.5; max-width: 100%;\">' + escapeHtml(productInfo) + '</div>';\r\n");
      out.write("                    contractProductHtml += '</div></div></div>';\r\n");
      out.write("                }\r\n");
      out.write("                $('#detail_contract_product').html(contractProductHtml);\r\n");
      out.write("            } else {\r\n");
      out.write("                $('#detail_contract_product_group').hide();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị mô tả chi tiết (đã loại bỏ hợp đồng/sản phẩm)\r\n");
      out.write("            $('#detail_description').val(cleanDescription || 'Không có mô tả');\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị text cho các trường category, priority, status\r\n");
      out.write("            var categoryLabels = {\r\n");
      out.write("                'technical': 'Kỹ thuật',\r\n");
      out.write("                'billing': 'Thanh toán',\r\n");
      out.write("                'general': 'Chung',\r\n");
      out.write("                'complaint': 'Khiếu nại'\r\n");
      out.write("            };\r\n");
      out.write("            var priorityLabels = {\r\n");
      out.write("                'urgent': 'Khẩn cấp',\r\n");
      out.write("                'high': 'Cao',\r\n");
      out.write("                'medium': 'Trung bình',\r\n");
      out.write("                'low': 'Thấp'\r\n");
      out.write("            };\r\n");
      out.write("            var statusLabels = {\r\n");
      out.write("                'open': 'Chờ xử lý',\r\n");
      out.write("                'in_progress': 'Đang xử lý',\r\n");
      out.write("                'processed': 'Đã xử lý',\r\n");
      out.write("                'resolved': 'Đã giải quyết',\r\n");
      out.write("                'closed': 'Đã giải quyết'\r\n");
      out.write("            };\r\n");
      out.write("            \r\n");
      out.write("            $('#detail_category').text(categoryLabels[ticket.category] || ticket.category || 'N/A');\r\n");
      out.write("            $('#detail_priority').text(priorityLabels[ticket.priority] || ticket.priority || 'N/A');\r\n");
      out.write("            $('#detail_status').text(statusLabels[ticket.status] || ticket.status || 'N/A');\r\n");
      out.write("            $('#detail_created').text(formatDate(ticket.createdAt));\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị deadline - format từ yyyy-MM-dd sang dd/MM/yyyy\r\n");
      out.write("            var deadlineDisplay = '';\r\n");
      out.write("            if (ticket.deadline && typeof ticket.deadline === 'string' && ticket.deadline.trim() !== '' && ticket.deadline !== 'null') {\r\n");
      out.write("                try {\r\n");
      out.write("                    // Deadline từ DB là yyyy-MM-dd, chuyển sang dd/MM/yyyy\r\n");
      out.write("                    var deadlineStr = ticket.deadline.trim();\r\n");
      out.write("                    if (deadlineStr.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\r\n");
      out.write("                        var parts = deadlineStr.split('-');\r\n");
      out.write("                        deadlineDisplay = parts[2] + '/' + parts[1] + '/' + parts[0];\r\n");
      out.write("                    } else {\r\n");
      out.write("                        deadlineDisplay = deadlineStr;\r\n");
      out.write("                    }\r\n");
      out.write("                } catch (e) {\r\n");
      out.write("                    deadlineDisplay = ticket.deadline;\r\n");
      out.write("                }\r\n");
      out.write("            } else {\r\n");
      out.write("                deadlineDisplay = '<span style=\"color: #999; font-style: italic;\">Chưa có</span>';\r\n");
      out.write("            }\r\n");
      out.write("            $('#detail_deadline').html(deadlineDisplay);\r\n");
      out.write("            \r\n");
      out.write("            $('#ticketDetailModal').modal('show');\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function escapeHtml(text) {\r\n");
      out.write("            if (!text) return '';\r\n");
      out.write("            var map = {\r\n");
      out.write("                '&': '&amp;',\r\n");
      out.write("                '<': '&lt;',\r\n");
      out.write("                '>': '&gt;',\r\n");
      out.write("                '\"': '&quot;',\r\n");
      out.write("                \"'\": '&#039;'\r\n");
      out.write("            };\r\n");
      out.write("            return text.toString().replace(/[&<>\"']/g, function(m) { return map[m]; });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function showCreateWorkOrderModal(id) {\r\n");
      out.write("            var ticket = allTickets.find(function(t) { return t.id == id; });\r\n");
      out.write("            if(!ticket) {\r\n");
      out.write("                console.error('Không tìm thấy ticket với ID:', id);\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Debug: Log thông tin ticket\r\n");
      out.write("            console.log('Ticket object:', ticket);\r\n");
      out.write("            console.log('ticket.customerId:', ticket.customerId);\r\n");
      out.write("            console.log('ticket.customerId type:', typeof ticket.customerId);\r\n");
      out.write("            \r\n");
      out.write("            // Validate: Check if ticket already has a work order\r\n");
      out.write("            var customerIdValue = (ticket.customerId != null && ticket.customerId !== undefined && ticket.customerId !== 0) \r\n");
      out.write("                ? ticket.customerId : '';\r\n");
      out.write("            \r\n");
      out.write("            if (customerIdValue && ticket.subject) {\r\n");
      out.write("                // Check if work order already exists\r\n");
      out.write("                $.ajax({\r\n");
      out.write("                    url: ctx + '/api/work-orders?action=checkByTicket',\r\n");
      out.write("                    type: 'GET',\r\n");
      out.write("                    data: {\r\n");
      out.write("                        ticketId: ticket.id,\r\n");
      out.write("                        title: ticket.subject,\r\n");
      out.write("                        customerId: customerIdValue\r\n");
      out.write("                    },\r\n");
      out.write("                    dataType: 'json',\r\n");
      out.write("                    success: function(response) {\r\n");
      out.write("                        if (response && response.success && response.exists) {\r\n");
      out.write("                            alert('Cảnh báo: Ticket này đã có work order!\\n\\n' +\r\n");
      out.write("                                  'Mã work order: ' + (response.workOrderNumber || 'N/A') + '\\n\\n' +\r\n");
      out.write("                                  'Mỗi ticket chỉ được tạo 1 work order. Vui lòng kiểm tra lại.');\r\n");
      out.write("                            return;\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // If no existing work order, proceed to open modal\r\n");
      out.write("                        openCreateWorkOrderModal(ticket, customerIdValue);\r\n");
      out.write("                    },\r\n");
      out.write("                    error: function() {\r\n");
      out.write("                        // If check fails, still allow to proceed (but backend will validate)\r\n");
      out.write("                        console.warn('Không thể kiểm tra work order, sẽ kiểm tra ở backend');\r\n");
      out.write("                        openCreateWorkOrderModal(ticket, customerIdValue);\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("            } else {\r\n");
      out.write("                // If no customerId or subject, proceed directly (backend will validate)\r\n");
      out.write("                openCreateWorkOrderModal(ticket, customerIdValue);\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function openCreateWorkOrderModal(ticket, customerIdValue) {\r\n");
      out.write("            // Load fresh data from server để có đầy đủ thông tin deadline\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: ctx + '/api/tech-support?action=get',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { id: ticket.id },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        // Sử dụng dữ liệu từ server\r\n");
      out.write("                        populateWorkOrderModal(response.data, customerIdValue);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Fallback to cached data\r\n");
      out.write("                        populateWorkOrderModal(ticket, customerIdValue);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function() {\r\n");
      out.write("                    // Fallback to cached data\r\n");
      out.write("                    populateWorkOrderModal(ticket, customerIdValue);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function populateWorkOrderModal(ticket, customerIdValue) {\r\n");
      out.write("            // Điền thông tin từ ticket\r\n");
      out.write("            $('#work_order_ticket_id').val(ticket.id);\r\n");
      out.write("            $('#work_order_customer_id').val(customerIdValue);\r\n");
      out.write("            console.log('Đã set customerId vào input:', customerIdValue);\r\n");
      out.write("            console.log('Giá trị customerId từ input sau khi set:', $('#work_order_customer_id').val());\r\n");
      out.write("            \r\n");
      out.write("            $('#work_order_ticket_number').text(ticket.ticketNumber || '#' + ticket.id);\r\n");
      out.write("            $('#work_order_customer_name').text(ticket.customerName || 'N/A');\r\n");
      out.write("            \r\n");
      out.write("            // Điền thông tin work order (readonly fields)\r\n");
      out.write("            $('#work_order_title').val(ticket.subject || '');\r\n");
      out.write("            \r\n");
      out.write("            // Tách thông tin hợp đồng và sản phẩm từ description\r\n");
      out.write("            var description = ticket.description || '';\r\n");
      out.write("            var contractInfo = '';\r\n");
      out.write("            var productInfo = '';\r\n");
      out.write("            var cleanDescription = description;\r\n");
      out.write("            \r\n");
      out.write("            // Tìm thông tin hợp đồng: [Hợp đồng: ...]\r\n");
      out.write("            var contractMatch = description.match(/\\[Hợp đồng:([^\\]]+)\\]/);\r\n");
      out.write("            if (contractMatch) {\r\n");
      out.write("                contractInfo = contractMatch[1].trim();\r\n");
      out.write("                cleanDescription = cleanDescription.replace(/\\[Hợp đồng:[^\\]]+\\]\\s*/g, '').trim();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Tìm thông tin sản phẩm: [Sản phẩm: ...]\r\n");
      out.write("            var productMatch = description.match(/\\[Sản phẩm:([^\\]]+)\\]/);\r\n");
      out.write("            if (productMatch) {\r\n");
      out.write("                productInfo = productMatch[1].trim();\r\n");
      out.write("                cleanDescription = cleanDescription.replace(/\\[Sản phẩm:[^\\]]+\\]\\s*/g, '').trim();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị hợp đồng & sản phẩm\r\n");
      out.write("            var contractProductHtml = '';\r\n");
      out.write("            if (contractInfo || productInfo) {\r\n");
      out.write("                $('#work_order_contract_product_group').show();\r\n");
      out.write("                if (contractInfo) {\r\n");
      out.write("                    contractProductHtml += '<div style=\"margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(60, 141, 188, 0.2);\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"display: flex; align-items: flex-start; gap: 10px;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex-shrink: 0; color: #3c8dbc; font-size: 18px; margin-top: 2px;\"><i class=\"fa fa-file-text-o\"></i></div>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex: 1; min-width: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<strong style=\"display: block; margin-bottom: 5px; color: #2c3e50; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\">HỢP ĐỒNG</strong>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; white-space: normal; font-size: 14px; color: #34495e; line-height: 1.5; max-width: 100%;\">' + escapeHtml(contractInfo) + '</div>';\r\n");
      out.write("                    contractProductHtml += '</div></div></div>';\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                if (productInfo) {\r\n");
      out.write("                    contractProductHtml += '<div style=\"padding-top: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"display: flex; align-items: flex-start; gap: 10px;\">';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex-shrink: 0; color: #27ae60; font-size: 18px; margin-top: 2px;\"><i class=\"fa fa-cube\"></i></div>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"flex: 1; min-width: 0;\">';\r\n");
      out.write("                    contractProductHtml += '<strong style=\"display: block; margin-bottom: 5px; color: #2c3e50; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\">SẢN PHẨM</strong>';\r\n");
      out.write("                    contractProductHtml += '<div style=\"word-wrap: break-word; word-break: break-word; overflow-wrap: break-word; white-space: normal; font-size: 14px; color: #34495e; line-height: 1.5; max-width: 100%;\">' + escapeHtml(productInfo) + '</div>';\r\n");
      out.write("                    contractProductHtml += '</div></div></div>';\r\n");
      out.write("                }\r\n");
      out.write("                $('#work_order_contract_product').html(contractProductHtml);\r\n");
      out.write("            } else {\r\n");
      out.write("                $('#work_order_contract_product_group').hide();\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị mô tả chi tiết (đã loại bỏ hợp đồng/sản phẩm)\r\n");
      out.write("            $('#work_order_description').val(cleanDescription || 'Không có mô tả');\r\n");
      out.write("            \r\n");
      out.write("            // Set độ ưu tiên\r\n");
      out.write("            var priority = ticket.priority || 'medium';\r\n");
      out.write("            var priorityLabels = {\r\n");
      out.write("                'urgent': 'Khẩn cấp',\r\n");
      out.write("                'high': 'Cao',\r\n");
      out.write("                'medium': 'Trung bình',\r\n");
      out.write("                'low': 'Thấp'\r\n");
      out.write("            };\r\n");
      out.write("            $('#work_order_priority').val(priority);\r\n");
      out.write("            $('#work_order_priority_display').val(priorityLabels[priority] || priority);\r\n");
      out.write("            \r\n");
      out.write("            // Set trạng thái mặc định là \"in_progress\"\r\n");
      out.write("            $('#work_order_status').val('in_progress');\r\n");
      out.write("            $('#work_order_status_display').val('Đang xử lý');\r\n");
      out.write("            \r\n");
      out.write("            // Hiển thị deadline - format từ yyyy-MM-dd sang dd/MM/yyyy\r\n");
      out.write("            var deadlineDisplay = '';\r\n");
      out.write("            if (ticket.deadline && typeof ticket.deadline === 'string' && ticket.deadline.trim() !== '' && ticket.deadline !== 'null') {\r\n");
      out.write("                try {\r\n");
      out.write("                    // Deadline từ DB là yyyy-MM-dd, chuyển sang dd/MM/yyyy\r\n");
      out.write("                    var deadlineStr = ticket.deadline.trim();\r\n");
      out.write("                    if (deadlineStr.match(/^\\d{4}-\\d{2}-\\d{2}$/)) {\r\n");
      out.write("                        var parts = deadlineStr.split('-');\r\n");
      out.write("                        deadlineDisplay = parts[2] + '/' + parts[1] + '/' + parts[0];\r\n");
      out.write("                    } else {\r\n");
      out.write("                        deadlineDisplay = deadlineStr;\r\n");
      out.write("                    }\r\n");
      out.write("                } catch (e) {\r\n");
      out.write("                    deadlineDisplay = ticket.deadline;\r\n");
      out.write("                }\r\n");
      out.write("            } else {\r\n");
      out.write("                deadlineDisplay = '<span style=\"color: #999; font-style: italic;\">Chưa có</span>';\r\n");
      out.write("            }\r\n");
      out.write("            $('#work_order_deadline').html(deadlineDisplay);\r\n");
      out.write("            \r\n");
      out.write("            $('#work_order_estimated_hours').val('');\r\n");
      out.write("            \r\n");
      out.write("            $('#createWorkOrderModal').modal('show');\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function confirmCreateWorkOrder() {\r\n");
      out.write("            // Validate required fields (từ ticket, không cần user nhập)\r\n");
      out.write("            var title = $('#work_order_title').val().trim();\r\n");
      out.write("            var description = $('#work_order_description').val().trim();\r\n");
      out.write("            \r\n");
      out.write("            if(!title) {\r\n");
      out.write("                alert('Lỗi: Không có tiêu đề từ ticket!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            if(!description) {\r\n");
      out.write("                alert('Lỗi: Không có mô tả từ ticket!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            var ticketId = $('#work_order_ticket_id').val();\r\n");
      out.write("            var customerId = $('#work_order_customer_id').val();\r\n");
      out.write("            \r\n");
      out.write("            // Debug: Kiểm tra customerId\r\n");
      out.write("            var ticket = allTickets.find(function(t) { return t.id == ticketId; });\r\n");
      out.write("            \r\n");
      out.write("            // Nếu customerId rỗng, thử lấy lại từ ticket object\r\n");
      out.write("            // Kiểm tra: rỗng, null, undefined, hoặc chuỗi 'null'/'undefined'\r\n");
      out.write("            if (!customerId || customerId === '' || customerId === 'null' || customerId === 'undefined' || customerId === '0') {\r\n");
      out.write("                if (ticket) {\r\n");
      out.write("                    // Thử lấy customerId từ ticket - kiểm tra cả null và 0\r\n");
      out.write("                    // ticket.customerId có thể là null, undefined, 0, hoặc số hợp lệ\r\n");
      out.write("                    if (ticket.customerId != null && ticket.customerId !== undefined && ticket.customerId !== 0) {\r\n");
      out.write("                        customerId = ticket.customerId;\r\n");
      out.write("                        $('#work_order_customer_id').val(customerId);\r\n");
      out.write("                        console.log('Đã lấy lại customerId từ ticket:', customerId);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Ticket không có customerId hợp lệ (null, undefined, hoặc 0)\r\n");
      out.write("                        console.error('Ticket không có customerId hợp lệ trong object');\r\n");
      out.write("                        console.log('Ticket ID:', ticketId);\r\n");
      out.write("                        console.log('Ticket object:', ticket);\r\n");
      out.write("                        console.log('ticket.customerId value:', ticket.customerId);\r\n");
      out.write("                        console.log('ticket.customerId type:', typeof ticket.customerId);\r\n");
      out.write("                        alert('Lỗi: Ticket này không có thông tin khách hàng trong hệ thống.\\n\\n' +\r\n");
      out.write("                              'Nguyên nhân: customer_id trong database có thể là NULL hoặc 0.\\n\\n' +\r\n");
      out.write("                              'Giải pháp:\\n' +\r\n");
      out.write("                              '1. Kiểm tra database: SELECT customer_id FROM support_requests WHERE id = ' + ticketId + ';\\n' +\r\n");
      out.write("                              '2. Nếu customer_id là NULL, cần cập nhật:\\n' +\r\n");
      out.write("                              '   UPDATE support_requests SET customer_id = [ID_KHÁCH_HÀNG] WHERE id = ' + ticketId + ';\\n\\n' +\r\n");
      out.write("                              'Vui lòng liên hệ quản trị viên để cập nhật thông tin khách hàng cho ticket.\\n\\n' +\r\n");
      out.write("                              'Ticket ID: ' + ticketId);\r\n");
      out.write("                        return;\r\n");
      out.write("                    }\r\n");
      out.write("                } else {\r\n");
      out.write("                    alert('Lỗi: Không tìm thấy ticket với ID: ' + ticketId);\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Validate: customerId bắt buộc phải có\r\n");
      out.write("            if (!customerId || customerId === '' || customerId === 'null' || customerId === 'undefined') {\r\n");
      out.write("                alert('Lỗi: Không tìm thấy thông tin khách hàng. Không thể tạo work order.\\n\\nVui lòng kiểm tra lại ticket hoặc liên hệ quản trị viên.');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Validate estimated hours\r\n");
      out.write("            var estimatedHours = $('#work_order_estimated_hours').val();\r\n");
      out.write("            if (estimatedHours && estimatedHours.trim() !== '') {\r\n");
      out.write("                var hoursValue = parseFloat(estimatedHours);\r\n");
      out.write("                if (isNaN(hoursValue)) {\r\n");
      out.write("                    alert('Lỗi: Giờ ước tính không hợp lệ. Vui lòng nhập số.');\r\n");
      out.write("                    $('#work_order_estimated_hours').focus();\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("                if (hoursValue <= 0) {\r\n");
      out.write("                    alert('Lỗi: Giờ ước tính phải lớn hơn 0. Vui lòng nhập giá trị hợp lệ.');\r\n");
      out.write("                    $('#work_order_estimated_hours').focus();\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("                if (hoursValue > 100) {\r\n");
      out.write("                    alert('Lỗi: Giờ ước tính không được vượt quá 100 giờ. Vui lòng nhập giá trị nhỏ hơn.');\r\n");
      out.write("                    $('#work_order_estimated_hours').focus();\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            var data = {\r\n");
      out.write("                action: 'create',\r\n");
      out.write("                ticketId: ticketId,\r\n");
      out.write("                customerId: customerId,\r\n");
      out.write("                title: title,\r\n");
      out.write("                description: description,\r\n");
      out.write("                priority: $('#work_order_priority').val() || 'medium',\r\n");
      out.write("                status: $('#work_order_status').val() || 'in_progress',\r\n");
      out.write("                estimatedHours: estimatedHours && estimatedHours.trim() !== '' ? estimatedHours : null\r\n");
      out.write("            };\r\n");
      out.write("            \r\n");
      out.write("            console.log('Tạo work order với dữ liệu:', data);\r\n");
      out.write("            \r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: ctx + '/api/work-orders',\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: data,\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if(response && response.success) {\r\n");
      out.write("                        alert('✓ Tạo đơn hàng công việc thành công!\\n\\nMã đơn hàng: ' + (response.workOrderNumber || ''));\r\n");
      out.write("                        $('#createWorkOrderModal').modal('hide');\r\n");
      out.write("                        \r\n");
      out.write("                        // Reset form\r\n");
      out.write("                        $('#createWorkOrderForm')[0].reset();\r\n");
      out.write("                        \r\n");
      out.write("                        // Reload tickets (not silent, show notifications if status changed)\r\n");
      out.write("                        loadTickets(false);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        var errorMsg = response.message || 'Không thể tạo đơn hàng';\r\n");
      out.write("                        // Check if error is about existing work order\r\n");
      out.write("                        if (errorMsg.includes('đã có work order') || errorMsg.includes('existingWorkOrderNumber')) {\r\n");
      out.write("                            var existingWO = response.existingWorkOrderNumber || 'N/A';\r\n");
      out.write("                            alert('✗ Lỗi: Ticket này đã có work order!\\n\\n' +\r\n");
      out.write("                                  'Mã work order: ' + existingWO + '\\n\\n' +\r\n");
      out.write("                                  'Mỗi ticket chỉ được tạo 1 work order. Vui lòng kiểm tra lại.');\r\n");
      out.write("                        } else {\r\n");
      out.write("                            alert('✗ Lỗi: ' + errorMsg);\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error creating work order:', error);\r\n");
      out.write("                    alert('✗ Lỗi kết nối máy chủ: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        function showError(msg) {\r\n");
      out.write("            $('#ticketsTableBody').html('<tr><td colspan=\"8\" class=\"text-center text-danger\">' + msg + '</td></tr>');\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /**\r\n");
      out.write("         * Sync ticket status for all completed work orders\r\n");
      out.write("         * This fixes tickets that weren't updated when work order was closed\r\n");
      out.write("         */\r\n");
      out.write("        function syncTicketStatusForCompletedWorkOrders() {\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: ctx + '/api/work-orders?action=syncTicketStatus',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                cache: false,\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response && response.success) {\r\n");
      out.write("                        var syncedCount = response.syncedCount || 0;\r\n");
      out.write("                        var alreadyResolved = response.alreadyResolvedCount || 0;\r\n");
      out.write("                        var failedCount = response.failedCount || 0;\r\n");
      out.write("                        \r\n");
      out.write("                        if (syncedCount > 0) {\r\n");
      out.write("                            console.log('✓ Đã đồng bộ ' + syncedCount + ' ticket(s) từ completed work orders');\r\n");
      out.write("                            // Reload tickets to show updated status\r\n");
      out.write("                            setTimeout(function() {\r\n");
      out.write("                                loadTickets(false);\r\n");
      out.write("                            }, 1000);\r\n");
      out.write("                        } else {\r\n");
      out.write("                            console.log('Không có ticket nào cần đồng bộ (đã resolved: ' + alreadyResolved + ', không tìm thấy: ' + failedCount + ')');\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        console.warn('Lỗi khi đồng bộ ticket status: ' + (response.message || 'Unknown error'));\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.warn('Không thể đồng bộ ticket status: ' + error);\r\n");
      out.write("                    // Don't show error to user, just log it\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("    </script>\r\n");
      out.write("</body>\r\n");
      out.write("</html>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}

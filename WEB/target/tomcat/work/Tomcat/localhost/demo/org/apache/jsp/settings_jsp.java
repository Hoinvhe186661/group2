/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-11-05 17:22:16 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class settings_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write('\r');
      out.write('\n');

    // Kiểm tra đăng nhập
    String username = (String) session.getAttribute("username");
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    String userRole = (String) session.getAttribute("userRole");
    
    if (username == null || isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect(request.getContextPath() + "/login.jsp");
        return;
    }
    
    // Kiểm tra quyền truy cập - chỉ admin mới được vào
    if (!"admin".equals(userRole)) {
        response.sendRedirect(request.getContextPath() + "/403.jsp");
        return;
    }

      out.write("\r\n");
      out.write("<!DOCTYPE html>\r\n");
      out.write("<html>\r\n");
      out.write("<head>\r\n");
      out.write("    <meta charset=\"UTF-8\">\r\n");
      out.write("    <title>Bảng điều khiển | Cài đặt</title>\r\n");
      out.write("    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>\r\n");
      out.write("    \r\n");
      out.write("    <!-- bootstrap 3.0.2 -->\r\n");
      out.write("    <link href=\"css/bootstrap.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- font Awesome -->\r\n");
      out.write("    <link href=\"css/font-awesome.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Ionicons -->\r\n");
      out.write("    <link href=\"css/ionicons.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Theme style -->\r\n");
      out.write("    <link href=\"css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>\r\n");
      out.write("</head>\r\n");
      out.write("<body class=\"skin-black\">\r\n");
      out.write("    <!-- header logo: style can be found in header.less -->\r\n");
      out.write("    <header class=\"header\">\r\n");
      out.write("        <a href=\"admin.jsp\" class=\"logo\">\r\n");
      out.write("            Bảng điều khiển \r\n");
      out.write("        </a>\r\n");
      out.write("        <!-- Header Navbar: style can be found in header.less -->\r\n");
      out.write("        <nav class=\"navbar navbar-static-top\" role=\"navigation\">\r\n");
      out.write("            <!-- Sidebar toggle button-->\r\n");
      out.write("            <a href=\"#\" class=\"navbar-btn sidebar-toggle\" data-toggle=\"offcanvas\" role=\"button\">\r\n");
      out.write("                <span class=\"sr-only\">Toggle navigation</span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("            </a>\r\n");
      out.write("            <div class=\"navbar-right\">\r\n");
      out.write("                <ul class=\"nav navbar-nav\">\r\n");
      out.write("                    <!-- User Account: style can be found in dropdown.less -->\r\n");
      out.write("                    <li class=\"dropdown user user-menu\">\r\n");
      out.write("                        <a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\">\r\n");
      out.write("                            <i class=\"fa fa-user\"></i>\r\n");
      out.write("                            <span>Admin <i class=\"caret\"></i></span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                        <ul class=\"dropdown-menu dropdown-custom dropdown-menu-right\">\r\n");
      out.write("                            <li class=\"dropdown-header text-center\">Tài khoản</li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"profile.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-user fa-fw pull-right\"></i>\r\n");
      out.write("                                    Hồ sơ\r\n");
      out.write("                                </a>\r\n");
      out.write("                                <a href=\"settings.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-cog fa-fw pull-right\"></i>\r\n");
      out.write("                                    Cài đặt\r\n");
      out.write("                                </a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                            <li class=\"divider\"></li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"logout\"><i class=\"fa fa-ban fa-fw pull-right\"></i> Đăng xuất</a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                        </ul>\r\n");
      out.write("                    </li>\r\n");
      out.write("                </ul>\r\n");
      out.write("            </div>\r\n");
      out.write("        </nav>\r\n");
      out.write("    </header>\r\n");
      out.write("    \r\n");
      out.write("    <div class=\"wrapper row-offcanvas row-offcanvas-left\">\r\n");
      out.write("        <!-- Left side column. contains the logo and sidebar -->\r\n");
      out.write("        <aside class=\"left-side sidebar-offcanvas\">\r\n");
      out.write("            <!-- sidebar: style can be found in sidebar.less -->\r\n");
      out.write("            <section class=\"sidebar\">\r\n");
      out.write("                <!-- Sidebar user panel -->\r\n");
      out.write("                <div class=\"user-panel\">\r\n");
      out.write("                    <div class=\"pull-left image\">\r\n");
      out.write("                        <img src=\"img/26115.jpg\" class=\"img-circle\" alt=\"User Image\" />\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"pull-left info\">\r\n");
      out.write("                        <p>Xin chào, Admin</p>\r\n");
      out.write("                        <a href=\"#\"><i class=\"fa fa-circle text-success\"></i> Online</a>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <!-- sidebar menu: : style can be found in sidebar.less -->\r\n");
      out.write("                 \r\n");
      out.write("                <ul class=\"sidebar-menu\">\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"admin.jsp\">\r\n");
      out.write("                            <i class=\"fa fa-dashboard\"></i> <span>Bảng điều khiển</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"product\">\r\n");
      out.write("                            <i class=\"fa fa-shopping-cart\"></i> <span>Quản lý sản phẩm</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"orders.jsp\">\r\n");
      out.write("                            <i class=\"fa fa-file-text-o\"></i> <span>Quản lý đơn hàng</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"customers\">\r\n");
      out.write("                            <i class=\"fa fa-users\"></i> <span>Quản lý khách hàng</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"email-management\">\r\n");
      out.write("                            <i class=\"fa fa-envelope\"></i> <span>Quản lý Email</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li>\r\n");
      out.write("                        <a href=\"reports.jsp\">\r\n");
      out.write("                            <i class=\"fa fa-bar-chart\"></i> <span>Báo cáo</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                    <li class=\"active\">\r\n");
      out.write("                        <a href=\"settings.jsp\">\r\n");
      out.write("                            <i class=\"fa fa-cog\"></i> <span>Cài đặt</span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                    </li>\r\n");
      out.write("                </ul>\r\n");
      out.write("            </section>\r\n");
      out.write("            <!-- /.sidebar -->\r\n");
      out.write("        </aside>\r\n");
      out.write("\r\n");
      out.write("        <aside class=\"right-side\">\r\n");
      out.write("            <!-- Main content -->\r\n");
      out.write("            <section class=\"content\">\r\n");
      out.write("                <div class=\"row\">\r\n");
      out.write("                    <div class=\"col-md-12\">\r\n");
      out.write("                        <div class=\"panel\">\r\n");
      out.write("                            <header class=\"panel-heading\">\r\n");
      out.write("                                <h3>Cài đặt hệ thống</h3>\r\n");
      out.write("                            </header>\r\n");
      out.write("                            <div class=\"panel-body\">\r\n");
      out.write("                                <!-- Tab navigation -->\r\n");
      out.write("                                <ul class=\"nav nav-tabs\" role=\"tablist\">\r\n");
      out.write("                                    <li role=\"presentation\" class=\"active\">\r\n");
      out.write("                                        <a href=\"#general\" aria-controls=\"general\" role=\"tab\" data-toggle=\"tab\">\r\n");
      out.write("                                            <i class=\"fa fa-cog\"></i> Cài đặt chung\r\n");
      out.write("                                        </a>\r\n");
      out.write("                                    </li>\r\n");
      out.write("                                    <li role=\"presentation\">\r\n");
      out.write("                                        <a href=\"#email\" aria-controls=\"email\" role=\"tab\" data-toggle=\"tab\">\r\n");
      out.write("                                            <i class=\"fa fa-envelope\"></i> Liên Hệ \r\n");
      out.write("                                        </a>\r\n");
      out.write("                                    </li>\r\n");
      out.write("                                    \r\n");
      out.write("                                    \r\n");
      out.write("                                </ul>\r\n");
      out.write("\r\n");
      out.write("                                <!-- Tab content -->\r\n");
      out.write("                                <div class=\"tab-content\" style=\"margin-top: 20px;\">\r\n");
      out.write("                                    <!-- Cài đặt chung -->\r\n");
      out.write("                                    <div role=\"tabpanel\" class=\"tab-pane active\" id=\"general\">\r\n");
      out.write("                                        <form id=\"generalSettingsForm\">\r\n");
      out.write("                                            <div class=\"row\">\r\n");
      out.write("                                                <div class=\"col-md-6\">\r\n");
      out.write("                                                    <div class=\"form-group\">\r\n");
      out.write("                                                        <label for=\"siteName\">Tên website:</label>\r\n");
      out.write("                                                        <input type=\"text\" class=\"form-control\" id=\"siteName\" value=\"Cửa hàng trực tuyến\">\r\n");
      out.write("                                                    </div>\r\n");
      out.write("                                                    <div class=\"form-group\">\r\n");
      out.write("                                                        <label for=\"siteDescription\">Mô tả website:</label>\r\n");
      out.write("                                                        <textarea class=\"form-control\" id=\"siteDescription\" rows=\"3\">Cửa hàng trực tuyến chuyên bán các sản phẩm chất lượng cao</textarea>\r\n");
      out.write("                                                    </div>\r\n");
      out.write("                                                    \r\n");
      out.write("                                                </div>\r\n");
      out.write("                                                \r\n");
      out.write("                                            </div>\r\n");
      out.write("                                            <div class=\"form-group\">\r\n");
      out.write("                                                <button type=\"button\" class=\"btn btn-primary\" id=\"saveGeneralBtn\" onclick=\"saveGeneralSettings(this)\">\r\n");
      out.write("                                                    <i class=\"fa fa-save\"></i> Lưu cài đặt chung\r\n");
      out.write("                                                </button>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                        </form>\r\n");
      out.write("                                    </div>\r\n");
      out.write("\r\n");
      out.write("                                    <!-- Cài đặt Liên hệ  -->\r\n");
      out.write("                                    <div role=\"tabpanel\" class=\"tab-pane\" id=\"email\">\r\n");
      out.write("                                        <form id=\"emailSettingsForm\">\r\n");
      out.write("                                            <div class=\"row\">\r\n");
      out.write("                                                <div class=\"col-md-6\">\r\n");
      out.write("                                                    <div class=\"form-group\">\r\n");
      out.write("                                                        <label for=\"siteEmail\">Email liên hệ:</label>\r\n");
      out.write("                                                        <input type=\"email\" class=\"form-control\" id=\"siteEmail\" value=\"contact@example.com\" required pattern=\"^[a-zA-Z0-9._%+-]+@(gmail\\.com|fpt\\.edu\\.vn)$\" title=\"Chỉ chấp nhận email miền gmail.com hoặc fpt.edu.vn\">\r\n");
      out.write("                                                    </div>\r\n");
      out.write("                                                    <div class=\"form-group\">\r\n");
      out.write("                                                        <label for=\"sitePhone\">Số điện thoại:</label>\r\n");
      out.write("                                                        <input type=\"tel\" class=\"form-control\" id=\"sitePhone\" value=\"0123456789\" required pattern=\"^[0-9]{10,11}$\" title=\"Chỉ cho phép số, 10 hoặc 11 chữ số\">\r\n");
      out.write("                                                    </div>\r\n");
      out.write("                                                   \r\n");
      out.write("                                                </div>\r\n");
      out.write("                                                <div class=\"col-md-6\">\r\n");
      out.write("                                                    <div class=\"form-group\">\r\n");
      out.write("                                                        <label for=\"siteAddress\">Địa chỉ:</label>\r\n");
      out.write("                                                        <textarea class=\"form-control\" id=\"siteAddress\" rows=\"3\" required>123 Đường ABC, Quận 1, TP.HCM</textarea>\r\n");
      out.write("                                                    </div>\r\n");
      out.write("                                                    \r\n");
      out.write("                                                </div>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                            <div class=\"form-group\">\r\n");
      out.write("                                                <button type=\"button\" class=\"btn btn-primary\" onclick=\"saveContactSettings(this)\">\r\n");
      out.write("                                                    <i class=\"fa fa-save\"></i> Lưu cài đặt Liên Hệ \r\n");
      out.write("                                                </button>\r\n");
      out.write("                                            \r\n");
      out.write("                                            </div>\r\n");
      out.write("                                        </form>\r\n");
      out.write("                                    </div>\r\n");
      out.write("\r\n");
      out.write("                                   \r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("            </section><!-- /.content -->\r\n");
      out.write("        </aside><!-- /.right-side -->\r\n");
      out.write("    </div><!-- ./wrapper -->\r\n");
      out.write("\r\n");
      out.write("    <!-- jQuery 2.0.2 -->\r\n");
      out.write("    <script src=\"http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js\"></script>\r\n");
      out.write("    <script src=\"js/jquery.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- jQuery UI 1.10.3 -->\r\n");
      out.write("    <script src=\"js/jquery-ui-1.10.3.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Bootstrap -->\r\n");
      out.write("    <script src=\"js/bootstrap.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Director App -->\r\n");
      out.write("    <script src=\"js/Director/app.js\" type=\"text/javascript\"></script>\r\n");
      out.write("\r\n");
      out.write("    <script type=\"text/javascript\">\r\n");
      out.write("        // Load settings từ database khi trang được mở\r\n");
      out.write("        window.onload = function() {\r\n");
      out.write("            loadSettings();\r\n");
      out.write("        };\r\n");
      out.write("\r\n");
      out.write("        function loadSettings() {\r\n");
      out.write("            var xhr = new XMLHttpRequest();\r\n");
      out.write("            xhr.open('GET', 'settings?action=getAll', true);\r\n");
      out.write("            xhr.withCredentials = true; // Đảm bảo gửi cookie/session\r\n");
      out.write("            xhr.onreadystatechange = function() {\r\n");
      out.write("                if (xhr.readyState === 4 && xhr.status === 200) {\r\n");
      out.write("                    try {\r\n");
      out.write("                        var response = JSON.parse(xhr.responseText);\r\n");
      out.write("                        if (response.success && response.data) {\r\n");
      out.write("                            var data = response.data;\r\n");
      out.write("                            \r\n");
      out.write("                            // Load cài đặt chung\r\n");
      out.write("                            if (data.site_name) {\r\n");
      out.write("                                document.getElementById('siteName').value = data.site_name;\r\n");
      out.write("                            }\r\n");
      out.write("                            if (data.site_description) {\r\n");
      out.write("                                document.getElementById('siteDescription').value = data.site_description;\r\n");
      out.write("                            }\r\n");
      out.write("                            if (data.site_email) {\r\n");
      out.write("                                document.getElementById('siteEmail').value = data.site_email;\r\n");
      out.write("                            }\r\n");
      out.write("                            if (data.site_phone) {\r\n");
      out.write("                                document.getElementById('sitePhone').value = data.site_phone;\r\n");
      out.write("                            }\r\n");
      out.write("                            if (data.site_address) {\r\n");
      out.write("                                document.getElementById('siteAddress').value = data.site_address;\r\n");
      out.write("                            }\r\n");
      out.write("                            \r\n");
      out.write("                            // (Đã bỏ các trường SMTP không sử dụng)\r\n");
      out.write("                        }\r\n");
      out.write("                    } catch (e) {\r\n");
      out.write("                        console.error('Lỗi khi load settings: ', e);\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            };\r\n");
      out.write("            xhr.send();\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        function saveGeneralSettings(buttonElement) {\r\n");
      out.write("            // Lấy dữ liệu từ form\r\n");
      out.write("            var siteName = document.getElementById('siteName').value;\r\n");
      out.write("            var siteDescription = document.getElementById('siteDescription').value;\r\n");
      out.write("            var siteEmail = document.getElementById('siteEmail').value;\r\n");
      out.write("            var sitePhone = document.getElementById('sitePhone').value;\r\n");
      out.write("            var siteAddress = document.getElementById('siteAddress').value;\r\n");
      out.write("\r\n");
      out.write("            // Nếu trường email tồn tại, kiểm tra domain hợp lệ (gmail.com | fpt.edu.vn)\r\n");
      out.write("            if (siteEmail) {\r\n");
      out.write("                var emailPattern = /^[a-zA-Z0-9._%+-]+@(gmail\\.com|fpt\\.edu\\.vn)$/;\r\n");
      out.write("                if (!emailPattern.test(siteEmail)) {\r\n");
      out.write("                    alert('Email liên hệ chỉ được phép thuộc miền gmail.com hoặc fpt.edu.vn');\r\n");
      out.write("                    try { document.getElementById('siteEmail').focus(); } catch (e) {}\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Lấy nút lưu để disable và hiển thị loading\r\n");
      out.write("            var saveButton = buttonElement || document.getElementById('saveGeneralBtn');\r\n");
      out.write("            var originalText = saveButton.innerHTML;\r\n");
      out.write("            saveButton.disabled = true;\r\n");
      out.write("            saveButton.innerHTML = '<i class=\"fa fa-spinner fa-spin\"></i> Đang lưu...';\r\n");
      out.write("\r\n");
      out.write("            // Tạo URLSearchParams thay vì FormData\r\n");
      out.write("            var params = new URLSearchParams();\r\n");
      out.write("            params.append('action', 'saveGeneral');\r\n");
      out.write("            params.append('siteName', siteName);\r\n");
      out.write("            params.append('siteDescription', siteDescription);\r\n");
      out.write("            params.append('siteEmail', siteEmail);\r\n");
      out.write("            params.append('sitePhone', sitePhone);\r\n");
      out.write("            params.append('siteAddress', siteAddress);\r\n");
      out.write("\r\n");
      out.write("            // Gửi AJAX request\r\n");
      out.write("            var xhr = new XMLHttpRequest();\r\n");
      out.write("            xhr.open('POST', 'settings', true);\r\n");
      out.write("            xhr.withCredentials = true; // Đảm bảo gửi cookie/session\r\n");
      out.write("            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');\r\n");
      out.write("            xhr.onreadystatechange = function() {\r\n");
      out.write("                if (xhr.readyState === 4) {\r\n");
      out.write("                    if (xhr.status === 200) {\r\n");
      out.write("                        try {\r\n");
      out.write("                            var response = JSON.parse(xhr.responseText);\r\n");
      out.write("                            console.log('Response from server:', response);\r\n");
      out.write("                            if (response.success) {\r\n");
      out.write("                                // Hiển thị thông báo thành công\r\n");
      out.write("                                saveButton.innerHTML = '<i class=\"fa fa-check\"></i> Đã lưu!';\r\n");
      out.write("                                saveButton.classList.add('btn-success');\r\n");
      out.write("                                \r\n");
      out.write("                                // Đợi 1 giây rồi redirect về index.jsp\r\n");
      out.write("                                setTimeout(function() {\r\n");
      out.write("                                    window.location.href = 'index.jsp';\r\n");
      out.write("                                }, 1000);\r\n");
      out.write("                            } else {\r\n");
      out.write("                                // Khôi phục nút và hiển thị lỗi\r\n");
      out.write("                                saveButton.disabled = false;\r\n");
      out.write("                                saveButton.innerHTML = originalText;\r\n");
      out.write("                                \r\n");
      out.write("                                // Xử lý lỗi \"Không có quyền truy cập\"\r\n");
      out.write("                                var errorMessage = response.message || 'Không thể lưu cài đặt';\r\n");
      out.write("                                if (errorMessage.includes('Không có quyền truy cập')) {\r\n");
      out.write("                                    alert('Lỗi: ' + errorMessage + '\\n\\nVui lòng đăng nhập lại với tài khoản admin để tiếp tục.');\r\n");
      out.write("                                    // Chuyển hướng đến trang login\r\n");
      out.write("                                    setTimeout(function() {\r\n");
      out.write("                                        window.location.href = 'login.jsp';\r\n");
      out.write("                                    }, 2000);\r\n");
      out.write("                                } else {\r\n");
      out.write("                                    alert('Lỗi: ' + errorMessage);\r\n");
      out.write("                                }\r\n");
      out.write("                                console.error('Server error:', response);\r\n");
      out.write("                            }\r\n");
      out.write("                        } catch (e) {\r\n");
      out.write("                            // Khôi phục nút và hiển thị lỗi\r\n");
      out.write("                            saveButton.disabled = false;\r\n");
      out.write("                            saveButton.innerHTML = originalText;\r\n");
      out.write("                            alert('Lỗi khi xử lý phản hồi từ server: ' + e.message);\r\n");
      out.write("                            console.error('Parse error:', e);\r\n");
      out.write("                            console.error('Response text:', xhr.responseText);\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        // Khôi phục nút và hiển thị lỗi\r\n");
      out.write("                        saveButton.disabled = false;\r\n");
      out.write("                        saveButton.innerHTML = originalText;\r\n");
      out.write("                        alert('Lỗi kết nối đến server (Status: ' + xhr.status + ')');\r\n");
      out.write("                        console.error('HTTP error:', xhr.status, xhr.statusText);\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            };\r\n");
      out.write("            xhr.send(params.toString());\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        function saveContactSettings(buttonElement) {\r\n");
      out.write("            // Lấy dữ liệu liên hệ\r\n");
      out.write("            var siteEmail = document.getElementById('siteEmail').value;\r\n");
      out.write("            var sitePhone = document.getElementById('sitePhone').value;\r\n");
      out.write("            var siteAddress = document.getElementById('siteAddress').value;\r\n");
      out.write("\r\n");
      out.write("            // HTML5 validation cho form liên hệ\r\n");
      out.write("            var form = document.getElementById('emailSettingsForm');\r\n");
      out.write("            if (form && !form.checkValidity()) {\r\n");
      out.write("                form.reportValidity();\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Bảo vệ bổ sung ở JS: kiểm tra domain email\r\n");
      out.write("            var emailPattern = /^[a-zA-Z0-9._%+-]+@(gmail\\.com|fpt\\.edu\\.vn)$/;\r\n");
      out.write("            if (!emailPattern.test(siteEmail)) {\r\n");
      out.write("                alert('Email liên hệ chỉ được phép thuộc miền gmail.com hoặc fpt.edu.vn');\r\n");
      out.write("                try { document.getElementById('siteEmail').focus(); } catch (e) {}\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Disable nút và hiển thị trạng thái\r\n");
      out.write("            var saveButton = buttonElement;\r\n");
      out.write("            var originalText = saveButton.innerHTML;\r\n");
      out.write("            saveButton.disabled = true;\r\n");
      out.write("            saveButton.innerHTML = '<i class=\"fa fa-spinner fa-spin\"></i> Đang lưu...';\r\n");
      out.write("\r\n");
      out.write("            // Gửi như cài đặt chung để lưu vào bảng settings (site_email/phone/address)\r\n");
      out.write("            var params = new URLSearchParams();\r\n");
      out.write("            params.append('action', 'saveGeneral');\r\n");
      out.write("            params.append('siteEmail', siteEmail);\r\n");
      out.write("            params.append('sitePhone', sitePhone);\r\n");
      out.write("            params.append('siteAddress', siteAddress);\r\n");
      out.write("\r\n");
      out.write("            var xhr = new XMLHttpRequest();\r\n");
      out.write("            xhr.open('POST', 'settings', true);\r\n");
      out.write("            xhr.withCredentials = true;\r\n");
      out.write("            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');\r\n");
      out.write("            xhr.onreadystatechange = function() {\r\n");
      out.write("                if (xhr.readyState === 4) {\r\n");
      out.write("                    if (xhr.status === 200) {\r\n");
      out.write("                        try {\r\n");
      out.write("                            var response = JSON.parse(xhr.responseText);\r\n");
      out.write("                            if (response.success) {\r\n");
      out.write("                                saveButton.innerHTML = '<i class=\"fa fa-check\"></i> Đã lưu!';\r\n");
      out.write("                                saveButton.classList.add('btn-success');\r\n");
      out.write("                                setTimeout(function() {\r\n");
      out.write("                                    window.location.href = 'index.jsp';\r\n");
      out.write("                                }, 800);\r\n");
      out.write("                            } else {\r\n");
      out.write("                                saveButton.disabled = false;\r\n");
      out.write("                                saveButton.innerHTML = originalText;\r\n");
      out.write("                                alert('Lỗi: ' + (response.message || 'Không thể lưu cài đặt liên hệ'));\r\n");
      out.write("                            }\r\n");
      out.write("                        } catch (e) {\r\n");
      out.write("                            saveButton.disabled = false;\r\n");
      out.write("                            saveButton.innerHTML = originalText;\r\n");
      out.write("                            alert('Lỗi khi xử lý phản hồi từ server: ' + e.message);\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        saveButton.disabled = false;\r\n");
      out.write("                        saveButton.innerHTML = originalText;\r\n");
      out.write("                        alert('Lỗi kết nối đến server (Status: ' + xhr.status + ')');\r\n");
      out.write("                    }\r\n");
      out.write("                }\r\n");
      out.write("            };\r\n");
      out.write("            xhr.send(params.toString());\r\n");
      out.write("        }\r\n");
      out.write("    </script>\r\n");
      out.write("</body>\r\n");
      out.write("</html>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}

/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-11-13 19:04:12 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class stock_005fhistory_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("  ");
 String username=(String) session.getAttribute("username"); Boolean isLoggedIn=(Boolean)
    session.getAttribute("isLoggedIn"); String userRole=(String) session.getAttribute("userRole"); if (username==null ||
    isLoggedIn==null || !isLoggedIn) { response.sendRedirect(request.getContextPath() + "/login.jsp" ); return; } 
      out.write("\r\n");
      out.write("    <!DOCTYPE html>\r\n");
      out.write("    <html>\r\n");
      out.write("\r\n");
      out.write("    <head>\r\n");
      out.write("      <meta charset=\"UTF-8\">\r\n");
      out.write("      <title>Lịch sử xuất nhập kho</title>\r\n");
      out.write("      <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>\r\n");
      out.write("      <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/bootstrap.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("      <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/font-awesome.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("      <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("      <style>\r\n");
      out.write("        .history-card {\r\n");
      out.write("          border: 1px solid #eee;\r\n");
      out.write("          border-radius: 6px;\r\n");
      out.write("          padding: 16px;\r\n");
      out.write("          margin-bottom: 12px;\r\n");
      out.write("          background: #fff\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .history-badge {\r\n");
      out.write("          padding: 4px 8px;\r\n");
      out.write("          border-radius: 12px;\r\n");
      out.write("          font-size: 12px\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .badge-in {\r\n");
      out.write("          background: #e8f5e9;\r\n");
      out.write("          color: #2e7d32\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .badge-out {\r\n");
      out.write("          background: #fdecea;\r\n");
      out.write("          color: #c62828\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .badge-adj {\r\n");
      out.write("          background: #e8f0fe;\r\n");
      out.write("          color: #1a73e8\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .qty-pos {\r\n");
      out.write("          color: #2e7d32;\r\n");
      out.write("          font-weight: 600\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .qty-neg {\r\n");
      out.write("          color: #c62828;\r\n");
      out.write("          font-weight: 600\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .muted {\r\n");
      out.write("          color: #777\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        .filter-bar .form-control {\r\n");
      out.write("          height: 36px\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        body {\r\n");
      out.write("          background: #f5f6f8\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("      .table-responsive {\r\n");
      out.write("        margin-top: 10px;\r\n");
      out.write("      }\r\n");
      out.write("      </style>\r\n");
      out.write("    </head>\r\n");
      out.write("\r\n");
      out.write("    <body class=\"skin-black\">\r\n");
      out.write("      <header class=\"header\">\r\n");
      out.write("        <a href=\"");
      out.print(request.getContextPath());
      out.write("/admin.jsp\" class=\"logo\">Quản lý kho</a>\r\n");
      out.write("        <nav class=\"navbar navbar-static-top\" role=\"navigation\">\r\n");
      out.write("          <a href=\"#\" class=\"navbar-btn sidebar-toggle\" data-toggle=\"offcanvas\" role=\"button\">\r\n");
      out.write("            <span class=\"icon-bar\"></span><span class=\"icon-bar\"></span><span class=\"icon-bar\"></span>\r\n");
      out.write("          </a>\r\n");
      out.write("          <div class=\"navbar-right\">\r\n");
      out.write("            <ul class=\"nav navbar-nav\">\r\n");
      out.write("              <li class=\"dropdown user user-menu\"><a class=\"dropdown-toggle\" data-toggle=\"dropdown\" href=\"#\"><i\r\n");
      out.write("                    class=\"fa fa-user\"></i><span>\r\n");
      out.write("                    ");
      out.print( username );
      out.write(" <i class=\"caret\"></i>\r\n");
      out.write("                  </span></a>\r\n");
      out.write("                <ul class=\"dropdown-menu\">\r\n");
      out.write("                  <li class=\"dropdown-header text-center\">Tài khoản</li>\r\n");
      out.write("                  <li><a href=\"profile.jsp\">Hồ sơ</a><a href=\"");
      out.print(request.getContextPath());
      out.write("/logout\">Đăng xuất</a></li>\r\n");
      out.write("                </ul>\r\n");
      out.write("              </li>\r\n");
      out.write("            </ul>\r\n");
      out.write("          </div>\r\n");
      out.write("        </nav>\r\n");
      out.write("      </header>\r\n");
      out.write("      <div class=\"wrapper row-offcanvas row-offcanvas-left\">\r\n");
      out.write("        ");
      org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, "partials/sidebar.jsp", out, false);
      out.write("\r\n");
      out.write("        <aside class=\"right-side\">\r\n");
      out.write("          <section class=\"content\">\r\n");
      out.write("            <div class=\"row\">\r\n");
      out.write("              <div class=\"col-xs-12\">\r\n");
      out.write("                <div class=\"panel\">\r\n");
      out.write("                   <header class=\"panel-heading\">\r\n");
      out.write("                  <h3 style=\"display: inline-block; margin: 0 0 15px 0;\"><i class=\"fa fa-history\"></i> Lịch sử Xuất, Nhập, Tồn</h3>\r\n");
      out.write("                  <div class=\"panel-tools\" style=\"float: right; margin-bottom: 15px;\">\r\n");
      out.write("                    <a class=\"btn btn-default btn-sm\" href=\"");
      out.print(request.getContextPath());
      out.write("/inventory.jsp\">\r\n");
      out.write("                      <i class=\"fa fa-arrow-left\"></i> Quay lại\r\n");
      out.write("                    </a>\r\n");
      out.write("                  </div>\r\n");
      out.write("                  <ul class=\"nav nav-tabs\" style=\"border-bottom:none; clear: both;\">\r\n");
      out.write("                    <li class=\"active\"><a href=\"#tab-in\" data-toggle=\"tab\"><i class=\"fa fa-arrow-down\"></i> Lịch sử nhập kho</a></li>\r\n");
      out.write("                    <li><a href=\"#tab-out\" data-toggle=\"tab\"><i class=\"fa fa-arrow-up\"></i> Lịch sử xuất kho</a></li>\r\n");
      out.write("                    <li><a href=\"#tab-balance\" data-toggle=\"tab\"><i class=\"fa fa-cubes\"></i> Lịch sử tồn kho</a></li>\r\n");
      out.write("                     </ul>\r\n");
      out.write("                   </header>\r\n");
      out.write("                  <div class=\"panel-body tab-content\">\r\n");
      out.write("                  <!-- TAB 1: LỊCH SỬ NHẬP KHO -->\r\n");
      out.write("                  <div class=\"tab-pane active\" id=\"tab-in\">\r\n");
      out.write("                    <div class=\"row filter-bar\" style=\"margin-bottom:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-4\"><input id=\"inSearchKeyword\" class=\"form-control\"\r\n");
      out.write("                          placeholder=\"Tìm theo tên/mã sản phẩm\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"inDateFrom\" class=\"form-control\" placeholder=\"Từ ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"inDateTo\" class=\"form-control\" placeholder=\"Đến ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Lọc</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-primary btn-sm\" style=\"width: 100%;\" onclick=\"reloadInHistory(true)\" title=\"Áp dụng bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-search\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Reset</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-warning btn-sm\" style=\"width: 100%;\" onclick=\"resetInFilters()\" title=\"Xóa tất cả bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-refresh\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"table-responsive\">\r\n");
      out.write("                      <table class=\"table table-bordered table-striped\">\r\n");
      out.write("                        <thead>\r\n");
      out.write("                          <tr>\r\n");
      out.write("                            <th>Thời gian</th>\r\n");
      out.write("                            <th>Sản phẩm</th>\r\n");
      out.write("                            <th>Số lượng nhập</th>\r\n");
      out.write("                            <th>Đơn giá nhập</th>\r\n");
      out.write("                            <th>Tổng tiền</th>\r\n");
      out.write("                            <th>Kho</th>\r\n");
      out.write("                            <th>Nhà cung cấp</th>\r\n");
      out.write("                            <th>Người thực hiện</th>\r\n");
      out.write("                            <th>Ghi chú</th>\r\n");
      out.write("                          </tr>\r\n");
      out.write("                        </thead>\r\n");
      out.write("                        <tbody id=\"inHistoryBody\">\r\n");
      out.write("                          <tr><td colspan=\"9\" class=\"text-center\"><i class=\"fa fa-spinner fa-spin\"></i> Đang tải...</td></tr>\r\n");
      out.write("                        </tbody>\r\n");
      out.write("                      </table>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"row\" style=\"margin-top:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-6\"><span id=\"inHistoryInfo\" class=\"muted\"></span></div>\r\n");
      out.write("                      <div class=\"col-sm-6\" style=\"text-align:right;\">\r\n");
      out.write("                        <ul class=\"pagination\" id=\"inHistoryPagination\" style=\"margin:0;\"></ul>\r\n");
      out.write("                      </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                  </div>\r\n");
      out.write("\r\n");
      out.write("                  <!-- TAB 2: LỊCH SỬ XUẤT KHO -->\r\n");
      out.write("                  <div class=\"tab-pane\" id=\"tab-out\">\r\n");
      out.write("                    <div class=\"row filter-bar\" style=\"margin-bottom:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-4\"><input id=\"outSearchKeyword\" class=\"form-control\"\r\n");
      out.write("                          placeholder=\"Tìm theo tên/mã sản phẩm\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"outDateFrom\" class=\"form-control\" placeholder=\"Từ ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"outDateTo\" class=\"form-control\" placeholder=\"Đến ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Lọc</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-primary btn-sm\" style=\"width: 100%;\" onclick=\"reloadOutHistory(true)\" title=\"Áp dụng bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-search\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Reset</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-warning btn-sm\" style=\"width: 100%;\" onclick=\"resetOutFilters()\" title=\"Xóa tất cả bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-refresh\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"table-responsive\">\r\n");
      out.write("                      <table class=\"table table-bordered table-striped\">\r\n");
      out.write("                        <thead>\r\n");
      out.write("                          <tr>\r\n");
      out.write("                            <th>Thời gian</th>\r\n");
      out.write("                            <th>Sản phẩm</th>\r\n");
      out.write("                            <th>Số lượng xuất</th>\r\n");
      out.write("                            <th>Giá bán</th>\r\n");
      out.write("                            <th>Kho</th>\r\n");
      out.write("                            <th>Lý do xuất</th>\r\n");
      out.write("                            <th>Người thực hiện</th>\r\n");
      out.write("                            <th>Ghi chú</th>\r\n");
      out.write("                          </tr>\r\n");
      out.write("                        </thead>\r\n");
      out.write("                        <tbody id=\"outHistoryBody\">\r\n");
      out.write("                          <tr><td colspan=\"8\" class=\"text-center\"><i class=\"fa fa-spinner fa-spin\"></i> Đang tải...</td></tr>\r\n");
      out.write("                        </tbody>\r\n");
      out.write("                      </table>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"row\" style=\"margin-top:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-6\"><span id=\"outHistoryInfo\" class=\"muted\"></span></div>\r\n");
      out.write("                      <div class=\"col-sm-6\" style=\"text-align:right;\">\r\n");
      out.write("                        <ul class=\"pagination\" id=\"outHistoryPagination\" style=\"margin:0;\"></ul>\r\n");
      out.write("                      </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("\r\n");
      out.write("                  <!-- TAB 3: LỊCH SỬ TỒN KHO -->\r\n");
      out.write("                  <div class=\"tab-pane\" id=\"tab-balance\">\r\n");
      out.write("                      <div class=\"row filter-bar\" style=\"margin-bottom:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-4\"><input id=\"balanceSearchKeyword\" class=\"form-control\"\r\n");
      out.write("                          placeholder=\"Tìm theo tên/mã sản phẩm\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"balanceDateFrom\" class=\"form-control\" placeholder=\"Từ ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-3\"><input type=\"date\" id=\"balanceDateTo\" class=\"form-control\" placeholder=\"Đến ngày\" /></div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Lọc</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-primary btn-sm\" style=\"width: 100%;\" onclick=\"reloadBalanceHistory(true)\" title=\"Áp dụng bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-search\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      <div class=\"col-sm-1\">\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                          <label style=\"color: transparent; margin-bottom: 5px;\">Reset</label>\r\n");
      out.write("                          <button type=\"button\" class=\"btn btn-warning btn-sm\" style=\"width: 100%;\" onclick=\"resetBalanceFilters()\" title=\"Xóa tất cả bộ lọc\">\r\n");
      out.write("                            <i class=\"fa fa-refresh\"></i>\r\n");
      out.write("                          </button>\r\n");
      out.write("                        </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      <div class=\"table-responsive\">\r\n");
      out.write("                        <table class=\"table table-bordered table-striped\">\r\n");
      out.write("                          <thead>\r\n");
      out.write("                            <tr>\r\n");
      out.write("                              <th>Thời gian</th>\r\n");
      out.write("                              <th>Sản phẩm</th>\r\n");
      out.write("                              <th>Tồn kho</th>\r\n");
      out.write("                              <th>Tồn thực tế (hiện tại)</th>\r\n");
      out.write("                              <th>Đã giữ chỗ (hiện tại)</th>\r\n");
      out.write("                              <th>Khả dụng (hiện tại)</th>\r\n");
      out.write("                              <th>Kho</th>\r\n");
      out.write("                            </tr>\r\n");
      out.write("                          </thead>\r\n");
      out.write("                        <tbody id=\"balanceHistoryBody\">\r\n");
      out.write("                          <tr><td colspan=\"6\" class=\"text-center\"><i class=\"fa fa-spinner fa-spin\"></i> Đang tải...</td></tr>\r\n");
      out.write("                          </tbody>\r\n");
      out.write("                        </table>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      <div class=\"row\" style=\"margin-top:10px;\">\r\n");
      out.write("                      <div class=\"col-sm-6\"><span id=\"balanceHistoryInfo\" class=\"muted\"></span></div>\r\n");
      out.write("                        <div class=\"col-sm-6\" style=\"text-align:right;\">\r\n");
      out.write("                        <ul class=\"pagination\" id=\"balanceHistoryPagination\" style=\"margin:0;\"></ul>\r\n");
      out.write("                      </div>\r\n");
      out.write("                      </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                  </div>\r\n");
      out.write("                </div>\r\n");
      out.write("              </div>\r\n");
      out.write("            </div>\r\n");
      out.write("          </section>\r\n");
      out.write("        </aside>\r\n");
      out.write("      </div>\r\n");
      out.write("\r\n");
      out.write("      <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/jquery.min.js\"></script>\r\n");
      out.write("      <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/bootstrap.min.js\"></script>\r\n");
      out.write("      <script>\r\n");
      out.write("      // ================== TAB NHẬP KHO ==================\r\n");
      out.write("      var inPage = 1;\r\n");
      out.write("      var inPageSize = 10;\r\n");
      out.write("\r\n");
      out.write("      function reloadInHistory(resetPage) {\r\n");
      out.write("        if (resetPage) inPage = 1;\r\n");
      out.write("        var params = { action: 'getHistory', type: 'in', page: inPage, pageSize: inPageSize };\r\n");
      out.write("        var urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("        var productIdParam = urlParams.get('productId');\r\n");
      out.write("        var keyword = ($('#inSearchKeyword').val() || '').trim();\r\n");
      out.write("        var dateFrom = $('#inDateFrom').val();\r\n");
      out.write("        var dateTo = $('#inDateTo').val();\r\n");
      out.write("        if (productIdParam) params.productId = productIdParam;\r\n");
      out.write("        if (keyword) params.q = keyword;\r\n");
      out.write("        if (dateFrom) params.dateFrom = dateFrom;\r\n");
      out.write("        if (dateTo) params.dateTo = dateTo;\r\n");
      out.write("        $.getJSON('");
      out.print(request.getContextPath());
      out.write("/inventory', params, function (res) {\r\n");
      out.write("          if (!res.success) {\r\n");
      out.write("            $('#inHistoryBody').html('<tr><td colspan=\"9\" class=\"text-center alert alert-danger\">' + (res.message || 'Lỗi tải lịch sử') + '</td></tr>');\r\n");
      out.write("            return;\r\n");
      out.write("          }\r\n");
      out.write("          renderInHistory(res);\r\n");
      out.write("          }).fail(function (xhr) {\r\n");
      out.write("          $('#inHistoryBody').html('<tr><td colspan=\"9\" class=\"text-center alert alert-danger\">' + (xhr.responseText || 'Lỗi kết nối') + '</td></tr>');\r\n");
      out.write("        });\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function renderInHistory(res) {\r\n");
      out.write("        if (res.currentPage) inPage = res.currentPage;\r\n");
      out.write("        var body = $('#inHistoryBody');\r\n");
      out.write("        body.empty();\r\n");
      out.write("        if (!res.data || res.data.length === 0) {\r\n");
      out.write("          body.html('<tr><td colspan=\"9\" class=\"text-center muted\">Không có dữ liệu</td></tr>');\r\n");
      out.write("          updateInPagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("          $('#inHistoryInfo').text('0 bản ghi');\r\n");
      out.write("          return;\r\n");
      out.write("        }\r\n");
      out.write("        var totalQuantity = 0;\r\n");
      out.write("        var totalAmount = 0;\r\n");
      out.write("        res.data.forEach(function(h) {\r\n");
      out.write("          var when = new Date(h.createdAt).toLocaleString('vi-VN');\r\n");
      out.write("          var unitCost = h.unitCost != null ? formatCurrencyVN(h.unitCost) + ' đ' : '';\r\n");
      out.write("          var qty = h.quantity || 0;\r\n");
      out.write("          var amount = (h.unitCost != null && h.quantity != null) ? h.unitCost * h.quantity : 0;\r\n");
      out.write("          var total = amount > 0 ? formatCurrencyVN(amount) + ' đ' : '';\r\n");
      out.write("          var supplier = extractSupplierFromNotes(h.notes);\r\n");
      out.write("          totalQuantity += qty;\r\n");
      out.write("          totalAmount += amount;\r\n");
      out.write("          var row = '<tr>' +\r\n");
      out.write("            '<td>' + when + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.productName || '') + ' <span class=\"muted\">(' + escapeHtml(h.productCode || '') + ')</span></td>' +\r\n");
      out.write("            '<td class=\"qty-pos\">+' + qty + '</td>' +\r\n");
      out.write("            '<td>' + unitCost + '</td>' +\r\n");
      out.write("            '<td><strong>' + total + '</strong></td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.warehouseLocation || '') + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(supplier) + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.createdByName || '') + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.notes || '') + '</td>' +\r\n");
      out.write("            '</tr>';\r\n");
      out.write("          body.append(row);\r\n");
      out.write("        });\r\n");
      out.write("        var start = (res.currentPage - 1) * res.pageSize + (res.data.length > 0 ? 1 : 0);\r\n");
      out.write("        var end = (res.currentPage - 1) * res.pageSize + res.data.length;\r\n");
      out.write("        $('#inHistoryInfo').text('Hiển thị ' + (res.totalCount > 0 ? start : 0) + ' đến ' + end + ' trong tổng số ' + res.totalCount + ' bản ghi');\r\n");
      out.write("        updateInPagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function updateInPagination(totalCount, totalPages) {\r\n");
      out.write("        var ul = $('#inHistoryPagination');\r\n");
      out.write("        ul.empty();\r\n");
      out.write("        var prev = $('<li class=\"paginate_button ' + (inPage <= 1 ? 'disabled' : '') + '\"><a href=\"#\">Trước</a></li>');\r\n");
      out.write("        prev.on('click', function (e) { e.preventDefault(); if (inPage > 1) { inPage--; reloadInHistory(false); } });\r\n");
      out.write("        ul.append(prev);\r\n");
      out.write("        var maxVisible = 5;\r\n");
      out.write("        var start = Math.max(1, inPage - Math.floor(maxVisible / 2));\r\n");
      out.write("        var end = Math.min(totalPages, start + maxVisible - 1);\r\n");
      out.write("        if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);\r\n");
      out.write("        for (var p = start; p <= end; p++) {\r\n");
      out.write("          (function (page) {\r\n");
      out.write("            var li = $('<li class=\"paginate_button ' + (page === inPage ? 'active' : '') + '\"><a href=\"#\">' + page + '</a></li>');\r\n");
      out.write("            li.on('click', function (e) { e.preventDefault(); inPage = page; reloadInHistory(false); });\r\n");
      out.write("            ul.append(li);\r\n");
      out.write("          })(p);\r\n");
      out.write("        }\r\n");
      out.write("        var next = $('<li class=\"paginate_button ' + (inPage >= totalPages ? 'disabled' : '') + '\"><a href=\"#\">Tiếp</a></li>');\r\n");
      out.write("        next.on('click', function (e) { e.preventDefault(); if (inPage < totalPages) { inPage++; reloadInHistory(false); } });\r\n");
      out.write("        ul.append(next);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function resetInFilters() {\r\n");
      out.write("        $('#inSearchKeyword').val('');\r\n");
      out.write("        $('#inDateFrom').val('');\r\n");
      out.write("        $('#inDateTo').val('');\r\n");
      out.write("        inPage = 1;\r\n");
      out.write("        reloadInHistory(false);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      // ================== TAB XUẤT KHO ==================\r\n");
      out.write("      var outPage = 1;\r\n");
      out.write("      var outPageSize = 8;\r\n");
      out.write("\r\n");
      out.write("      function reloadOutHistory(resetPage) {\r\n");
      out.write("        if (resetPage) outPage = 1;\r\n");
      out.write("        var params = { action: 'getHistory', type: 'out', page: outPage, pageSize: outPageSize };\r\n");
      out.write("        var urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("        var productIdParam = urlParams.get('productId');\r\n");
      out.write("        var keyword = ($('#outSearchKeyword').val() || '').trim();\r\n");
      out.write("        var dateFrom = $('#outDateFrom').val();\r\n");
      out.write("        var dateTo = $('#outDateTo').val();\r\n");
      out.write("        if (productIdParam) params.productId = productIdParam;\r\n");
      out.write("        if (keyword) params.q = keyword;\r\n");
      out.write("        if (dateFrom) params.dateFrom = dateFrom;\r\n");
      out.write("        if (dateTo) params.dateTo = dateTo;\r\n");
      out.write("        $.getJSON('");
      out.print(request.getContextPath());
      out.write("/inventory', params, function (res) {\r\n");
      out.write("          if (!res.success) {\r\n");
      out.write("            $('#outHistoryBody').html('<tr><td colspan=\"8\" class=\"text-center alert alert-danger\">' + (res.message || 'Lỗi tải lịch sử') + '</td></tr>');\r\n");
      out.write("            return;\r\n");
      out.write("          }\r\n");
      out.write("          renderOutHistory(res);\r\n");
      out.write("        }).fail(function (xhr) {\r\n");
      out.write("          $('#outHistoryBody').html('<tr><td colspan=\"8\" class=\"text-center alert alert-danger\">' + (xhr.responseText || 'Lỗi kết nối') + '</td></tr>');\r\n");
      out.write("        });\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function renderOutHistory(res) {\r\n");
      out.write("        if (res.currentPage) outPage = res.currentPage;\r\n");
      out.write("        var body = $('#outHistoryBody');\r\n");
      out.write("        body.empty();\r\n");
      out.write("        if (!res.data || res.data.length === 0) {\r\n");
      out.write("          body.html('<tr><td colspan=\"8\" class=\"text-center muted\">Không có dữ liệu</td></tr>');\r\n");
      out.write("          updateOutPagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("          $('#outHistoryInfo').text('0 bản ghi');\r\n");
      out.write("          return;\r\n");
      out.write("        }\r\n");
      out.write("        var totalQuantity = 0;\r\n");
      out.write("        res.data.forEach(function(h) {\r\n");
      out.write("          var when = new Date(h.createdAt).toLocaleString('vi-VN');\r\n");
      out.write("          var unitPrice = h.unitPrice != null ? formatCurrencyVN(h.unitPrice) + ' đ' : '';\r\n");
      out.write("          var reason = extractReasonFromNotes(h.notes);\r\n");
      out.write("          var qty = h.quantity || 0;\r\n");
      out.write("          totalQuantity += qty;\r\n");
      out.write("          var row = '<tr>' +\r\n");
      out.write("            '<td>' + when + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.productName || '') + ' <span class=\"muted\">(' + escapeHtml(h.productCode || '') + ')</span></td>' +\r\n");
      out.write("            '<td class=\"qty-neg\">-' + qty + '</td>' +\r\n");
      out.write("            '<td>' + unitPrice + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.warehouseLocation || '') + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(reason) + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.createdByName || '') + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.notes || '') + '</td>' +\r\n");
      out.write("          '</tr>';\r\n");
      out.write("          body.append(row);\r\n");
      out.write("        });\r\n");
      out.write("        // Thêm hàng tổng\r\n");
      out.write("        var totalRow = '<tr style=\"background-color: #f5f5f5; font-weight: bold;\">' +\r\n");
      out.write("          '<td colspan=\"2\" style=\"text-align: right;\"><strong>TỔNG:</strong></td>' +\r\n");
      out.write("          '<td class=\"qty-neg\"><strong>-' + totalQuantity + '</strong></td>' +\r\n");
      out.write("          '<td colspan=\"5\"></td>' +\r\n");
      out.write("          '</tr>';\r\n");
      out.write("        body.append(totalRow);\r\n");
      out.write("        var start = (res.currentPage - 1) * res.pageSize + (res.data.length > 0 ? 1 : 0);\r\n");
      out.write("        var end = (res.currentPage - 1) * res.pageSize + res.data.length;\r\n");
      out.write("        $('#outHistoryInfo').text('Hiển thị ' + (res.totalCount > 0 ? start : 0) + ' đến ' + end + ' trong tổng số ' + res.totalCount + ' bản ghi');\r\n");
      out.write("        updateOutPagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function updateOutPagination(totalCount, totalPages) {\r\n");
      out.write("        var ul = $('#outHistoryPagination');\r\n");
      out.write("        ul.empty();\r\n");
      out.write("        var prev = $('<li class=\"paginate_button ' + (outPage <= 1 ? 'disabled' : '') + '\"><a href=\"#\">Trước</a></li>');\r\n");
      out.write("        prev.on('click', function (e) { e.preventDefault(); if (outPage > 1) { outPage--; reloadOutHistory(false); } });\r\n");
      out.write("          ul.append(prev);\r\n");
      out.write("          var maxVisible = 5;\r\n");
      out.write("        var start = Math.max(1, outPage - Math.floor(maxVisible / 2));\r\n");
      out.write("          var end = Math.min(totalPages, start + maxVisible - 1);\r\n");
      out.write("          if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);\r\n");
      out.write("          for (var p = start; p <= end; p++) {\r\n");
      out.write("          (function (page) {\r\n");
      out.write("            var li = $('<li class=\"paginate_button ' + (page === outPage ? 'active' : '') + '\"><a href=\"#\">' + page + '</a></li>');\r\n");
      out.write("            li.on('click', function (e) { e.preventDefault(); outPage = page; reloadOutHistory(false); });\r\n");
      out.write("              ul.append(li);\r\n");
      out.write("            })(p);\r\n");
      out.write("          }\r\n");
      out.write("        var next = $('<li class=\"paginate_button ' + (outPage >= totalPages ? 'disabled' : '') + '\"><a href=\"#\">Tiếp</a></li>');\r\n");
      out.write("        next.on('click', function (e) { e.preventDefault(); if (outPage < totalPages) { outPage++; reloadOutHistory(false); } });\r\n");
      out.write("          ul.append(next);\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("      function resetOutFilters() {\r\n");
      out.write("        $('#outSearchKeyword').val('');\r\n");
      out.write("        $('#outDateFrom').val('');\r\n");
      out.write("        $('#outDateTo').val('');\r\n");
      out.write("        outPage = 1;\r\n");
      out.write("        reloadOutHistory(false);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      // ================== TAB TỒN KHO ==================\r\n");
      out.write("      var balancePage = 1;\r\n");
      out.write("      var balancePageSize = 10;\r\n");
      out.write("\r\n");
      out.write("      function reloadBalanceHistory(resetPage) {\r\n");
      out.write("        if (resetPage) balancePage = 1;\r\n");
      out.write("        var params = { action: 'getStockBalance', page: balancePage, pageSize: balancePageSize };\r\n");
      out.write("        var urlParams = new URLSearchParams(window.location.search);\r\n");
      out.write("        var productIdParam = urlParams.get('productId');\r\n");
      out.write("        var keyword = ($('#balanceSearchKeyword').val() || '').trim();\r\n");
      out.write("        var dateFrom = $('#balanceDateFrom').val();\r\n");
      out.write("        var dateTo = $('#balanceDateTo').val();\r\n");
      out.write("        if (productIdParam) params.productId = productIdParam;\r\n");
      out.write("        if (keyword) params.q = keyword;\r\n");
      out.write("        if (dateFrom) params.dateFrom = dateFrom;\r\n");
      out.write("        if (dateTo) params.dateTo = dateTo;\r\n");
      out.write("        $.getJSON('");
      out.print(request.getContextPath());
      out.write("/inventory', params, function (res) {\r\n");
      out.write("          if (!res.success) {\r\n");
      out.write("            $('#balanceHistoryBody').html('<tr><td colspan=\"7\" class=\"text-center alert alert-danger\">' + (res.message || 'Lỗi tải lịch sử') + '</td></tr>');\r\n");
      out.write("            return;\r\n");
      out.write("          }\r\n");
      out.write("          renderBalanceHistory(res);\r\n");
      out.write("        }).fail(function (xhr) {\r\n");
      out.write("          $('#balanceHistoryBody').html('<tr><td colspan=\"7\" class=\"text-center alert alert-danger\">' + (xhr.responseText || 'Lỗi kết nối') + '</td></tr>');\r\n");
      out.write("        });\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function renderBalanceHistory(res) {\r\n");
      out.write("        if (res.currentPage) balancePage = res.currentPage;\r\n");
      out.write("        var body = $('#balanceHistoryBody');\r\n");
      out.write("        body.empty();\r\n");
      out.write("        if (!res.data || res.data.length === 0) {\r\n");
      out.write("          body.html('<tr><td colspan=\"7\" class=\"text-center muted\">Không có dữ liệu</td></tr>');\r\n");
      out.write("          updateBalancePagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("          $('#balanceHistoryInfo').text('0 bản ghi');\r\n");
      out.write("          return;\r\n");
      out.write("        }\r\n");
      out.write("        var totalStockBefore = 0;\r\n");
      out.write("        var totalCurrentStock = 0;\r\n");
      out.write("        var totalReservedStock = 0;\r\n");
      out.write("        var totalAvailableStock = 0;\r\n");
      out.write("        res.data.forEach(function(h) {\r\n");
      out.write("          var when = new Date(h.createdAt).toLocaleString('vi-VN');\r\n");
      out.write("          var stockOriginal = h.stockBefore != null ? h.stockBefore : 0;\r\n");
      out.write("          var stockBefore = Math.max(stockOriginal, 0);\r\n");
      out.write("          var currentStockNow = h.currentStock != null ? h.currentStock : 0;\r\n");
      out.write("          var reservedStockNow = h.reservedStock != null ? h.reservedStock : 0;\r\n");
      out.write("          var availableStockNow = h.availableStock != null ? h.availableStock : Math.max(currentStockNow - reservedStockNow, 0);\r\n");
      out.write("          totalStockBefore += stockBefore;\r\n");
      out.write("          totalCurrentStock += currentStockNow;\r\n");
      out.write("          totalReservedStock += reservedStockNow;\r\n");
      out.write("          totalAvailableStock += availableStockNow;\r\n");
      out.write("          var row = '<tr>' +\r\n");
      out.write("            '<td>' + when + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.productName || '') + ' <span class=\"muted\">(' + escapeHtml(h.productCode || '') + ')</span></td>' +\r\n");
      out.write("            '<td>' + stockBefore + '</td>' +\r\n");
      out.write("            '<td>' + currentStockNow + '</td>' +\r\n");
      out.write("            '<td>' + reservedStockNow + '</td>' +\r\n");
      out.write("            '<td>' + availableStockNow + '</td>' +\r\n");
      out.write("            '<td>' + escapeHtml(h.warehouseLocation || '') + '</td>' +\r\n");
      out.write("            '</tr>';\r\n");
      out.write("          body.append(row);\r\n");
      out.write("        });\r\n");
      out.write("        var start = (res.currentPage - 1) * res.pageSize + (res.data.length > 0 ? 1 : 0);\r\n");
      out.write("        var end = (res.currentPage - 1) * res.pageSize + res.data.length;\r\n");
      out.write("        $('#balanceHistoryInfo').text('Hiển thị ' + (res.totalCount > 0 ? start : 0) + ' đến ' + end + ' trong tổng số ' + res.totalCount + ' bản ghi');\r\n");
      out.write("        updateBalancePagination(res.totalCount || 0, res.totalPages || 1);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function updateBalancePagination(totalCount, totalPages) {\r\n");
      out.write("        var ul = $('#balanceHistoryPagination');\r\n");
      out.write("        ul.empty();\r\n");
      out.write("        var prev = $('<li class=\"paginate_button ' + (balancePage <= 1 ? 'disabled' : '') + '\"><a href=\"#\">Trước</a></li>');\r\n");
      out.write("        prev.on('click', function (e) { e.preventDefault(); if (balancePage > 1) { balancePage--; reloadBalanceHistory(false); } });\r\n");
      out.write("           ul.append(prev);\r\n");
      out.write("           var maxVisible = 5;\r\n");
      out.write("        var start = Math.max(1, balancePage - Math.floor(maxVisible / 2));\r\n");
      out.write("           var end = Math.min(totalPages, start + maxVisible - 1);\r\n");
      out.write("           if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);\r\n");
      out.write("           for (var p = start; p <= end; p++) {\r\n");
      out.write("             (function (page) {\r\n");
      out.write("            var li = $('<li class=\"paginate_button ' + (page === balancePage ? 'active' : '') + '\"><a href=\"#\">' + page + '</a></li>');\r\n");
      out.write("            li.on('click', function (e) { e.preventDefault(); balancePage = page; reloadBalanceHistory(false); });\r\n");
      out.write("               ul.append(li);\r\n");
      out.write("             })(p);\r\n");
      out.write("           }\r\n");
      out.write("        var next = $('<li class=\"paginate_button ' + (balancePage >= totalPages ? 'disabled' : '') + '\"><a href=\"#\">Tiếp</a></li>');\r\n");
      out.write("        next.on('click', function (e) { e.preventDefault(); if (balancePage < totalPages) { balancePage++; reloadBalanceHistory(false); } });\r\n");
      out.write("           ul.append(next);\r\n");
      out.write("         }\r\n");
      out.write("\r\n");
      out.write("      function resetBalanceFilters() {\r\n");
      out.write("        $('#balanceSearchKeyword').val('');\r\n");
      out.write("        $('#balanceDateFrom').val('');\r\n");
      out.write("        $('#balanceDateTo').val('');\r\n");
      out.write("        balancePage = 1;\r\n");
      out.write("        reloadBalanceHistory(false);\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      // ================== HELPER FUNCTIONS ==================\r\n");
      out.write("      function formatCurrencyVN(n) {\r\n");
      out.write("        try {\r\n");
      out.write("          return Number(n).toLocaleString('vi-VN');\r\n");
      out.write("        } catch (e) {\r\n");
      out.write("          return n;\r\n");
      out.write("        }\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function escapeHtml(s) {\r\n");
      out.write("        if (!s) return '';\r\n");
      out.write("        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#39;');\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function extractSupplierFromNotes(notes) {\r\n");
      out.write("        if (!notes) return '';\r\n");
      out.write("        // Thử nhiều pattern để tìm nhà cung cấp\r\n");
      out.write("        var patterns = [\r\n");
      out.write("          /Nhà cung cấp:\\s*([^\\n|]+)/i,\r\n");
      out.write("          /Nhà cung cấp[:\\s]+([^\\n|]+)/i,\r\n");
      out.write("          /NCC[:\\s]+([^\\n|]+)/i,\r\n");
      out.write("          /Supplier[:\\s]+([^\\n|]+)/i,\r\n");
      out.write("          /Nhà cung cấp\\s+([^\\n|]+)/i\r\n");
      out.write("        ];\r\n");
      out.write("        for (var i = 0; i < patterns.length; i++) {\r\n");
      out.write("          var match = notes.match(patterns[i]);\r\n");
      out.write("          if (match && match[1]) {\r\n");
      out.write("            var supplier = match[1].trim();\r\n");
      out.write("            // Loại bỏ các ký tự không cần thiết ở cuối\r\n");
      out.write("            supplier = supplier.replace(/[|\\n\\r].*$/, '').trim();\r\n");
      out.write("            if (supplier.length > 0) {\r\n");
      out.write("              return supplier;\r\n");
      out.write("            }\r\n");
      out.write("          }\r\n");
      out.write("        }\r\n");
      out.write("        return '';\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      function extractReasonFromNotes(notes) {\r\n");
      out.write("        if (!notes) return '';\r\n");
      out.write("        var match = notes.match(/Lý do:\\s*([^\\n]+)/);\r\n");
      out.write("        return match ? match[1].trim() : '';\r\n");
      out.write("      }\r\n");
      out.write("\r\n");
      out.write("      // ================== INITIALIZE ==================\r\n");
      out.write("      $(function () {\r\n");
      out.write("        reloadInHistory(false);\r\n");
      out.write("        reloadOutHistory(false);\r\n");
      out.write("        reloadBalanceHistory(false);\r\n");
      out.write("      });\r\n");
      out.write("      </script>\r\n");
      out.write("    </body>\r\n");
      out.write("\r\n");
      out.write("    </html>\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}

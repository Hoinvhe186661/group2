/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-11-12 13:43:36 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.util.*;

public final class inventory_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

    String username = (String) session.getAttribute("username");
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    
    if (username == null || isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect(request.getContextPath() + "/login.jsp");
        return;
    }
    
    // Kiểm tra quyền truy cập - giống như role_permissions.jsp
    @SuppressWarnings("unchecked")
    Set<String> userPermissions = (Set<String>) session.getAttribute("userPermissions");
    if (userPermissions == null) {
        userPermissions = new HashSet<String>();
    }
    
    boolean canManage = userPermissions.contains("manage_inventory");
    boolean canView = userPermissions.contains("view_inventory");
    if (!canManage && !canView) {
        response.sendRedirect(request.getContextPath() + "/403.jsp");
        return;
    }

      out.write("\r\n");
      out.write("<!DOCTYPE html>\r\n");
      out.write("<html>\r\n");
      out.write("<head>\r\n");
      out.write("    <meta charset=\"UTF-8\">\r\n");
      out.write("    <title>Quản lý kho | Bảng điều khiển quản trị</title>\r\n");
      out.write("    <meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no' name='viewport'>\r\n");
      out.write("    <meta name=\"description\" content=\"Warehouse Management System\">\r\n");
      out.write("    <meta name=\"keywords\" content=\"Inventory, Stock, Warehouse\">\r\n");
      out.write("    \r\n");
      out.write("    <!-- bootstrap 3.0.2 -->\r\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/bootstrap.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- font Awesome -->\r\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/font-awesome.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Ionicons -->\r\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/ionicons.min.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <!-- Theme style -->\r\n");
      out.write("    <link href=\"");
      out.print(request.getContextPath());
      out.write("/css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n");
      out.write("    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>\r\n");
      out.write("    \r\n");
      out.write("    <style>\r\n");
      out.write("        /* CSS cho phần lọc - giống với trang products */\r\n");
      out.write("        .filter-panel {\r\n");
      out.write("            background-color: #f9f9f9;\r\n");
      out.write("            border-radius: 5px;\r\n");
      out.write("            padding: 15px;\r\n");
      out.write("            margin-bottom: 15px;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .form-control {\r\n");
      out.write("            border-radius: 4px;\r\n");
      out.write("            border: 1px solid #ccc;\r\n");
      out.write("            transition: border-color 0.3s ease;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .btn {\r\n");
      out.write("            border-radius: 4px;\r\n");
      out.write("            transition: all 0.3s ease;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .btn:hover {\r\n");
      out.write("            transform: translateY(-1px);\r\n");
      out.write("            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .form-control:focus {\r\n");
      out.write("            border-color: #3c8dbc;\r\n");
      out.write("            box-shadow: 0 0 5px rgba(60, 141, 188, 0.3);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel label {\r\n");
      out.write("            font-weight: bold;\r\n");
      out.write("            color: #333;\r\n");
      out.write("            margin-bottom: 5px;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .btn-warning {\r\n");
      out.write("            background-color: #f0ad4e;\r\n");
      out.write("            border-color: #eea236;\r\n");
      out.write("            color: #fff;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .filter-panel .btn-warning:hover {\r\n");
      out.write("            background-color: #ec971f;\r\n");
      out.write("            border-color: #d58512;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Dashboard cards */\r\n");
      out.write("        .stat-card {\r\n");
      out.write("            background: #fff;\r\n");
      out.write("            border-radius: 5px;\r\n");
      out.write("            padding: 20px;\r\n");
      out.write("            margin-bottom: 20px;\r\n");
      out.write("            box-shadow: 0 1px 3px rgba(0,0,0,0.12);\r\n");
      out.write("            border-left: 4px solid #3c8dbc;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stat-card.warning {\r\n");
      out.write("            border-left-color: #f39c12;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stat-card.danger {\r\n");
      out.write("            border-left-color: #dd4b39;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stat-card.success {\r\n");
      out.write("            border-left-color: #00a65a;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stat-card h3 {\r\n");
      out.write("            margin: 0 0 10px 0;\r\n");
      out.write("            font-size: 32px;\r\n");
      out.write("            font-weight: bold;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stat-card p {\r\n");
      out.write("            margin: 0;\r\n");
      out.write("            color: #666;\r\n");
      out.write("            font-size: 14px;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Stock status badges */\r\n");
      out.write("        .stock-normal {\r\n");
      out.write("            color: #00a65a;\r\n");
      out.write("            font-weight: bold;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stock-low {\r\n");
      out.write("            color: #f39c12;\r\n");
      out.write("            font-weight: bold;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        .stock-out {\r\n");
      out.write("            color: #dd4b39;\r\n");
      out.write("            font-weight: bold;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Responsive cho filter panel */\r\n");
      out.write("        @media (max-width: 768px) {\r\n");
      out.write("            .filter-panel .col-md-3,\r\n");
      out.write("            .filter-panel .col-md-2 {\r\n");
      out.write("                margin-bottom: 10px;\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        @media (max-width: 992px) {\r\n");
      out.write("            .filter-panel .col-md-3 {\r\n");
      out.write("                margin-bottom: 10px;\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Style cho modal form */\r\n");
      out.write("        #stockInModal .table td,\r\n");
      out.write("        #stockOutModal .table td {\r\n");
      out.write("            vertical-align: middle;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        #stockInModal .table .btn,\r\n");
      out.write("        #stockOutModal .table .btn {\r\n");
      out.write("            white-space: nowrap;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /* Đảm bảo input trong table không bị quá lớn */\r\n");
      out.write("        #stockInModal .table .form-control,\r\n");
      out.write("        #stockOutModal .table .form-control {\r\n");
      out.write("            font-size: 13px;\r\n");
      out.write("        }\r\n");
      out.write("    </style>\r\n");
      out.write("    \r\n");
      out.write("    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->\r\n");
      out.write("    <!--[if lt IE 9]>\r\n");
      out.write("      <script src=\"https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js\"></script>\r\n");
      out.write("      <script src=\"https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js\"></script>\r\n");
      out.write("    <![endif]-->\r\n");
      out.write("</head>\r\n");
      out.write("<body class=\"skin-black\">\r\n");
      out.write("    <!-- header logo: style can be found in header.less -->\r\n");
      out.write("    <header class=\"header\">\r\n");
      out.write("        <a href=\"");
      out.print(request.getContextPath());
      out.write("/admin.jsp\" class=\"logo\">\r\n");
      out.write("            Bảng điều khiển \r\n");
      out.write("        </a>\r\n");
      out.write("        <!-- Header Navbar: style can be found in header.less -->\r\n");
      out.write("        <nav class=\"navbar navbar-static-top\" role=\"navigation\">\r\n");
      out.write("            <!-- Sidebar toggle button-->\r\n");
      out.write("            <a href=\"#\" class=\"navbar-btn sidebar-toggle\" data-toggle=\"offcanvas\" role=\"button\">\r\n");
      out.write("                <span class=\"sr-only\">Toggle navigation</span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("                <span class=\"icon-bar\"></span>\r\n");
      out.write("            </a>\r\n");
      out.write("            <div class=\"navbar-right\">\r\n");
      out.write("                <ul class=\"nav navbar-nav\">\r\n");
      out.write("                    <!-- User Account: style can be found in dropdown.less -->\r\n");
      out.write("                    <li class=\"dropdown user user-menu\">\r\n");
      out.write("                        <a href=\"#\" class=\"dropdown-toggle\" data-toggle=\"dropdown\">\r\n");
      out.write("                            <i class=\"fa fa-user\"></i>\r\n");
      out.write("                            <span>");
      out.print( username );
      out.write(" <i class=\"caret\"></i></span>\r\n");
      out.write("                        </a>\r\n");
      out.write("                        <ul class=\"dropdown-menu dropdown-custom dropdown-menu-right\">\r\n");
      out.write("                            <li class=\"dropdown-header text-center\">Tài khoản</li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"profile.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-user fa-fw pull-right\"></i>\r\n");
      out.write("                                    Hồ sơ\r\n");
      out.write("                                </a>\r\n");
      out.write("                                <a href=\"settings.jsp\">\r\n");
      out.write("                                <i class=\"fa fa-cog fa-fw pull-right\"></i>\r\n");
      out.write("                                    Cài đặt\r\n");
      out.write("                                </a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                            <li class=\"divider\"></li>\r\n");
      out.write("                            <li>\r\n");
      out.write("                                <a href=\"");
      out.print(request.getContextPath());
      out.write("/logout\"><i class=\"fa fa-ban fa-fw pull-right\"></i> Đăng xuất</a>\r\n");
      out.write("                            </li>\r\n");
      out.write("                        </ul>\r\n");
      out.write("                    </li>\r\n");
      out.write("                </ul>\r\n");
      out.write("            </div>\r\n");
      out.write("        </nav>\r\n");
      out.write("    </header>\r\n");
      out.write("    <div class=\"wrapper row-offcanvas row-offcanvas-left\">\r\n");
      out.write("        <!-- Left side column. contains the logo and sidebar -->\r\n");
      out.write("        <aside class=\"left-side sidebar-offcanvas\">\r\n");
      out.write("            <!-- sidebar: style can be found in sidebar.less -->\r\n");
      out.write("            <section class=\"sidebar\">\r\n");
      out.write("                <!-- Sidebar user panel -->\r\n");
      out.write("                <div class=\"user-panel\">\r\n");
      out.write("                    <div class=\"pull-left image\">\r\n");
      out.write("                        <img src=\"");
      out.print(request.getContextPath());
      out.write("/img/26115.jpg\" class=\"img-circle\" alt=\"User Image\" />\r\n");
      out.write("                    </div>\r\n");
      out.write("                    <div class=\"pull-left info\">\r\n");
      out.write("                        <p>Xin chào, ");
      out.print( username );
      out.write("</p>\r\n");
      out.write("                        <a href=\"#\"><i class=\"fa fa-circle text-success\"></i> Online</a>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <!-- search form -->\r\n");
      out.write("                <form action=\"#\" method=\"get\" class=\"sidebar-form\">\r\n");
      out.write("                    <div class=\"input-group\">\r\n");
      out.write("                        <input type=\"text\" name=\"q\" class=\"form-control\" placeholder=\"Tìm kiếm...\"/>\r\n");
      out.write("                        <span class=\"input-group-btn\">\r\n");
      out.write("                            <button type='submit' name='seach' id='search-btn' class=\"btn btn-flat\"><i class=\"fa fa-search\"></i></button>\r\n");
      out.write("                        </span>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </form>\r\n");
      out.write("                <!-- /.search form -->\r\n");
      out.write("                <!-- sidebar menu: : style can be found in sidebar.less -->\r\n");
      out.write("                ");
      org.apache.jasper.runtime.JspRuntimeLibrary.include(request, response, "partials/sidebar.jsp", out, false);
      out.write("\r\n");
      out.write("            </section>\r\n");
      out.write("            <!-- /.sidebar -->\r\n");
      out.write("        </aside>\r\n");
      out.write("        <aside class=\"right-side\">\r\n");
      out.write("            <!-- Main content -->\r\n");
      out.write("            <section class=\"content\">\r\n");
      out.write("                \r\n");
      out.write("                <div class=\"row\">\r\n");
      out.write("                    <div class=\"col-xs-12\">\r\n");
      out.write("                        <div class=\"panel\">\r\n");
      out.write("                            <header class=\"panel-heading\">\r\n");
      out.write("                                <h3>Danh sách hợp đồng</h3>\r\n");
      out.write("                                <div class=\"panel-tools\">\r\n");
      out.write("                                    <button class=\"btn btn-success btn-sm\" data-toggle=\"modal\" data-target=\"#stockInModal\">\r\n");
      out.write("                                        <i class=\"fa fa-arrow-down\"></i> Nhập kho\r\n");
      out.write("                                    </button>\r\n");
      out.write("                                    <button class=\"btn btn-danger btn-sm\" data-toggle=\"modal\" data-target=\"#stockOutModal\">\r\n");
      out.write("                                        <i class=\"fa fa-arrow-up\"></i> Xuất kho\r\n");
      out.write("                                    </button>\r\n");
      out.write("                                    <a class=\"btn btn-warning btn-sm\" href=\"");
      out.print(request.getContextPath());
      out.write("/stock.jsp\">\r\n");
      out.write("                                        <i class=\"fa fa-cubes\"></i> Tồn kho\r\n");
      out.write("                                    </a>\r\n");
      out.write("                                    <a class=\"btn btn-info btn-sm\" href=\"");
      out.print(request.getContextPath());
      out.write("/stock_history.jsp\">\r\n");
      out.write("                                        <i class=\"fa fa-history\"></i> Lịch sử\r\n");
      out.write("                                    </a>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </header>\r\n");
      out.write("                            \r\n");
      out.write("                            <!-- Phần lọc -->\r\n");
      out.write("                            <div class=\"panel-body filter-panel\">\r\n");
      out.write("                                <div class=\"row\">\r\n");
      out.write("                                    <div class=\"col-md-12\">\r\n");
      out.write("                                        <div class=\"row\">\r\n");
      out.write("                                            <!-- Lọc theo trạng thái hợp đồng -->\r\n");
      out.write("                                            <div class=\"col-md-3\">\r\n");
      out.write("                                                <div class=\"form-group\">\r\n");
      out.write("                                                    <label for=\"filterContractStatus\">Trạng thái:</label>\r\n");
      out.write("                                                    <select class=\"form-control\" id=\"filterContractStatus\">\r\n");
      out.write("                                                        <option value=\"\">Tất cả trạng thái</option>\r\n");
      out.write("                                                        <option value=\"draft\">Nháp</option>\r\n");
      out.write("                                                        <option value=\"active\">Hiệu Lực</option>\r\n");
      out.write("                                                        <option value=\"terminated\">Chấm Dứt</option>\r\n");
      out.write("                                                    </select>\r\n");
      out.write("                                                </div>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                            \r\n");
      out.write("                                            <!-- Tìm kiếm -->\r\n");
      out.write("                                            <div class=\"col-md-7\">\r\n");
      out.write("                                                <div class=\"form-group\">\r\n");
      out.write("                                                    <label for=\"searchContract\">Tìm kiếm:</label>\r\n");
      out.write("                                                    <input type=\"text\" class=\"form-control\" id=\"searchContract\" \r\n");
      out.write("                                                           placeholder=\"Mã hợp đồng, tên khách hàng...\" \r\n");
      out.write("                                                           onkeypress=\"if(event.key==='Enter') filterContracts()\">\r\n");
      out.write("                                                </div>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                            \r\n");
      out.write("                                            <!-- Nút lọc -->\r\n");
      out.write("                                            <div class=\"col-md-1\">\r\n");
      out.write("                                                <div class=\"form-group\">\r\n");
      out.write("                                                    <label style=\"color: transparent;\">Lọc</label>\r\n");
      out.write("                                                    <button type=\"button\" class=\"btn btn-primary btn-sm\" \r\n");
      out.write("                                                            style=\"width: 100%;\" onclick=\"filterContracts()\" \r\n");
      out.write("                                                            title=\"Áp dụng bộ lọc\">\r\n");
      out.write("                                                        <i class=\"fa fa-search\"></i>\r\n");
      out.write("                                                    </button>\r\n");
      out.write("                                                </div>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                            \r\n");
      out.write("                                            <!-- Nút reset -->\r\n");
      out.write("                                            <div class=\"col-md-1\">\r\n");
      out.write("                                                <div class=\"form-group\">\r\n");
      out.write("                                                    <label style=\"color: transparent;\">Reset</label>\r\n");
      out.write("                                                    <button type=\"button\" class=\"btn btn-warning btn-sm\" \r\n");
      out.write("                                                            style=\"width: 100%;\" onclick=\"resetFilters()\" \r\n");
      out.write("                                                            title=\"Xóa tất cả bộ lọc\">\r\n");
      out.write("                                                        <i class=\"fa fa-refresh\"></i>\r\n");
      out.write("                                                    </button>\r\n");
      out.write("                                                </div>\r\n");
      out.write("                                            </div>\r\n");
      out.write("                                        </div>\r\n");
      out.write("                                    </div>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            \r\n");
      out.write("                            <div class=\"panel-body table-responsive\">\r\n");
      out.write("                                <table class=\"table table-hover\" id=\"contractsTable\">\r\n");
      out.write("                                    <thead>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <th>ID</th>\r\n");
      out.write("                                            <th>Số hợp đồng</th>\r\n");
      out.write("                                            <th>Tên khách hàng</th>\r\n");
      out.write("                                            <th>Số điện thoại</th>\r\n");
      out.write("                                            <th>Loại</th>\r\n");
      out.write("                                            <th>Tiêu đề</th>\r\n");
      out.write("                                            <th>Ngày bắt đầu</th>\r\n");
      out.write("                                            <th>Giá trị</th>\r\n");
      out.write("                                            <th>Trạng thái</th>\r\n");
      out.write("                                            <th>Thao tác</th>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </thead>\r\n");
      out.write("                                    <tbody>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <td colspan=\"11\" class=\"text-center\">\r\n");
      out.write("                                                <i class=\"fa fa-spinner fa-spin\"></i> Đang tải dữ liệu...\r\n");
      out.write("                                            </td>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </tbody>\r\n");
      out.write("                                </table>\r\n");
      out.write("                                \r\n");
      out.write("                                <!-- Phân trang -->\r\n");
      out.write("                                <div class=\"row\" style=\"margin-top: 20px;\">\r\n");
      out.write("                                    <div class=\"col-md-8\">\r\n");
      out.write("                                        <div class=\"dataTables_info\" id=\"paginationInfo\" role=\"status\" aria-live=\"polite\">\r\n");
      out.write("                                            Hiển thị <span id=\"showingStart\">0</span> đến <span id=\"showingEnd\">0</span> \r\n");
      out.write("                                            trong tổng số <span id=\"totalRecords\">0</span> hợp đồng\r\n");
      out.write("                                        </div>\r\n");
      out.write("                                    </div>\r\n");
      out.write("                                    <div class=\"col-md-4\">\r\n");
      out.write("                                        <div class=\"dataTables_paginate paging_simple_numbers\" style=\"text-align: right;\">\r\n");
      out.write("                                            <ul class=\"pagination\" id=\"pagination\">\r\n");
      out.write("                                                <li class=\"paginate_button previous disabled\">\r\n");
      out.write("                                                    <a href=\"#\" id=\"prevBtn\">Trước</a>\r\n");
      out.write("                                                </li>\r\n");
      out.write("                                                <li class=\"paginate_button active\">\r\n");
      out.write("                                                    <a href=\"#\" class=\"page-link\" data-page=\"1\">1</a>\r\n");
      out.write("                                                </li>\r\n");
      out.write("                                                <li class=\"paginate_button next\">\r\n");
      out.write("                                                    <a href=\"#\" id=\"nextBtn\">Tiếp</a>\r\n");
      out.write("                                                </li>\r\n");
      out.write("                                            </ul>\r\n");
      out.write("                                        </div>\r\n");
      out.write("                                    </div>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </div>\r\n");
      out.write("                </div>\r\n");
      out.write("                \r\n");
      out.write("            </section><!-- /.content -->\r\n");
      out.write("        </aside><!-- /.right-side -->\r\n");
      out.write("    </div><!-- ./wrapper -->\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal xem sản phẩm -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"invViewProductModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-lg\" role=\"document\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\">Chi tiết sản phẩm</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\" id=\"invViewProductContent\">\r\n");
      out.write("                    <div class=\"text-center\"><i class=\"fa fa-spinner fa-spin\"></i> Đang tải...</div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <a class=\"btn btn-default\" id=\"invViewHistoryBtn\" href=\"#\" target=\"_blank\" style=\"display:none;\">\r\n");
      out.write("                        <i class=\"fa fa-history\"></i> Xem lịch sử\r\n");
      out.write("                    </a>\r\n");
      out.write("                    <button class=\"btn btn-primary\" data-dismiss=\"modal\">Đóng</button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal xem chi tiết hợp đồng -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"viewContractModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-lg\" role=\"document\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\">Chi tiết hợp đồng</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\" id=\"viewContractContent\">\r\n");
      out.write("                    <div class=\"text-center\"><i class=\"fa fa-spinner fa-spin\"></i> Đang tải...</div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <button type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\">Đóng</button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal Nhập kho -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"stockInModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-xl\" role=\"document\" style=\"width: 95%; max-width: 1400px;\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\"><i class=\"fa fa-arrow-down\"></i> Phiếu Nhập Kho</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\" style=\"max-height: 80vh; overflow-y: auto;\">\r\n");
      out.write("                    <form id=\"stockInForm\">\r\n");
      out.write("                        <!-- Thông tin chung -->\r\n");
      out.write("                        <div class=\"row\" style=\"margin-bottom: 20px;\">\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Kho <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <select id=\"stockInWarehouse\" class=\"form-control\" required>\r\n");
      out.write("                                        <option value=\"Main Warehouse\">Kho Chính</option>\r\n");
      out.write("                                        <option value=\"Warehouse A\">Kho A</option>\r\n");
      out.write("                                        <option value=\"Warehouse B\">Kho B</option>\r\n");
      out.write("                                    </select>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Nhà cung cấp <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <select id=\"stockInSupplierId\" class=\"form-control\" required>\r\n");
      out.write("                                        <option value=\"\">-- Chọn nhà cung cấp --</option>\r\n");
      out.write("                                    </select>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Người liên hệ</label>\r\n");
      out.write("                                    <input type=\"text\" id=\"stockInSupplierContact\" class=\"form-control\" readonly style=\"background-color: #f5f5f5;\">\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Ngày nhập <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <input type=\"date\" id=\"stockInDate\" class=\"form-control\" required>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Bảng sản phẩm -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <div class=\"row\" style=\"margin-bottom: 10px;\">\r\n");
      out.write("                                <div class=\"col-md-12\">\r\n");
      out.write("                                    <button type=\"button\" class=\"btn btn-primary btn-sm\" onclick=\"addStockInRow()\">\r\n");
      out.write("                                        <i class=\"fa fa-plus\"></i> Thêm sản phẩm\r\n");
      out.write("                                    </button>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"table-responsive\">\r\n");
      out.write("                                <table class=\"table table-bordered table-hover\" id=\"stockInProductsTable\">\r\n");
      out.write("                                    <thead>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <th style=\"width: 50px;\">STT</th>\r\n");
      out.write("                                            <th style=\"width: 200px;\">Sản phẩm <span class=\"text-danger\">*</span></th>\r\n");
      out.write("                                            <th style=\"width: 200px;\">Tên sản phẩm</th>\r\n");
      out.write("                                            <th style=\"width: 100px;\">Đơn vị</th>\r\n");
      out.write("                                            <th style=\"width: 120px;\">Số lượng <span class=\"text-danger\">*</span></th>\r\n");
      out.write("                                            <th style=\"width: 150px;\">Đơn giá nhập <span class=\"text-danger\">*</span></th>\r\n");
      out.write("                                            <th style=\"width: 150px;\">Tổng số tiền</th>\r\n");
      out.write("                                            <th style=\"width: 80px;\">Thao tác</th>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </thead>\r\n");
      out.write("                                    <tbody id=\"stockInProductsBody\">\r\n");
      out.write("                                        <!-- Dòng sản phẩm sẽ được thêm bằng JavaScript -->\r\n");
      out.write("                                    </tbody>\r\n");
      out.write("                                    <tfoot>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <td colspan=\"6\" style=\"text-align: right; font-weight: bold;\">Tổng cộng:</td>\r\n");
      out.write("                                            <td id=\"stockInTotalAmount\" style=\"font-weight: bold; color: #d9534f; font-size: 16px;\">0 VNĐ</td>\r\n");
      out.write("                                            <td></td>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </tfoot>\r\n");
      out.write("                                </table>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Ghi chú -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label>Ghi chú</label>\r\n");
      out.write("                            <textarea id=\"stockInNotes\" class=\"form-control\" rows=\"3\" placeholder=\"Nhập ghi chú về giao dịch này...\" oninput=\"updateWordCounter(this, 'stockInNotesCounter', 150)\"></textarea>\r\n");
      out.write("                            <small class=\"form-text text-muted\">\r\n");
      out.write("                                <span id=\"stockInNotesCounter\" style=\"color:#5cb85c;\">0</span> / 150 từ\r\n");
      out.write("                            </small>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </form>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <button class=\"btn btn-default\" data-dismiss=\"modal\">Hủy</button>\r\n");
      out.write("                    <button class=\"btn btn-success\" onclick=\"submitStockIn()\">\r\n");
      out.write("                        <i class=\"fa fa-save\"></i> Nhập kho\r\n");
      out.write("                    </button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- Modal Xuất kho -->\r\n");
      out.write("    <div class=\"modal fade\" id=\"stockOutModal\" tabindex=\"-1\" role=\"dialog\">\r\n");
      out.write("        <div class=\"modal-dialog modal-xl\" role=\"document\" style=\"width: 95%; max-width: 1400px;\">\r\n");
      out.write("            <div class=\"modal-content\">\r\n");
      out.write("                <div class=\"modal-header\">\r\n");
      out.write("                    <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;</button>\r\n");
      out.write("                    <h4 class=\"modal-title\"><i class=\"fa fa-arrow-up\"></i> Phiếu Xuất Kho</h4>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-body\" style=\"max-height: 80vh; overflow-y: auto;\">\r\n");
      out.write("                    <form id=\"stockOutForm\">\r\n");
      out.write("                        <!-- Thông tin chung -->\r\n");
      out.write("                        <div class=\"row\" style=\"margin-bottom: 20px;\">\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Kho <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <select id=\"stockOutWarehouse\" class=\"form-control\" required>\r\n");
      out.write("                                        <option value=\"Main Warehouse\">Kho Chính</option>\r\n");
      out.write("                                        <option value=\"Warehouse A\">Kho A</option>\r\n");
      out.write("                                        <option value=\"Warehouse B\">Kho B</option>\r\n");
      out.write("                                    </select>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Mã hợp đồng</label>\r\n");
      out.write("                                    <select id=\"stockOutContractId\" class=\"form-control\">\r\n");
      out.write("                                        <option value=\"\">-- Chọn mã hợp đồng --</option>\r\n");
      out.write("                                    </select>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Tên khách hàng</label>\r\n");
      out.write("                                    <input type=\"text\" id=\"stockOutCustomerName\" class=\"form-control\" readonly style=\"background-color: #f5f5f5;\">\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"col-md-3\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Lý do xuất kho <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <select id=\"stockOutReason\" class=\"form-control\" required>\r\n");
      out.write("                                        <option value=\"\">-- Chọn lý do --</option>\r\n");
      out.write("                                        <option value=\"Bán hàng\">Bán hàng</option>\r\n");
      out.write("                                        <option value=\"Bảo hành\">Bảo hành</option>\r\n");
      out.write("                                        <option value=\"Điều chuyển\">Điều chuyển</option>\r\n");
      out.write("                                        <option value=\"Hỏng hóc\">Hỏng hóc</option>\r\n");
      out.write("                                        <option value=\"Khác\">Khác</option>\r\n");
      out.write("                                    </select>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        <div class=\"row\" style=\"margin-bottom: 20px;\">\r\n");
      out.write("                            <div class=\"col-md-4\">\r\n");
      out.write("                                <div class=\"form-group\">\r\n");
      out.write("                                    <label>Ngày xuất <span class=\"text-danger\">*</span></label>\r\n");
      out.write("                                    <input type=\"date\" id=\"stockOutDate\" class=\"form-control\" required>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Bảng sản phẩm -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <div class=\"row\" style=\"margin-bottom: 10px;\">\r\n");
      out.write("                                <div class=\"col-md-12\">\r\n");
      out.write("                                    <button type=\"button\" class=\"btn btn-primary btn-sm\" onclick=\"addStockOutRow()\">\r\n");
      out.write("                                        <i class=\"fa fa-plus\"></i> Thêm sản phẩm\r\n");
      out.write("                                    </button>\r\n");
      out.write("                                </div>\r\n");
      out.write("                            </div>\r\n");
      out.write("                            <div class=\"table-responsive\">\r\n");
      out.write("                                <table class=\"table table-bordered table-hover\" id=\"stockOutProductsTable\">\r\n");
      out.write("                                    <thead>\r\n");
      out.write("                                        <tr>\r\n");
      out.write("                                            <th style=\"width: 50px;\">STT</th>\r\n");
      out.write("                                            <th style=\"width: 200px;\">Sản phẩm <span class=\"text-danger\">*</span></th>\r\n");
      out.write("                                            <th style=\"width: 200px;\">Tên sản phẩm</th>\r\n");
      out.write("                                            <th style=\"width: 100px;\">Đơn vị</th>\r\n");
      out.write("                                            <th style=\"width: 120px;\">Tồn khả dụng</th>\r\n");
      out.write("                                            <th style=\"width: 120px;\">Số lượng xuất <span class=\"text-danger\">*</span></th>\r\n");
      out.write("                                            <th style=\"width: 80px;\">Thao tác</th>\r\n");
      out.write("                                        </tr>\r\n");
      out.write("                                    </thead>\r\n");
      out.write("                                    <tbody id=\"stockOutProductsBody\">\r\n");
      out.write("                                        <!-- Dòng sản phẩm sẽ được thêm bằng JavaScript -->\r\n");
      out.write("                                    </tbody>\r\n");
      out.write("                                </table>\r\n");
      out.write("                            </div>\r\n");
      out.write("                        </div>\r\n");
      out.write("                        \r\n");
      out.write("                        <!-- Ghi chú -->\r\n");
      out.write("                        <div class=\"form-group\">\r\n");
      out.write("                            <label>Ghi chú</label>\r\n");
      out.write("                            <textarea id=\"stockOutNotes\" class=\"form-control\" rows=\"3\" placeholder=\"Nhập ghi chú về giao dịch này...\" oninput=\"updateWordCounter(this, 'stockOutNotesCounter', 150)\"></textarea>\r\n");
      out.write("                            <small class=\"form-text text-muted\">\r\n");
      out.write("                                <span id=\"stockOutNotesCounter\" style=\"color:#5cb85c;\">0</span> / 150 từ\r\n");
      out.write("                            </small>\r\n");
      out.write("                        </div>\r\n");
      out.write("                    </form>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"modal-footer\">\r\n");
      out.write("                    <button class=\"btn btn-default\" data-dismiss=\"modal\">Hủy</button>\r\n");
      out.write("                    <button class=\"btn btn-danger\" onclick=\"submitStockOut()\">\r\n");
      out.write("                        <i class=\"fa fa-save\"></i> Xuất kho\r\n");
      out.write("                    </button>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("\r\n");
      out.write("    <!-- jQuery 2.0.2 -->\r\n");
      out.write("    <script src=\"http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js\"></script>\r\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/jquery.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- jQuery UI 1.10.3 -->\r\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/jquery-ui-1.10.3.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Bootstrap -->\r\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/bootstrap.min.js\" type=\"text/javascript\"></script>\r\n");
      out.write("    <!-- Director App -->\r\n");
      out.write("    <script src=\"");
      out.print(request.getContextPath());
      out.write("/js/Director/app.js\" type=\"text/javascript\"></script>\r\n");
      out.write("\r\n");
      out.write("    <script type=\"text/javascript\">\r\n");
      out.write("        var currentPage = 1;\r\n");
      out.write("        var itemsPerPage = 10;\r\n");
      out.write("        var allProducts = [];\r\n");
      out.write("        \r\n");
      out.write("        // Khởi tạo window.productList và window.supplierList\r\n");
      out.write("        window.productList = [];\r\n");
      out.write("        window.supplierList = [];\r\n");
      out.write("        \r\n");
      out.write("        // Load dữ liệu khi trang được tải\r\n");
      out.write("        $(document).ready(function() {\r\n");
      out.write("            console.log('Page loaded, initializing...');\r\n");
      out.write("            loadProductsForDropdown();\r\n");
      out.write("            loadSuppliersForDropdown();\r\n");
      out.write("            loadContractsData();\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        /**\r\n");
      out.write("         * Hàm load dữ liệu hợp đồng\r\n");
      out.write("         */\r\n");
      out.write("        function loadContractsData() {\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: {\r\n");
      out.write("                    action: 'getContractsList',\r\n");
      out.write("                    status: $('#filterContractStatus').val(),\r\n");
      out.write("                    search: $('#searchContract').val(),\r\n");
      out.write("                    page: currentPage,\r\n");
      out.write("                    pageSize: itemsPerPage\r\n");
      out.write("                },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success) {\r\n");
      out.write("                        console.log('Contracts loaded:', response.data);\r\n");
      out.write("                        console.log('Total contracts:', response.totalCount);\r\n");
      out.write("                        updateContractsTable(response.data);\r\n");
      out.write("                        updatePaginationInfo(response);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Lỗi khi tải dữ liệu: ' + response.message);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('AJAX Error:', error);\r\n");
      out.write("                    var tbody = $('#contractsTable tbody');\r\n");
      out.write("                    tbody.html('<tr><td colspan=\"11\" class=\"text-center text-danger\">Lỗi tải dữ liệu hợp đồng: ' + (error||'') + '</td></tr>');\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /**\r\n");
      out.write("         * Cập nhật dropdown danh mục trong bộ lọc (chỉ 3 danh mục cố định)\r\n");
      out.write("         * @param {Array} categories - Danh sách danh mục từ server (không sử dụng, chỉ để giữ tương thích)\r\n");
      out.write("         */\r\n");
      out.write("        function updateCategoryFilter(categories) {\r\n");
      out.write("            var categorySelect = $('#filterCategory');\r\n");
      out.write("            var currentValue = categorySelect.val();\r\n");
      out.write("            \r\n");
      out.write("            // Chỉ hiển thị 3 danh mục cố định\r\n");
      out.write("            categorySelect.empty();\r\n");
      out.write("            categorySelect.append('<option value=\"\">Tất cả danh mục</option>');\r\n");
      out.write("            categorySelect.append('<option value=\"Máy phát điện\">Máy phát điện</option>');\r\n");
      out.write("            categorySelect.append('<option value=\"Máy bơm nước\">Máy bơm nước</option>');\r\n");
      out.write("            categorySelect.append('<option value=\"Máy tiện\">Máy tiện</option>');\r\n");
      out.write("            \r\n");
      out.write("            // Khôi phục giá trị đã chọn nếu có và hợp lệ\r\n");
      out.write("            if (currentValue && (currentValue === \"Máy phát điện\" || currentValue === \"Máy bơm nước\" || currentValue === \"Máy tiện\" || currentValue === \"\")) {\r\n");
      out.write("                categorySelect.val(currentValue);\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Hàm load dữ liệu mẫu (fallback)\r\n");
      out.write("        function loadSampleData() {\r\n");
      out.write("            var sampleData = [\r\n");
      out.write("                {\r\n");
      out.write("                    id: 1,\r\n");
      out.write("                    productCode: 'GEN-001',\r\n");
      out.write("                    productName: 'Máy phát điện 10KVA',\r\n");
      out.write("                    category: 'Máy phát điện',\r\n");
      out.write("                    warehouse: 'Main Warehouse',\r\n");
      out.write("                    currentStock: 15,\r\n");
      out.write("                    minStock: 5,\r\n");
      out.write("                    maxStock: 50\r\n");
      out.write("                },\r\n");
      out.write("                {\r\n");
      out.write("                    id: 2,\r\n");
      out.write("                    productCode: 'GEN-002',\r\n");
      out.write("                    productName: 'Máy phát điện 20KVA',\r\n");
      out.write("                    category: 'Máy phát điện',\r\n");
      out.write("                    warehouse: 'Main Warehouse',\r\n");
      out.write("                    currentStock: 3,\r\n");
      out.write("                    minStock: 5,\r\n");
      out.write("                    maxStock: 30\r\n");
      out.write("                },\r\n");
      out.write("                {\r\n");
      out.write("                    id: 3,\r\n");
      out.write("                    productCode: 'PART-001',\r\n");
      out.write("                    productName: 'Bộ lọc dầu',\r\n");
      out.write("                    category: 'Phụ tùng',\r\n");
      out.write("                    warehouse: 'Main Warehouse',\r\n");
      out.write("                    currentStock: 0,\r\n");
      out.write("                    minStock: 10,\r\n");
      out.write("                    maxStock: 100\r\n");
      out.write("                }\r\n");
      out.write("            ];\r\n");
      out.write("            \r\n");
      out.write("            allProducts = sampleData;\r\n");
      out.write("            updateInventoryTable(sampleData);\r\n");
      out.write("            updateDashboard(sampleData);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Cập nhật bảng hợp đồng\r\n");
      out.write("        function updateContractsTable(data) {\r\n");
      out.write("            var tbody = $('#contractsTable tbody');\r\n");
      out.write("            tbody.empty();\r\n");
      out.write("            \r\n");
      out.write("            if (data.length === 0) {\r\n");
      out.write("                tbody.append('<tr><td colspan=\"11\" class=\"text-center text-muted\">' +\r\n");
      out.write("                    '<i class=\"fa fa-info-circle\"></i> Không có hợp đồng nào</td></tr>');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            data.forEach(function(contract) {\r\n");
      out.write("                // Debug: log trạng thái của từng hợp đồng\r\n");
      out.write("                console.log('Contract ID:', contract.id, 'Status:', contract.status);\r\n");
      out.write("                \r\n");
      out.write("                var statusBadge = getStatusBadge(contract.status);\r\n");
      out.write("                var contractValue = contract.contractValue != null && contract.contractValue !== 'null' \r\n");
      out.write("                    ? formatCurrencyVN(contract.contractValue) + ' VNĐ' \r\n");
      out.write("                    : '--';\r\n");
      out.write("                \r\n");
      out.write("                // Tạo nút thao tác dựa vào trạng thái\r\n");
      out.write("                var actionButtons = '';\r\n");
      out.write("                var contractStatus = contract.status || '';\r\n");
      out.write("                \r\n");
      out.write("                // Hiển thị nút Xem cho tất cả hợp đồng\r\n");
      out.write("                actionButtons = '<button class=\"btn btn-info btn-xs\" onclick=\"viewContract(' + contract.id + ')\" title=\"Xem chi tiết\">' +\r\n");
      out.write("                    '<i class=\"fa fa-eye\"></i> Xem' +\r\n");
      out.write("                '</button>';\r\n");
      out.write("                \r\n");
      out.write("                // Hiển thị nút Xuất kho cho hợp đồng ở trạng thái draft hoặc active\r\n");
      out.write("                if (contractStatus === 'draft' || contractStatus === 'active') {\r\n");
      out.write("                    actionButtons += ' ' +\r\n");
      out.write("                        '<button class=\"btn btn-danger btn-xs\" onclick=\"exportStockForContract(' + contract.id + ')\" title=\"Xuất kho\">' +\r\n");
      out.write("                        '<i class=\"fa fa-arrow-up\"></i> Xuất kho' +\r\n");
      out.write("                    '</button>';\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                var row = '<tr>' +\r\n");
      out.write("                    '<td>' + contract.id + '</td>' +\r\n");
      out.write("                    '<td>' + escapeHtml(contract.contractNumber || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + escapeHtml(contract.customerName || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + escapeHtml(contract.customerPhone || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + escapeHtml(contract.contractType || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + escapeHtml(contract.title || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + (contract.startDate || '--') + '</td>' +\r\n");
      out.write("                    '<td>' + contractValue + '</td>' +\r\n");
      out.write("                    '<td>' + statusBadge + '</td>' +\r\n");
      out.write("                    '<td>' + actionButtons + '</td>' +\r\n");
      out.write("                '</tr>';\r\n");
      out.write("                tbody.append(row);\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Lấy badge trạng thái hợp đồng\r\n");
      out.write("        function getStatusBadge(status) {\r\n");
      out.write("            var badgeClass = 'label-default';\r\n");
      out.write("            var statusText = status;\r\n");
      out.write("            \r\n");
      out.write("            switch(status) {\r\n");
      out.write("                case 'draft':\r\n");
      out.write("                    badgeClass = 'label-default';\r\n");
      out.write("                    statusText = 'Nháp';\r\n");
      out.write("                    break;\r\n");
      out.write("                case 'active':\r\n");
      out.write("                    badgeClass = 'label-success';\r\n");
      out.write("                    statusText = 'Hiệu Lực';\r\n");
      out.write("                    break;\r\n");
      out.write("                case 'terminated':\r\n");
      out.write("                    badgeClass = 'label-danger';\r\n");
      out.write("                    statusText = 'Chấm Dứt';\r\n");
      out.write("                    break;\r\n");
      out.write("                case 'deleted':\r\n");
      out.write("                    badgeClass = 'label-default';\r\n");
      out.write("                    statusText = 'Đã xóa';\r\n");
      out.write("                    break;\r\n");
      out.write("                default:\r\n");
      out.write("                    badgeClass = 'label-default';\r\n");
      out.write("                    statusText = status || 'Không xác định';\r\n");
      out.write("                    break;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            return '<span class=\"label ' + badgeClass + '\">' + statusText + '</span>';\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Xem chi tiết hợp đồng - hiển thị modal với danh sách sản phẩm và kiểm tra kho\r\n");
      out.write("        function viewContract(contractId) {\r\n");
      out.write("            if (!contractId || contractId <= 0) {\r\n");
      out.write("                alert('ID hợp đồng không hợp lệ');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Load chi tiết hợp đồng\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getContractDetails', contractId: contractId },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        var data = response.data;\r\n");
      out.write("                        var products = data.products || [];\r\n");
      out.write("                        \r\n");
      out.write("                        // Tạo HTML cho bảng sản phẩm\r\n");
      out.write("                        var productsHtml = '';\r\n");
      out.write("                        var insufficientProducts = [];\r\n");
      out.write("                        \r\n");
      out.write("                        if (products.length === 0) {\r\n");
      out.write("                            productsHtml = '<tr><td colspan=\"7\" class=\"text-center text-muted\">Hợp đồng chưa có sản phẩm</td></tr>';\r\n");
      out.write("                        } else {\r\n");
      out.write("                            products.forEach(function(product, index) {\r\n");
      out.write("                                var isAvailable = product.available === true;\r\n");
      out.write("                                var requiredQty = product.quantity || 0;\r\n");
      out.write("                                var totalQty = product.totalStock || 0;\r\n");
      out.write("                                var reservedQty = product.reservedStock || 0;\r\n");
      out.write("                                var availableQty = product.availableStock || 0;\r\n");
      out.write("                                var shortage = Math.max(requiredQty - availableQty, 0);\r\n");
      out.write("                                \r\n");
      out.write("                                // Lưu danh sách sản phẩm không đủ\r\n");
      out.write("                                if (!isAvailable) {\r\n");
      out.write("                                    insufficientProducts.push({\r\n");
      out.write("                                        name: product.productName || '',\r\n");
      out.write("                                        required: requiredQty,\r\n");
      out.write("                                        available: availableQty,\r\n");
      out.write("                                        total: totalQty,\r\n");
      out.write("                                        reserved: reservedQty,\r\n");
      out.write("                                        shortage: shortage\r\n");
      out.write("                                    });\r\n");
      out.write("                                }\r\n");
      out.write("                                \r\n");
      out.write("                                // Tạo badge và màu nền cho hàng\r\n");
      out.write("                                var availableBadge = isAvailable \r\n");
      out.write("                                    ? '<span class=\"label label-success\"><i class=\"fa fa-check\"></i> Đủ</span>' \r\n");
      out.write("                                    : '<span class=\"label label-danger\"><i class=\"fa fa-times\"></i> Thiếu</span>';\r\n");
      out.write("                                \r\n");
      out.write("                                // Màu nền cho hàng không đủ\r\n");
      out.write("                                var rowClass = isAvailable ? '' : 'danger';\r\n");
      out.write("                                var rowStyle = isAvailable ? '' : 'background-color: #f2dede;';\r\n");
      out.write("                                \r\n");
      out.write("                                var stockTitle = 'Tổng: ' + totalQty + ' | Giữ chỗ: ' + reservedQty + ' | Khả dụng: ' + availableQty;\r\n");
      out.write("                                \r\n");
      out.write("                                productsHtml += '<tr class=\"' + rowClass + '\" style=\"' + rowStyle + '\">' +\r\n");
      out.write("                                    '<td>' + (index + 1) + '</td>' +\r\n");
      out.write("                                    '<td><strong>' + escapeHtml(product.productCode || '') + '</strong></td>' +\r\n");
      out.write("                                    '<td><strong>' + escapeHtml(product.productName || '') + '</strong></td>' +\r\n");
      out.write("                                    '<td>' + escapeHtml(product.unit || '') + '</td>' +\r\n");
      out.write("                                    '<td style=\"text-align: right;\"><strong>' + requiredQty + '</strong></td>' +\r\n");
      out.write("                                    '<td style=\"text-align: right;\" title=\"' + stockTitle + '\">' + availableQty + '</td>' +\r\n");
      out.write("                                    '<td style=\"text-align: center;\">' + availableBadge;\r\n");
      out.write("                                \r\n");
      out.write("                                // Hiển thị số lượng thiếu nếu không đủ\r\n");
      out.write("                                if (!isAvailable) {\r\n");
      out.write("                                    productsHtml += '<br/><small class=\"text-danger\">Thiếu: <strong>' + shortage + '</strong></small>';\r\n");
      out.write("                                }\r\n");
      out.write("                                \r\n");
      out.write("                                productsHtml += '</td></tr>';\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Tạo nội dung modal\r\n");
      out.write("                        var modalContent = '<div class=\"row\">' +\r\n");
      out.write("                            '<div class=\"col-md-12\">' +\r\n");
      out.write("                                '<h4>Hợp đồng: ' + escapeHtml(data.contractNumber || '') + '</h4>' +\r\n");
      out.write("                                '<p><strong>Khách hàng:</strong> ' + escapeHtml(data.customerName || '') + '</p>' +\r\n");
      out.write("                                '<p><strong>Trạng thái:</strong> ' + getStatusBadge(data.status) + '</p>' +\r\n");
      out.write("                            '</div>' +\r\n");
      out.write("                        '</div>' +\r\n");
      out.write("                        '<hr/>' +\r\n");
      out.write("                        '<h5>Danh sách sản phẩm</h5>' +\r\n");
      out.write("                        '<div class=\"table-responsive\">' +\r\n");
      out.write("                            '<table class=\"table table-bordered table-hover\">' +\r\n");
      out.write("                                '<thead>' +\r\n");
      out.write("                                    '<tr>' +\r\n");
      out.write("                                        '<th style=\"width: 50px;\">STT</th>' +\r\n");
      out.write("                                        '<th>Mã sản phẩm</th>' +\r\n");
      out.write("                                        '<th>Tên sản phẩm</th>' +\r\n");
      out.write("                                        '<th>Đơn vị</th>' +\r\n");
      out.write("                                        '<th style=\"text-align: right;\">Số lượng cần</th>' +\r\n");
      out.write("                                        '<th style=\"text-align: right;\">Tồn khả dụng</th>' +\r\n");
      out.write("                                        '<th style=\"text-align: center;\">Trạng thái</th>' +\r\n");
      out.write("                                    '</tr>' +\r\n");
      out.write("                                '</thead>' +\r\n");
      out.write("                                '<tbody>' + productsHtml + '</tbody>' +\r\n");
      out.write("                            '</table>' +\r\n");
      out.write("                        '</div>';\r\n");
      out.write("                        \r\n");
      out.write("                        // Hiển thị thông báo validation\r\n");
      out.write("                        if (data.status === 'pending_approval') {\r\n");
      out.write("                            if (data.allProductsAvailable) {\r\n");
      out.write("                                // Tất cả sản phẩm đều đủ\r\n");
      out.write("                                modalContent += '<div class=\"alert alert-success\" style=\"margin-top: 15px;\">' +\r\n");
      out.write("                                    '<i class=\"fa fa-check-circle\"></i> <strong>Thông báo</strong><br/>' +\r\n");
      out.write("                                    'Tất cả sản phẩm đều đủ trong kho. Bạn có thể duyệt hợp đồng.' +\r\n");
      out.write("                                '</div>';\r\n");
      out.write("                            } else {\r\n");
      out.write("                                // Có sản phẩm không đủ - hiển thị chi tiết\r\n");
      out.write("                                var insufficientList = '';\r\n");
      out.write("                                insufficientProducts.forEach(function(p) {\r\n");
      out.write("                                    insufficientList += '<li><strong>' + escapeHtml(p.name) + '</strong>: ' +\r\n");
      out.write("                                        'Cần <span class=\"text-danger\"><strong>' + p.required + '</strong></span>, ' +\r\n");
      out.write("                                        'Có <span class=\"text-warning\"><strong>' + p.available + '</strong></span> (Tổng: ' + p.total + ', Giữ chỗ: ' + p.reserved + '), ' +\r\n");
      out.write("                                        'Thiếu <span class=\"text-danger\"><strong>' + p.shortage + '</strong></span></li>';\r\n");
      out.write("                                });\r\n");
      out.write("                                \r\n");
      out.write("                                modalContent += '<div class=\"alert alert-danger\" style=\"margin-top: 15px;\">' +\r\n");
      out.write("                                    '<i class=\"fa fa-exclamation-triangle\"></i> <strong>Thiếu hàng!</strong><br/>' +\r\n");
      out.write("                                    '<strong>Không thể duyệt hợp đồng vì có sản phẩm không đủ trong kho:</strong>' +\r\n");
      out.write("                                    '<ul style=\"margin-top: 10px; margin-bottom: 0;\">' + insufficientList + '</ul>' +\r\n");
      out.write("                                    '<p style=\"margin-top: 10px; margin-bottom: 0;\"><strong>Vui lòng nhập thêm hàng vào kho trước khi duyệt hợp đồng.</strong></p>' +\r\n");
      out.write("                                '</div>';\r\n");
      out.write("                            }\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        $('#viewContractContent').html(modalContent);\r\n");
      out.write("                        $('#viewContractModal').data('contract-id', contractId);\r\n");
      out.write("                        $('#viewContractModal').data('contract-status', data.status);\r\n");
      out.write("                        $('#viewContractModal').data('all-products-available', data.allProductsAvailable);\r\n");
      out.write("                        \r\n");
      out.write("                        \r\n");
      out.write("                        $('#viewContractModal').modal('show');\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Không thể tải thông tin hợp đồng: ' + (response.message || 'Lỗi không xác định'));\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('AJAX Error:', error);\r\n");
      out.write("                    alert('Lỗi kết nối đến server: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Biến flag để tránh reset form khi đang load từ exportStockForContract\r\n");
      out.write("        var isExportingFromContract = false;\r\n");
      out.write("        \r\n");
      out.write("        // Xuất kho cho hợp đồng đã duyệt\r\n");
      out.write("        // Tự động mở form xuất kho và load dữ liệu từ hợp đồng\r\n");
      out.write("        function exportStockForContract(contractId) {\r\n");
      out.write("            if (!contractId || contractId <= 0) {\r\n");
      out.write("                alert('ID hợp đồng không hợp lệ');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            console.log('Export stock for contract ID:', contractId);\r\n");
      out.write("            \r\n");
      out.write("            // Set flag để tránh reset form\r\n");
      out.write("            isExportingFromContract = true;\r\n");
      out.write("            \r\n");
      out.write("            // Kiểm tra xem modal đã mở chưa\r\n");
      out.write("            var modal = $('#stockOutModal');\r\n");
      out.write("            var isModalVisible = modal.is(':visible') || modal.hasClass('in');\r\n");
      out.write("            \r\n");
      out.write("            if (isModalVisible) {\r\n");
      out.write("                // Nếu modal đã mở, load trực tiếp\r\n");
      out.write("                loadContractsForDropdown(function() {\r\n");
      out.write("                    setContractAndLoadInfo(contractId);\r\n");
      out.write("                });\r\n");
      out.write("            } else {\r\n");
      out.write("                // Mở modal xuất kho\r\n");
      out.write("                modal.modal('show');\r\n");
      out.write("                \r\n");
      out.write("                // Đợi modal mở xong rồi load dữ liệu hợp đồng\r\n");
      out.write("                modal.one('shown.bs.modal', function() {\r\n");
      out.write("                    // Load danh sách hợp đồng vào dropdown trước (luôn load để đảm bảo có đầy đủ options)\r\n");
      out.write("                    loadContractsForDropdown(function() {\r\n");
      out.write("                        setContractAndLoadInfo(contractId);\r\n");
      out.write("                    });\r\n");
      out.write("                });\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Helper function để set contract và load info từ backend\r\n");
      out.write("        function setContractAndLoadInfo(contractId) {\r\n");
      out.write("            console.log('Setting contract ID and loading info from backend:', contractId);\r\n");
      out.write("            \r\n");
      out.write("            // Lấy warehouse được chọn (nếu có)\r\n");
      out.write("            var warehouse = $('#stockOutWarehouse').val() || 'Main Warehouse';\r\n");
      out.write("            \r\n");
      out.write("            // Gọi backend để lấy đầy đủ thông tin hợp đồng, sản phẩm và tồn kho\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { \r\n");
      out.write("                    action: 'getContractInfoForStockOut', \r\n");
      out.write("                    contractId: contractId,\r\n");
      out.write("                    warehouse: warehouse\r\n");
      out.write("                },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    console.log('Contract info from backend:', response);\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        var data = response.data;\r\n");
      out.write("                        \r\n");
      out.write("                        // Set contract ID trong dropdown\r\n");
      out.write("                        var contractSelect = $('#stockOutContractId');\r\n");
      out.write("                        contractSelect.val(contractId);\r\n");
      out.write("                        \r\n");
      out.write("                        // Hiển thị tên khách hàng từ backend\r\n");
      out.write("                        $('#stockOutCustomerName').val(data.customerName || '');\r\n");
      out.write("                        \r\n");
      out.write("                        // Set ngày mặc định từ backend (hôm nay) và có thể chỉnh sửa\r\n");
      out.write("                        if (data.defaultDate) {\r\n");
      out.write("                            $('#stockOutDate').val(data.defaultDate);\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Xóa tất cả sản phẩm hiện tại trong bảng\r\n");
      out.write("                        $('#stockOutProductsBody').empty();\r\n");
      out.write("                        stockOutRowCounter = 0;\r\n");
      out.write("                        \r\n");
      out.write("                        // Thêm sản phẩm từ backend vào bảng\r\n");
      out.write("                        if (data.products && data.products.length > 0) {\r\n");
      out.write("                            data.products.forEach(function(product) {\r\n");
      out.write("                                addProductRowFromBackend(product, warehouse);\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        console.log('Successfully loaded contract info from backend');\r\n");
      out.write("                    } else {\r\n");
      out.write("                        console.error('Failed to load contract info:', response.message);\r\n");
      out.write("                        alert('Lỗi khi tải thông tin hợp đồng: ' + (response.message || 'Unknown error'));\r\n");
      out.write("                    }\r\n");
      out.write("                    \r\n");
      out.write("                    // Reset flag sau khi load xong\r\n");
      out.write("                    setTimeout(function() {\r\n");
      out.write("                        isExportingFromContract = false;\r\n");
      out.write("                    }, 500);\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading contract info from backend:', error);\r\n");
      out.write("                    alert('Lỗi khi tải thông tin hợp đồng: ' + error);\r\n");
      out.write("                    isExportingFromContract = false;\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Helper function để thêm dòng sản phẩm từ dữ liệu backend\r\n");
      out.write("        function addProductRowFromBackend(product, warehouse) {\r\n");
      out.write("            stockOutRowCounter++;\r\n");
      out.write("            var rowId = 'stockOutRow_' + stockOutRowCounter;\r\n");
      out.write("            var tbody = $('#stockOutProductsBody');\r\n");
      out.write("            \r\n");
      out.write("            // Tìm tồn kho tại warehouse được chọn\r\n");
      out.write("            var currentStock = 0;\r\n");
      out.write("            var totalStock = 0;\r\n");
      out.write("            var reservedStock = 0;\r\n");
      out.write("            if (product.stocks && product.stocks.length > 0) {\r\n");
      out.write("                var stockAtWarehouse = product.stocks.find(function(s) {\r\n");
      out.write("                    return s.warehouse === warehouse;\r\n");
      out.write("                });\r\n");
      out.write("                if (stockAtWarehouse) {\r\n");
      out.write("                    totalStock = stockAtWarehouse.stock || 0;\r\n");
      out.write("                    reservedStock = stockAtWarehouse.reserved || 0;\r\n");
      out.write("                    currentStock = stockAtWarehouse.available || Math.max(totalStock - reservedStock, 0);\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("            var stockTitle = 'Tổng: ' + totalStock + ' | Giữ chỗ: ' + reservedStock + ' | Khả dụng: ' + currentStock;\r\n");
      out.write("            \r\n");
      out.write("            var row = '<tr id=\"' + rowId + '\">' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' + stockOutRowCounter + '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<select class=\"form-control stockOutProductSelect\" data-row-id=\"' + rowId + '\" required>' +\r\n");
      out.write("                    '</select>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockOutProductName\" readonly style=\"background-color: #f5f5f5;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockOutProductUnit\" readonly style=\"background-color: #f5f5f5; text-align: center;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<span class=\"stockOutCurrentStock\" style=\"font-weight: bold; color: #5cb85c;\" title=\"' + stockTitle + '\">' + currentStock + '</span>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<input type=\"number\" class=\"form-control stockOutQuantity\" min=\"1\" max=\"' + currentStock + '\" value=\"' + (product.quantity && product.quantity > 0 ? product.quantity : '') + '\" required placeholder=\"Nhập số lượng\" style=\"text-align: right;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<button type=\"button\" class=\"btn btn-danger btn-xs\" onclick=\"removeStockOutRow(\\'' + rowId + '\\')\" title=\"Xóa dòng\">' +\r\n");
      out.write("                        '<i class=\"fa fa-trash\"></i> Xóa' +\r\n");
      out.write("                    '</button>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("            '</tr>';\r\n");
      out.write("            \r\n");
      out.write("            tbody.append(row);\r\n");
      out.write("            \r\n");
      out.write("            // Render options cho dropdown sản phẩm\r\n");
      out.write("            var selectEl = $('#' + rowId + ' .stockOutProductSelect');\r\n");
      out.write("            renderStockOutProductOptions(selectEl);\r\n");
      out.write("            \r\n");
      out.write("            // Set sản phẩm được chọn và cập nhật thông tin\r\n");
      out.write("            setTimeout(function() {\r\n");
      out.write("                selectEl.val(product.productId);\r\n");
      out.write("                var selectedOption = selectEl.find('option:selected');\r\n");
      out.write("                if (selectedOption.length > 0) {\r\n");
      out.write("                    $('#' + rowId + ' .stockOutProductName').val(selectedOption.data('name') || product.productName || '');\r\n");
      out.write("                    $('#' + rowId + ' .stockOutProductUnit').val(selectedOption.data('unit') || product.unit || '');\r\n");
      out.write("                } else {\r\n");
      out.write("                    $('#' + rowId + ' .stockOutProductName').val(product.productName || '');\r\n");
      out.write("                    $('#' + rowId + ' .stockOutProductUnit').val(product.unit || '');\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                // Gán sự kiện change cho dropdown sản phẩm\r\n");
      out.write("                selectEl.off('change').on('change', function() {\r\n");
      out.write("                    var row = $(this).closest('tr');\r\n");
      out.write("                    var selectedOption = $(this).find('option:selected');\r\n");
      out.write("                    var productId = $(this).val();\r\n");
      out.write("                    var warehouse = $('#stockOutWarehouse').val();\r\n");
      out.write("                    \r\n");
      out.write("                    if (productId) {\r\n");
      out.write("                        row.find('.stockOutProductName').val(selectedOption.data('name') || '');\r\n");
      out.write("                        row.find('.stockOutProductUnit').val(selectedOption.data('unit') || '');\r\n");
      out.write("                        loadCurrentStock(productId, warehouse, row);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        row.find('.stockOutProductName').val('');\r\n");
      out.write("                        row.find('.stockOutProductUnit').val('');\r\n");
      out.write("                        row.find('.stockOutCurrentStock').text('--').attr('title', '');\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("                \r\n");
      out.write("                // Gán sự kiện input cho số lượng\r\n");
      out.write("                $('#' + rowId + ' .stockOutQuantity').off('input').on('input', function() {\r\n");
      out.write("                    var row = $(this).closest('tr');\r\n");
      out.write("                    var quantity = parseInt($(this).val()) || 0;\r\n");
      out.write("                    var currentStock = parseInt(row.find('.stockOutCurrentStock').text()) || 0;\r\n");
      out.write("                    \r\n");
      out.write("                    if (quantity > currentStock) {\r\n");
      out.write("                        $(this).val(currentStock);\r\n");
      out.write("                        alert('Số lượng xuất không được vượt quá tồn kho khả dụng (' + currentStock + ')');\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("            }, 100);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Xác định trạng thái tồn kho\r\n");
      out.write("        function getStockStatus(currentStock, minStock) {\r\n");
      out.write("            if (currentStock === 0) {\r\n");
      out.write("                return { class: 'stock-out', text: 'Hết hàng' };\r\n");
      out.write("            } else if (currentStock <= minStock) {\r\n");
      out.write("                return { class: 'stock-low', text: 'Sắp hết' };\r\n");
      out.write("            } else {\r\n");
      out.write("                return { class: 'stock-normal', text: 'Bình thường' };\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // (Đã loại bỏ các hàm tổng hợp client-side; phân trang/đếm hiển thị do backend cung cấp)\r\n");
      out.write("        \r\n");
      out.write("        // Cập nhật phân trang từ response\r\n");
      out.write("        function updatePaginationInfo(response) {\r\n");
      out.write("            var startItem = (response.currentPage - 1) * response.pageSize + 1;\r\n");
      out.write("            var endItem = Math.min(response.currentPage * response.pageSize, response.totalCount);\r\n");
      out.write("            \r\n");
      out.write("            $('#showingStart').text(response.totalCount > 0 ? startItem : 0);\r\n");
      out.write("            $('#showingEnd').text(endItem);\r\n");
      out.write("            $('#totalRecords').text(response.totalCount);\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Định dạng số tiền VNĐ (dùng cho cột giá)\r\n");
      out.write("        function formatCurrencyVN(n){\r\n");
      out.write("            try { return Number(n).toLocaleString('vi-VN'); } catch(e) { return n; }\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Cập nhật bộ đếm số từ + đổi màu khi vượt quá\r\n");
      out.write("        function updateWordCounter(textarea, counterId, limit){\r\n");
      out.write("            var text = textarea && textarea.value ? textarea.value : '';\r\n");
      out.write("            var words = text.trim().length ? text.trim().split(/\\s+/).filter(function(w){ return w.length>0; }) : [];\r\n");
      out.write("            var count = words.length;\r\n");
      out.write("            var el = document.getElementById(counterId);\r\n");
      out.write("            if (el){\r\n");
      out.write("                el.textContent = count;\r\n");
      out.write("                if (count > limit){\r\n");
      out.write("                    el.style.color = '#d9534f';\r\n");
      out.write("                    textarea.style.borderColor = '#d9534f';\r\n");
      out.write("                } else {\r\n");
      out.write("                    el.style.color = '#5cb85c';\r\n");
      out.write("                    textarea.style.borderColor = '';\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        function buildHistoryUrl(productId){\r\n");
      out.write("            return '");
      out.print(request.getContextPath());
      out.write("/stock_history.jsp?productId=' + encodeURIComponent(productId);\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("        // Xem chi tiết sản phẩm (modal)\r\n");
      out.write("        function invViewProduct(productId) {\r\n");
      out.write("            if (!productId) { alert('ID sản phẩm không hợp lệ'); return; }\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getInventoryDetail', productId: productId },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(res){\r\n");
      out.write("                    if (!res.success) { alert('Không thể tải thông tin sản phẩm'); return; }\r\n");
      out.write("                    var d = res.data || {};\r\n");
      out.write("                    var statusBadge = d.status === 'active' ? '<span class=\"label label-success\">Đang bán</span>' : '<span class=\"label label-warning\">Ngừng bán</span>';\r\n");
      out.write("                    var html = ''+\r\n");
      out.write("                        '<div class=\"row\">'+\r\n");
      out.write("                          '<div class=\"col-sm-6\">'+\r\n");
      out.write("                            '<h4 style=\"margin-top:0\">'+escapeHtml(d.productName||'')+'</h4>'+statusBadge+\r\n");
      out.write("                            '<p><strong>Mã:</strong> '+escapeHtml(d.productCode||'')+'</p>'+\r\n");
      out.write("                            '<p><strong>Danh mục:</strong> '+escapeHtml(d.category||'')+'</p>'+\r\n");
      out.write("                            '<p><strong>Đơn vị:</strong> '+escapeHtml(d.unit||'')+'</p>'+\r\n");
      out.write("                            '<p><strong>Giá bán:</strong> '+(d.unitPrice!=null?formatCurrencyVN(d.unitPrice):'--')+' VNĐ</p>'+\r\n");
      out.write("                            '<p><strong>Giá nhập gần nhất:</strong> '+(d.unitCost!=null?formatCurrencyVN(d.unitCost):'--')+' VNĐ</p>'+\r\n");
      out.write("                            '<p><strong>Số lượng tồn:</strong> '+(d.totalStock!=null?d.totalStock:'--')+'</p>'+\r\n");
      out.write("                            '<p><strong>Số lượng đã bán:</strong> '+(d.quantitySold!=null?d.quantitySold:'--')+'</p>'+\r\n");
      out.write("                          '</div>'+\r\n");
      out.write("                          '<div class=\"col-sm-6\">'+\r\n");
      out.write("                            (d.imageUrl?('<img src=\"'+d.imageUrl+'\" style=\"max-width:100%;border:1px solid #eee;border-radius:6px\">'):'')+\r\n");
      out.write("                          '</div>'+\r\n");
      out.write("                        '</div>'+\r\n");
      out.write("                        '<hr/>'+\r\n");
      out.write("                        '<p><strong>Mô tả:</strong><br>' + (escapeHtml(d.description||'Không có')) + '</p>'+\r\n");
      out.write("                        '<p><strong>Thông số kỹ thuật:</strong><br>' + (escapeHtml(d.specifications||'Không có')) + '</p>'+\r\n");
      out.write("                        '<h4>Vị trí kho</h4>'+\r\n");
      out.write("                        renderWarehouseTable(d.warehouses||[]);\r\n");
      out.write("                    $('#invViewProductContent').html(html);\r\n");
      out.write("                    $('#invViewProductModal').modal('show');\r\n");
      out.write("                },\r\n");
      out.write("                error: function(){ alert('Lỗi kết nối máy chủ'); }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\\\"/g,'&quot;').replace(/'/g,'&#39;'); }\r\n");
      out.write("\r\n");
      out.write("        function renderWarehouseTable(rows){\r\n");
      out.write("            if (!rows || rows.length === 0) return '<div class=\"muted\">Không có dữ liệu vị trí kho</div>';\r\n");
      out.write("            var html = '<table class=\"table table-bordered\"><thead><tr><th>Kho</th><th>Tồn</th></tr></thead><tbody>';\r\n");
      out.write("            rows.forEach(function(r){ html += '<tr><td>'+escapeHtml(r.warehouse||'')+'</td><td>'+ (r.stock!=null?r.stock:'--') +'</td></tr>'; });\r\n");
      out.write("            html += '</tbody></table>';\r\n");
      out.write("            return html;\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Load sản phẩm cho dropdown\r\n");
      out.write("        function loadProductsForDropdown() {\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getProducts' },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    console.log('Products loaded:', response);\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        window.productList = response.data;\r\n");
      out.write("                        console.log('Total products:', window.productList.length);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        console.warn('No products found or response failed');\r\n");
      out.write("                        window.productList = [];\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading products:', error);\r\n");
      out.write("                    console.error('Response:', xhr.responseText);\r\n");
      out.write("                    window.productList = [];\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Load nhà cung cấp cho dropdown từ backend\r\n");
      out.write("        function loadSuppliersForDropdown() {\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getSuppliers' },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    console.log('Suppliers loaded:', response);\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        window.supplierList = response.data;\r\n");
      out.write("                        console.log('Total suppliers:', window.supplierList.length);\r\n");
      out.write("                        renderStockInSupplierOptions();\r\n");
      out.write("                    } else {\r\n");
      out.write("                        console.warn('No suppliers found or response failed');\r\n");
      out.write("                        window.supplierList = [];\r\n");
      out.write("                        renderStockInSupplierOptions();\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading suppliers:', error);\r\n");
      out.write("                    console.error('Response:', xhr.responseText);\r\n");
      out.write("                    window.supplierList = [];\r\n");
      out.write("                    renderStockInSupplierOptions();\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Render options cho dropdown nhà cung cấp\r\n");
      out.write("        function renderStockInSupplierOptions() {\r\n");
      out.write("            var selectEl = $('#stockInSupplierId');\r\n");
      out.write("            if (selectEl.length === 0) return;\r\n");
      out.write("            \r\n");
      out.write("            var options = '<option value=\"\">-- Chọn nhà cung cấp --</option>';\r\n");
      out.write("            (window.supplierList || []).forEach(function(s) {\r\n");
      out.write("                options += '<option value=\"' + s.id + '\" data-name=\"' + escapeHtml(s.companyName || '') + '\" data-contact=\"' + escapeHtml(s.contactPerson || '') + '\">' + \r\n");
      out.write("                          escapeHtml(s.supplierCode || '') + ' - ' + escapeHtml(s.companyName || '') + '</option>';\r\n");
      out.write("            });\r\n");
      out.write("            selectEl.html(options);\r\n");
      out.write("            \r\n");
      out.write("            // Gán sự kiện change để hiển thị người liên hệ\r\n");
      out.write("            selectEl.off('change').on('change', function() {\r\n");
      out.write("                var selectedOption = $(this).find('option:selected');\r\n");
      out.write("                var contactPerson = selectedOption.data('contact') || '';\r\n");
      out.write("                $('#stockInSupplierContact').val(contactPerson);\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("\r\n");
      out.write("        // Biến đếm số dòng sản phẩm\r\n");
      out.write("        var stockInRowCounter = 0;\r\n");
      out.write("        \r\n");
      out.write("        // Render options cho select sản phẩm (dùng chung cho tất cả dropdown)\r\n");
      out.write("        function renderStockInProductOptions(selectElement) {\r\n");
      out.write("            if (!selectElement || selectElement.length === 0) return;\r\n");
      out.write("            var options = '<option value=\"\">-- Chọn sản phẩm --</option>';\r\n");
      out.write("            (window.productList || []).forEach(function(p) {\r\n");
      out.write("                options += '<option value=\"' + p.id + '\" data-name=\"' + escapeHtml(p.productName || '') + '\" data-unit=\"' + escapeHtml(p.unit || '') + '\" data-supplier=\"' + escapeHtml(p.supplierName || '') + '\">' + p.productCode + ' - ' + p.productName + '</option>';\r\n");
      out.write("            });\r\n");
      out.write("            selectElement.html(options);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Thêm dòng sản phẩm mới vào bảng\r\n");
      out.write("        function addStockInRow() {\r\n");
      out.write("            stockInRowCounter++;\r\n");
      out.write("            var rowId = 'stockInRow_' + stockInRowCounter;\r\n");
      out.write("            var tbody = $('#stockInProductsBody');\r\n");
      out.write("            \r\n");
      out.write("            var row = '<tr id=\"' + rowId + '\">' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' + stockInRowCounter + '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<select class=\"form-control stockInProductSelect\" data-row-id=\"' + rowId + '\" required>' +\r\n");
      out.write("                    '</select>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockInProductName\" readonly style=\"background-color: #f5f5f5;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockInProductUnit\" readonly style=\"background-color: #f5f5f5; text-align: center;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<input type=\"number\" class=\"form-control stockInQuantity\" min=\"1\" value=\"\" required placeholder=\"Nhập số lượng\" style=\"text-align: right;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<input type=\"number\" class=\"form-control stockInUnitCost\" min=\"1\" step=\"1000\" value=\"\" required placeholder=\"Nhập đơn giá\" style=\"text-align: right;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: right; vertical-align: middle;\">' +\r\n");
      out.write("                    '<span class=\"stockInRowTotal\" style=\"font-weight: bold; color: #d9534f;\">0 VNĐ</span>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<button type=\"button\" class=\"btn btn-danger btn-xs\" onclick=\"removeStockInRow(\\'' + rowId + '\\')\" title=\"Xóa dòng\">' +\r\n");
      out.write("                        '<i class=\"fa fa-trash\"></i> Xóa' +\r\n");
      out.write("                    '</button>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("            '</tr>';\r\n");
      out.write("            \r\n");
      out.write("            tbody.append(row);\r\n");
      out.write("            \r\n");
      out.write("            // Render options cho dropdown sản phẩm vừa thêm\r\n");
      out.write("            var selectEl = $('#' + rowId + ' .stockInProductSelect');\r\n");
      out.write("            renderStockInProductOptions(selectEl);\r\n");
      out.write("            \r\n");
      out.write("            // Gán sự kiện change cho dropdown sản phẩm\r\n");
      out.write("            selectEl.off('change').on('change', function() {\r\n");
      out.write("                var row = $(this).closest('tr');\r\n");
      out.write("                var selectedOption = $(this).find('option:selected');\r\n");
      out.write("                var productId = $(this).val();\r\n");
      out.write("                \r\n");
      out.write("                if (productId) {\r\n");
      out.write("                    // Cập nhật tên sản phẩm\r\n");
      out.write("                    row.find('.stockInProductName').val(selectedOption.data('name') || '');\r\n");
      out.write("                    // Cập nhật đơn vị\r\n");
      out.write("                    row.find('.stockInProductUnit').val(selectedOption.data('unit') || '');\r\n");
      out.write("                    // Cập nhật nhà cung cấp (nếu chưa có) - tìm supplierId từ product\r\n");
      out.write("                    var supplierName = selectedOption.data('supplier') || '';\r\n");
      out.write("                    if (supplierName && !$('#stockInSupplierId').val()) {\r\n");
      out.write("                        // Tìm supplierId từ supplierList dựa vào tên\r\n");
      out.write("                        var matchedSupplier = (window.supplierList || []).find(function(s) {\r\n");
      out.write("                            return s.companyName === supplierName;\r\n");
      out.write("                        });\r\n");
      out.write("                        if (matchedSupplier) {\r\n");
      out.write("                            $('#stockInSupplierId').val(matchedSupplier.id).trigger('change');\r\n");
      out.write("                        }\r\n");
      out.write("                    }\r\n");
      out.write("                } else {\r\n");
      out.write("                    row.find('.stockInProductName').val('');\r\n");
      out.write("                    row.find('.stockInProductUnit').val('');\r\n");
      out.write("                }\r\n");
      out.write("                \r\n");
      out.write("                // Tính lại tổng tiền của dòng\r\n");
      out.write("                calculateRowTotal(row);\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Gán sự kiện input cho số lượng và đơn giá\r\n");
      out.write("            $('#' + rowId + ' .stockInQuantity, #' + rowId + ' .stockInUnitCost').off('input').on('input', function() {\r\n");
      out.write("                calculateRowTotal($(this).closest('tr'));\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Cập nhật lại STT cho tất cả các dòng\r\n");
      out.write("            updateStockInRowNumbers();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Xóa dòng sản phẩm\r\n");
      out.write("        function removeStockInRow(rowId) {\r\n");
      out.write("            $('#' + rowId).remove();\r\n");
      out.write("            updateStockInRowNumbers();\r\n");
      out.write("            calculateTotalAmount();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Cập nhật lại số thứ tự các dòng\r\n");
      out.write("        function updateStockInRowNumbers() {\r\n");
      out.write("            $('#stockInProductsBody tr').each(function(index) {\r\n");
      out.write("                $(this).find('td:first').text(index + 1);\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Tính tổng tiền của 1 dòng\r\n");
      out.write("        function calculateRowTotal(row) {\r\n");
      out.write("            var quantity = parseFloat(row.find('.stockInQuantity').val()) || 0;\r\n");
      out.write("            var unitCost = parseFloat(row.find('.stockInUnitCost').val()) || 0;\r\n");
      out.write("            var total = quantity * unitCost;\r\n");
      out.write("            row.find('.stockInRowTotal').text(formatCurrencyVN(total) + ' VNĐ');\r\n");
      out.write("            calculateTotalAmount();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Tính tổng tiền tất cả các dòng\r\n");
      out.write("        function calculateTotalAmount() {\r\n");
      out.write("            var total = 0;\r\n");
      out.write("            $('#stockInProductsBody tr').each(function() {\r\n");
      out.write("                var quantity = parseFloat($(this).find('.stockInQuantity').val()) || 0;\r\n");
      out.write("                var unitCost = parseFloat($(this).find('.stockInUnitCost').val()) || 0;\r\n");
      out.write("                total += quantity * unitCost;\r\n");
      out.write("            });\r\n");
      out.write("            $('#stockInTotalAmount').text(formatCurrencyVN(total) + ' VNĐ');\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Submit form nhập kho (nhiều sản phẩm)\r\n");
      out.write("        function submitStockIn() {\r\n");
      out.write("            var warehouse = $('#stockInWarehouse').val();\r\n");
      out.write("            var notes = $('#stockInNotes').val();\r\n");
      out.write("            var supplierId = $('#stockInSupplierId').val();\r\n");
      out.write("            var receiptDate = $('#stockInDate').val();\r\n");
      out.write("\r\n");
      out.write("            // Validate thông tin chung\r\n");
      out.write("            if (!warehouse) {\r\n");
      out.write("                alert('Vui lòng chọn kho!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            if (!supplierId || supplierId === '') {\r\n");
      out.write("                alert('Vui lòng chọn nhà cung cấp!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            if (!receiptDate) {\r\n");
      out.write("                alert('Vui lòng chọn ngày nhập!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Validate ngày nhập: không được là ngày quá khứ (hôm qua trở về trước)\r\n");
      out.write("            var today = new Date();\r\n");
      out.write("            today.setHours(0,0,0,0);\r\n");
      out.write("            var chosen = new Date(receiptDate);\r\n");
      out.write("            chosen.setHours(0,0,0,0);\r\n");
      out.write("            if (chosen < today) {\r\n");
      out.write("                alert('Ngày nhập không được nhỏ hơn ngày hôm nay.');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Validate ghi chú tối đa 150 từ\r\n");
      out.write("            if (notes) {\r\n");
      out.write("                var wordCount = notes.trim().split(/\\s+/).filter(function(w){ return w.length > 0; }).length;\r\n");
      out.write("                if (wordCount > 150) {\r\n");
      out.write("                    alert('Ghi chú không được vượt quá 150 từ (hiện tại: ' + wordCount + ').');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Lấy tất cả sản phẩm từ bảng\r\n");
      out.write("            var products = [];\r\n");
      out.write("            var hasError = false;\r\n");
      out.write("            var errorMsg = '';\r\n");
      out.write("\r\n");
      out.write("            $('#stockInProductsBody tr').each(function(index) {\r\n");
      out.write("                var row = $(this);\r\n");
      out.write("                var productId = row.find('.stockInProductSelect').val();\r\n");
      out.write("                var quantity = row.find('.stockInQuantity').val();\r\n");
      out.write("                var unitCost = row.find('.stockInUnitCost').val();\r\n");
      out.write("                var productName = row.find('.stockInProductName').val();\r\n");
      out.write("\r\n");
      out.write("                // Validate từng dòng\r\n");
      out.write("                if (!productId) {\r\n");
      out.write("                    hasError = true;\r\n");
      out.write("                    errorMsg = 'Dòng ' + (index + 1) + ': Vui lòng chọn sản phẩm!';\r\n");
      out.write("                    return false; // break loop\r\n");
      out.write("                }\r\n");
      out.write("                if (!quantity || quantity <= 0 || !Number.isInteger(Number(quantity))) {\r\n");
      out.write("                    hasError = true;\r\n");
      out.write("                    errorMsg = 'Dòng ' + (index + 1) + ' (' + productName + '): Số lượng phải là số nguyên dương!';\r\n");
      out.write("                    return false;\r\n");
      out.write("                }\r\n");
      out.write("                if (!unitCost || unitCost <= 0) {\r\n");
      out.write("                    hasError = true;\r\n");
      out.write("                    errorMsg = 'Dòng ' + (index + 1) + ' (' + productName + '): Đơn giá nhập phải lớn hơn 0!';\r\n");
      out.write("                    return false;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                products.push({\r\n");
      out.write("                    productId: parseInt(productId),\r\n");
      out.write("                    quantity: parseInt(quantity),\r\n");
      out.write("                    unitCost: parseFloat(unitCost),\r\n");
      out.write("                    warehouse: warehouse\r\n");
      out.write("                });\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (hasError) {\r\n");
      out.write("                alert(errorMsg);\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            if (products.length === 0) {\r\n");
      out.write("                alert('Vui lòng thêm ít nhất một sản phẩm!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Lấy tên nhà cung cấp từ dropdown\r\n");
      out.write("            var supplierName = '';\r\n");
      out.write("            if (supplierId) {\r\n");
      out.write("                var selectedSupplier = (window.supplierList || []).find(function(s) {\r\n");
      out.write("                    return String(s.id) === String(supplierId);\r\n");
      out.write("                });\r\n");
      out.write("                if (selectedSupplier) {\r\n");
      out.write("                    supplierName = selectedSupplier.companyName || '';\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            var formData = {\r\n");
      out.write("                action: 'stockIn',\r\n");
      out.write("                notes: notes,\r\n");
      out.write("                supplierId: supplierId,\r\n");
      out.write("                supplierName: supplierName,\r\n");
      out.write("                receiptDate: receiptDate,\r\n");
      out.write("                products: JSON.stringify(products)\r\n");
      out.write("            };\r\n");
      out.write("\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: formData,\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success) {\r\n");
      out.write("                        alert('Nhập kho thành công!');\r\n");
      out.write("                        $('#stockInModal').modal('hide');\r\n");
      out.write("                        loadInventoryData();\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Lỗi: ' + response.message);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('AJAX Error:', error);\r\n");
      out.write("                    alert('Lỗi kết nối server: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // ========== XUẤT KHO ==========\r\n");
      out.write("        // Biến đếm số dòng sản phẩm xuất kho\r\n");
      out.write("        var stockOutRowCounter = 0;\r\n");
      out.write("        \r\n");
      out.write("        // Thêm dòng sản phẩm mới vào bảng xuất kho\r\n");
      out.write("        function addStockOutRow() {\r\n");
      out.write("            stockOutRowCounter++;\r\n");
      out.write("            var rowId = 'stockOutRow_' + stockOutRowCounter;\r\n");
      out.write("            var tbody = $('#stockOutProductsBody');\r\n");
      out.write("            \r\n");
      out.write("            var row = '<tr id=\"' + rowId + '\">' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' + stockOutRowCounter + '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<select class=\"form-control stockOutProductSelect\" data-row-id=\"' + rowId + '\" required>' +\r\n");
      out.write("                    '</select>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockOutProductName\" readonly style=\"background-color: #f5f5f5;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<input type=\"text\" class=\"form-control stockOutProductUnit\" readonly style=\"background-color: #f5f5f5; text-align: center;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<span class=\"stockOutCurrentStock\" style=\"font-weight: bold; color: #5cb85c;\">--</span>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td>' +\r\n");
      out.write("                    '<input type=\"number\" class=\"form-control stockOutQuantity\" min=\"1\" value=\"\" required placeholder=\"Nhập số lượng\" style=\"text-align: right;\">' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("                '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                    '<button type=\"button\" class=\"btn btn-danger btn-xs\" onclick=\"removeStockOutRow(\\'' + rowId + '\\')\" title=\"Xóa dòng\">' +\r\n");
      out.write("                        '<i class=\"fa fa-trash\"></i> Xóa' +\r\n");
      out.write("                    '</button>' +\r\n");
      out.write("                '</td>' +\r\n");
      out.write("            '</tr>';\r\n");
      out.write("            \r\n");
      out.write("            tbody.append(row);\r\n");
      out.write("            \r\n");
      out.write("            // Render options cho dropdown sản phẩm vừa thêm\r\n");
      out.write("            var selectEl = $('#' + rowId + ' .stockOutProductSelect');\r\n");
      out.write("            renderStockOutProductOptions(selectEl);\r\n");
      out.write("            \r\n");
      out.write("            // Gán sự kiện change cho dropdown sản phẩm\r\n");
      out.write("            selectEl.off('change').on('change', function() {\r\n");
      out.write("                var row = $(this).closest('tr');\r\n");
      out.write("                var selectedOption = $(this).find('option:selected');\r\n");
      out.write("                var productId = $(this).val();\r\n");
      out.write("                var warehouse = $('#stockOutWarehouse').val();\r\n");
      out.write("                \r\n");
      out.write("                if (productId) {\r\n");
      out.write("                    // Cập nhật tên sản phẩm và đơn vị\r\n");
      out.write("                    row.find('.stockOutProductName').val(selectedOption.data('name') || '');\r\n");
      out.write("                    row.find('.stockOutProductUnit').val(selectedOption.data('unit') || '');\r\n");
      out.write("                    \r\n");
      out.write("                    // Load tồn khả dụng tại kho\r\n");
      out.write("                    loadCurrentStock(productId, warehouse, row);\r\n");
      out.write("                } else {\r\n");
      out.write("                    row.find('.stockOutProductName').val('');\r\n");
      out.write("                    row.find('.stockOutProductUnit').val('');\r\n");
      out.write("                    row.find('.stockOutCurrentStock').text('--').attr('title', '');\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Gán sự kiện change cho kho để cập nhật tồn kho\r\n");
      out.write("            $('#stockOutWarehouse').off('change.stockOut').on('change.stockOut', function() {\r\n");
      out.write("                var warehouse = $(this).val();\r\n");
      out.write("                $('#stockOutProductsBody tr').each(function() {\r\n");
      out.write("                    var productId = $(this).find('.stockOutProductSelect').val();\r\n");
      out.write("                    if (productId) {\r\n");
      out.write("                        loadCurrentStock(productId, warehouse, $(this));\r\n");
      out.write("                    }\r\n");
      out.write("                });\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Validate số lượng xuất không vượt quá tồn kho\r\n");
      out.write("            $('#' + rowId + ' .stockOutQuantity').off('input').on('input', function() {\r\n");
      out.write("                var row = $(this).closest('tr');\r\n");
      out.write("                var quantity = parseInt($(this).val()) || 0;\r\n");
      out.write("                var currentStock = parseInt(row.find('.stockOutCurrentStock').text()) || 0;\r\n");
      out.write("                \r\n");
      out.write("                if (quantity > currentStock) {\r\n");
      out.write("                    $(this).css('border-color', '#d9534f');\r\n");
      out.write("                    alert('Số lượng xuất (' + quantity + ') không được vượt quá tồn kho khả dụng (' + currentStock + ')!');\r\n");
      out.write("                    $(this).val(currentStock);\r\n");
      out.write("                } else {\r\n");
      out.write("                    $(this).css('border-color', '');\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("            \r\n");
      out.write("            // Cập nhật lại STT cho tất cả các dòng\r\n");
      out.write("            updateStockOutRowNumbers();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Render options cho select sản phẩm xuất kho\r\n");
      out.write("        function renderStockOutProductOptions(selectElement) {\r\n");
      out.write("            if (!selectElement || selectElement.length === 0) return;\r\n");
      out.write("            var options = '<option value=\"\">-- Chọn sản phẩm --</option>';\r\n");
      out.write("            (window.productList || []).forEach(function(p) {\r\n");
      out.write("                options += '<option value=\"' + p.id + '\" data-name=\"' + escapeHtml(p.productName || '') + '\" data-unit=\"' + escapeHtml(p.unit || '') + '\">' + p.productCode + ' - ' + p.productName + '</option>';\r\n");
      out.write("            });\r\n");
      out.write("            selectElement.html(options);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Load tồn khả dụng của sản phẩm\r\n");
      out.write("        function loadCurrentStock(productId, warehouse, row) {\r\n");
      out.write("            if (!productId || !warehouse) {\r\n");
      out.write("                    row.find('.stockOutCurrentStock').text('--').attr('title', '');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getInventoryDetail', productId: productId },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success && response.data && response.data.warehouses) {\r\n");
      out.write("                        var warehouses = response.data.warehouses;\r\n");
      out.write("                        var found = warehouses.find(function(w) {\r\n");
      out.write("                            return w.warehouse === warehouse;\r\n");
      out.write("                        });\r\n");
      out.write("                        var available = found ? (found.available || 0) : 0;\r\n");
      out.write("                        var total = found ? (found.stock || 0) : 0;\r\n");
      out.write("                        var reserved = found ? (found.reserved || 0) : 0;\r\n");
      out.write("                        var title = 'Tổng: ' + total + ' | Giữ chỗ: ' + reserved + ' | Khả dụng: ' + available;\r\n");
      out.write("                        row.find('.stockOutCurrentStock').text(available).attr('title', title);\r\n");
      out.write("                        \r\n");
      out.write("                        // Cập nhật max cho input số lượng\r\n");
      out.write("                        row.find('.stockOutQuantity').attr('max', available);\r\n");
      out.write("                    } else {\r\n");
      out.write("                        row.find('.stockOutCurrentStock').text('0').attr('title', '');\r\n");
      out.write("                        row.find('.stockOutQuantity').attr('max', 0);\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function() {\r\n");
      out.write("                    row.find('.stockOutCurrentStock').text('--').attr('title', '');\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Xóa dòng sản phẩm xuất kho\r\n");
      out.write("        function removeStockOutRow(rowId) {\r\n");
      out.write("            $('#' + rowId).remove();\r\n");
      out.write("            updateStockOutRowNumbers();\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Cập nhật lại số thứ tự các dòng xuất kho\r\n");
      out.write("        function updateStockOutRowNumbers() {\r\n");
      out.write("            $('#stockOutProductsBody tr').each(function(index) {\r\n");
      out.write("                $(this).find('td:first').text(index + 1);\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Submit form xuất kho - chỉ validate UI, xử lý chính ở backend\r\n");
      out.write("        function submitStockOut() {\r\n");
      out.write("            var warehouse = $('#stockOutWarehouse').val();\r\n");
      out.write("            var reason = $('#stockOutReason').val();\r\n");
      out.write("            var notes = $('#stockOutNotes').val();\r\n");
      out.write("            var outDate = $('#stockOutDate').val();\r\n");
      out.write("\r\n");
      out.write("            // Validate thông tin chung (UI validation)\r\n");
      out.write("            if (!warehouse) {\r\n");
      out.write("                alert('Vui lòng chọn kho!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            if (!reason || reason === '') {\r\n");
      out.write("                alert('Vui lòng chọn lý do xuất kho!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            if (!outDate) {\r\n");
      out.write("                alert('Vui lòng chọn ngày xuất!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Validate ngày xuất: không được là ngày tương lai (UI validation)\r\n");
      out.write("            var today = new Date();\r\n");
      out.write("            today.setHours(23,59,59,999);\r\n");
      out.write("            var chosen = new Date(outDate);\r\n");
      out.write("            chosen.setHours(23,59,59,999);\r\n");
      out.write("            if (chosen > today) {\r\n");
      out.write("                alert('Ngày xuất không được lớn hơn ngày hôm nay.');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Validate ghi chú tối đa 150 từ (UI validation)\r\n");
      out.write("            if (notes) {\r\n");
      out.write("                var wordCount = notes.trim().split(/\\s+/).filter(function(w){ return w.length > 0; }).length;\r\n");
      out.write("                if (wordCount > 150) {\r\n");
      out.write("                    alert('Ghi chú không được vượt quá 150 từ (hiện tại: ' + wordCount + ').');\r\n");
      out.write("                    return;\r\n");
      out.write("                }\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Lấy tất cả sản phẩm từ bảng - chỉ validate cơ bản ở frontend\r\n");
      out.write("            var products = [];\r\n");
      out.write("            var hasError = false;\r\n");
      out.write("            var errorMsg = '';\r\n");
      out.write("\r\n");
      out.write("            $('#stockOutProductsBody tr').each(function(index) {\r\n");
      out.write("                var row = $(this);\r\n");
      out.write("                var productId = row.find('.stockOutProductSelect').val();\r\n");
      out.write("                var quantity = row.find('.stockOutQuantity').val();\r\n");
      out.write("                var productName = row.find('.stockOutProductName').val();\r\n");
      out.write("\r\n");
      out.write("                // Validate cơ bản ở frontend (UI/UX)\r\n");
      out.write("                if (!productId) {\r\n");
      out.write("                    hasError = true;\r\n");
      out.write("                    errorMsg = 'Dòng ' + (index + 1) + ': Vui lòng chọn sản phẩm!';\r\n");
      out.write("                    return false; // break loop\r\n");
      out.write("                }\r\n");
      out.write("                if (!quantity || quantity <= 0 || !Number.isInteger(Number(quantity))) {\r\n");
      out.write("                    hasError = true;\r\n");
      out.write("                    errorMsg = 'Dòng ' + (index + 1) + ' (' + productName + '): Số lượng phải là số nguyên dương!';\r\n");
      out.write("                    return false;\r\n");
      out.write("                }\r\n");
      out.write("\r\n");
      out.write("                // Thêm vào mảng - validation tồn kho sẽ được xử lý ở backend\r\n");
      out.write("                products.push({\r\n");
      out.write("                    productId: parseInt(productId),\r\n");
      out.write("                    quantity: parseInt(quantity),\r\n");
      out.write("                    warehouse: warehouse\r\n");
      out.write("                });\r\n");
      out.write("            });\r\n");
      out.write("\r\n");
      out.write("            if (hasError) {\r\n");
      out.write("                alert(errorMsg);\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            if (products.length === 0) {\r\n");
      out.write("                alert('Vui lòng thêm ít nhất một sản phẩm!');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Lấy contractId từ form (nếu có)\r\n");
      out.write("            var contractId = $('#stockOutContractId').val();\r\n");
      out.write("            \r\n");
      out.write("            // Tạo notes với lý do xuất kho\r\n");
      out.write("            var fullNotes = 'Lý do: ' + reason;\r\n");
      out.write("            if (notes && notes.trim() !== '') {\r\n");
      out.write("                fullNotes += '\\n' + notes;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Nếu có contractId, thêm thông tin hợp đồng vào notes\r\n");
      out.write("            if (contractId && contractId !== '') {\r\n");
      out.write("                fullNotes = 'Xuất kho cho hợp đồng ID: ' + contractId + '\\n' + fullNotes;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Gửi dữ liệu lên backend - backend sẽ xử lý validation tồn kho và trừ kho\r\n");
      out.write("            var formData = {\r\n");
      out.write("                action: 'stockOut',\r\n");
      out.write("                notes: fullNotes,\r\n");
      out.write("                referenceType: reason,\r\n");
      out.write("                products: JSON.stringify(products)\r\n");
      out.write("            };\r\n");
      out.write("            \r\n");
      out.write("            // Thêm contractId nếu có (để cập nhật trạng thái sau khi xuất kho)\r\n");
      out.write("            if (contractId && contractId !== '') {\r\n");
      out.write("                formData.contractId = contractId;\r\n");
      out.write("            }\r\n");
      out.write("\r\n");
      out.write("            // Hiển thị loading\r\n");
      out.write("            var submitBtn = $('button[onclick=\"submitStockOut()\"]');\r\n");
      out.write("            var originalText = submitBtn.html();\r\n");
      out.write("            submitBtn.prop('disabled', true).html('<i class=\"fa fa-spinner fa-spin\"></i> Đang xuất kho...');\r\n");
      out.write("\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'POST',\r\n");
      out.write("                data: formData,\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    submitBtn.prop('disabled', false).html(originalText);\r\n");
      out.write("                    \r\n");
      out.write("                    if (response.success) {\r\n");
      out.write("                        alert('✓ Xuất kho thành công!' + (response.message ? '\\n' + response.message : ''));\r\n");
      out.write("                        $('#stockOutModal').modal('hide');\r\n");
      out.write("                        // Reload danh sách hợp đồng để cập nhật trạng thái\r\n");
      out.write("                        loadContractsData();\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('✗ Lỗi: ' + (response.message || 'Không thể xuất kho'));\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    submitBtn.prop('disabled', false).html(originalText);\r\n");
      out.write("                    console.error('AJAX Error:', error);\r\n");
      out.write("                    console.error('Response:', xhr.responseText);\r\n");
      out.write("                    alert('✗ Lỗi kết nối server: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Nhập kho nhanh\r\n");
      out.write("        function quickStockIn(productId) {\r\n");
      out.write("            // Mở modal\r\n");
      out.write("            $('#stockInModal').modal('show');\r\n");
      out.write("            setTimeout(function() {\r\n");
      out.write("                // Reset và thêm dòng đầu tiên\r\n");
      out.write("                $('#stockInProductsBody').empty();\r\n");
      out.write("                stockInRowCounter = 0;\r\n");
      out.write("                addStockInRow();\r\n");
      out.write("                \r\n");
      out.write("                // Nếu có productId, chọn sản phẩm đó ở dòng đầu tiên\r\n");
      out.write("                if (productId) {\r\n");
      out.write("                    var firstRow = $('#stockInProductsBody tr:first');\r\n");
      out.write("                    firstRow.find('.stockInProductSelect').val(productId).trigger('change');\r\n");
      out.write("                }\r\n");
      out.write("            }, 100);\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // (Đã loại bỏ quickStockOut vì không dùng)\r\n");
      out.write("        \r\n");
      out.write("        // Trang lịch sử được mở tại stock_history.jsp\r\n");
      out.write("        \r\n");
      out.write("        /**\r\n");
      out.write("         * Lọc hợp đồng với AJAX từ backend\r\n");
      out.write("         */\r\n");
      out.write("        function filterContracts() {\r\n");
      out.write("            currentPage = 1; // Reset về trang đầu khi lọc\r\n");
      out.write("            loadContractsData(); // Load lại dữ liệu với bộ lọc hiện tại\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        /**\r\n");
      out.write("         * Reset bộ lọc về trạng thái ban đầu\r\n");
      out.write("         */\r\n");
      out.write("        function resetFilters() {\r\n");
      out.write("            $('#filterContractStatus').val('');\r\n");
      out.write("            $('#searchContract').val('');\r\n");
      out.write("            currentPage = 1;\r\n");
      out.write("            loadContractsData(); // Load lại dữ liệu ban đầu\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Reset form khi đóng modal\r\n");
      out.write("        $('#stockInModal').on('hidden.bs.modal', function() {\r\n");
      out.write("            $('#stockInForm')[0].reset();\r\n");
      out.write("            $('#stockInProductsBody').empty();\r\n");
      out.write("            stockInRowCounter = 0;\r\n");
      out.write("            $('#stockInTotalAmount').text('0 VNĐ');\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        // Thiết lập mặc định khi mở modal nhập kho\r\n");
      out.write("        $('#stockInModal').on('shown.bs.modal', function() {\r\n");
      out.write("            // Set ngày hiện tại\r\n");
      out.write("            var today = new Date();\r\n");
      out.write("            var yyyy = today.getFullYear();\r\n");
      out.write("            var mm = ('0' + (today.getMonth() + 1)).slice(-2);\r\n");
      out.write("            var dd = ('0' + today.getDate()).slice(-2);\r\n");
      out.write("            $('#stockInDate').val(yyyy + '-' + mm + '-' + dd);\r\n");
      out.write("            \r\n");
      out.write("            // Load lại danh sách nhà cung cấp\r\n");
      out.write("            renderStockInSupplierOptions();\r\n");
      out.write("            \r\n");
      out.write("            // Reset bảng và thêm dòng đầu tiên\r\n");
      out.write("            $('#stockInProductsBody').empty();\r\n");
      out.write("            stockInRowCounter = 0;\r\n");
      out.write("            addStockInRow();\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        // Reset form khi đóng modal xuất kho\r\n");
      out.write("        $('#stockOutModal').on('hidden.bs.modal', function() {\r\n");
      out.write("            // Reset flag\r\n");
      out.write("            isExportingFromContract = false;\r\n");
      out.write("            \r\n");
      out.write("            $('#stockOutForm')[0].reset();\r\n");
      out.write("            $('#stockOutContractId').val('');\r\n");
      out.write("            $('#stockOutCustomerName').val('');\r\n");
      out.write("            $('#stockOutProductsBody').empty();\r\n");
      out.write("            stockOutRowCounter = 0;\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        // Load danh sách hợp đồng cho dropdown\r\n");
      out.write("        function loadContractsForDropdown(callback) {\r\n");
      out.write("            var selectEl = $('#stockOutContractId');\r\n");
      out.write("            if (selectEl.length === 0) {\r\n");
      out.write("                console.error('Element #stockOutContractId not found');\r\n");
      out.write("                if (callback) callback();\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            console.log('Loading contracts for dropdown...');\r\n");
      out.write("            \r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getContracts' },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    console.log('Contracts loaded:', response);\r\n");
      out.write("                    if (response && response.success) {\r\n");
      out.write("                        selectEl.empty();\r\n");
      out.write("                        selectEl.append('<option value=\"\">-- Chọn mã hợp đồng --</option>');\r\n");
      out.write("                        \r\n");
      out.write("                        if (response.data && response.data.length > 0) {\r\n");
      out.write("                            response.data.forEach(function(contract) {\r\n");
      out.write("                                if (contract && contract.id && contract.contractNumber) {\r\n");
      out.write("                                    var displayText = escapeHtml(contract.contractNumber || '');\r\n");
      out.write("                                    if (contract.customerName) {\r\n");
      out.write("                                        displayText += ' - ' + escapeHtml(contract.customerName);\r\n");
      out.write("                                    }\r\n");
      out.write("                                    var option = $('<option></option>')\r\n");
      out.write("                                        .attr('value', contract.id)\r\n");
      out.write("                                        .attr('data-customer-name', escapeHtml(contract.customerName || ''))\r\n");
      out.write("                                        .text(displayText);\r\n");
      out.write("                                    selectEl.append(option);\r\n");
      out.write("                                    console.log('Added contract option:', contract.id, contract.contractNumber);\r\n");
      out.write("                                }\r\n");
      out.write("                            });\r\n");
      out.write("                            console.log('Successfully loaded ' + response.data.length + ' contracts into dropdown');\r\n");
      out.write("                        } else {\r\n");
      out.write("                            console.warn('No contracts found in response data');\r\n");
      out.write("                            selectEl.append('<option value=\"\" disabled>Không có hợp đồng nào</option>');\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        console.warn('Response failed:', response);\r\n");
      out.write("                        selectEl.empty();\r\n");
      out.write("                        selectEl.append('<option value=\"\">-- Lỗi tải dữ liệu --</option>');\r\n");
      out.write("                    }\r\n");
      out.write("                    // Gọi callback sau khi hoàn thành\r\n");
      out.write("                    if (callback) {\r\n");
      out.write("                        console.log('Calling callback after loading contracts');\r\n");
      out.write("                        callback();\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading contracts:', error);\r\n");
      out.write("                    console.error('Status:', status);\r\n");
      out.write("                    console.error('Response:', xhr.responseText);\r\n");
      out.write("                    selectEl.empty();\r\n");
      out.write("                    selectEl.append('<option value=\"\">-- Lỗi: ' + error + ' --</option>');\r\n");
      out.write("                    // Gọi callback ngay cả khi có lỗi\r\n");
      out.write("                    if (callback) callback();\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Load thông tin hợp đồng khi chọn\r\n");
      out.write("        function loadContractInfo(contractId) {\r\n");
      out.write("            if (!contractId || contractId === '') {\r\n");
      out.write("                $('#stockOutCustomerName').val('');\r\n");
      out.write("                // Xóa tất cả sản phẩm trong bảng\r\n");
      out.write("                $('#stockOutProductsBody').empty();\r\n");
      out.write("                stockOutRowCounter = 0;\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            console.log('Loading contract info for ID:', contractId);\r\n");
      out.write("            \r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { action: 'getContractInfo', contractId: contractId },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    console.log('Contract info response:', response);\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        var data = response.data;\r\n");
      out.write("                        \r\n");
      out.write("                        // Đảm bảo contract number được hiển thị trong dropdown\r\n");
      out.write("                        var contractSelect = $('#stockOutContractId');\r\n");
      out.write("                        if (contractSelect.val() != contractId) {\r\n");
      out.write("                            contractSelect.val(contractId);\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Đảm bảo dropdown hiển thị đúng contract number\r\n");
      out.write("                        var selectedOption = contractSelect.find('option:selected');\r\n");
      out.write("                        if (selectedOption.length === 0 || selectedOption.val() != contractId) {\r\n");
      out.write("                            // Nếu không tìm thấy option, thử tìm lại\r\n");
      out.write("                            var option = contractSelect.find('option[value=\"' + contractId + '\"]');\r\n");
      out.write("                            if (option.length > 0) {\r\n");
      out.write("                                contractSelect.val(contractId);\r\n");
      out.write("                                console.log('Contract number displayed:', option.text());\r\n");
      out.write("                            } else {\r\n");
      out.write("                                console.warn('Contract option not found in dropdown for ID:', contractId);\r\n");
      out.write("                            }\r\n");
      out.write("                        } else {\r\n");
      out.write("                            console.log('Contract number displayed:', selectedOption.text());\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Hiển thị tên khách hàng\r\n");
      out.write("                        $('#stockOutCustomerName').val(data.customerName || '');\r\n");
      out.write("                        \r\n");
      out.write("                        // Xóa tất cả sản phẩm hiện tại trong bảng\r\n");
      out.write("                        $('#stockOutProductsBody').empty();\r\n");
      out.write("                        stockOutRowCounter = 0;\r\n");
      out.write("                        \r\n");
      out.write("                        // Tự động thêm sản phẩm từ hợp đồng vào bảng\r\n");
      out.write("                        if (data.products && data.products.length > 0) {\r\n");
      out.write("                            data.products.forEach(function(product) {\r\n");
      out.write("                                stockOutRowCounter++;\r\n");
      out.write("                                var rowId = 'stockOutRow_' + stockOutRowCounter;\r\n");
      out.write("                                var tbody = $('#stockOutProductsBody');\r\n");
      out.write("                                \r\n");
      out.write("                                var row = '<tr id=\"' + rowId + '\">' +\r\n");
      out.write("                                    '<td style=\"text-align: center; vertical-align: middle;\">' + stockOutRowCounter + '</td>' +\r\n");
      out.write("                                    '<td>' +\r\n");
      out.write("                                        '<select class=\"form-control stockOutProductSelect\" data-row-id=\"' + rowId + '\" required>' +\r\n");
      out.write("                                        '</select>' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                    '<td style=\"vertical-align: middle;\">' +\r\n");
      out.write("                                        '<input type=\"text\" class=\"form-control stockOutProductName\" readonly style=\"background-color: #f5f5f5;\">' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                    '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                                        '<input type=\"text\" class=\"form-control stockOutProductUnit\" readonly style=\"background-color: #f5f5f5; text-align: center;\">' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                    '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                                        '<span class=\"stockOutCurrentStock\" style=\"font-weight: bold; color: #5cb85c;\">--</span>' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                    '<td>' +\r\n");
      out.write("                                        '<input type=\"number\" class=\"form-control stockOutQuantity\" min=\"1\" value=\"' + (product.quantity && product.quantity > 0 ? product.quantity : '') + '\" required placeholder=\"Nhập số lượng\" style=\"text-align: right;\">' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                    '<td style=\"text-align: center; vertical-align: middle;\">' +\r\n");
      out.write("                                        '<button type=\"button\" class=\"btn btn-danger btn-xs\" onclick=\"removeStockOutRow(\\'' + rowId + '\\')\" title=\"Xóa dòng\">' +\r\n");
      out.write("                                            '<i class=\"fa fa-trash\"></i> Xóa' +\r\n");
      out.write("                                        '</button>' +\r\n");
      out.write("                                    '</td>' +\r\n");
      out.write("                                '</tr>';\r\n");
      out.write("                                \r\n");
      out.write("                                tbody.append(row);\r\n");
      out.write("                                \r\n");
      out.write("                                // Render options cho dropdown sản phẩm\r\n");
      out.write("                                var selectEl = $('#' + rowId + ' .stockOutProductSelect');\r\n");
      out.write("                                renderStockOutProductOptions(selectEl);\r\n");
      out.write("                                \r\n");
      out.write("                                // Chọn sản phẩm từ hợp đồng và cập nhật thông tin\r\n");
      out.write("                                var rowEl = $('#' + rowId);\r\n");
      out.write("                                setTimeout(function() {\r\n");
      out.write("                                    selectEl.val(product.productId);\r\n");
      out.write("                                    var selectedOption = selectEl.find('option:selected');\r\n");
      out.write("                                    if (selectedOption.length > 0) {\r\n");
      out.write("                                        rowEl.find('.stockOutProductName').val(selectedOption.data('name') || product.productName || '');\r\n");
      out.write("                                        rowEl.find('.stockOutProductUnit').val(selectedOption.data('unit') || product.unit || '');\r\n");
      out.write("                                    } else {\r\n");
      out.write("                                        // Nếu không tìm thấy trong dropdown, dùng thông tin từ hợp đồng\r\n");
      out.write("                                        rowEl.find('.stockOutProductName').val(product.productName || '');\r\n");
      out.write("                                        rowEl.find('.stockOutProductUnit').val(product.unit || '');\r\n");
      out.write("                                    }\r\n");
      out.write("                                    \r\n");
      out.write("                                    // Load tồn khả dụng\r\n");
      out.write("                                    var warehouse = $('#stockOutWarehouse').val();\r\n");
      out.write("                                    loadCurrentStock(product.productId, warehouse, rowEl);\r\n");
      out.write("                                }, 100);\r\n");
      out.write("                                \r\n");
      out.write("                                // Gán sự kiện change cho dropdown sản phẩm\r\n");
      out.write("                                selectEl.off('change').on('change', function() {\r\n");
      out.write("                                    var row = $(this).closest('tr');\r\n");
      out.write("                                    var selectedOption = $(this).find('option:selected');\r\n");
      out.write("                                    var productId = $(this).val();\r\n");
      out.write("                                    var warehouse = $('#stockOutWarehouse').val();\r\n");
      out.write("                                    \r\n");
      out.write("                                    if (productId) {\r\n");
      out.write("                                        row.find('.stockOutProductName').val(selectedOption.data('name') || '');\r\n");
      out.write("                                        row.find('.stockOutProductUnit').val(selectedOption.data('unit') || '');\r\n");
      out.write("                                        loadCurrentStock(productId, warehouse, row);\r\n");
      out.write("                                    } else {\r\n");
      out.write("                                        row.find('.stockOutProductName').val('');\r\n");
      out.write("                                        row.find('.stockOutProductUnit').val('');\r\n");
      out.write("                                        row.find('.stockOutCurrentStock').text('--').attr('title', '');\r\n");
      out.write("                                    }\r\n");
      out.write("                                });\r\n");
      out.write("                                \r\n");
      out.write("                                // Validate số lượng xuất không vượt quá tồn kho\r\n");
      out.write("                                $('#' + rowId + ' .stockOutQuantity').off('input').on('input', function() {\r\n");
      out.write("                                    var row = $(this).closest('tr');\r\n");
      out.write("                                    var quantity = parseInt($(this).val()) || 0;\r\n");
      out.write("                                    var currentStock = parseInt(row.find('.stockOutCurrentStock').text()) || 0;\r\n");
      out.write("                                    \r\n");
      out.write("                                    if (quantity > currentStock) {\r\n");
      out.write("                                        $(this).css('border-color', '#d9534f');\r\n");
      out.write("                                        alert('Số lượng xuất (' + quantity + ') không được vượt quá tồn kho khả dụng (' + currentStock + ')!');\r\n");
      out.write("                                        $(this).val(currentStock);\r\n");
      out.write("                                    } else {\r\n");
      out.write("                                        $(this).css('border-color', '');\r\n");
      out.write("                                    }\r\n");
      out.write("                                });\r\n");
      out.write("                            });\r\n");
      out.write("                            \r\n");
      out.write("                            // Cập nhật lại STT cho tất cả các dòng\r\n");
      out.write("                            updateStockOutRowNumbers();\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Không thể tải thông tin hợp đồng: ' + (response.message || ''));\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading contract info:', error);\r\n");
      out.write("                    alert('Lỗi khi tải thông tin hợp đồng: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        }\r\n");
      out.write("        \r\n");
      out.write("        // Thiết lập mặc định khi mở modal xuất kho\r\n");
      out.write("        $('#stockOutModal').on('shown.bs.modal', function() {\r\n");
      out.write("            // Nếu đang load từ exportStockForContract, không reset form\r\n");
      out.write("            if (isExportingFromContract) {\r\n");
      out.write("                console.log('Skipping form reset - loading from contract export');\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Lấy ngày hiện tại từ server (backend sẽ set mặc định)\r\n");
      out.write("            // Frontend chỉ set nếu chưa có giá trị\r\n");
      out.write("            if (!$('#stockOutDate').val()) {\r\n");
      out.write("                var today = new Date();\r\n");
      out.write("                var yyyy = today.getFullYear();\r\n");
      out.write("                var mm = ('0' + (today.getMonth() + 1)).slice(-2);\r\n");
      out.write("                var dd = ('0' + today.getDate()).slice(-2);\r\n");
      out.write("                $('#stockOutDate').val(yyyy + '-' + mm + '-' + dd);\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Load danh sách hợp đồng\r\n");
      out.write("            loadContractsForDropdown();\r\n");
      out.write("            \r\n");
      out.write("            // Reset các trường hợp đồng và khách hàng\r\n");
      out.write("            $('#stockOutContractId').val('');\r\n");
      out.write("            $('#stockOutCustomerName').val('');\r\n");
      out.write("            \r\n");
      out.write("            // Reset bảng và thêm dòng đầu tiên\r\n");
      out.write("            $('#stockOutProductsBody').empty();\r\n");
      out.write("            stockOutRowCounter = 0;\r\n");
      out.write("            addStockOutRow();\r\n");
      out.write("        });\r\n");
      out.write("        \r\n");
      out.write("        // Xử lý khi chọn hợp đồng - gọi backend để load thông tin\r\n");
      out.write("        $('#stockOutContractId').on('change', function() {\r\n");
      out.write("            var contractId = $(this).val();\r\n");
      out.write("            if (!contractId || contractId === '') {\r\n");
      out.write("                $('#stockOutCustomerName').val('');\r\n");
      out.write("                $('#stockOutProductsBody').empty();\r\n");
      out.write("                stockOutRowCounter = 0;\r\n");
      out.write("                return;\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            var selectedOption = $(this).find('option:selected');\r\n");
      out.write("            var customerName = selectedOption.data('customer-name') || '';\r\n");
      out.write("            \r\n");
      out.write("            // Cập nhật tên khách hàng tạm thời từ dropdown (sẽ được cập nhật từ backend)\r\n");
      out.write("            if (customerName) {\r\n");
      out.write("                $('#stockOutCustomerName').val(customerName);\r\n");
      out.write("            }\r\n");
      out.write("            \r\n");
      out.write("            // Gọi backend để load thông tin đầy đủ (sản phẩm, tồn kho, ngày mặc định)\r\n");
      out.write("            var warehouse = $('#stockOutWarehouse').val() || 'Main Warehouse';\r\n");
      out.write("            $.ajax({\r\n");
      out.write("                url: '");
      out.print(request.getContextPath());
      out.write("/inventory',\r\n");
      out.write("                type: 'GET',\r\n");
      out.write("                data: { \r\n");
      out.write("                    action: 'getContractInfoForStockOut', \r\n");
      out.write("                    contractId: contractId,\r\n");
      out.write("                    warehouse: warehouse\r\n");
      out.write("                },\r\n");
      out.write("                dataType: 'json',\r\n");
      out.write("                success: function(response) {\r\n");
      out.write("                    if (response.success && response.data) {\r\n");
      out.write("                        var data = response.data;\r\n");
      out.write("                        \r\n");
      out.write("                        // Cập nhật tên khách hàng từ backend\r\n");
      out.write("                        $('#stockOutCustomerName').val(data.customerName || '');\r\n");
      out.write("                        \r\n");
      out.write("                        // Set ngày mặc định từ backend (nếu chưa có giá trị)\r\n");
      out.write("                        if (data.defaultDate && !$('#stockOutDate').val()) {\r\n");
      out.write("                            $('#stockOutDate').val(data.defaultDate);\r\n");
      out.write("                        }\r\n");
      out.write("                        \r\n");
      out.write("                        // Xóa tất cả sản phẩm hiện tại\r\n");
      out.write("                        $('#stockOutProductsBody').empty();\r\n");
      out.write("                        stockOutRowCounter = 0;\r\n");
      out.write("                        \r\n");
      out.write("                        // Thêm sản phẩm từ backend\r\n");
      out.write("                        if (data.products && data.products.length > 0) {\r\n");
      out.write("                            data.products.forEach(function(product) {\r\n");
      out.write("                                addProductRowFromBackend(product, warehouse);\r\n");
      out.write("                            });\r\n");
      out.write("                        }\r\n");
      out.write("                    } else {\r\n");
      out.write("                        alert('Lỗi khi tải thông tin hợp đồng: ' + (response.message || 'Unknown error'));\r\n");
      out.write("                    }\r\n");
      out.write("                },\r\n");
      out.write("                error: function(xhr, status, error) {\r\n");
      out.write("                    console.error('Error loading contract info:', error);\r\n");
      out.write("                    alert('Lỗi khi tải thông tin hợp đồng: ' + error);\r\n");
      out.write("                }\r\n");
      out.write("            });\r\n");
      out.write("        });\r\n");
      out.write("\r\n");
      out.write("        // Cập nhật nút phân trang (backend-driven)\r\n");
      out.write("        function updatePaginationButtons(totalPages) {\r\n");
      out.write("            var pagination = $('#pagination');\r\n");
      out.write("            pagination.empty();\r\n");
      out.write("            var prevLi = $('<li class=\"paginate_button ' + (currentPage <= 1 ? 'disabled' : '') + '\"><a href=\"#\">Trước</a></li>');\r\n");
      out.write("            prevLi.on('click', function(e){ e.preventDefault(); if (currentPage > 1) { currentPage--; loadContractsData(); } });\r\n");
      out.write("            pagination.append(prevLi);\r\n");
      out.write("            var maxVisible = 5;\r\n");
      out.write("            var start = Math.max(1, currentPage - Math.floor(maxVisible/2));\r\n");
      out.write("            var end = Math.min(totalPages, start + maxVisible - 1);\r\n");
      out.write("            if (end - start + 1 < maxVisible) start = Math.max(1, end - maxVisible + 1);\r\n");
      out.write("            for (var p = start; p <= end; p++) {\r\n");
      out.write("                (function(page){\r\n");
      out.write("                    var li = $('<li class=\"paginate_button ' + (page === currentPage ? 'active' : '') + '\"><a href=\"#\">' + page + '</a></li>');\r\n");
      out.write("                    li.on('click', function(e){ e.preventDefault(); currentPage = page; loadContractsData(); });\r\n");
      out.write("                    pagination.append(li);\r\n");
      out.write("                })(p);\r\n");
      out.write("            }\r\n");
      out.write("            var nextLi = $('<li class=\"paginate_button ' + (currentPage >= totalPages ? 'disabled' : '') + '\"><a href=\"#\">Tiếp</a></li>');\r\n");
      out.write("            nextLi.on('click', function(e){ e.preventDefault(); if (currentPage < totalPages) { currentPage++; loadContractsData(); } });\r\n");
      out.write("            pagination.append(nextLi);\r\n");
      out.write("        }\r\n");
      out.write("    </script>\r\n");
      out.write("</body>\r\n");
      out.write("</html>\r\n");
      out.write("\r\n");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}

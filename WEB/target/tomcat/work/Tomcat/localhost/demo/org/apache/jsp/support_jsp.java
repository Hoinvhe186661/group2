/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: Apache Tomcat/7.0.47
 * Generated at: 2025-11-13 07:15:47 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import java.util.Set;
import com.hlgenerator.dao.SettingsDAO;
import java.util.Map;
import com.hlgenerator.dao.SettingsDAO;
import com.hlgenerator.dao.ProductDAO;
import java.util.Map;
import java.util.List;
import java.net.URLEncoder;

public final class support_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  static {
    _jspx_dependants = new java.util.HashMap<java.lang.String,java.lang.Long>(2);
    _jspx_dependants.put("/footer.jsp", Long.valueOf(1762992088858L));
    _jspx_dependants.put("/header.jsp", Long.valueOf(1762992088859L));
  }

  private org.apache.jasper.runtime.TagHandlerPool _005fjspx_005ftagPool_005fc_005fchoose;
  private org.apache.jasper.runtime.TagHandlerPool _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest;
  private org.apache.jasper.runtime.TagHandlerPool _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody;
  private org.apache.jasper.runtime.TagHandlerPool _005fjspx_005ftagPool_005fc_005fif_0026_005ftest;
  private org.apache.jasper.runtime.TagHandlerPool _005fjspx_005ftagPool_005fc_005fotherwise;

  private javax.el.ExpressionFactory _el_expressionfactory;
  private org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public void _jspInit() {
    _005fjspx_005ftagPool_005fc_005fchoose = org.apache.jasper.runtime.TagHandlerPool.getTagHandlerPool(getServletConfig());
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest = org.apache.jasper.runtime.TagHandlerPool.getTagHandlerPool(getServletConfig());
    _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody = org.apache.jasper.runtime.TagHandlerPool.getTagHandlerPool(getServletConfig());
    _005fjspx_005ftagPool_005fc_005fif_0026_005ftest = org.apache.jasper.runtime.TagHandlerPool.getTagHandlerPool(getServletConfig());
    _005fjspx_005ftagPool_005fc_005fotherwise = org.apache.jasper.runtime.TagHandlerPool.getTagHandlerPool(getServletConfig());
    _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
    _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
  }

  public void _jspDestroy() {
    _005fjspx_005ftagPool_005fc_005fchoose.release();
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.release();
    _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody.release();
    _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.release();
    _005fjspx_005ftagPool_005fc_005fotherwise.release();
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
        throws java.io.IOException, javax.servlet.ServletException {

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=UTF-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write('\n');
      out.write('\n');



    // Kiểm tra đăng nhập
    String username = (String) session.getAttribute("username");
    Boolean isLoggedIn = (Boolean) session.getAttribute("isLoggedIn");
    String userRole = (String) session.getAttribute("userRole");
    
    if (username == null || isLoggedIn == null || !isLoggedIn) {
        response.sendRedirect(request.getContextPath() + "/login.jsp");
        return;
    }
    
    // Kiểm tra quyền: chỉ người có quyền submit_support_request mới truy cập được
    @SuppressWarnings("unchecked")
    Set<String> userPermissions = (Set<String>) session.getAttribute("userPermissions");
    if (userPermissions == null || !userPermissions.contains("submit_support_request")) {
        response.sendRedirect(request.getContextPath() + "/error/403.jsp");
        return;
    }

      out.write("\n");
      out.write("<!DOCTYPE html>\n");
      out.write("<html lang=\"vi\">\n");
      out.write("<head>\n");
      out.write("    <meta charset=\"UTF-8\">\n");
      out.write("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n");
      out.write("    <title>Công ty CP Chế tạo máy Hoà Lạc - Chuyên cung cấp máy phát điện chính hãng</title>\n");
      out.write("    <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n");
      out.write("    <link href=\"https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap\" rel=\"stylesheet\">\n");
      out.write("    \n");
      out.write("    <style>\n");
      out.write("        :root { --primary-red:#dc3545; --text-dark:#343a40; }\n");
      out.write("        .top-header { background: var(--primary-red); color:#ffffff; padding:8px 0; font-size:14px; }\n");
      out.write("        .header-text { font-weight:600; text-transform:uppercase; }\n");
      out.write("        .contact-info { margin-right:20px; }\n");
      out.write("\n");
      out.write("        /* Navbar tweaks */\n");
      out.write("        .navbar { box-shadow:0 2px 10px rgba(0,0,0,0.06); }\n");
      out.write("        .navbar .nav-link { color: var(--text-dark); font-weight:500; text-transform:uppercase; }\n");
      out.write("        .navbar .nav-link:hover, .navbar .nav-link.active { color: var(--primary-red); }\n");
      out.write("\n");
      out.write("        /* Search */\n");
      out.write("        .search-container { position:relative; margin:0 20px; }\n");
      out.write("        .search-input { width:300px; max-width:42vw; padding:12px 45px 12px 15px; border:1px solid #dee2e6; border-radius:25px; font-size:14px; }\n");
      out.write("        .search-icon { position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#6c757d; }\n");
      out.write("        .phone-number { color:var(--primary-red); font-weight:600; }\n");
      out.write("\n");
      out.write("        /* Support header */\n");
      out.write("        .support-header { background:#ffffff; border:1px solid #eee; border-radius:12px; padding:14px 16px; box-shadow:0 4px 16px rgba(0,0,0,0.05); }\n");
      out.write("        .support-title { margin:0; color:var(--text-dark); font-weight:700; letter-spacing:.2px; }\n");
      out.write("        .create-request-link { color:var(--primary-red); text-decoration:none; font-weight:500; }\n");
      out.write("        .create-request-link:hover { text-decoration:underline; }\n");
      out.write("\n");
      out.write("        /* Table style */\n");
      out.write("        .support-table thead th { background:#f8f9fa; color:#495057; font-weight:600; border-bottom:2px solid #e9ecef; }\n");
      out.write("        .support-table tbody tr:hover { background:#fffafa; }\n");
      out.write("\n");
      out.write("        /* Pagination */\n");
      out.write("        .custom-pagination .page-link { color:var(--text-dark); border:none; border-radius:8px; margin:0 3px; }\n");
      out.write("        .custom-pagination .page-item.active .page-link, .custom-pagination .page-link:hover { background:var(--primary-red); color:#fff; }\n");
      out.write("\n");
      out.write("        /* Floating icons */\n");
      out.write("        .floating-icons { position:fixed; right:18px; bottom:18px; z-index:1030; }\n");
      out.write("        .floating-icon { width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#ffffff; color:var(--text-dark); box-shadow:0 6px 20px rgba(0,0,0,0.12); margin:8px 0; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, color .2s ease; }\n");
      out.write("        .floating-icon:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.16); color:var(--primary-red); }\n");
      out.write("\n");
      out.write("        /* Modal header */\n");
      out.write("        .modal-header { background:#f8f9fa; }\n");
      out.write("        .btn-success { background:#28a745; border-color:#28a745; }\n");
      out.write("        .btn-danger { background:#dc3545; border-color:#dc3545; }\n");
      out.write("        \n");
      out.write("        /* Khung cho các trường thông tin */\n");
      out.write("        .form-control-plaintext { \n");
      out.write("            background: #ffffff; \n");
      out.write("            border: 1px solid #ced4da; \n");
      out.write("            border-radius: 6px; \n");
      out.write("            padding: 0.75rem; \n");
      out.write("            margin-bottom: 0.5rem;\n");
      out.write("            min-height: 2.5rem;\n");
      out.write("            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Khung cho textarea */\n");
      out.write("        .form-control { \n");
      out.write("            border: 1px solid #ced4da; \n");
      out.write("            border-radius: 6px; \n");
      out.write("            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Khung cho modal */\n");
      out.write("        .modal-content { \n");
      out.write("            border: 2px solid #dee2e6; \n");
      out.write("            box-shadow: 0 8px 32px rgba(0,0,0,0.1); \n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Padding cho modal body */\n");
      out.write("        .modal-body { \n");
      out.write("            padding: 2rem; \n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Styling cho labels */\n");
      out.write("        .modal-body label { \n");
      out.write("            font-weight: 600; \n");
      out.write("            color: #495057; \n");
      out.write("            margin-bottom: 0.5rem; \n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Focus state */\n");
      out.write("        .form-control:focus { \n");
      out.write("            border-color: #80bdff; \n");
      out.write("            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); \n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Success notification modal - Compact alert style */\n");
      out.write("        .success-modal .modal-dialog {\n");
      out.write("            max-width: 320px;\n");
      out.write("            width: 90%;\n");
      out.write("            margin: 2% auto;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-modal .modal-content {\n");
      out.write("            border: 1px solid #ccc;\n");
      out.write("            border-radius: 6px;\n");
      out.write("            box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n");
      out.write("            background: white;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-modal .modal-header {\n");
      out.write("            background: #f8f9fa;\n");
      out.write("            border-bottom: 1px solid #dee2e6;\n");
      out.write("            border-radius: 6px 6px 0 0;\n");
      out.write("            padding: 0.5rem 0.75rem;\n");
      out.write("            font-size: 0.85rem;\n");
      out.write("            font-weight: 500;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-modal .modal-body {\n");
      out.write("            padding: 0.75rem;\n");
      out.write("            text-align: left;\n");
      out.write("            font-size: 0.85rem;\n");
      out.write("            line-height: 1.3;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-modal .modal-footer {\n");
      out.write("            border-top: 1px solid #dee2e6;\n");
      out.write("            padding: 0.4rem 0.75rem;\n");
      out.write("            justify-content: flex-end;\n");
      out.write("            gap: 0.4rem;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-btn {\n");
      out.write("            background: #007bff;\n");
      out.write("            border: 1px solid #007bff;\n");
      out.write("            color: white;\n");
      out.write("            padding: 0.3rem 0.6rem;\n");
      out.write("            border-radius: 3px;\n");
      out.write("            font-size: 0.8rem;\n");
      out.write("            font-weight: 400;\n");
      out.write("            cursor: pointer;\n");
      out.write("            transition: background-color 0.15s ease-in-out;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-btn:hover {\n");
      out.write("            background: #0056b3;\n");
      out.write("            border-color: #0056b3;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .success-btn:focus {\n");
      out.write("            outline: none;\n");
      out.write("            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        /* Cancel button style */\n");
      out.write("        .cancel-btn {\n");
      out.write("            background: #6c757d;\n");
      out.write("            border: 1px solid #6c757d;\n");
      out.write("            color: white;\n");
      out.write("            padding: 0.3rem 0.6rem;\n");
      out.write("            border-radius: 3px;\n");
      out.write("            font-size: 0.8rem;\n");
      out.write("            font-weight: 400;\n");
      out.write("            cursor: pointer;\n");
      out.write("            transition: background-color 0.15s ease-in-out;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .cancel-btn:hover {\n");
      out.write("            background: #545b62;\n");
      out.write("            border-color: #545b62;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        .cancel-btn:focus {\n");
      out.write("            outline: none;\n");
      out.write("            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);\n");
      out.write("        }\n");
      out.write("    </style>\n");
      out.write("    </head>\n");
      out.write("    <body>\n");
      out.write("    <!-- Top Header -->\n");
      out.write("    ");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

    // Luôn load settings mới nhất từ database để đảm bảo hiển thị đúng giá trị đã cập nhật
    SettingsDAO headerSettingsDAO = new SettingsDAO();
    Map<String, String> headerSettings = headerSettingsDAO.getAllSettings();
    
    // Lấy các giá trị settings, nếu không có thì dùng giá trị mặc định
    String headerSiteName = headerSettings.get("site_name") != null ? headerSettings.get("site_name") : "HOÀ LẠC ELECTRIC INDUSTRIAL GENERATOR";
    String headerSiteDescription = headerSettings.get("site_description") != null ? headerSettings.get("site_description") : "MÁY PHÁT ĐIỆN CÔNG NGHIỆP";
    String headerSiteEmail = headerSettings.get("site_email") != null ? headerSettings.get("site_email") : "Mayphatdienhoalac@gmail.com";
    String headerSitePhone = headerSettings.get("site_phone") != null ? headerSettings.get("site_phone") : "0989.888.999";
    String headerSiteAddress = headerSettings.get("site_address") != null ? headerSettings.get("site_address") : "";
    
    // Lưu vào pageContext để dùng lại trong cùng request (nhưng các trang khác sẽ load lại từ DB)
    pageContext.setAttribute("siteName", headerSiteName);
    pageContext.setAttribute("siteDescription", headerSiteDescription);
    pageContext.setAttribute("siteEmail", headerSiteEmail);
    pageContext.setAttribute("sitePhone", headerSitePhone);
    pageContext.setAttribute("siteAddress", headerSiteAddress);

      out.write('\r');
      out.write('\n');
      out.write("\r\n");
      out.write("<style>\r\n");
      out.write("    .top-header { background: #dc3545; color: #ffffff; padding: 8px 0; font-size: 14px; }\r\n");
      out.write("    .header-text { font-weight: 600; text-transform: uppercase; }\r\n");
      out.write("    .contact-info { margin-right: 20px; }\r\n");
      out.write("    .header-navbar { background: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px 0; }\r\n");
      out.write("    .menu-navbar { background: #eeeeee; border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5; padding: 8px 0; }\r\n");
      out.write("    .logo-container { display:flex; align-items:center; }\r\n");
      out.write("    .logo-icon { width:60px; height:60px; border-radius:50%; margin-right:15px; overflow:hidden; }\r\n");
      out.write("    .logo-icon img { width:100%; height:100%; object-fit:cover; }\r\n");
      out.write("    .logo-text { color:#343a40; font-size:16px; font-weight:600; line-height:1.2; }\r\n");
      out.write("    .contact-info-nav { display:flex; align-items:center; gap:20px; }\r\n");
      out.write("    .phone-number { color:#dc3545; font-weight:600; font-size:16px; }\r\n");
      out.write("    .nav-icons { display:flex; gap:15px; }\r\n");
      out.write("    .nav-icons i { font-size:20px; color:#343a40; cursor:pointer; }\r\n");
      out.write("    .nav-icons a { color: inherit; text-decoration: none; transition: color 0.3s ease; }\r\n");
      out.write("    .nav-icons a:hover { color: #dc3545; }\r\n");
      out.write("    .management-icon-link { \r\n");
      out.write("        position: relative; \r\n");
      out.write("        display: inline-flex; \r\n");
      out.write("        align-items: center;\r\n");
      out.write("        justify-content: center;\r\n");
      out.write("        width: 32px;\r\n");
      out.write("        height: 32px;\r\n");
      out.write("        border-radius: 50%;\r\n");
      out.write("        background: linear-gradient(135deg, #dc3545, #c82333);\r\n");
      out.write("        color: white !important;\r\n");
      out.write("        margin-right: 10px;\r\n");
      out.write("        transition: all 0.3s ease;\r\n");
      out.write("        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);\r\n");
      out.write("    }\r\n");
      out.write("    .management-icon-link:hover { \r\n");
      out.write("        color: white !important; \r\n");
      out.write("        transform: translateY(-2px);\r\n");
      out.write("        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.5);\r\n");
      out.write("    }\r\n");
      out.write("    .management-icon-link i { \r\n");
      out.write("        font-size: 15px; \r\n");
      out.write("        color: white;\r\n");
      out.write("    }\r\n");
      out.write("    .navbar-nav .nav-link { color:#343a40 !important; font-weight:500; margin:0 8px; padding:8px 12px !important; text-transform:uppercase; font-size:14px; }\r\n");
      out.write("    .navbar-nav .nav-link:hover { color:#dc3545 !important; }\r\n");
      out.write("    .navbar-nav .nav-link.active { color:#dc3545 !important; font-weight:700; }\r\n");
      out.write("    /* Floating toast styles (global notification) */\r\n");
      out.write("    .floating-toast-container {\r\n");
      out.write("        position: fixed;\r\n");
      out.write("        top: 20px;\r\n");
      out.write("        right: 20px;\r\n");
      out.write("        z-index: 99999;\r\n");
      out.write("        display: flex;\r\n");
      out.write("        flex-direction: column;\r\n");
      out.write("        gap: 10px;\r\n");
      out.write("        pointer-events: none; /* allow clicks through when no toast */\r\n");
      out.write("    }\r\n");
      out.write("    .floating-toast {\r\n");
      out.write("        min-width: 280px;\r\n");
      out.write("        max-width: 420px;\r\n");
      out.write("        padding: 12px 16px;\r\n");
      out.write("        border-radius: 8px;\r\n");
      out.write("        color: #fff;\r\n");
      out.write("        font-weight: 600;\r\n");
      out.write("        box-shadow: 0 8px 20px rgba(0,0,0,0.15);\r\n");
      out.write("        pointer-events: auto; /* allow interacting with buttons inside */\r\n");
      out.write("        opacity: 0;\r\n");
      out.write("        transform: translateY(-10px) scale(0.98);\r\n");
      out.write("        transition: opacity 220ms ease, transform 220ms ease;\r\n");
      out.write("    }\r\n");
      out.write("    .floating-toast.show { opacity: 1; transform: translateY(0) scale(1); }\r\n");
      out.write("    .floating-toast.success { background: #28a745; }\r\n");
      out.write("    .floating-toast.danger { background: #dc3545; }\r\n");
      out.write("    .floating-toast.info { background: #17a2b8; }\r\n");
      out.write("    .floating-toast.warning { background: #ffc107; color: #212529; }\r\n");
      out.write("    .floating-toast .toast-close { float: right; margin-left: 8px; cursor: pointer; font-weight: 700; }\r\n");
      out.write("</style>\r\n");
      out.write("\r\n");
      out.write("<div class=\"top-header\" data-logged-in=\"");
      out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.isLoggedIn eq true}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
      out.write("\">\r\n");
      out.write("    <div class=\"container\">\r\n");
      out.write("        <div class=\"row align-items-center\">\r\n");
      out.write("            <div class=\"col-md-6\"><span class=\"header-text\">");
      out.print( pageContext.getAttribute("siteDescription") != null ? pageContext.getAttribute("siteDescription") : "MÁY PHÁT ĐIỆN CÔNG NGHIỆP" );
      out.write("</span></div>\r\n");
      out.write("            <div class=\"col-md-6 text-end\">\r\n");
      out.write("                <span class=\"contact-info\"><i class=\"fas fa-envelope\"></i> ");
      out.print( pageContext.getAttribute("siteEmail") != null ? pageContext.getAttribute("siteEmail") : "Mayphatdienhoalac@gmail.com" );
      out.write("</span>\r\n");
      out.write("                <span class=\"contact-info\"><i class=\"fas fa-clock\"></i> 08:00 - 17:00</span>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</div>\r\n");
      out.write("\r\n");
      out.write("<nav class=\"navbar header-navbar navbar-expand-lg navbar-light bg-white\" aria-label=\"Thanh điều hướng logo, tìm kiếm và tài khoản\">\r\n");
      out.write("    <div class=\"container\">\r\n");
      out.write("        <a class=\"navbar-brand\" href=\"index.jsp\">\r\n");
      out.write("            <div class=\"logo-container\">\r\n");
      out.write("                <div class=\"logo-icon\">\r\n");
      out.write("                    <img src=\"images/banner-logo.png\" alt=\"Logo Hoà Lạc\" onerror=\"this.style.display='none'; this.nextElementSibling.style.display='flex';\">\r\n");
      out.write("                    <div style=\"display:none; width:100%; height:100%; background:#dc3545; border-radius:50%; align-items:center; justify-content:center; color:white; font-size:20px;\">★</div>\r\n");
      out.write("                </div>\r\n");
      out.write("                <div class=\"logo-text\"><strong>");
      out.print( pageContext.getAttribute("siteName") != null ? pageContext.getAttribute("siteName") : "HOÀ LẠC ELECTRIC INDUSTRIAL GENERATOR" );
      out.write("</strong></div>\r\n");
      out.write("            </div>\r\n");
      out.write("        </a>\r\n");
      out.write("        <div class=\"contact-info-nav\">\r\n");
      out.write("            <div class=\"phone-number\"><i class=\"fas fa-phone\"></i> ");
      out.print( pageContext.getAttribute("sitePhone") != null ? pageContext.getAttribute("sitePhone") : "0989.888.999" );
      out.write("</div>\r\n");
      out.write("            <div class=\"nav-icons\">\r\n");
      out.write("                ");
      if (_jspx_meth_c_005fchoose_005f0(_jspx_page_context))
        return;
      out.write("\r\n");
      out.write("                <i class=\"fas fa-shopping-bag\"></i>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</nav>\r\n");
      out.write("\r\n");
      out.write("<nav class=\"menu-navbar\" aria-label=\"Thanh menu chính\">\r\n");
      out.write("    <div class=\"container\">\r\n");
      out.write("        <ul class=\"navbar-nav flex-row justify-content-center w-100\">\r\n");
      out.write("            <li class=\"nav-item\"><a class=\"nav-link\" href=\"index.jsp\" id=\"nav-home\">TRANG CHỦ</a></li>\r\n");
      out.write("            <li class=\"nav-item\"><a class=\"nav-link\" href=\"about.jsp\" id=\"nav-about\">GIỚI THIỆU</a></li>\r\n");
      out.write("            <li class=\"nav-item\"><a class=\"nav-link\" href=\"guest-products\">MÁY PHÁT ĐIỆN</a></li>\r\n");
      out.write("          \r\n");
      out.write("            \r\n");
      out.write("           \r\n");
      out.write("            <li class=\"nav-item\"><a class=\"nav-link\" href=\"contact.jsp\" id=\"nav-contact\">LIÊN HỆ</a></li>\r\n");
      out.write("            ");
      if (_jspx_meth_c_005fif_005f1(_jspx_page_context))
        return;
      out.write("\r\n");
      out.write("        </ul>\r\n");
      out.write("    </div>\r\n");
      out.write("</nav>\r\n");
      out.write("\r\n");
      out.write("<script>\r\n");
      out.write("// Auto-set active menu item based on current page\r\n");
      out.write("document.addEventListener('DOMContentLoaded', function() {\r\n");
      out.write("    const currentPage = window.location.pathname.split('/').pop();\r\n");
      out.write("    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');\r\n");
      out.write("    \r\n");
      out.write("    navLinks.forEach(link => {\r\n");
      out.write("        link.classList.remove('active');\r\n");
      out.write("        const href = link.getAttribute('href');\r\n");
      out.write("        \r\n");
      out.write("        if (href === 'index.jsp' && (currentPage === 'index.jsp' || currentPage === '')) {\r\n");
      out.write("            link.classList.add('active');\r\n");
      out.write("        } else if (href === 'about.jsp' && currentPage === 'about.jsp') {\r\n");
      out.write("            link.classList.add('active');\r\n");
      out.write("        } else if (href === 'support.jsp' && currentPage === 'support.jsp') {\r\n");
      out.write("            link.classList.add('active');\r\n");
      out.write("        } else if ((href === 'contact' || href === 'contact.jsp') && (currentPage === 'contact' || currentPage === 'contact.jsp')) {\r\n");
      out.write("            link.classList.add('active');\r\n");
      out.write("        }\r\n");
      out.write("    });\r\n");
      out.write("});\r\n");
      out.write("\r\n");
      out.write("// Note: auto-logout on tab close was removed to avoid logging out on refresh\r\n");
      out.write("</script>\r\n");
      out.write("<!-- Global toast container will be created by notify.js if not present -->\r\n");
      out.write("<div id=\"toastContainer\" class=\"floating-toast-container\" aria-live=\"polite\" aria-atomic=\"true\"></div>\r\n");
      out.write("<script src=\"js/notify.js\"></script>");
      out.write("\n");
      out.write("    \n");
      out.write("    \n");
      out.write("\n");
      out.write("    \n");
      out.write("    \n");
      out.write("\n");
      out.write("    <div class=\"container mt-4\">\n");
      out.write("    <div class=\"support-header mb-3 d-flex justify-content-between align-items-center\">\n");
      out.write("        <div>\n");
      out.write("            <h4 class=\"support-title\">Yêu cầu hỗ trợ</h4>\n");
      out.write("            <a href=\"#\" class=\"create-request-link\" data-bs-toggle=\"modal\" data-bs-target=\"#supportModal\">Tạo yêu cầu mới +</a>\n");
      out.write("        </div>\n");
      out.write("        <div class=\"d-flex align-items-center gap-2 support-search\" style=\"min-width:580px;\">\n");
      out.write("            <input type=\"text\" class=\"form-control\" placeholder=\"Tìm kiếm...\" style=\"max-width:200px;\" id=\"searchInput\">\n");
      out.write("            <select id=\"filterStatus\" class=\"form-select\" style=\"max-width:140px;\">\n");
      out.write("              <option value=\"\">Tất cả trạng thái</option>\n");
      out.write("              <option value=\"waiting\">Chờ xử lý</option>\n");
      out.write("              <option value=\"in_progress\">Đang xử lý</option>\n");
      out.write("              <option value=\"resolved\">Đã giải quyết</option>\n");
      out.write("              <option value=\"cancelled\">Đã hủy</option>\n");
      out.write("              <option value=\"closed\">Đã đóng</option>\n");
      out.write("            </select>\n");
      out.write("            <select id=\"filterCategory\" class=\"form-select\" style=\"max-width:140px;\">\n");
      out.write("              <option value=\"\">Tất cả loại</option>\n");
      out.write("              <option value=\"technical\">Kỹ thuật</option>\n");
      out.write("              <option value=\"billing\">Thanh toán</option>\n");
      out.write("              <option value=\"general\">Chung</option>\n");
      out.write("              <option value=\"complaint\">Khiếu nại</option>\n");
      out.write("            </select>\n");
      out.write("            <button type=\"button\" class=\"btn btn-primary btn-sm\" id=\"filterBtn\" style=\"min-width:60px;\">\n");
      out.write("              <i class=\"fas fa-filter\"></i> Lọc\n");
      out.write("            </button>\n");
      out.write("            <button type=\"button\" class=\"btn btn-secondary btn-sm\" id=\"clearFilterBtn\" style=\"min-width:60px;\">\n");
      out.write("              <i class=\"fas fa-times\"></i> Xóa\n");
      out.write("            </button>\n");
      out.write("        </div>\n");
      out.write("    </div>\n");
      out.write("    <div class=\"table-responsive\">\n");
      out.write("        <table class=\"table support-table align-middle\">\n");
      out.write("            <thead>\n");
      out.write("                <tr>\n");
      out.write("                  <th style=\"cursor: pointer;\">ID <span id=\"sortIdArrow\">↕</span></th>\n");
      out.write("                    <th>Loại yêu cầu</th>\n");
      out.write("                    <th>Tiêu đề</th>\n");
      out.write("                    <th style=\"cursor: pointer;\">Ngày tạo <span id=\"sortDateArrow\">↕</span></th>\n");
      out.write("                    <th>Trạng thái</th>\n");
      out.write("                    <th>Thao tác</th>\n");
      out.write("                </tr>\n");
      out.write("            </thead>\n");
      out.write("            <tbody id=\"supportRows\"></tbody>\n");
      out.write("        </table>\n");
      out.write("    </div>\n");
      out.write("    <div class=\"d-flex justify-content-end mt-2\">\n");
      out.write("        <nav>\n");
      out.write("            <ul class=\"pagination custom-pagination mb-0\">\n");
      out.write("                <li class=\"page-item\"><a class=\"page-link\" href=\"#\">Trước</a></li>\n");
      out.write("                <li class=\"page-item active\"><a class=\"page-link\" href=\"#\">1</a></li>\n");
      out.write("                <li class=\"page-item\"><a class=\"page-link\" href=\"#\">Tiếp</a></li>\n");
      out.write("            </ul>\n");
      out.write("        </nav>\n");
      out.write("    </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("    <!-- Modal Yêu cầu hỗ trợ -->\n");
      out.write("<div class=\"modal fade\" id=\"supportModal\" tabindex=\"-1\" aria-labelledby=\"supportModalLabel\" aria-hidden=\"true\">\n");
      out.write("  <div class=\"modal-dialog\">\n");
      out.write("    <div class=\"modal-content\" style=\"border-radius:30px;\">\n");
      out.write("      <div class=\"modal-header\">\n");
      out.write("        <h5 class=\"modal-title\" id=\"supportModalLabel\">Yêu cầu hỗ trợ</h5>\n");
      out.write("        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Đóng\"></button>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-body\">\n");
      out.write("        <form id=\"supportForm\">\n");
      out.write("          <div class=\"row mb-2\">\n");
      out.write("            <div class=\"col-6\">\n");
      out.write("              <label>Họ tên</label>\n");
      out.write("              <input type=\"text\" class=\"form-control\" id=\"displayName\" readonly>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"col-6\">\n");
      out.write("              <label>Email</label>\n");
      out.write("              <input type=\"email\" class=\"form-control\" id=\"email\" readonly>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("          \n");
      out.write("          <!-- Radio buttons để chọn loại yêu cầu -->\n");
      out.write("          <div class=\"mb-3\">\n");
      out.write("            <label class=\"form-label fw-bold\">Trường hợp :</label>\n");
      out.write("            <div class=\"d-flex gap-3\">\n");
      out.write("              <div class=\"form-check\">\n");
      out.write("                <input class=\"form-check-input\" type=\"radio\" name=\"requestType\" id=\"requestTypeContract\" value=\"contract\" checked>\n");
      out.write("                <label class=\"form-check-label\" for=\"requestTypeContract\">\n");
      out.write("                  Có hợp đồng\n");
      out.write("                </label>\n");
      out.write("              </div>\n");
      out.write("              <div class=\"form-check\">\n");
      out.write("                <input class=\"form-check-input\" type=\"radio\" name=\"requestType\" id=\"requestTypeExternal\" value=\"external\">\n");
      out.write("                <label class=\"form-check-label\" for=\"requestTypeExternal\">\n");
      out.write("                  Sản phẩm ngoài\n");
      out.write("                </label>\n");
      out.write("              </div>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("          \n");
      out.write("          <!-- Form 1: Có hợp đồng -->\n");
      out.write("          <div id=\"formWithContract\">\n");
      out.write("            <div class=\"row mb-2\">\n");
      out.write("              <div class=\"col-12\">\n");
      out.write("                <label>Hợp đồng <span class=\"text-danger\">*</span></label>\n");
      out.write("                <select class=\"form-control\" id=\"contractSelect\">\n");
      out.write("                  <option value=\"\">-- Chọn hợp đồng --</option>\n");
      out.write("                </select>\n");
      out.write("              </div>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"row mb-2\">\n");
      out.write("              <div class=\"col-12\">\n");
      out.write("                <label>Sản phẩm trong hợp đồng <span class=\"text-danger\">*</span></label>\n");
      out.write("                <select class=\"form-control\" id=\"contractProductSelect\" disabled>\n");
      out.write("                  <option value=\"\">-- Chọn sản phẩm --</option>\n");
      out.write("                </select>\n");
      out.write("              </div>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"mb-2\">\n");
      out.write("              <label>Loại yêu cầu :</label>\n");
      out.write("              <select class=\"form-control\" id=\"category\">\n");
      out.write("                  <option value=\"technical\">Kỹ thuật</option>\n");
      out.write("                  <option value=\"billing\">Thanh toán</option>\n");
      out.write("                  <option value=\"general\" selected>Chung</option>\n");
      out.write("                  <option value=\"complaint\">Khiếu nại</option>\n");
      out.write("              </select>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("          \n");
      out.write("          <!-- Form 2: Sản phẩm ngoài -->\n");
      out.write("          <div id=\"formExternal\" style=\"display: none;\">\n");
      out.write("            <div class=\"row mb-2\">\n");
      out.write("              <div class=\"col-12\">\n");
      out.write("                <label>Tên sản phẩm muốn sửa chữa <span class=\"text-danger\">*</span></label>\n");
      out.write("                <input type=\"text\" class=\"form-control\" id=\"externalProductName\" placeholder=\"Nhập tên sản phẩm\">\n");
      out.write("              </div>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"mb-2\">\n");
      out.write("              <label>Loại kỹ thuật <span class=\"text-danger\">*</span>:</label>\n");
      out.write("              <select class=\"form-control\" id=\"categoryExternal\">\n");
      out.write("                  <option value=\"technical\" selected>Kỹ thuật</option>\n");
      out.write("                  <option value=\"general\">Chung</option>\n");
      out.write("              </select>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("          \n");
      out.write("          <!-- Các trường chung -->\n");
      out.write("          <div class=\"mb-2\">\n");
      out.write("            <label>Tiêu đề <span class=\"text-danger\">*</span>:</label>\n");
      out.write("            <input type=\"text\" class=\"form-control\" id=\"subject\" placeholder=\"Nhập tiêu đề\">\n");
      out.write("          </div>\n");
      out.write("          <div class=\"mb-2\">\n");
      out.write("            <label>Độ ưu tiên:</label>\n");
      out.write("            <select class=\"form-control\" id=\"priority\">\n");
      out.write("                <option value=\"low\">Thấp</option>\n");
      out.write("                <option value=\"medium\" selected>Trung bình</option>\n");
      out.write("                <option value=\"high\">Cao</option>\n");
      out.write("                <option value=\"urgent\">Khẩn cấp</option>\n");
      out.write("            </select>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"mb-2\">\n");
      out.write("            <label>Ngày tạo :</label>\n");
      out.write("            <input type=\"text\" class=\"form-control\" id=\"createdDate\" readonly style=\"background-color: #e9ecef;\">\n");
      out.write("            <small class=\"text-muted\" id=\"createdDateText\"></small>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"mb-2\">\n");
      out.write("            <label>Ngày mong muốn công việc hoàn thành :</label>\n");
      out.write("            <input type=\"date\" class=\"form-control\" id=\"deadline\" min=\"\">\n");
      out.write("            \n");
      out.write("          </div>\n");
      out.write("          <div class=\"mb-2\">\n");
      out.write("            <label>Chi tiết vấn đề <span class=\"text-danger\">*</span>:</label>\n");
      out.write("            <textarea class=\"form-control\" id=\"description\"></textarea>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"text-end mt-3\">\n");
      out.write("            <button type=\"submit\" class=\"btn btn-success\" id=\"submitBtn\">Xác nhận</button>\n");
      out.write("            <button type=\"button\" class=\"btn btn-danger\" data-bs-dismiss=\"modal\">Hủy bỏ</button>\n");
      out.write("          </div>\n");
      out.write("        </form>\n");
      out.write("      </div>\n");
      out.write("    </div>\n");
      out.write("  </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<!-- Modal xem chi tiết yêu cầu -->\n");
      out.write("<div class=\"modal fade\" id=\"viewModal\" tabindex=\"-1\" aria-hidden=\"true\">\n");
      out.write("  <div class=\"modal-dialog modal-lg\">\n");
      out.write("    <div class=\"modal-content\" style=\"border-radius:20px;\">\n");
      out.write("      <div class=\"modal-header\">\n");
      out.write("        <h5 class=\"modal-title\">Chi tiết yêu cầu hỗ trợ</h5>\n");
      out.write("        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Đóng\"></button>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-body\">\n");
      out.write("        <div class=\"row g-3\">\n");
      out.write("          <div class=\"col-md-6\"><label>Mã ticket</label><div id=\"v_ticket\" class=\"form-control-plaintext\"></div></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Trạng thái</label><div id=\"v_status\" class=\"form-control-plaintext\"></div></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Loại yêu cầu</label>\n");
      out.write("            <select id=\"v_category_inp\" class=\"form-control\" disabled>\n");
      out.write("              <option value=\"technical\">Kỹ thuật</option>\n");
      out.write("              <option value=\"billing\">Thanh toán</option>\n");
      out.write("              <option value=\"general\">Chung</option>\n");
      out.write("              <option value=\"complaint\">Khiếu nại</option>\n");
      out.write("            </select>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"col-md-6\">\n");
      out.write("            <label>Hợp đồng</label>\n");
      out.write("            <select id=\"v_contract_select\" class=\"form-control\" disabled>\n");
      out.write("              <option value=\"\">-- Chọn hợp đồng --</option>\n");
      out.write("            </select>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"col-md-6\"><label>Ưu tiên</label>\n");
      out.write("            <select id=\"v_priority_inp\" class=\"form-control\" disabled>\n");
      out.write("              <option value=\"\">--</option>\n");
      out.write("              <option value=\"urgent\">Khẩn cấp</option>\n");
      out.write("              <option value=\"high\">Cao</option>\n");
      out.write("              <option value=\"medium\">Trung bình</option>\n");
      out.write("              <option value=\"low\">Thấp</option>\n");
      out.write("            </select>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"col-md-6\">\n");
      out.write("            <label>Sản phẩm trong hợp đồng</label>\n");
      out.write("            <select id=\"v_product_select\" class=\"form-control\" disabled>\n");
      out.write("              <option value=\"\">-- Chọn sản phẩm --</option>\n");
      out.write("            </select>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"col-12\">\n");
      out.write("            <label>Sản phẩm ngoài</label>\n");
      out.write("            <input type=\"text\" id=\"v_external_product\" class=\"form-control\" placeholder=\"Nhập tên sản phẩm ngoài\" disabled/>\n");
      out.write("          </div>\n");
      out.write("          <div class=\"col-12\"><label>Tiêu đề</label><input id=\"v_subject_inp\" class=\"form-control\" disabled/></div>\n");
      out.write("          <div class=\"col-12\"><label>Chi tiết vấn đề</label><textarea id=\"v_description_inp\" class=\"form-control\" rows=\"4\" disabled></textarea></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Ngày tạo</label><div id=\"v_created\" class=\"form-control-plaintext\"></div></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Ngày xử lý xong</label><div id=\"v_resolved\" class=\"form-control-plaintext\"></div></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Ngày mong muốn công việc hoàn thành</label><input type=\"date\" id=\"v_deadline\" class=\"form-control\" min=\"\" disabled></div>\n");
      out.write("          <div class=\"col-md-6\"><label>Người được phân công</label><div id=\"v_assigned_to\" class=\"form-control-plaintext\"></div></div>\n");
      out.write("          <div class=\"col-12\"><label>Giải pháp</label><textarea id=\"v_resolution\" class=\"form-control\" rows=\"3\" readonly></textarea></div>\n");
      out.write("          <div class=\"col-12 d-flex align-items-center justify-content-between\">\n");
      out.write("            <div class=\"form-check\">\n");
      out.write("              <input class=\"form-check-input\" type=\"checkbox\" id=\"v_enable_edit\">\n");
      out.write("              <label class=\"form-check-label\" for=\"v_enable_edit\">Chỉnh sửa </label>\n");
      out.write("            </div>\n");
      out.write("            <button type=\"button\" id=\"v_save_btn\" class=\"btn btn-success\" disabled>Lưu yêu cầu</button>\n");
      out.write("          </div>\n");
      out.write("        </div>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-footer\">\n");
      out.write("        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Đóng</button>\n");
      out.write("      </div>\n");
      out.write("    </div>\n");
      out.write("  </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<!-- Modal Feedback (riêng biệt) -->\n");
      out.write("<div class=\"modal fade\" id=\"feedbackModal\" tabindex=\"-1\" aria-labelledby=\"feedbackModalLabel\" aria-hidden=\"true\">\n");
      out.write("  <div class=\"modal-dialog\">\n");
      out.write("    <div class=\"modal-content\" style=\"border-radius:20px;\">\n");
      out.write("      <div class=\"modal-header\">\n");
      out.write("        <h5 class=\"modal-title\" id=\"feedbackModalLabel\">\n");
      out.write("          <i class=\"fas fa-star\"></i> Đánh giá dịch vụ\n");
      out.write("        </h5>\n");
      out.write("        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Đóng\"></button>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-body\">\n");
      out.write("        <div id=\"feedbackModalContent\">\n");
      out.write("          <div class=\"mb-3\">\n");
      out.write("            <label><strong>Ticket:</strong> <span id=\"feedbackTicketNumber\"></span></label>\n");
      out.write("          </div>\n");
      out.write("          <div id=\"feedbackDisplayInModal\" style=\"display: none;\">\n");
      out.write("            <div class=\"alert alert-success\">\n");
      out.write("              <strong>Đánh giá của bạn:</strong>\n");
      out.write("              <div id=\"feedbackRatingDisplayModal\" style=\"font-size: 20px; color: #ffc107; margin: 10px 0;\"></div>\n");
      out.write("              <div id=\"feedbackCommentDisplayModal\" style=\"margin-top: 10px;\"></div>\n");
      out.write("              <div id=\"feedbackImageDisplayModal\" style=\"margin-top: 10px;\"></div>\n");
      out.write("              <div style=\"margin-top: 10px; font-size: 12px; color: #666;\">\n");
      out.write("                <small>Ngày đánh giá: <span id=\"feedbackDateDisplayModal\"></span></small>\n");
      out.write("              </div>\n");
      out.write("              <div class=\"alert alert-warning mt-2\" style=\"margin-bottom: 0; padding: 8px 12px; font-size: 13px;\">\n");
      out.write("                <i class=\"fas fa-info-circle\"></i> <strong>Lưu ý:</strong> Feedback đã được gửi và không thể chỉnh sửa.\n");
      out.write("              </div>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("          <div id=\"feedbackFormInModal\" style=\"display: none;\">\n");
      out.write("            <div class=\"mb-3\">\n");
      out.write("              <label>Mức độ hài lòng (1-5 sao):</label>\n");
      out.write("              <div class=\"rating-input-modal\" style=\"font-size: 30px; cursor: pointer; user-select: none;\">\n");
      out.write("                <span class=\"star-modal\" data-rating=\"1\">☆</span>\n");
      out.write("                <span class=\"star-modal\" data-rating=\"2\">☆</span>\n");
      out.write("                <span class=\"star-modal\" data-rating=\"3\">☆</span>\n");
      out.write("                <span class=\"star-modal\" data-rating=\"4\">☆</span>\n");
      out.write("                <span class=\"star-modal\" data-rating=\"5\">☆</span>\n");
      out.write("              </div>\n");
      out.write("              <input type=\"hidden\" id=\"feedbackRatingModal\" value=\"0\">\n");
      out.write("              <div id=\"ratingTextModal\" style=\"margin-top: 5px; color: #666; font-size: 14px;\"></div>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"mb-3\">\n");
      out.write("              <label>Nhận xét của bạn:</label>\n");
      out.write("              <textarea id=\"feedbackCommentModal\" class=\"form-control\" rows=\"3\" placeholder=\"Chia sẻ cảm nhận của bạn về dịch vụ hỗ trợ...\" maxlength=\"1000\"></textarea>\n");
      out.write("              <small class=\"text-muted\" id=\"feedback_comment_char_count\">Số ký tự: 0 / 1000 ký tự</small>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"mb-3\">\n");
      out.write("              <label>Ảnh minh chứng (tùy chọn, tối đa 10MB):</label>\n");
      out.write("              <input type=\"file\" id=\"feedbackImageModal\" class=\"form-control\" accept=\"image/jpeg,image/jpg,image/png,image/gif,image/webp\" onchange=\"previewImageModal(this)\">\n");
      out.write("              <small class=\"text-muted\">Chỉ chấp nhận file ảnh: JPG, PNG, GIF, WEBP (tối đa 10MB)</small>\n");
      out.write("              <div id=\"imagePreviewModal\" style=\"margin-top: 10px; display: none;\">\n");
      out.write("                <img id=\"previewImgModal\" src=\"\" alt=\"Preview\" style=\"max-width: 300px; max-height: 300px; border-radius: 5px; border: 1px solid #ddd;\">\n");
      out.write("                <button type=\"button\" class=\"btn btn-sm btn-danger mt-2\" onclick=\"removeImageModal()\">Xóa ảnh</button>\n");
      out.write("              </div>\n");
      out.write("              <div id=\"imageSizeErrorModal\" class=\"text-danger\" style=\"display: none; margin-top: 5px;\"></div>\n");
      out.write("            </div>\n");
      out.write("            <div class=\"d-flex gap-2\">\n");
      out.write("              <button type=\"button\" class=\"btn btn-primary\" id=\"submitFeedbackBtnModal\" onclick=\"submitFeedbackFromModal()\">Gửi đánh giá</button>\n");
      out.write("              <button type=\"button\" class=\"btn btn-secondary\" id=\"cancelFeedbackBtnModal\" onclick=\"hideFeedbackFormInModal()\" style=\"display: none;\">Hủy</button>\n");
      out.write("            </div>\n");
      out.write("          </div>\n");
      out.write("        </div>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-footer\">\n");
      out.write("        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Đóng</button>\n");
      out.write("      </div>\n");
      out.write("    </div>\n");
      out.write("  </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<!-- Modal thông báo thành công - Simple alert style -->\n");
      out.write("<div class=\"modal fade success-modal\" id=\"successModal\" tabindex=\"-1\" aria-hidden=\"true\">\n");
      out.write("  <div class=\"modal-dialog\">\n");
      out.write("    <div class=\"modal-content\">\n");
      out.write("      <div class=\"modal-header\">\n");
      out.write("        <h5 class=\"modal-title\" id=\"successTitle\">Thông báo</h5>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-body\">\n");
      out.write("        <div id=\"successMessage\">Thao tác đã được thực hiện thành công.</div>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-footer\">\n");
      out.write("        <button type=\"button\" class=\"btn success-btn\" data-bs-dismiss=\"modal\">OK</button>\n");
      out.write("      </div>\n");
      out.write("    </div>\n");
      out.write("  </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<!-- Modal xác nhận hủy yêu cầu -->\n");
      out.write("<div class=\"modal fade success-modal\" id=\"confirmModal\" tabindex=\"-1\" aria-hidden=\"true\">\n");
      out.write("  <div class=\"modal-dialog\">\n");
      out.write("    <div class=\"modal-content\">\n");
      out.write("      <div class=\"modal-header\">\n");
      out.write("        <h5 class=\"modal-title\">Xác nhận</h5>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-body\">\n");
      out.write("        <div id=\"confirmMessage\">Bạn có chắc chắn muốn hủy yêu cầu này?</div>\n");
      out.write("      </div>\n");
      out.write("      <div class=\"modal-footer\">\n");
      out.write("        <button type=\"button\" class=\"btn cancel-btn\" data-bs-dismiss=\"modal\">Hủy</button>\n");
      out.write("        <button type=\"button\" class=\"btn success-btn\" id=\"confirmCancelBtn\">OK</button>\n");
      out.write("      </div>\n");
      out.write("    </div>\n");
      out.write("  </div>\n");
      out.write("</div>\n");
      out.write("\n");
      out.write("<script>\n");
      out.write("  // Context path - global scope để các hàm có thể truy cập\n");
      out.write("  var ctx = '");
      out.print(request.getContextPath());
      out.write("';\n");
      out.write("  \n");
      out.write("  // ========== Feedback Modal Functions (Global scope) ==========\n");
      out.write("  \n");
      out.write("  // Open feedback modal\n");
      out.write("  function openFeedbackModal(ticketId, ticketNumber) {\n");
      out.write("    document.getElementById('feedbackTicketNumber').textContent = ticketNumber || '#' + ticketId;\n");
      out.write("    document.getElementById('feedbackModal').setAttribute('data-current-ticket-id', ticketId);\n");
      out.write("    \n");
      out.write("    // Load existing feedback\n");
      out.write("    loadFeedbackForModal(ticketId);\n");
      out.write("    \n");
      out.write("    // Show modal\n");
      out.write("    const feedbackModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('feedbackModal'));\n");
      out.write("    feedbackModal.show();\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Load feedback for modal\n");
      out.write("  function loadFeedbackForModal(ticketId) {\n");
      out.write("    fetch(ctx + '/api/feedback?action=getByTicketId&ticketId=' + encodeURIComponent(ticketId), {\n");
      out.write("      headers: { 'Accept': 'application/json' }\n");
      out.write("    })\n");
      out.write("    .then(r => r.json())\n");
      out.write("    .then(j => {\n");
      out.write("      if (j && j.success) {\n");
      out.write("        if (j.data) {\n");
      out.write("          // Có feedback - hiển thị\n");
      out.write("          displayFeedbackInModal(j.data);\n");
      out.write("        } else {\n");
      out.write("          // Chưa có feedback - hiển thị form\n");
      out.write("          showFeedbackFormInModal();\n");
      out.write("        }\n");
      out.write("      } else {\n");
      out.write("        // Lỗi hoặc chưa có feedback - hiển thị form\n");
      out.write("        showFeedbackFormInModal();\n");
      out.write("      }\n");
      out.write("    })\n");
      out.write("    .catch(error => {\n");
      out.write("      console.error('Error loading feedback:', error);\n");
      out.write("      showFeedbackFormInModal();\n");
      out.write("    });\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Display existing feedback in modal\n");
      out.write("  function displayFeedbackInModal(feedback) {\n");
      out.write("    document.getElementById('feedbackDisplayInModal').style.display = 'block';\n");
      out.write("    document.getElementById('feedbackFormInModal').style.display = 'none';\n");
      out.write("    \n");
      out.write("    // Hiển thị rating\n");
      out.write("    var ratingDisplay = document.getElementById('feedbackRatingDisplayModal');\n");
      out.write("    if (ratingDisplay) {\n");
      out.write("      ratingDisplay.textContent = feedback.ratingStars || '';\n");
      out.write("      ratingDisplay.title = feedback.ratingDisplay || '';\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hiển thị comment\n");
      out.write("    var commentDisplay = document.getElementById('feedbackCommentDisplayModal');\n");
      out.write("    if (commentDisplay) {\n");
      out.write("      commentDisplay.textContent = feedback.comment || '(Không có nhận xét)';\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hiển thị ảnh\n");
      out.write("    var imageDisplay = document.getElementById('feedbackImageDisplayModal');\n");
      out.write("    if (imageDisplay) {\n");
      out.write("      if (feedback.imagePath) {\n");
      out.write("        imageDisplay.innerHTML = '<img src=\"' + ctx + '/' + feedback.imagePath + '\" alt=\"Feedback image\" style=\"max-width: 300px; max-height: 300px; border-radius: 5px; border: 1px solid #ddd; margin-top: 10px;\">';\n");
      out.write("      } else {\n");
      out.write("        imageDisplay.innerHTML = '';\n");
      out.write("      }\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hiển thị ngày\n");
      out.write("    var dateDisplay = document.getElementById('feedbackDateDisplayModal');\n");
      out.write("    if (dateDisplay && feedback.createdAt) {\n");
      out.write("      var date = new Date(feedback.createdAt);\n");
      out.write("      dateDisplay.textContent = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // KHÔNG lưu feedback ID - không cho phép chỉnh sửa\n");
      out.write("    // Xóa feedback ID nếu có để ngăn chặn việc cập nhật\n");
      out.write("    var formInModal = document.getElementById('feedbackFormInModal');\n");
      out.write("    if (formInModal) {\n");
      out.write("      formInModal.removeAttribute('data-feedback-id');\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Show feedback form in modal\n");
      out.write("  function showFeedbackFormInModal() {\n");
      out.write("    document.getElementById('feedbackDisplayInModal').style.display = 'none';\n");
      out.write("    document.getElementById('feedbackFormInModal').style.display = 'block';\n");
      out.write("    document.getElementById('cancelFeedbackBtnModal').style.display = 'none';\n");
      out.write("    \n");
      out.write("    // Reset form\n");
      out.write("    document.getElementById('feedbackRatingModal').value = '0';\n");
      out.write("    document.getElementById('feedbackCommentModal').value = '';\n");
      out.write("    document.getElementById('feedbackImageModal').value = '';\n");
      out.write("    document.getElementById('imagePreviewModal').style.display = 'none';\n");
      out.write("    document.getElementById('imageSizeErrorModal').style.display = 'none';\n");
      out.write("    updateRatingDisplayModal(0);\n");
      out.write("    \n");
      out.write("    // Initialize rating stars for modal\n");
      out.write("    initRatingStarsModal();\n");
      out.write("    \n");
      out.write("    // Initialize character count for feedback comment\n");
      out.write("    updateFeedbackCommentCharCount();\n");
      out.write("    \n");
      out.write("    // Add event listener for real-time character count\n");
      out.write("    var commentTextarea = document.getElementById('feedbackCommentModal');\n");
      out.write("    if (commentTextarea) {\n");
      out.write("      commentTextarea.addEventListener('input', updateFeedbackCommentCharCount);\n");
      out.write("      commentTextarea.addEventListener('paste', function() {\n");
      out.write("        setTimeout(updateFeedbackCommentCharCount, 10);\n");
      out.write("      });\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Function to update character count display for feedback comment\n");
      out.write("  function updateFeedbackCommentCharCount() {\n");
      out.write("    var textarea = document.getElementById('feedbackCommentModal');\n");
      out.write("    if (!textarea) return;\n");
      out.write("    \n");
      out.write("    var text = textarea.value || '';\n");
      out.write("    var charCount = text.length;\n");
      out.write("    var maxChars = 1000;\n");
      out.write("    var remaining = maxChars - charCount;\n");
      out.write("    \n");
      out.write("    var countElement = document.getElementById('feedback_comment_char_count');\n");
      out.write("    if (!countElement) return;\n");
      out.write("    \n");
      out.write("    if (charCount > maxChars) {\n");
      out.write("      countElement.className = 'text-danger';\n");
      out.write("      countElement.textContent = 'Số ký tự: ' + charCount + ' / ' + maxChars + ' ký tự (Vượt quá ' + (charCount - maxChars) + ' ký tự)';\n");
      out.write("    } else if (charCount > maxChars * 0.9) {\n");
      out.write("      countElement.className = 'text-warning';\n");
      out.write("      countElement.textContent = 'Số ký tự: ' + charCount + ' / ' + maxChars + ' ký tự (Còn lại: ' + remaining + ' ký tự)';\n");
      out.write("    } else {\n");
      out.write("      countElement.className = 'text-muted';\n");
      out.write("      countElement.textContent = 'Số ký tự: ' + charCount + ' / ' + maxChars + ' ký tự (Còn lại: ' + remaining + ' ký tự)';\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Preview image\n");
      out.write("  function previewImageModal(input) {\n");
      out.write("    var errorDiv = document.getElementById('imageSizeErrorModal');\n");
      out.write("    var previewDiv = document.getElementById('imagePreviewModal');\n");
      out.write("    var previewImg = document.getElementById('previewImgModal');\n");
      out.write("    \n");
      out.write("    if (input.files && input.files[0]) {\n");
      out.write("      var file = input.files[0];\n");
      out.write("      \n");
      out.write("      // Validate file size (10MB)\n");
      out.write("      if (file.size > 10 * 1024 * 1024) {\n");
      out.write("        errorDiv.textContent = 'Kích thước ảnh quá lớn. Tối đa 10MB.';\n");
      out.write("        errorDiv.style.display = 'block';\n");
      out.write("        input.value = '';\n");
      out.write("        previewDiv.style.display = 'none';\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Validate file type\n");
      out.write("      var validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];\n");
      out.write("      if (!validTypes.includes(file.type)) {\n");
      out.write("        errorDiv.textContent = 'Định dạng ảnh không hợp lệ. Chỉ chấp nhận JPG, PNG, GIF, WEBP.';\n");
      out.write("        errorDiv.style.display = 'block';\n");
      out.write("        input.value = '';\n");
      out.write("        previewDiv.style.display = 'none';\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      errorDiv.style.display = 'none';\n");
      out.write("      \n");
      out.write("      var reader = new FileReader();\n");
      out.write("      reader.onload = function(e) {\n");
      out.write("        previewImg.src = e.target.result;\n");
      out.write("        previewDiv.style.display = 'block';\n");
      out.write("      };\n");
      out.write("      reader.readAsDataURL(file);\n");
      out.write("    } else {\n");
      out.write("      previewDiv.style.display = 'none';\n");
      out.write("      errorDiv.style.display = 'none';\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Remove image\n");
      out.write("  function removeImageModal() {\n");
      out.write("    document.getElementById('feedbackImageModal').value = '';\n");
      out.write("    document.getElementById('imagePreviewModal').style.display = 'none';\n");
      out.write("    document.getElementById('imageSizeErrorModal').style.display = 'none';\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Hide feedback form in modal\n");
      out.write("  function hideFeedbackFormInModal() {\n");
      out.write("    var ticketId = document.getElementById('feedbackModal').getAttribute('data-current-ticket-id');\n");
      out.write("    if (ticketId) {\n");
      out.write("      loadFeedbackForModal(ticketId);\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Initialize rating stars for modal\n");
      out.write("  function initRatingStarsModal() {\n");
      out.write("    var stars = document.querySelectorAll('.rating-input-modal .star-modal');\n");
      out.write("    stars.forEach(function(star) {\n");
      out.write("      star.addEventListener('click', function() {\n");
      out.write("        var rating = parseInt(this.getAttribute('data-rating'));\n");
      out.write("        setRatingModal(rating);\n");
      out.write("      });\n");
      out.write("      star.addEventListener('mouseenter', function() {\n");
      out.write("        var rating = parseInt(this.getAttribute('data-rating'));\n");
      out.write("        highlightStarsModal(rating);\n");
      out.write("      });\n");
      out.write("    });\n");
      out.write("    \n");
      out.write("    var ratingInput = document.querySelector('.rating-input-modal');\n");
      out.write("    if (ratingInput) {\n");
      out.write("      ratingInput.addEventListener('mouseleave', function() {\n");
      out.write("        var currentRating = parseInt(document.getElementById('feedbackRatingModal').value) || 0;\n");
      out.write("        highlightStarsModal(currentRating);\n");
      out.write("      });\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Set rating in modal\n");
      out.write("  function setRatingModal(rating) {\n");
      out.write("    document.getElementById('feedbackRatingModal').value = rating;\n");
      out.write("    updateRatingDisplayModal(rating);\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Highlight stars in modal\n");
      out.write("  function highlightStarsModal(rating) {\n");
      out.write("    var stars = document.querySelectorAll('.rating-input-modal .star-modal');\n");
      out.write("    stars.forEach(function(star) {\n");
      out.write("      var starRating = parseInt(star.getAttribute('data-rating'));\n");
      out.write("      if (starRating <= rating) {\n");
      out.write("        star.textContent = '★';\n");
      out.write("        star.style.color = '#ffc107';\n");
      out.write("      } else {\n");
      out.write("        star.textContent = '☆';\n");
      out.write("        star.style.color = '#ccc';\n");
      out.write("      }\n");
      out.write("    });\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Update rating display text in modal\n");
      out.write("  function updateRatingDisplayModal(rating) {\n");
      out.write("    var ratingText = document.getElementById('ratingTextModal');\n");
      out.write("    if (!ratingText) return;\n");
      out.write("    \n");
      out.write("    var textMap = {\n");
      out.write("      0: 'Vui lòng chọn đánh giá',\n");
      out.write("      1: 'Rất không hài lòng',\n");
      out.write("      2: 'Không hài lòng',\n");
      out.write("      3: 'Bình thường',\n");
      out.write("      4: 'Hài lòng',\n");
      out.write("      5: 'Rất hài lòng'\n");
      out.write("    };\n");
      out.write("    \n");
      out.write("    ratingText.textContent = textMap[rating] || '';\n");
      out.write("    highlightStarsModal(rating);\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("  // Submit feedback from modal\n");
      out.write("  function submitFeedbackFromModal() {\n");
      out.write("    console.log('submitFeedbackFromModal called');\n");
      out.write("    var ticketId = document.getElementById('feedbackModal').getAttribute('data-current-ticket-id');\n");
      out.write("    if (!ticketId) {\n");
      out.write("      alert('Không tìm thấy ticket ID');\n");
      out.write("      console.error('Ticket ID not found');\n");
      out.write("      return;\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Kiểm tra xem đã có feedback chưa - nếu có thì không cho phép gửi mới\n");
      out.write("    var feedbackId = document.getElementById('feedbackFormInModal').getAttribute('data-feedback-id');\n");
      out.write("    if (feedbackId && feedbackId !== '') {\n");
      out.write("      alert('Feedback đã được gửi. Không thể chỉnh sửa hoặc gửi lại feedback!');\n");
      out.write("      return;\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    var rating = parseInt(document.getElementById('feedbackRatingModal').value);\n");
      out.write("    if (rating < 1 || rating > 5) {\n");
      out.write("      alert('Vui lòng chọn đánh giá từ 1 đến 5 sao');\n");
      out.write("      console.error('Invalid rating:', rating);\n");
      out.write("      return;\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    var comment = document.getElementById('feedbackCommentModal').value || '';\n");
      out.write("    \n");
      out.write("    // Validate character count - tối đa 1000 ký tự\n");
      out.write("    var charCount = comment.length;\n");
      out.write("    if (charCount > 1000) {\n");
      out.write("      alert('Nhận xét không được vượt quá 1000 ký tự. Hiện tại bạn đã nhập ' + charCount + ' ký tự. Vui lòng rút gọn nội dung.');\n");
      out.write("      document.getElementById('feedbackCommentModal').focus();\n");
      out.write("      return;\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    var imageInput = document.getElementById('feedbackImageModal');\n");
      out.write("    var hasImage = imageInput && imageInput.files && imageInput.files[0];\n");
      out.write("    \n");
      out.write("    var submitBtn = document.getElementById('submitFeedbackBtnModal');\n");
      out.write("    if (!submitBtn) {\n");
      out.write("      alert('Không tìm thấy nút submit');\n");
      out.write("      console.error('Submit button not found');\n");
      out.write("      return;\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    submitBtn.disabled = true;\n");
      out.write("    submitBtn.textContent = 'Đang gửi...';\n");
      out.write("    \n");
      out.write("    // Nếu có ảnh, sử dụng FormData (multipart)\n");
      out.write("    // CHỈ cho phép tạo mới, KHÔNG cho phép update\n");
      out.write("    if (hasImage) {\n");
      out.write("      console.log('Submitting with image');\n");
      out.write("      var formData = new FormData();\n");
      out.write("      formData.append('action', 'create'); // Luôn là create, không cho update\n");
      out.write("      formData.append('ticketId', ticketId);\n");
      out.write("      formData.append('rating', rating);\n");
      out.write("      formData.append('comment', comment);\n");
      out.write("      formData.append('image', imageInput.files[0]);\n");
      out.write("      \n");
      out.write("      console.log('Sending request to:', ctx + '/api/feedback');\n");
      out.write("      \n");
      out.write("      fetch(ctx + '/api/feedback', {\n");
      out.write("        method: 'POST',\n");
      out.write("        body: formData\n");
      out.write("      })\n");
      out.write("      .then(r => {\n");
      out.write("        console.log('Response status:', r.status);\n");
      out.write("        if (!r.ok) {\n");
      out.write("          throw new Error('HTTP ' + r.status);\n");
      out.write("        }\n");
      out.write("        return r.text().then(text => {\n");
      out.write("          console.log('Raw response text:', text);\n");
      out.write("          try {\n");
      out.write("            return JSON.parse(text);\n");
      out.write("          } catch (e) {\n");
      out.write("            console.error('JSON parse error:', e);\n");
      out.write("            throw new Error('Invalid JSON response: ' + text.substring(0, 100));\n");
      out.write("          }\n");
      out.write("        });\n");
      out.write("      })\n");
      out.write("      .then(j => {\n");
      out.write("        console.log('Parsed response:', j);\n");
      out.write("        submitBtn.disabled = false;\n");
      out.write("        submitBtn.textContent = 'Gửi đánh giá';\n");
      out.write("        \n");
      out.write("        if (j && j.success) {\n");
      out.write("          alert('✓ ' + (j.message || 'Cảm ơn bạn đã gửi feedback!'));\n");
      out.write("          // Đóng modal feedback\n");
      out.write("          const feedbackModalEl = document.getElementById('feedbackModal');\n");
      out.write("          const feedbackModal = bootstrap.Modal.getInstance(feedbackModalEl);\n");
      out.write("          if (feedbackModal) {\n");
      out.write("            feedbackModal.hide();\n");
      out.write("          }\n");
      out.write("          // Reload lại danh sách support requests để cập nhật trạng thái\n");
      out.write("          load();\n");
      out.write("        } else {\n");
      out.write("          alert('✗ ' + (j && j.message ? j.message : 'Lỗi khi gửi feedback'));\n");
      out.write("        }\n");
      out.write("      })\n");
      out.write("      .catch(error => {\n");
      out.write("        submitBtn.disabled = false;\n");
      out.write("        submitBtn.textContent = 'Gửi đánh giá';\n");
      out.write("        console.error('Error submitting feedback:', error);\n");
      out.write("        alert('✗ Lỗi kết nối: ' + error.message);\n");
      out.write("      });\n");
      out.write("    } else {\n");
      out.write("      // Không có ảnh, sử dụng URLSearchParams\n");
      out.write("      // CHỈ cho phép tạo mới, KHÔNG cho phép update\n");
      out.write("      console.log('Submitting without image');\n");
      out.write("      var formData = new URLSearchParams();\n");
      out.write("      formData.append('action', 'create'); // Luôn là create, không cho update\n");
      out.write("      formData.append('ticketId', ticketId);\n");
      out.write("      formData.append('rating', rating);\n");
      out.write("      formData.append('comment', comment);\n");
      out.write("      \n");
      out.write("      console.log('Form data:', formData.toString());\n");
      out.write("      console.log('Sending request to:', ctx + '/api/feedback');\n");
      out.write("      \n");
      out.write("      fetch(ctx + '/api/feedback', {\n");
      out.write("        method: 'POST',\n");
      out.write("        headers: {\n");
      out.write("          'Content-Type': 'application/x-www-form-urlencoded',\n");
      out.write("          'Accept': 'application/json'\n");
      out.write("        },\n");
      out.write("        body: formData.toString()\n");
      out.write("      })\n");
      out.write("      .then(r => {\n");
      out.write("        console.log('Response status:', r.status);\n");
      out.write("        if (!r.ok) {\n");
      out.write("          throw new Error('HTTP ' + r.status);\n");
      out.write("        }\n");
      out.write("        return r.text().then(text => {\n");
      out.write("          console.log('Raw response text:', text);\n");
      out.write("          try {\n");
      out.write("            return JSON.parse(text);\n");
      out.write("          } catch (e) {\n");
      out.write("            console.error('JSON parse error:', e);\n");
      out.write("            throw new Error('Invalid JSON response: ' + text.substring(0, 100));\n");
      out.write("          }\n");
      out.write("        });\n");
      out.write("      })\n");
      out.write("      .then(j => {\n");
      out.write("        console.log('Parsed response:', j);\n");
      out.write("        submitBtn.disabled = false;\n");
      out.write("        submitBtn.textContent = 'Gửi đánh giá';\n");
      out.write("        \n");
      out.write("        if (j && j.success) {\n");
      out.write("          alert('✓ ' + (j.message || 'Cảm ơn bạn đã gửi feedback!'));\n");
      out.write("          // Đóng modal feedback\n");
      out.write("          const feedbackModalEl = document.getElementById('feedbackModal');\n");
      out.write("          const feedbackModal = bootstrap.Modal.getInstance(feedbackModalEl);\n");
      out.write("          if (feedbackModal) {\n");
      out.write("            feedbackModal.hide();\n");
      out.write("          }\n");
      out.write("          // Reload lại danh sách support requests để cập nhật trạng thái\n");
      out.write("          load();\n");
      out.write("        } else {\n");
      out.write("          alert('✗ ' + (j && j.message ? j.message : 'Lỗi khi gửi feedback'));\n");
      out.write("        }\n");
      out.write("      })\n");
      out.write("      .catch(error => {\n");
      out.write("        submitBtn.disabled = false;\n");
      out.write("        submitBtn.textContent = 'Gửi đánh giá';\n");
      out.write("        console.error('Error submitting feedback:', error);\n");
      out.write("        alert('✗ Lỗi kết nối: ' + error.message);\n");
      out.write("      });\n");
      out.write("    }\n");
      out.write("  }\n");
      out.write("  \n");
      out.write("    // Tự động set ngày hiện tại cho trường \"Ngày tạo\" và set min date cho deadline\n");
      out.write("    document.addEventListener('DOMContentLoaded', function() {\n");
      out.write("    // Set date using local timezone to avoid UTC offset (+/-1 day) issues\n");
      out.write("    var now = new Date();\n");
      out.write("    var yyyyLocal = now.getFullYear();\n");
      out.write("    var mmLocal = String(now.getMonth() + 1).padStart(2, '0');\n");
      out.write("    var ddLocal = String(now.getDate()).padStart(2, '0');\n");
      out.write("    var todayLocal = yyyyLocal + '-' + mmLocal + '-' + ddLocal;\n");
      out.write("    var createdInput = document.getElementById('createdDate');\n");
      out.write("    var createdText = document.getElementById('createdDateText');\n");
      out.write("    var deadlineInput = document.getElementById('deadline');\n");
      out.write("    // Format ngày tạo theo dd/MM/yyyy\n");
      out.write("    if (createdInput) {\n");
      out.write("      try {\n");
      out.write("        var d = new Date();\n");
      out.write("        var dd = String(d.getDate()).padStart(2, '0');\n");
      out.write("        var mm = String(d.getMonth() + 1).padStart(2, '0');\n");
      out.write("        var yyyy = d.getFullYear();\n");
      out.write("        var formattedDate = dd + '/' + mm + '/' + yyyy;\n");
      out.write("        createdInput.value = formattedDate;\n");
      out.write("        if (createdText) createdText.textContent = '';\n");
      out.write("      } catch(e) {\n");
      out.write("        console.error('Error setting created date:', e);\n");
      out.write("      }\n");
      out.write("    }\n");
      out.write("    // Set min date và giá trị mặc định cho deadline input (date picker)\n");
      out.write("    if (deadlineInput) {\n");
      out.write("      try {\n");
      out.write("        var today = new Date();\n");
      out.write("        var yyyy = today.getFullYear();\n");
      out.write("        var mm = String(today.getMonth() + 1).padStart(2, '0');\n");
      out.write("        var dd = String(today.getDate()).padStart(2, '0');\n");
      out.write("        var todayStr = yyyy + '-' + mm + '-' + dd;\n");
      out.write("        \n");
      out.write("        // Set min attribute để không cho chọn ngày quá khứ\n");
      out.write("        deadlineInput.setAttribute('min', todayStr);\n");
      out.write("        \n");
      out.write("        // Set giá trị mặc định là ngày hiện tại\n");
      out.write("        deadlineInput.value = todayStr;\n");
      out.write("      } catch(e) {\n");
      out.write("        console.error('Error setting deadline date picker:', e);\n");
      out.write("      }\n");
      out.write("    }\n");
      out.write("    try {\n");
      out.write("      var d = new Date();\n");
      out.write("      var dd = String(d.getDate()).padStart(2,'0');\n");
      out.write("      var mm = String(d.getMonth()+1).padStart(2,'0');\n");
      out.write("      var yyyy = d.getFullYear();\n");
      out.write("      if (createdText) createdText.textContent = dd + '/' + mm + '/' + yyyy;\n");
      out.write("    } catch(e) {}\n");
      out.write("    \n");
      out.write("    // Hàm hiển thị thông báo thành công - Simple alert style\n");
      out.write("    function showSuccessModal(title, message) {\n");
      out.write("      const successModal = document.getElementById('successModal');\n");
      out.write("      const successTitle = document.getElementById('successTitle');\n");
      out.write("      const successMessage = document.getElementById('successMessage');\n");
      out.write("      \n");
      out.write("      if (successTitle) successTitle.textContent = title || 'Thông báo';\n");
      out.write("      if (successMessage) successMessage.textContent = message;\n");
      out.write("      \n");
      out.write("      const modal = bootstrap.Modal.getOrCreateInstance(successModal);\n");
      out.write("      modal.show();\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hàm hiển thị modal xác nhận hủy yêu cầu\n");
      out.write("    function showConfirmModal(message, onConfirm) {\n");
      out.write("      const confirmModal = document.getElementById('confirmModal');\n");
      out.write("      const confirmMessage = document.getElementById('confirmMessage');\n");
      out.write("      const confirmBtn = document.getElementById('confirmCancelBtn');\n");
      out.write("      \n");
      out.write("      if (confirmMessage) confirmMessage.textContent = message;\n");
      out.write("      \n");
      out.write("      // Xóa event listener cũ nếu có\n");
      out.write("      const newConfirmBtn = confirmBtn.cloneNode(true);\n");
      out.write("      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);\n");
      out.write("      \n");
      out.write("      // Thêm event listener mới\n");
      out.write("      newConfirmBtn.addEventListener('click', function() {\n");
      out.write("        const modal = bootstrap.Modal.getInstance(confirmModal);\n");
      out.write("        modal.hide();\n");
      out.write("        if (onConfirm) onConfirm();\n");
      out.write("      });\n");
      out.write("      \n");
      out.write("      const modal = bootstrap.Modal.getOrCreateInstance(confirmModal);\n");
      out.write("      modal.show();\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Prefill name/email: first from live API, fallback to session variables\n");
      out.write("    try {\n");
      out.write("      const sessionEmail = '");
      out.print( String.valueOf(session.getAttribute("email")) );
      out.write("';\n");
      out.write("      const sessionUsername = '");
      out.print( String.valueOf(session.getAttribute("username")) );
      out.write("';\n");
      out.write("      const sessionFullName = '");
      out.print( String.valueOf(session.getAttribute("fullName")) );
      out.write("';\n");
      out.write("      const sessionCustomerId = '");
      out.print( String.valueOf(session.getAttribute("customerId")) );
      out.write("';\n");
      out.write("      const sessionUserId = '");
      out.print( String.valueOf(session.getAttribute("userId")) );
      out.write("';\n");
      out.write("      const emailInp = document.getElementById('email');\n");
      out.write("      const nameInp = document.getElementById('displayName');\n");
      out.write("      // Fill from session immediately\n");
      out.write("      if (emailInp && sessionEmail && sessionEmail !== 'null') emailInp.value = sessionEmail;\n");
      out.write("      if (nameInp) {\n");
      out.write("        const name = (sessionFullName && sessionFullName !== 'null') ? sessionFullName : (sessionUsername && sessionUsername !== 'null' ? sessionUsername : '');\n");
      out.write("        nameInp.value = name;\n");
      out.write("      }\n");
      out.write("      // Then fetch fresh user info to reflect any recent changes and update header too\n");
      out.write("      if (sessionUserId && sessionUserId !== 'null') {\n");
      out.write("        fetch(ctx + '/api/users?action=get&id=' + encodeURIComponent(sessionUserId), { headers: { 'Accept': 'application/json' } })\n");
      out.write("          .then(function(r){ return r.json(); })\n");
      out.write("          .then(function(j){\n");
      out.write("            if (j && j.success && j.data) {\n");
      out.write("              const u = j.data;\n");
      out.write("              if (emailInp && u.email) emailInp.value = u.email;\n");
      out.write("              if (nameInp && (u.fullName || u.username)) nameInp.value = (u.fullName || u.username);\n");
      out.write("              try {\n");
      out.write("                var headerUser = document.querySelector('.user-info');\n");
      out.write("                if (headerUser) headerUser.innerHTML = '<i class=\"fas fa-user\"></i> ' + (u.fullName || u.username || '');\n");
      out.write("              } catch(e) {}\n");
      out.write("            }\n");
      out.write("          }).catch(function(){});\n");
      out.write("      }\n");
      out.write("\n");
      out.write("      // Load contracts (already filtered by backend based on session customerId)\n");
      out.write("      const contractSelect = document.getElementById('contractSelect');\n");
      out.write("      const productSelect = document.getElementById('contractProductSelect');\n");
      out.write("      // ctx already defined above; avoid redeclaration that breaks script execution\n");
      out.write("      fetch(ctx + '/api/contracts', { headers: { 'Accept': 'application/json' } })\n");
      out.write("        .then(r => r.json())\n");
      out.write("        .then(j => {\n");
      out.write("          if (!j || !j.success) return;\n");
      out.write("          // Lọc chỉ lấy hợp đồng có trạng thái 'active' hoặc 'terminated'\n");
      out.write("          const list = Array.isArray(j.data) ? j.data.filter(c => c.status === 'active' || c.status === 'terminated') : [];\n");
      out.write("          list.forEach(it => {\n");
      out.write("            const opt = document.createElement('option');\n");
      out.write("            opt.value = it.id;\n");
      out.write("            opt.textContent = (it.contractNumber ? (it.contractNumber + ' - ') : '') + (it.title || ('HĐ #' + it.id));\n");
      out.write("            contractSelect.appendChild(opt);\n");
      out.write("          });\n");
      out.write("        });\n");
      out.write("\n");
      out.write("      // Luôn prefill lại thông tin người dùng mỗi khi mở modal (tránh bị xoá bởi reset)\n");
      out.write("      try {\n");
      out.write("        const modalEl = document.getElementById('supportModal');\n");
      out.write("        if (modalEl) {\n");
      out.write("          modalEl.addEventListener('show.bs.modal', function(){\n");
      out.write("            if (emailInp && sessionEmail && sessionEmail !== 'null') emailInp.value = sessionEmail;\n");
      out.write("            if (nameInp) {\n");
      out.write("              const name = (sessionFullName && sessionFullName !== 'null') ? sessionFullName : (sessionUsername && sessionUsername !== 'null' ? sessionUsername : '');\n");
      out.write("              nameInp.value = name;\n");
      out.write("            }\n");
      out.write("            // Reset và set lại ngày tạo khi mở modal\n");
      out.write("            const createdInput = document.getElementById('createdDate');\n");
      out.write("            if (createdInput) {\n");
      out.write("              try {\n");
      out.write("                var d = new Date();\n");
      out.write("                var dd = String(d.getDate()).padStart(2, '0');\n");
      out.write("                var mm = String(d.getMonth() + 1).padStart(2, '0');\n");
      out.write("                var yyyy = d.getFullYear();\n");
      out.write("                var formattedDate = dd + '/' + mm + '/' + yyyy;\n");
      out.write("                createdInput.value = formattedDate;\n");
      out.write("              } catch(e) {\n");
      out.write("                console.error('Error setting created date:', e);\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("            // Set deadline field mặc định là ngày hiện tại khi mở modal (date picker format: yyyy-MM-dd)\n");
      out.write("            const deadlineInp = document.getElementById('deadline');\n");
      out.write("            if (deadlineInp) {\n");
      out.write("              try {\n");
      out.write("                var today = new Date();\n");
      out.write("                var yyyy = today.getFullYear();\n");
      out.write("                var mm = String(today.getMonth() + 1).padStart(2, '0');\n");
      out.write("                var dd = String(today.getDate()).padStart(2, '0');\n");
      out.write("                var todayStr = yyyy + '-' + mm + '-' + dd;\n");
      out.write("                \n");
      out.write("                // Set min attribute để không cho chọn ngày quá khứ\n");
      out.write("                deadlineInp.setAttribute('min', todayStr);\n");
      out.write("                \n");
      out.write("                // Set giá trị mặc định là ngày hiện tại\n");
      out.write("                deadlineInp.value = todayStr;\n");
      out.write("              } catch(e) {\n");
      out.write("                console.error('Error setting deadline:', e);\n");
      out.write("                deadlineInp.value = '';\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("          });\n");
      out.write("        }\n");
      out.write("      } catch(e) {}\n");
      out.write("\n");
      out.write("      contractSelect.addEventListener('change', function(){\n");
      out.write("        const id = this.value;\n");
      out.write("        productSelect.innerHTML = '<option value=\"\">-- Chọn sản phẩm --</option>';\n");
      out.write("        productSelect.disabled = !id;\n");
      out.write("        if (!id) return;\n");
      out.write("        fetch(ctx + '/api/contract-items?contractId=' + encodeURIComponent(id), { headers: { 'Accept': 'application/json' } })\n");
      out.write("          .then(r => r.json())\n");
      out.write("          .then(j => {\n");
      out.write("            if (!j || !j.success) return;\n");
      out.write("            const arr = Array.isArray(j.data) ? j.data : [];\n");
      out.write("            arr.forEach(item => {\n");
      out.write("              const opt = document.createElement('option');\n");
      out.write("              opt.value = item.productId;\n");
      out.write("              const name = item.description ? item.description : ('Sản phẩm #' + item.productId);\n");
      out.write("              opt.textContent = name;\n");
      out.write("              opt.dataset.quantity = item.quantity != null ? String(item.quantity) : '';\n");
      out.write("              opt.dataset.unitPrice = item.unitPrice != null ? String(item.unitPrice) : '';\n");
      out.write("              productSelect.appendChild(opt);\n");
      out.write("            });\n");
      out.write("          });\n");
      out.write("      });\n");
      out.write("      \n");
      out.write("      // Xử lý chuyển đổi giữa 2 loại form\n");
      out.write("      const requestTypeContract = document.getElementById('requestTypeContract');\n");
      out.write("      const requestTypeExternal = document.getElementById('requestTypeExternal');\n");
      out.write("      const formWithContract = document.getElementById('formWithContract');\n");
      out.write("      const formExternal = document.getElementById('formExternal');\n");
      out.write("      \n");
      out.write("      function switchFormType() {\n");
      out.write("        const isContract = requestTypeContract.checked;\n");
      out.write("        if (isContract) {\n");
      out.write("          formWithContract.style.display = 'block';\n");
      out.write("          formExternal.style.display = 'none';\n");
      out.write("        } else {\n");
      out.write("          formWithContract.style.display = 'none';\n");
      out.write("          formExternal.style.display = 'block';\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      if (requestTypeContract) {\n");
      out.write("        requestTypeContract.addEventListener('change', switchFormType);\n");
      out.write("      }\n");
      out.write("      if (requestTypeExternal) {\n");
      out.write("        requestTypeExternal.addEventListener('change', switchFormType);\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Reset form khi mở modal\n");
      out.write("      const modalEl = document.getElementById('supportModal');\n");
      out.write("      if (modalEl) {\n");
      out.write("        modalEl.addEventListener('show.bs.modal', function(){\n");
      out.write("          // Reset về form có hợp đồng\n");
      out.write("          if (requestTypeContract) requestTypeContract.checked = true;\n");
      out.write("          if (requestTypeExternal) requestTypeExternal.checked = false;\n");
      out.write("          switchFormType();\n");
      out.write("          \n");
      out.write("          // Reset các trường\n");
      out.write("          if (document.getElementById('externalProductName')) {\n");
      out.write("            document.getElementById('externalProductName').value = '';\n");
      out.write("          }\n");
      out.write("          if (document.getElementById('categoryExternal')) {\n");
      out.write("            document.getElementById('categoryExternal').value = 'technical';\n");
      out.write("          }\n");
      out.write("        });\n");
      out.write("      }\n");
      out.write("    } catch (e) {}\n");
      out.write("    const tbody = document.getElementById('supportRows');\n");
      out.write("    const pagerContainer = document.querySelector('.pagination.custom-pagination');\n");
      out.write("    let allItems = []; // Cache để xử lý cancel ở frontend\n");
      out.write("    let currentPage = 1;\n");
      out.write("    const pageSize = 9;\n");
      out.write("    let totalRecords = 0;\n");
      out.write("    let totalPages = 1;\n");
      out.write("    let cancelledItems = new Set(); // Lưu trữ các ID đã hủy trên frontend\n");
      out.write("    let searchTerm = ''; // Lưu từ khóa tìm kiếm\n");
      out.write("    let filterStatus = ''; // Lọc theo trạng thái\n");
      out.write("    let filterCategory = ''; // Lọc theo loại yêu cầu\n");
      out.write("    let sortField = ''; // Field để sắp xếp\n");
      out.write("    let sortDirection = 'desc'; // 'asc' hoặc 'desc'\n");
      out.write("    function formatDate(it){\n");
      out.write("      // Format theo dd/MM/yyyy\n");
      out.write("      if (it.createdDate && typeof it.createdDate === 'string') {\n");
      out.write("        if (it.createdDate.includes('-')) {\n");
      out.write("          // Format yyyy-MM-dd từ database\n");
      out.write("          var parts = it.createdDate.split('-');\n");
      out.write("          if (parts.length === 3) {\n");
      out.write("            return parts[2] + '/' + parts[1] + '/' + parts[0];\n");
      out.write("          }\n");
      out.write("        } else if (it.createdDate.includes('/')) {\n");
      out.write("          // Đã có format với dấu /\n");
      out.write("          var testParts = it.createdDate.split('/');\n");
      out.write("          if (testParts.length === 3 && testParts[0].length === 4) {\n");
      out.write("            // Là yyyy/MM/dd, convert sang dd/MM/yyyy\n");
      out.write("            return testParts[2] + '/' + testParts[1] + '/' + testParts[0];\n");
      out.write("          }\n");
      out.write("          // Đã là dd/MM/yyyy, giữ nguyên\n");
      out.write("          return it.createdDate;\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      if (it.createdAt) {\n");
      out.write("        try {\n");
      out.write("          var date = new Date(it.createdAt);\n");
      out.write("          var dd = String(date.getDate()).padStart(2, '0');\n");
      out.write("          var mm = String(date.getMonth() + 1).padStart(2, '0');\n");
      out.write("          var yyyy = date.getFullYear();\n");
      out.write("          return dd + '/' + mm + '/' + yyyy;\n");
      out.write("        } catch (e) {\n");
      out.write("          console.error('Error formatting date:', e);\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      return '';\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    function getStatusText(status) {\n");
      out.write("      const statusMap = {\n");
      out.write("        'pending': 'Chờ xử lý',\n");
      out.write("        'open': 'Chờ xử lý',\n");
      out.write("        'in_progress': 'Đang xử lý',\n");
      out.write("        'processed': 'Đã xử lý',\n");
      out.write("        'resolved': 'Đã giải quyết',\n");
      out.write("        'cancelled': 'Đã hủy',\n");
      out.write("        'closed': 'Đã đóng'\n");
      out.write("      };\n");
      out.write("      return statusMap[status] || 'Chờ xử lý';\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    function getStatusClass(status) {\n");
      out.write("      const classMap = {\n");
      out.write("        'pending': 'bg-warning',\n");
      out.write("        'open': 'bg-warning',\n");
      out.write("        'in_progress': 'bg-info',\n");
      out.write("        'processed': 'bg-info',\n");
      out.write("        'resolved': 'bg-success',\n");
      out.write("        'cancelled': 'bg-danger',\n");
      out.write("        'closed': 'bg-secondary'\n");
      out.write("      };\n");
      out.write("      return classMap[status] || 'bg-warning';\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hàm filterItems đã được chuyển sang backend, không cần nữa\n");
      out.write("    \n");
      out.write("    function rows(items){\n");
      out.write("      console.log('rows() called with', items ? items.length : 0, 'items');\n");
      out.write("      if (!tbody) {\n");
      out.write("        console.error('tbody element not found!');\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      tbody.innerHTML = '';\n");
      out.write("      if(!items || !items.length){\n");
      out.write("        tbody.innerHTML = '<tr><td colspan=\"6\" class=\"text-center text-muted\"><i class=\"fas fa-info-circle\"></i> Bạn chưa có yêu cầu hỗ trợ nào. <a href=\"#\" data-bs-toggle=\"modal\" data-bs-target=\"#supportModal\" class=\"text-primary\">Tạo yêu cầu mới</a></td></tr>';\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      items.forEach(function(it, idx){\n");
      out.write("        const created = formatDate(it);\n");
      out.write("        // Ưu tiên trạng thái đã hủy trên frontend\n");
      out.write("        const finalStatus = cancelledItems.has(String(it.id)) ? 'cancelled' : (it.status || 'pending');\n");
      out.write("        const status = getStatusText(finalStatus);\n");
      out.write("        const statusClass = getStatusClass(finalStatus);\n");
      out.write("        const tr = document.createElement('tr');\n");
      out.write("        // Hiển thị nút hủy cho pending, open, cancelled, closed\n");
      out.write("        const canCancel = finalStatus === 'pending' || finalStatus === 'open' || finalStatus === 'cancelled' || finalStatus === 'closed';\n");
      out.write("        const cancelButton = canCancel ? '<a href=\"#\" class=\"cancel-link text-danger\" data-id=\"'+ (it.id||'') +'\">Hủy</a>' : '';\n");
      out.write("        // Hiển thị nút feedback cho resolved hoặc closed\n");
      out.write("        const canFeedback = finalStatus === 'resolved' || finalStatus === 'closed';\n");
      out.write("        const feedbackButton = canFeedback ? '<a href=\"#\" class=\"feedback-link text-success ms-2\" data-id=\"'+ (it.id||'') +'\" data-ticket-number=\"'+ (it.ticketNumber||'') +'\" title=\"Đánh giá dịch vụ\"><i class=\"fas fa-star\"></i> Feedback</a>' : '';\n");
      out.write("        // Tính số thứ tự theo trang hiện tại\n");
      out.write("        const sequenceNumber = (currentPage - 1) * pageSize + idx + 1;\n");
      out.write("        var displaySubject = (it.subject||'');\n");
      out.write("        tr.innerHTML = '<td>'+ sequenceNumber +'</td><td>'+ (it.category||'') +'</td><td>'+ displaySubject +'</td><td>'+ created +'</td><td><span class=\"badge ' + statusClass + '\">' + status + '</span></td><td><a href=\"#\" class=\"view-link me-2\" data-id=\"'+ (it.id||'') +'\">Xem</a> ' + cancelButton + feedbackButton + '</td>';\n");
      out.write("        tbody.appendChild(tr);\n");
      out.write("      });\n");
      out.write("      console.log('rows() completed, added', items.length, 'rows to tbody');\n");
      out.write("    }\n");
      out.write("\n");
      out.write("    function renderPagination(){\n");
      out.write("      if(!pagerContainer) {\n");
      out.write("        console.warn('pagerContainer not found!');\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      console.log('renderPagination() - currentPage:', currentPage, 'totalPages:', totalPages);\n");
      out.write("      let html = '';\n");
      out.write("      html += '<li class=\"page-item'+(currentPage===1?' disabled':'')+'\"><a class=\"page-link\" href=\"#\" data-page=\"prev\">Trước</a></li>';\n");
      out.write("      // show only current page number\n");
      out.write("      html += '<li class=\"page-item active\"><a class=\"page-link\" href=\"#\" data-page=\"'+currentPage+'\">'+currentPage+'</a></li>';\n");
      out.write("      html += '<li class=\"page-item'+(currentPage>=totalPages?' disabled':'')+'\"><a class=\"page-link\" href=\"#\" data-page=\"next\">Tiếp</a></li>';\n");
      out.write("      pagerContainer.innerHTML = html;\n");
      out.write("      console.log('Pagination HTML:', html);\n");
      out.write("    }\n");
      out.write("\n");
      out.write("    function renderPage(page){\n");
      out.write("      // Validate page\n");
      out.write("      console.log('renderPage called with:', page, 'currentPage:', currentPage, 'totalPages:', totalPages);\n");
      out.write("      if(page === 'prev') page = Math.max(1, currentPage - 1);\n");
      out.write("      if(page === 'next') page = Math.min(totalPages, currentPage + 1);\n");
      out.write("      page = Math.min(Math.max(1, parseInt(page||1,10)), totalPages);\n");
      out.write("      console.log('Setting currentPage to:', page);\n");
      out.write("      currentPage = page;\n");
      out.write("      // Load data từ backend với page mới\n");
      out.write("      load();\n");
      out.write("    }\n");
      out.write("    function load(){\n");
      out.write("      console.log('Loading support requests...');\n");
      out.write("      console.log('Current filters - searchTerm:', searchTerm, 'filterStatus:', filterStatus, 'filterCategory:', filterCategory);\n");
      out.write("      console.log('Pagination - currentPage:', currentPage, 'pageSize:', pageSize, 'sortField:', sortField, 'sortDirection:', sortDirection);\n");
      out.write("      \n");
      out.write("      // Xây dựng URL với các tham số - sử dụng endpoint mới với logic backend\n");
      out.write("      let url = ctx + '/api/support-customer?action=list&page=' + currentPage + '&pageSize=' + pageSize;\n");
      out.write("      if (searchTerm) url += '&search=' + encodeURIComponent(searchTerm);\n");
      out.write("      if (filterStatus) url += '&filterStatus=' + encodeURIComponent(filterStatus);\n");
      out.write("      if (filterCategory) url += '&filterCategory=' + encodeURIComponent(filterCategory);\n");
      out.write("      if (sortField) url += '&sortField=' + encodeURIComponent(sortField);\n");
      out.write("      if (sortDirection) url += '&sortDirection=' + encodeURIComponent(sortDirection);\n");
      out.write("      \n");
      out.write("      console.log('Request URL:', url);\n");
      out.write("      \n");
      out.write("      fetch(url, {headers:{'Accept':'application/json'}})\n");
      out.write("        .then(r => {\n");
      out.write("          console.log('Load response status:', r.status);\n");
      out.write("          if (!r.ok) {\n");
      out.write("            throw new Error('HTTP ' + r.status);\n");
      out.write("          }\n");
      out.write("          return r.json();\n");
      out.write("        })\n");
      out.write("        .then(j => { \n");
      out.write("          console.log('Load response data (full):', JSON.stringify(j, null, 2));\n");
      out.write("          console.log('Response details - totalRecords:', j.totalRecords, 'totalPages:', j.totalPages, 'currentPage:', j.currentPage, 'pageSize:', j.pageSize);\n");
      out.write("          console.log('Response has data?', Array.isArray(j.data), 'data length:', j.data ? j.data.length : 0);\n");
      out.write("          if (j && j.success) {\n");
      out.write("            allItems = Array.isArray(j.data)? j.data : [];\n");
      out.write("            \n");
      out.write("            // Lấy thông tin phân trang từ response\n");
      out.write("            if (j.totalRecords !== undefined && j.totalRecords !== null) {\n");
      out.write("              totalRecords = parseInt(j.totalRecords);\n");
      out.write("            }\n");
      out.write("            if (j.totalPages !== undefined && j.totalPages !== null) {\n");
      out.write("              totalPages = Math.max(1, parseInt(j.totalPages));\n");
      out.write("            } else if (totalRecords > 0) {\n");
      out.write("              // Tính toán nếu backend không trả về\n");
      out.write("              totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));\n");
      out.write("            }\n");
      out.write("            if (j.currentPage !== undefined && j.currentPage !== null) {\n");
      out.write("              currentPage = Math.max(1, parseInt(j.currentPage));\n");
      out.write("            }\n");
      out.write("            \n");
      out.write("            console.log('Updating UI - allItems:', allItems.length, 'totalRecords:', totalRecords, 'totalPages:', totalPages, 'currentPage:', currentPage);\n");
      out.write("            \n");
      out.write("            // Đảm bảo render cả table và pagination\n");
      out.write("            if (tbody) {\n");
      out.write("              rows(allItems);\n");
      out.write("            } else {\n");
      out.write("              console.error('tbody is null!');\n");
      out.write("            }\n");
      out.write("            renderPagination();\n");
      out.write("          } else {\n");
      out.write("            console.error('Load server error:', j);\n");
      out.write("            if (tbody) {\n");
      out.write("              tbody.innerHTML='<tr><td colspan=\"6\" class=\"text-center text-danger\"><i class=\"fas fa-exclamation-triangle\"></i> ' + (j && j.message ? j.message : 'Lỗi tải dữ liệu') + '</td></tr>';\n");
      out.write("            }\n");
      out.write("          }\n");
      out.write("        })\n");
      out.write("        .catch(error => {\n");
      out.write("          console.error('Load request failed:', error);\n");
      out.write("          tbody.innerHTML='<tr><td colspan=\"6\" class=\"text-center text-danger\"><i class=\"fas fa-exclamation-triangle\"></i> Lỗi kết nối máy chủ: ' + error.message + '</td></tr>';\n");
      out.write("        });\n");
      out.write("    }\n");
      out.write("    load();\n");
      out.write("\n");
      out.write("    // Thêm event listener cho sắp xếp\n");
      out.write("    document.querySelector('th:nth-child(1)').addEventListener('click', function(e) {\n");
      out.write("      e.preventDefault();\n");
      out.write("      console.log('Sort by ID clicked, current sortField:', sortField, 'sortDirection:', sortDirection);\n");
      out.write("      if (sortField === 'id') {\n");
      out.write("        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';\n");
      out.write("      } else {\n");
      out.write("        sortField = 'id';\n");
      out.write("        sortDirection = 'asc';\n");
      out.write("      }\n");
      out.write("      const arrowEl = document.getElementById('sortIdArrow');\n");
      out.write("      if (arrowEl) arrowEl.textContent = sortDirection === 'asc' ? ' ↑' : ' ↓';\n");
      out.write("      currentPage = 1; // Reset về trang đầu khi sắp xếp\n");
      out.write("      console.log('Loading with sortField:', sortField, 'sortDirection:', sortDirection);\n");
      out.write("      load();\n");
      out.write("    });\n");
      out.write("    \n");
      out.write("    document.querySelector('th:nth-child(4)').addEventListener('click', function(e) {\n");
      out.write("      e.preventDefault();\n");
      out.write("      console.log('Sort by Date clicked, current sortField:', sortField, 'sortDirection:', sortDirection);\n");
      out.write("      if (sortField === 'date' || sortField === 'created_at') {\n");
      out.write("        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';\n");
      out.write("      } else {\n");
      out.write("        sortField = 'date';\n");
      out.write("        sortDirection = 'desc';\n");
      out.write("      }\n");
      out.write("      const arrowEl = document.getElementById('sortDateArrow');\n");
      out.write("      if (arrowEl) arrowEl.textContent = sortDirection === 'asc' ? ' ↑' : ' ↓';\n");
      out.write("      currentPage = 1; // Reset về trang đầu khi sắp xếp\n");
      out.write("      console.log('Loading with sortField:', sortField, 'sortDirection:', sortDirection);\n");
      out.write("      load();\n");
      out.write("    });\n");
      out.write("\n");
      out.write("    // Thêm chức năng tìm kiếm và lọc\n");
      out.write("    const searchInput = document.getElementById('searchInput');\n");
      out.write("    const statusSelect = document.getElementById('filterStatus');\n");
      out.write("    const categorySelect = document.getElementById('filterCategory');\n");
      out.write("    const filterBtn = document.getElementById('filterBtn');\n");
      out.write("    const clearFilterBtn = document.getElementById('clearFilterBtn');\n");
      out.write("    \n");
      out.write("    // Hàm áp dụng bộ lọc\n");
      out.write("    function applyFilters() {\n");
      out.write("      searchTerm = searchInput ? searchInput.value.trim() : '';\n");
      out.write("      filterStatus = statusSelect ? statusSelect.value : '';\n");
      out.write("      filterCategory = categorySelect ? categorySelect.value : '';\n");
      out.write("      currentPage = 1; // Reset về trang đầu khi lọc\n");
      out.write("      console.log('Applying filters - searchTerm:', searchTerm, 'filterStatus:', filterStatus, 'filterCategory:', filterCategory);\n");
      out.write("      load();\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Hàm xóa bộ lọc\n");
      out.write("    function clearFilters() {\n");
      out.write("      if (searchInput) searchInput.value = '';\n");
      out.write("      if (statusSelect) statusSelect.selectedIndex = 0;\n");
      out.write("      if (categorySelect) categorySelect.selectedIndex = 0;\n");
      out.write("      searchTerm = '';\n");
      out.write("      filterStatus = '';\n");
      out.write("      filterCategory = '';\n");
      out.write("      currentPage = 1; // Reset về trang đầu khi xóa lọc\n");
      out.write("      console.log('Clearing filters');\n");
      out.write("      load();\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Event listeners\n");
      out.write("    if (filterBtn) {\n");
      out.write("      filterBtn.addEventListener('click', applyFilters);\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    if (clearFilterBtn) {\n");
      out.write("      clearFilterBtn.addEventListener('click', clearFilters);\n");
      out.write("    }\n");
      out.write("    \n");
      out.write("    // Cho phép Enter để lọc\n");
      out.write("    if (searchInput) {\n");
      out.write("      searchInput.addEventListener('keypress', function(e) {\n");
      out.write("        if (e.key === 'Enter') {\n");
      out.write("          applyFilters();\n");
      out.write("        }\n");
      out.write("      });\n");
      out.write("    }\n");
      out.write("\n");
      out.write("    if (pagerContainer) {\n");
      out.write("      pagerContainer.addEventListener('click', function(e){\n");
      out.write("        const a = e.target.closest('a[data-page]');\n");
      out.write("        if(!a) return;\n");
      out.write("        e.preventDefault();\n");
      out.write("        const p = a.getAttribute('data-page');\n");
      out.write("        console.log('Pagination clicked, page:', p);\n");
      out.write("        renderPage(p === 'prev' || p === 'next' ? p : parseInt(p,10));\n");
      out.write("      });\n");
      out.write("    } else {\n");
      out.write("      console.warn('pagerContainer not found for event listener!');\n");
      out.write("    }\n");
      out.write("\n");
      out.write("    // Handle submit\n");
      out.write("    document.getElementById('supportForm').addEventListener('submit', function(e){\n");
      out.write("      e.preventDefault();\n");
      out.write("      const form = e.target;\n");
      out.write("      \n");
      out.write("      // Xác định loại form được chọn\n");
      out.write("      const requestTypeContract = document.getElementById('requestTypeContract');\n");
      out.write("      const isContractType = requestTypeContract && requestTypeContract.checked;\n");
      out.write("      \n");
      out.write("      const subject = document.getElementById('subject').value || '';\n");
      out.write("      const description = document.getElementById('description').value || '';\n");
      out.write("      \n");
      out.write("      // Validation theo loại form\n");
      out.write("      if (isContractType) {\n");
      out.write("        // Form có hợp đồng\n");
      out.write("        const cSel = document.getElementById('contractSelect');\n");
      out.write("        const pSel = document.getElementById('contractProductSelect');\n");
      out.write("        \n");
      out.write("        if (!cSel || !cSel.value || cSel.value.trim() === '') {\n");
      out.write("          showSuccessModal('Lỗi', 'Vui lòng chọn hợp đồng trước khi tạo yêu cầu hỗ trợ!');\n");
      out.write("          return;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        if (!pSel || !pSel.value || pSel.value.trim() === '') {\n");
      out.write("          showSuccessModal('Lỗi', 'Vui lòng chọn sản phẩm trong hợp đồng trước khi tạo yêu cầu hỗ trợ!');\n");
      out.write("          return;\n");
      out.write("        }\n");
      out.write("      } else {\n");
      out.write("        // Form sản phẩm ngoài\n");
      out.write("        const externalProductName = document.getElementById('externalProductName');\n");
      out.write("        if (!externalProductName || !externalProductName.value || externalProductName.value.trim() === '') {\n");
      out.write("          showSuccessModal('Lỗi', 'Vui lòng nhập tên sản phẩm muốn sửa chữa!');\n");
      out.write("          return;\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Kiểm tra các trường chung\n");
      out.write("      if (!subject || subject.trim() === '') {\n");
      out.write("        showSuccessModal('Lỗi', 'Vui lòng nhập tiêu đề yêu cầu hỗ trợ!');\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      if (!description || description.trim() === '') {\n");
      out.write("        showSuccessModal('Lỗi', 'Vui lòng nhập chi tiết vấn đề!');\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      const data = new URLSearchParams();\n");
      out.write("      let composed = description;\n");
      out.write("      let category = 'general';\n");
      out.write("      \n");
      out.write("      if (isContractType) {\n");
      out.write("        // Form có hợp đồng\n");
      out.write("        const cSel = document.getElementById('contractSelect');\n");
      out.write("        const pSel = document.getElementById('contractProductSelect');\n");
      out.write("        \n");
      out.write("        // Lưu hợp đồng/sản phẩm vào mô tả để hiển thị lại ở chi tiết\n");
      out.write("        if (cSel && cSel.value) {\n");
      out.write("          const cText = cSel.options[cSel.selectedIndex].textContent;\n");
      out.write("          composed = '[Hợp đồng: ' + cText + '] ' + composed;\n");
      out.write("        }\n");
      out.write("        if (pSel && pSel.value) {\n");
      out.write("          const pText = pSel.options[pSel.selectedIndex].textContent;\n");
      out.write("          composed = '[Sản phẩm: ' + pText + '] ' + composed;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        category = document.getElementById('category').value || 'general';\n");
      out.write("      } else {\n");
      out.write("        // Form sản phẩm ngoài\n");
      out.write("        const externalProductName = document.getElementById('externalProductName');\n");
      out.write("        if (externalProductName && externalProductName.value) {\n");
      out.write("          const productName = externalProductName.value.trim();\n");
      out.write("          composed = '[Sản phẩm ngoài: ' + productName + '] ' + composed;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        category = document.getElementById('categoryExternal').value || 'technical';\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      data.append('action', 'createSupportRequest');\n");
      out.write("      data.append('subject', subject);\n");
      out.write("      data.append('description', composed);\n");
      out.write("      data.append('category', category);\n");
      out.write("      \n");
      out.write("      // Lấy priority từ form\n");
      out.write("      const prioritySelect = document.getElementById('priority');\n");
      out.write("      const priority = prioritySelect ? (prioritySelect.value || 'medium') : 'medium';\n");
      out.write("      data.append('priority', priority);\n");
      out.write("      // Thêm deadline nếu có - date input trả về yyyy-MM-dd rồi, không cần convert\n");
      out.write("      const deadlineInp = document.getElementById('deadline');\n");
      out.write("      if (deadlineInp && deadlineInp.value && deadlineInp.value.trim() !== '') {\n");
      out.write("        var deadlineValue = deadlineInp.value.trim();\n");
      out.write("        console.log('DEBUG: Sending deadline:', deadlineValue);\n");
      out.write("        data.append('deadline', deadlineValue);\n");
      out.write("      } else {\n");
      out.write("        console.log('DEBUG: No deadline value found');\n");
      out.write("      }\n");
      out.write("      // backend tự xác định người dùng theo session; không gửi priority/customer/email\n");
      out.write("      fetch(ctx + '/api/support-customer', {\n");
      out.write("        method: 'POST',\n");
      out.write("        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },\n");
      out.write("        body: data.toString()\n");
      out.write("      }).then(r => {\n");
      out.write("        console.log('Response status:', r.status);\n");
      out.write("        console.log('Response headers:', r.headers);\n");
      out.write("        if (!r.ok) {\n");
      out.write("          throw new Error('HTTP ' + r.status);\n");
      out.write("        }\n");
      out.write("        return r.text().then(text => {\n");
      out.write("          console.log('Raw response text:', text);\n");
      out.write("          try {\n");
      out.write("            return JSON.parse(text);\n");
      out.write("          } catch (e) {\n");
      out.write("            console.error('JSON parse error:', e);\n");
      out.write("            throw new Error('Invalid JSON response: ' + text.substring(0, 100));\n");
      out.write("          }\n");
      out.write("        });\n");
      out.write("      })\n");
      out.write("        .then(j => {\n");
      out.write("          console.log('Parsed response data:', j);\n");
      out.write("          if(j && j.success){\n");
      out.write("            // Chỉ làm sạch các trường nhập liệu, giữ nguyên Họ tên/Email\n");
      out.write("            const subjInp = document.getElementById('subject');\n");
      out.write("            const descInp = document.getElementById('description');\n");
      out.write("            const catSel = document.getElementById('category');\n");
      out.write("            const cSel2 = document.getElementById('contractSelect');\n");
      out.write("            const pSel2 = document.getElementById('contractProductSelect');\n");
      out.write("            const externalProductName = document.getElementById('externalProductName');\n");
      out.write("            const categoryExternal = document.getElementById('categoryExternal');\n");
      out.write("            \n");
      out.write("            if (subjInp) subjInp.value = '';\n");
      out.write("            if (descInp) descInp.value = '';\n");
      out.write("            if (catSel) catSel.value = 'general';\n");
      out.write("            if (cSel2) cSel2.selectedIndex = 0;\n");
      out.write("            if (pSel2) { pSel2.innerHTML = '<option value=\"\">-- Chọn sản phẩm --</option>'; pSel2.disabled = true; }\n");
      out.write("            if (externalProductName) externalProductName.value = '';\n");
      out.write("            if (categoryExternal) categoryExternal.value = 'technical';\n");
      out.write("            \n");
      out.write("            // Reset priority về medium\n");
      out.write("            const prioritySelect = document.getElementById('priority');\n");
      out.write("            if (prioritySelect) prioritySelect.value = 'medium';\n");
      out.write("            \n");
      out.write("            // Reset về form có hợp đồng\n");
      out.write("            const requestTypeContract = document.getElementById('requestTypeContract');\n");
      out.write("            const requestTypeExternal = document.getElementById('requestTypeExternal');\n");
      out.write("            if (requestTypeContract) requestTypeContract.checked = true;\n");
      out.write("            if (requestTypeExternal) requestTypeExternal.checked = false;\n");
      out.write("            \n");
      out.write("            // Gọi lại hàm switchFormType nếu có\n");
      out.write("            const formWithContract = document.getElementById('formWithContract');\n");
      out.write("            const formExternal = document.getElementById('formExternal');\n");
      out.write("            if (formWithContract) formWithContract.style.display = 'block';\n");
      out.write("            if (formExternal) formExternal.style.display = 'none';\n");
      out.write("            // Reset deadline field về ngày hiện tại sau khi tạo thành công (date picker format: yyyy-MM-dd)\n");
      out.write("            const deadlineInp = document.getElementById('deadline');\n");
      out.write("            if (deadlineInp) {\n");
      out.write("              try {\n");
      out.write("                var today = new Date();\n");
      out.write("                var yyyy = today.getFullYear();\n");
      out.write("                var mm = String(today.getMonth() + 1).padStart(2, '0');\n");
      out.write("                var dd = String(today.getDate()).padStart(2, '0');\n");
      out.write("                var todayStr = yyyy + '-' + mm + '-' + dd;\n");
      out.write("                deadlineInp.value = todayStr;\n");
      out.write("              } catch(e) {\n");
      out.write("                deadlineInp.value = '';\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("\n");
      out.write("            const modalEl = document.getElementById('supportModal');\n");
      out.write("            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);\n");
      out.write("            modal.hide();\n");
      out.write("            \n");
      out.write("              // Hiển thị thông báo thành công bằng modal\n");
      out.write("              showSuccessModal('Tạo yêu cầu thành công!', j.message || 'Yêu cầu hỗ trợ đã được tạo thành công!');\n");
      out.write("            \n");
      out.write("            // Tải lại dữ liệu - reset về trang đầu\n");
      out.write("            currentPage = 1;\n");
      out.write("            load();\n");
      out.write("          } else {\n");
      out.write("            console.error('Server error:', j);\n");
      out.write("            alert(j && j.message ? j.message : 'Không thể tạo yêu cầu');\n");
      out.write("          }\n");
      out.write("        })\n");
      out.write("        .catch(error => {\n");
      out.write("          console.error('Request failed:', error);\n");
      out.write("          alert('Lỗi kết nối máy chủ: ' + error.message);\n");
      out.write("        });\n");
      out.write("    });\n");
      out.write("\n");
      out.write("    \n");
      out.write("   \n");
      out.write("     // View detail handler\n");
      out.write("    tbody.addEventListener('click', function(e){\n");
      out.write("      const viewLink = e.target.closest('a.view-link');\n");
      out.write("      const cancelLink = e.target.closest('a.cancel-link');\n");
      out.write("      const feedbackLink = e.target.closest('a.feedback-link');\n");
      out.write("      \n");
      out.write("      if(feedbackLink) {\n");
      out.write("        e.preventDefault();\n");
      out.write("        const id = feedbackLink.getAttribute('data-id');\n");
      out.write("        const ticketNumber = feedbackLink.getAttribute('data-ticket-number');\n");
      out.write("        openFeedbackModal(id, ticketNumber);\n");
      out.write("        return;\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      if(viewLink) {\n");
      out.write("        e.preventDefault();\n");
      out.write("        const id = viewLink.getAttribute('data-id');\n");
      out.write("        const it = allItems.find(function(x){ return String(x.id) === String(id); });\n");
      out.write("        if(!it) return;\n");
      out.write("        \n");
      out.write("        // Load fresh data from server for this specific ticket\n");
      out.write("        fetch(ctx + '/api/support-stats?action=getById&id=' + encodeURIComponent(id), { headers: { 'Accept': 'application/json' } })\n");
      out.write("          .then(r => r.json())\n");
      out.write("          .then(j => {\n");
      out.write("            console.log('DEBUG: getById response:', j);\n");
      out.write("            if (j && j.success && j.data) {\n");
      out.write("              // Use fresh data from server instead of cached data\n");
      out.write("              const freshData = j.data;\n");
      out.write("              console.log('DEBUG: freshData.deadline =', freshData.deadline);\n");
      out.write("              displayTicketDetail(freshData);\n");
      out.write("            } else {\n");
      out.write("              console.log('DEBUG: API failed, using cached data');\n");
      out.write("              // Fallback to cached data if API fails\n");
      out.write("              displayTicketDetail(it);\n");
      out.write("            }\n");
      out.write("          })\n");
      out.write("          .catch(error => {\n");
      out.write("            console.error('Failed to load fresh ticket data:', error);\n");
      out.write("            // Fallback to cached data\n");
      out.write("            displayTicketDetail(it);\n");
      out.write("          });\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      function displayTicketDetail(ticketData) {\n");
      out.write("      document.getElementById('v_ticket').textContent = ticketData.ticketNumber || '';\n");
      out.write("      // Hiển thị trạng thái bằng tiếng Việt\n");
      out.write("      const statusText = getStatusText(ticketData.status || 'pending');\n");
      out.write("      document.getElementById('v_status').textContent = statusText;\n");
      out.write("      // fill editable inputs\n");
      out.write("      var catInp = document.getElementById('v_category_inp');\n");
      out.write("      var priInp = document.getElementById('v_priority_inp');\n");
      out.write("      var subInp = document.getElementById('v_subject_inp');\n");
      out.write("      var desInp = document.getElementById('v_description_inp');\n");
      out.write("      var vContract = document.getElementById('v_contract_select');\n");
      out.write("      var vProduct = document.getElementById('v_product_select');\n");
      out.write("      var vExternalProduct = document.getElementById('v_external_product');\n");
      out.write("      var vDeadline = document.getElementById('v_deadline');\n");
      out.write("      // Reset trường sản phẩm ngoài về rỗng trước khi điền dữ liệu\n");
      out.write("      if (vExternalProduct) vExternalProduct.value = '';\n");
      out.write("      if (catInp) catInp.value = (ticketData.category||'general');\n");
      out.write("      if (priInp) priInp.value = (ticketData.priority ? ticketData.priority : '');\n");
      out.write("      if (subInp) subInp.value = (ticketData.subject||'');\n");
      out.write("      \n");
      out.write("      // Lưu description gốc (có prefix) để parse hợp đồng/sản phẩm\n");
      out.write("      var originalDescription = ticketData.description || '';\n");
      out.write("      \n");
      out.write("      // Loại bỏ các prefix [Sản phẩm: ...], [Hợp đồng: ...], [Sản phẩm ngoài: ...] khi hiển thị\n");
      out.write("      let cleanDescription = originalDescription;\n");
      out.write("      if (cleanDescription) {\n");
      out.write("        // Loại bỏ [Sản phẩm: ...]\n");
      out.write("        cleanDescription = cleanDescription.replace(/\\[Sản phẩm:[^\\]]+\\]\\s*/g, '');\n");
      out.write("        // Loại bỏ [Hợp đồng: ...]\n");
      out.write("        cleanDescription = cleanDescription.replace(/\\[Hợp đồng:[^\\]]+\\]\\s*/g, '');\n");
      out.write("        // Loại bỏ [Sản phẩm ngoài: ...]\n");
      out.write("        cleanDescription = cleanDescription.replace(/\\[Sản phẩm ngoài:[^\\]]+\\]\\s*/g, '');\n");
      out.write("        // Loại bỏ khoảng trắng thừa ở đầu và cuối\n");
      out.write("        cleanDescription = cleanDescription.trim();\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Hiển thị description đã làm sạch trong textarea\n");
      out.write("      if (desInp) desInp.value = cleanDescription;\n");
      out.write("      // Hiển thị deadline - date input cần format yyyy-MM-dd\n");
      out.write("      if (vDeadline) {\n");
      out.write("        console.log('DEBUG: ticketData.deadline =', ticketData.deadline);\n");
      out.write("        \n");
      out.write("        // Set min attribute để không cho chọn ngày quá khứ\n");
      out.write("        var today = new Date();\n");
      out.write("        var yyyy = today.getFullYear();\n");
      out.write("        var mm = String(today.getMonth() + 1).padStart(2, '0');\n");
      out.write("        var dd = String(today.getDate()).padStart(2, '0');\n");
      out.write("        var todayStr = yyyy + '-' + mm + '-' + dd;\n");
      out.write("        vDeadline.setAttribute('min', todayStr);\n");
      out.write("        \n");
      out.write("        if (ticketData.deadline) {\n");
      out.write("          var deadlineValue = ticketData.deadline;\n");
      out.write("          // Convert sang yyyy-MM-dd nếu cần\n");
      out.write("          if (typeof deadlineValue === 'string') {\n");
      out.write("            if (deadlineValue.includes('/')) {\n");
      out.write("              // Convert từ dd/MM/yyyy hoặc yyyy/MM/dd sang yyyy-MM-dd\n");
      out.write("              var parts = deadlineValue.split('/');\n");
      out.write("              if (parts.length === 3) {\n");
      out.write("                if (parts[0].length === 4) {\n");
      out.write("                  // yyyy/MM/dd\n");
      out.write("                  deadlineValue = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');\n");
      out.write("                } else {\n");
      out.write("                  // dd/MM/yyyy\n");
      out.write("                  deadlineValue = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');\n");
      out.write("                }\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("            // Nếu đã là yyyy-MM-dd thì giữ nguyên\n");
      out.write("            vDeadline.value = deadlineValue;\n");
      out.write("          } else {\n");
      out.write("            vDeadline.value = deadlineValue;\n");
      out.write("          }\n");
      out.write("          console.log('DEBUG: Set deadline value to:', vDeadline.value);\n");
      out.write("        } else {\n");
      out.write("          vDeadline.value = '';\n");
      out.write("          console.log('DEBUG: No deadline, cleared field');\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      // Format ngày tạo theo dd/MM/yyyy\n");
      out.write("      var created = '';\n");
      out.write("      if (ticketData.createdDate) {\n");
      out.write("        // Nếu có createdDate từ database (format: yyyy-MM-dd)\n");
      out.write("        if (ticketData.createdDate.includes('-')) {\n");
      out.write("          var parts = ticketData.createdDate.split('-');\n");
      out.write("          if (parts.length === 3) {\n");
      out.write("            created = parts[2] + '/' + parts[1] + '/' + parts[0];\n");
      out.write("          } else {\n");
      out.write("            created = ticketData.createdDate;\n");
      out.write("          }\n");
      out.write("        } else if (ticketData.createdDate.includes('/')) {\n");
      out.write("          // Đã là dd/MM/yyyy hoặc MM/dd/yyyy\n");
      out.write("          var testParts = ticketData.createdDate.split('/');\n");
      out.write("          if (testParts.length === 3 && testParts[0].length === 4) {\n");
      out.write("            // Là yyyy/MM/dd, convert sang dd/MM/yyyy\n");
      out.write("            created = testParts[2] + '/' + testParts[1] + '/' + testParts[0];\n");
      out.write("          } else {\n");
      out.write("            created = ticketData.createdDate;\n");
      out.write("          }\n");
      out.write("        } else {\n");
      out.write("          created = ticketData.createdDate;\n");
      out.write("        }\n");
      out.write("      } else if (ticketData.createdAt) {\n");
      out.write("        // Fallback: format từ timestamp\n");
      out.write("        try {\n");
      out.write("          var date = new Date(ticketData.createdAt);\n");
      out.write("          var dd = String(date.getDate()).padStart(2, '0');\n");
      out.write("          var mm = String(date.getMonth() + 1).padStart(2, '0');\n");
      out.write("          var yyyy = date.getFullYear();\n");
      out.write("          created = dd + '/' + mm + '/' + yyyy;\n");
      out.write("        } catch(e) {\n");
      out.write("          created = formatDate(ticketData);\n");
      out.write("        }\n");
      out.write("      } else {\n");
      out.write("        created = formatDate(ticketData);\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Format ngày xử lý xong theo dd/MM/yyyy\n");
      out.write("      var resolved = '';\n");
      out.write("      if (ticketData.resolvedAt) {\n");
      out.write("        try {\n");
      out.write("          var resolvedDate = new Date(ticketData.resolvedAt);\n");
      out.write("          var rdd = String(resolvedDate.getDate()).padStart(2, '0');\n");
      out.write("          var rmm = String(resolvedDate.getMonth() + 1).padStart(2, '0');\n");
      out.write("          var ryyyy = resolvedDate.getFullYear();\n");
      out.write("          resolved = rdd + '/' + rmm + '/' + ryyyy;\n");
      out.write("        } catch(e) {\n");
      out.write("          resolved = '';\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      document.getElementById('v_created').textContent = created;\n");
      out.write("      document.getElementById('v_resolved').textContent = resolved;\n");
      out.write("      \n");
      out.write("      // Hiển thị các trường mới\n");
      out.write("      // Ưu tiên hiển thị tên người được phân công, nếu không có thì hiển thị ID, nếu không có thì \"Chưa phân công\"\n");
      out.write("      var assignedToDisplay = ticketData.assignedToName || ticketData.assignedTo || 'Chưa phân công';\n");
      out.write("      document.getElementById('v_assigned_to').textContent = assignedToDisplay;\n");
      out.write("      document.getElementById('v_resolution').value = ticketData.resolution || '';\n");
      out.write("      \n");
      out.write("      // Store ticket ID in modal for feedback\n");
      out.write("      document.getElementById('viewModal').setAttribute('data-current-ticket-id', ticketData.id);\n");
      out.write("      \n");
      out.write("      // Show the modal\n");
      out.write("      const vm = bootstrap.Modal.getOrCreateInstance(document.getElementById('viewModal'));\n");
      out.write("      vm.show();\n");
      out.write("      \n");
      out.write("      // reset edit state\n");
      out.write("      const enable = document.getElementById('v_enable_edit');\n");
      out.write("      const saveBtn = document.getElementById('v_save_btn');\n");
      out.write("      [catInp, priInp, subInp, desInp, vDeadline, vExternalProduct].forEach(function(el){ if(el){ el.disabled = true; }});\n");
      out.write("      if (enable) enable.checked = false;\n");
      out.write("      if (saveBtn) saveBtn.disabled = true;\n");
      out.write("      \n");
      out.write("      // Kiểm tra trạng thái để quyết định có cho phép chỉnh sửa không\n");
      out.write("      const finalStatus = cancelledItems.has(String(ticketData.id)) ? 'cancelled' : (ticketData.status || 'pending');\n");
      out.write("      const canEdit = finalStatus === 'pending' || finalStatus === 'open';\n");
      out.write("      \n");
      out.write("      // Disable checkbox nếu không thể chỉnh sửa\n");
      out.write("      if (enable) {\n");
      out.write("        enable.disabled = !canEdit;\n");
      out.write("        if (!canEdit) {\n");
      out.write("          enable.title = 'Yêu cầu đang được thực hiện - không thể chỉnh sửa';\n");
      out.write("          enable.parentElement.style.color = '#dc3545';\n");
      out.write("          enable.parentElement.innerHTML = '<input class=\"form-check-input\" type=\"checkbox\" id=\"v_enable_edit\" disabled><label class=\"form-check-label\" for=\"v_enable_edit\" style=\"color: #dc3545;\">Chỉ chỉnh sửa và Lưu được yêu cầu trong trạng thái \"Chờ xử lý\"</label>';\n");
      out.write("        } else {\n");
      out.write("          enable.parentElement.style.color = '';\n");
      out.write("        }\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // Load contracts for view (read-only)\n");
      out.write("      try {\n");
      out.write("        // reset\n");
      out.write("        if (vContract) { vContract.innerHTML = '<option value=\"\">-- Chọn hợp đồng --</option>'; }\n");
      out.write("        if (vProduct) { vProduct.innerHTML = '<option value=\"\">-- Chọn sản phẩm --</option>'; vProduct.disabled = true; }\n");
      out.write("        fetch(ctx + '/api/contracts', { headers: { 'Accept': 'application/json' } })\n");
      out.write("          .then(r=>r.json()).then(function(j){\n");
      out.write("            if (!j || !j.success) return;\n");
      out.write("            // Lọc chỉ lấy hợp đồng có trạng thái 'active' hoặc 'terminated'\n");
      out.write("            const list = Array.isArray(j.data) ? j.data.filter(function(c) { return c.status === 'active' || c.status === 'terminated'; }) : [];\n");
      out.write("            list.forEach(function(c){\n");
      out.write("              var opt = document.createElement('option');\n");
      out.write("              opt.value = c.id;\n");
      out.write("              opt.textContent = (c.contractNumber ? (c.contractNumber + ' - ') : '') + (c.title || ('HĐ #' + c.id));\n");
      out.write("              vContract.appendChild(opt);\n");
      out.write("            });\n");
      out.write("            // Try detect from description pattern [Hợp đồng: ...] [Sản phẩm: ...] [Sản phẩm ngoài: ...]\n");
      out.write("            // Sử dụng originalDescription (có prefix) thay vì desInp.value (đã bị làm sạch)\n");
      out.write("            var desc = originalDescription || '';\n");
      out.write("            var contractLabel = (desc.match(/\\[Hợp đồng:([^\\]]+)\\]/) || [])[1];\n");
      out.write("            var productLabel = (desc.match(/\\[Sản phẩm:([^\\]]+)\\]/) || [])[1];\n");
      out.write("            var externalProductLabel = (desc.match(/\\[Sản phẩm ngoài:([^\\]]+)\\]/) || [])[1];\n");
      out.write("            \n");
      out.write("            // Hiển thị sản phẩm ngoài nếu có, nếu không thì để trống\n");
      out.write("            if (vExternalProduct) {\n");
      out.write("              if (externalProductLabel) {\n");
      out.write("              vExternalProduct.value = externalProductLabel.trim();\n");
      out.write("              } else {\n");
      out.write("                vExternalProduct.value = '';\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("            if (contractLabel) {\n");
      out.write("              for (var i=0;i<vContract.options.length;i++) {\n");
      out.write("                if (vContract.options[i].textContent.indexOf(contractLabel.trim()) !== -1) {\n");
      out.write("                  vContract.selectedIndex = i; break;\n");
      out.write("                }\n");
      out.write("              }\n");
      out.write("              if (vContract.value) {\n");
      out.write("                vProduct.disabled = false;\n");
      out.write("                fetch(ctx + '/api/contract-items?contractId=' + encodeURIComponent(vContract.value), { headers: { 'Accept': 'application/json' } })\n");
      out.write("                  .then(r=>r.json()).then(function(j2){\n");
      out.write("                    if (!j2 || !j2.success) return;\n");
      out.write("                    (Array.isArray(j2.data)? j2.data: []).forEach(function(item){\n");
      out.write("                      var opt = document.createElement('option');\n");
      out.write("                      opt.value = item.productId;\n");
      out.write("                      var name = item.description ? item.description : ('Sản phẩm #' + item.productId);\n");
      out.write("                      opt.textContent = name;\n");
      out.write("                      vProduct.appendChild(opt);\n");
      out.write("                    });\n");
      out.write("                    if (productLabel) {\n");
      out.write("                      for (var k=0;k<vProduct.options.length;k++) {\n");
      out.write("                        if (vProduct.options[k].textContent.indexOf(productLabel.trim()) !== -1) {\n");
      out.write("                          vProduct.selectedIndex = k; break;\n");
      out.write("                        }\n");
      out.write("                      }\n");
      out.write("                    }\n");
      out.write("                  });\n");
      out.write("              }\n");
      out.write("            }\n");
      out.write("          });\n");
      out.write("      } catch(e) {}\n");
      out.write("      \n");
      out.write("      // Attach handlers for edit functionality\n");
      out.write("      attachEditHandlers(ticketData.id, ticketData.status, catInp, priInp, subInp, desInp, vContract, vProduct, vExternalProduct, enable, saveBtn, vm);\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      function attachEditHandlers(ticketId, ticketStatus, catInp, priInp, subInp, desInp, vContract, vProduct, vExternalProduct, enable, saveBtn, vm) {\n");
      out.write("      // Kiểm tra trạng thái để quyết định có cho phép chỉnh sửa không\n");
      out.write("      const finalStatus = cancelledItems.has(String(ticketId)) ? 'cancelled' : (ticketStatus || 'pending');\n");
      out.write("      const canEdit = finalStatus === 'pending' || finalStatus === 'open';\n");
      out.write("      const vDeadline = document.getElementById('v_deadline');\n");
      out.write("      \n");
      out.write("      // Set min attribute cho deadline date picker để không cho chọn ngày quá khứ\n");
      out.write("      if (vDeadline) {\n");
      out.write("        var today = new Date();\n");
      out.write("        var yyyy = today.getFullYear();\n");
      out.write("        var mm = String(today.getMonth() + 1).padStart(2, '0');\n");
      out.write("        var dd = String(today.getDate()).padStart(2, '0');\n");
      out.write("        var todayStr = yyyy + '-' + mm + '-' + dd;\n");
      out.write("        vDeadline.setAttribute('min', todayStr);\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      // attach handlers\n");
      out.write("      if (enable) {\n");
      out.write("        enable.onchange = function(){\n");
      out.write("          if (!canEdit) {\n");
      out.write("            alert('Yêu cầu đang được thực hiện - không thể chỉnh sửa!');\n");
      out.write("            enable.checked = false;\n");
      out.write("            return;\n");
      out.write("          }\n");
      out.write("          var on = !!enable.checked;\n");
      out.write("          // chỉnh sửa loại yêu cầu, tiêu đề, mô tả, deadline, priority, sản phẩm ngoài\n");
      out.write("          [catInp, subInp, desInp, vDeadline, priInp, vExternalProduct].forEach(function(el){ if(el){ el.disabled = !on; }});\n");
      out.write("          if (saveBtn) saveBtn.disabled = !on;\n");
      out.write("          // Cho phép chọn hợp đồng/sản phẩm khi bật chỉnh sửa\n");
      out.write("          if (vContract) vContract.disabled = !on;\n");
      out.write("          if (vProduct) vProduct.disabled = !on || !vContract || !vContract.value;\n");
      out.write("          // Nạp lại danh sách sản phẩm khi đổi hợp đồng\n");
      out.write("          if (on && vContract) {\n");
      out.write("            vContract.onchange = function(){\n");
      out.write("              if (!vProduct) return;\n");
      out.write("              var id = vContract.value;\n");
      out.write("              vProduct.innerHTML = '<option value=\"\">-- Chọn sản phẩm --</option>';\n");
      out.write("              vProduct.disabled = !id;\n");
      out.write("              if (!id) return;\n");
      out.write("              fetch(ctx + '/api/contract-items?contractId=' + encodeURIComponent(id), { headers: { 'Accept': 'application/json' } })\n");
      out.write("                .then(function(r){ return r.json(); })\n");
      out.write("                .then(function(j2){\n");
      out.write("                  if (!j2 || !j2.success) return;\n");
      out.write("                  (Array.isArray(j2.data) ? j2.data : []).forEach(function(item){\n");
      out.write("                    var opt = document.createElement('option');\n");
      out.write("                    opt.value = item.productId;\n");
      out.write("                    var name = item.description ? item.description : ('Sản phẩm #' + item.productId);\n");
      out.write("                    opt.textContent = name;\n");
      out.write("                    vProduct.appendChild(opt);\n");
      out.write("                  });\n");
      out.write("                });\n");
      out.write("            };\n");
      out.write("          }\n");
      out.write("        };\n");
      out.write("      }\n");
      out.write("      if (saveBtn) {\n");
      out.write("        saveBtn.onclick = function(){\n");
      out.write("          // Validate: phải thỏa mãn CHỈ 1 trong 2 điều kiện (không được cả hai):\n");
      out.write("          // 1. Có chọn Hợp đồng VÀ Sản phẩm trong hợp đồng\n");
      out.write("          // 2. HOẶC có nhập Sản phẩm ngoài\n");
      out.write("          var hasContract = vContract && vContract.value && vContract.value.trim() !== '';\n");
      out.write("          var hasProduct = vProduct && vProduct.value && vProduct.value.trim() !== '';\n");
      out.write("          var hasExternalProduct = vExternalProduct && vExternalProduct.value && vExternalProduct.value.trim() !== '';\n");
      out.write("          \n");
      out.write("          var condition1 = hasContract && hasProduct; // Có hợp đồng và sản phẩm\n");
      out.write("          var condition2 = hasExternalProduct; // Có sản phẩm ngoài\n");
      out.write("          \n");
      out.write("          // Kiểm tra: Nếu có chọn hợp đồng nhưng không chọn sản phẩm\n");
      out.write("          if (hasContract && !hasProduct) {\n");
      out.write("            alert('Vui lòng chọn Sản phẩm trong hợp đồng hoặc bỏ chọn Hợp đồng và chỉ nhập Sản phẩm ngoài.');\n");
      out.write("            return;\n");
      out.write("          }\n");
      out.write("          \n");
      out.write("          // Kiểm tra: Nếu có chọn hợp đồng (dù có sản phẩm hay không) VÀ có sản phẩm ngoài\n");
      out.write("          if (hasContract && hasExternalProduct) {\n");
      out.write("            alert('Vui lòng chỉ chọn một trong hai: (Hợp đồng và Sản phẩm trong hợp đồng) HOẶC (Sản phẩm ngoài). Không được chọn cả hai!');\n");
      out.write("            return;\n");
      out.write("          }\n");
      out.write("          \n");
      out.write("          // Kiểm tra không có điều kiện nào\n");
      out.write("          if (!condition1 && !condition2) {\n");
      out.write("            alert('Vui lòng chọn Hợp đồng và Sản phẩm trong hợp đồng hoặc thêm Sản phẩm ngoài trước khi lưu.');\n");
      out.write("            return;\n");
      out.write("          }\n");
      out.write("          const data = new URLSearchParams();\n");
      out.write("          // Ghép thông tin hợp đồng/sản phẩm HOẶC sản phẩm ngoài vào mô tả (chỉ một trong hai)\n");
      out.write("          var baseDesc = desInp.value || '';\n");
      out.write("          try {\n");
      out.write("            // Loại bỏ tất cả các prefix cũ\n");
      out.write("            baseDesc = baseDesc.replace(/\\[Hợp đồng:[^\\]]+\\]\\s*/g,'')\n");
      out.write("                               .replace(/\\[Sản phẩm:[^\\]]+\\]\\s*/g,'')\n");
      out.write("                               .replace(/\\[Sản phẩm ngoài:[^\\]]+\\]\\s*/g,'')\n");
      out.write("                               .trim();\n");
      out.write("          } catch(e) {}\n");
      out.write("          var composed = baseDesc;\n");
      out.write("          \n");
      out.write("          // Chỉ lưu một trong hai: hợp đồng+sản phẩm HOẶC sản phẩm ngoài\n");
      out.write("          if (condition1) {\n");
      out.write("            // Có hợp đồng và sản phẩm - lưu hợp đồng và sản phẩm\n");
      out.write("            if (vContract && vContract.value) {\n");
      out.write("              var cText = vContract.options[vContract.selectedIndex].textContent;\n");
      out.write("              composed = '[Hợp đồng: ' + cText + '] ' + composed;\n");
      out.write("            }\n");
      out.write("            if (vProduct && vProduct.value) {\n");
      out.write("              var pText = vProduct.options[vProduct.selectedIndex].textContent;\n");
      out.write("              composed = '[Sản phẩm: ' + pText + '] ' + composed;\n");
      out.write("            }\n");
      out.write("          } else if (condition2) {\n");
      out.write("            // Có sản phẩm ngoài - chỉ lưu sản phẩm ngoài\n");
      out.write("            if (vExternalProduct && vExternalProduct.value && vExternalProduct.value.trim() !== '') {\n");
      out.write("              var externalProductName = vExternalProduct.value.trim();\n");
      out.write("              composed = '[Sản phẩm ngoài: ' + externalProductName + '] ' + composed;\n");
      out.write("            }\n");
      out.write("          }\n");
      out.write("          data.append('action', 'createSupportRequest');\n");
      out.write("          data.append('subject', subInp.value || '');\n");
      out.write("          data.append('description', composed);\n");
      out.write("          data.append('category', catInp.value || 'general');\n");
      out.write("          \n");
      out.write("          // Lấy priority từ form\n");
      out.write("          const priority = priInp ? (priInp.value || 'medium') : 'medium';\n");
      out.write("          data.append('priority', priority);\n");
      out.write("          \n");
      out.write("          data.append('delete_old_id', ticketId); // thêm ID để xóa bản cũ\n");
      out.write("          // Thêm deadline nếu có - date input trả về yyyy-MM-dd rồi, không cần convert\n");
      out.write("          if (vDeadline && vDeadline.value && vDeadline.value.trim() !== '') {\n");
      out.write("            var deadlineValue = vDeadline.value.trim();\n");
      out.write("            data.append('deadline', deadlineValue);\n");
      out.write("          }\n");
      out.write("          fetch(ctx + '/api/support-customer', {\n");
      out.write("            method: 'POST',\n");
      out.write("            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },\n");
      out.write("            body: data.toString()\n");
      out.write("          }).then(r => {\n");
      out.write("            console.log('Update response status:', r.status);\n");
      out.write("            if (!r.ok) {\n");
      out.write("              throw new Error('HTTP ' + r.status);\n");
      out.write("            }\n");
      out.write("            return r.json();\n");
      out.write("          }).then(function(j){\n");
      out.write("            console.log('Update response data:', j);\n");
      out.write("            if(j && j.success){\n");
      out.write("              vm.hide();\n");
      out.write("              \n");
      out.write("              // Hiển thị thông báo thành công bằng modal\n");
      out.write("              showSuccessModal('Cập nhật thành công!', 'Yêu cầu hỗ trợ đã được cập nhật thành công!');\n");
      out.write("              \n");
      out.write("              // Tải lại dữ liệu\n");
      out.write("              load();\n");
      out.write("            } else {\n");
      out.write("              console.error('Update server error:', j);\n");
      out.write("              alert(j && j.message ? j.message : 'Không thể cập nhật');\n");
      out.write("            }\n");
      out.write("          }).catch(function(error){ \n");
      out.write("            console.error('Update request failed:', error);\n");
      out.write("            alert('Lỗi kết nối máy chủ: ' + error.message); \n");
      out.write("          });\n");
      out.write("        };\n");
      out.write("      }\n");
      out.write("      }\n");
      out.write("      \n");
      out.write("      if(cancelLink) {\n");
      out.write("        e.preventDefault();\n");
      out.write("        const id = cancelLink.getAttribute('data-id');\n");
      out.write("        const it = allItems.find(function(x){ return String(x.id) === String(id); });\n");
      out.write("        if(!it) return;\n");
      out.write("        \n");
      out.write("        // Kiểm tra trạng thái trước khi hủy\n");
      out.write("        const finalStatus = cancelledItems.has(String(id)) ? 'cancelled' : (it.status || 'pending');\n");
      out.write("        if(finalStatus !== 'pending' && finalStatus !== 'open' && finalStatus !== 'cancelled' && finalStatus !== 'closed') {\n");
      out.write("          alert('Chỉ có thể hủy yêu cầu đang chờ xử lý, đã hủy hoặc đã đóng!');\n");
      out.write("          return;\n");
      out.write("        }\n");
      out.write("        \n");
      out.write("        \n");
      out.write("        // Hiển thị modal xác nhận thay vì confirm()\n");
      out.write("        showConfirmModal('Bạn có chắc chắn muốn hủy yêu cầu này?', function() {\n");
      out.write("          // Đánh dấu item đã hủy và cập nhật hiển thị\n");
      out.write("          cancelledItems.add(String(id));\n");
      out.write("          renderPage(currentPage); // Cập nhật hiển thị ngay lập tức\n");
      out.write("          \n");
      out.write("          // Gửi request hủy yêu cầu đến server\n");
      out.write("          const data = new URLSearchParams();\n");
      out.write("          data.append('action', 'cancel');\n");
      out.write("          data.append('id', id);\n");
      out.write("          \n");
      out.write("          console.log('DEBUG: Sending cancel request with:', data.toString());\n");
      out.write("          fetch(ctx + '/api/support-customer', {\n");
      out.write("            method: 'POST',\n");
      out.write("            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },\n");
      out.write("            body: data.toString()\n");
      out.write("          }).then(r => {\n");
      out.write("            console.log('Cancel response status:', r.status);\n");
      out.write("            if (!r.ok) {\n");
      out.write("              throw new Error('HTTP ' + r.status);\n");
      out.write("            }\n");
      out.write("            return r.json();\n");
      out.write("          })\n");
      out.write("            .then(j => {\n");
      out.write("              console.log('Cancel response data:', j);\n");
      out.write("              if(j && j.success){\n");
      out.write("                // Hiển thị thông báo thành công bằng modal\n");
      out.write("                showSuccessModal('Hủy yêu cầu thành công!', 'Đã hủy yêu cầu thành công!');\n");
      out.write("                \n");
      out.write("                // Tải lại dữ liệu\n");
      out.write("                load(); // Reload danh sách từ server\n");
      out.write("              } else {\n");
      out.write("                // Nếu server từ chối, revert lại trạng thái\n");
      out.write("                cancelledItems.delete(String(id));\n");
      out.write("                load(); // Reload để cập nhật UI\n");
      out.write("                showSuccessModal('Lỗi', j && j.message ? j.message : 'Không thể hủy yêu cầu');\n");
      out.write("              }\n");
      out.write("            })\n");
      out.write("            .catch(error => {\n");
      out.write("              console.error('Cancel request failed:', error);\n");
      out.write("              // Nếu có lỗi kết nối, revert lại trạng thái\n");
      out.write("              cancelledItems.delete(String(id));\n");
      out.write("              load(); // Reload để cập nhật UI\n");
      out.write("              showSuccessModal('Lỗi', 'Lỗi kết nối máy chủ: ' + error.message);\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("      }\n");
      out.write("    });\n");
      out.write("  });\n");
      out.write("</script>\n");
      out.write("\n");
      out.write("    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js\"></script>\n");
      out.write("    <script>\n");
      out.write("        // Smooth scrolling for navigation links\n");
      out.write("        document.querySelectorAll('a[href^=\"#\"]').forEach(anchor => {\n");
      out.write("            anchor.addEventListener('click', function (e) {\n");
      out.write("                e.preventDefault();\n");
      out.write("                const target = document.querySelector(this.getAttribute('href'));\n");
      out.write("                if (target) {\n");
      out.write("                    target.scrollIntoView({\n");
      out.write("                        behavior: 'smooth',\n");
      out.write("                        block: 'start'\n");
      out.write("                    });\n");
      out.write("                }\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("\n");
      out.write("        // Add scroll effect to navbar\n");
      out.write("        window.addEventListener('scroll', function() {\n");
      out.write("            const navbar = document.querySelector('.navbar');\n");
      out.write("            if (window.scrollY > 50) {\n");
      out.write("                navbar.classList.add('scrolled');\n");
      out.write("            } else {\n");
      out.write("                navbar.classList.remove('scrolled');\n");
      out.write("            }\n");
      out.write("        });\n");
      out.write("\n");
      out.write("        // Banner indicators functionality\n");
      out.write("        const bannerIndicators = document.querySelectorAll('.banner-indicators .indicator');\n");
      out.write("        bannerIndicators.forEach((indicator, index) => {\n");
      out.write("            indicator.addEventListener('click', function() {\n");
      out.write("                bannerIndicators.forEach(ind => ind.classList.remove('active'));\n");
      out.write("                this.classList.add('active');\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("\n");
      out.write("        // Quote indicators functionality\n");
      out.write("        const quoteIndicators = document.querySelectorAll('.quote-indicators .quote-indicator');\n");
      out.write("        quoteIndicators.forEach((indicator, index) => {\n");
      out.write("            indicator.addEventListener('click', function() {\n");
      out.write("                quoteIndicators.forEach(ind => ind.classList.remove('active'));\n");
      out.write("                this.classList.add('active');\n");
      out.write("            });\n");
      out.write("        });\n");
      out.write("        \n");
      out.write("\n");
      out.write("        \n");
      out.write("\n");
      out.write("      \n");
      out.write("\n");
      out.write("        \n");
      out.write("    \n");
      out.write("    </script>\n");
      out.write("   <div class=\"mt-5\"></div>\n");
      out.write("    ");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");
      out.write("\r\n");

    // Luôn load settings mới nhất từ database để đảm bảo hiển thị đúng giá trị đã cập nhật
    String footerPhone = "0989888999";
    String footerDescription = "Chuyên gia giải pháp máy phát điện công nghiệp";
    String footerName = "HOÀ LẠC ELECTRIC";
    String footerEmail = "contact@example.com";
    String footerAddress = "Đại Thanh, Hà Nội";
    
    try {
        SettingsDAO footerSettingsDAO = new SettingsDAO();
        Map<String, String> footerSettings = footerSettingsDAO.getAllSettings();
        
        // Lấy các giá trị settings, nếu không có thì dùng giá trị mặc định
        footerPhone = footerSettings.get("site_phone") != null ? footerSettings.get("site_phone") : footerPhone;
        footerDescription = footerSettings.get("site_description") != null ? footerSettings.get("site_description") : footerDescription;
        footerName = footerSettings.get("site_name") != null ? footerSettings.get("site_name") : footerName;
        footerEmail = footerSettings.get("site_email") != null ? footerSettings.get("site_email") : footerEmail;
        footerAddress = footerSettings.get("site_address") != null ? footerSettings.get("site_address") : footerAddress;
        
        // Cập nhật pageContext để các phần khác có thể dùng
        pageContext.setAttribute("sitePhone", footerPhone);
        pageContext.setAttribute("siteDescription", footerDescription);
        pageContext.setAttribute("siteName", footerName);
        pageContext.setAttribute("siteEmail", footerEmail);
        pageContext.setAttribute("siteAddress", footerAddress);
    } catch (Exception e) {
        // Nếu có lỗi, dùng giá trị từ pageContext hoặc giá trị mặc định
        String tempPhone = (String) pageContext.getAttribute("sitePhone");
        if (tempPhone != null) {
            footerPhone = tempPhone;
        } else {
            pageContext.setAttribute("sitePhone", footerPhone);
        }
        String tempDesc = (String) pageContext.getAttribute("siteDescription");
        if (tempDesc != null) {
            footerDescription = tempDesc;
        } else {
            pageContext.setAttribute("siteDescription", footerDescription);
        }
        // Đảm bảo các giá trị khác cũng được set
        if (pageContext.getAttribute("siteName") == null) {
            pageContext.setAttribute("siteName", footerName);
        }
        if (pageContext.getAttribute("siteEmail") == null) {
            pageContext.setAttribute("siteEmail", footerEmail);
        }
        if (pageContext.getAttribute("siteAddress") == null) {
            pageContext.setAttribute("siteAddress", footerAddress);
        }
    }
    
    // Load danh sách categories từ database để hiển thị trong footer
    List<String> productCategories = new java.util.ArrayList<String>();
    try {
        ProductDAO footerProductDAO = new ProductDAO();
        productCategories = footerProductDAO.getAllCategories();
        // Giới hạn tối đa 4 categories để hiển thị trong footer
        if (productCategories.size() > 4) {
            productCategories = productCategories.subList(0, 4);
        }
    } catch (Exception e) {
        // Nếu có lỗi, dùng danh sách mặc định
        productCategories.add("Máy phát điện Diesel");
        productCategories.add("Máy phát điện 3 pha");
        productCategories.add("Máy phát điện công nghiệp");
        productCategories.add("Phụ kiện máy phát điện");
    }
    
    // Nếu không có categories nào trong database, dùng danh sách mặc định
    if (productCategories.isEmpty()) {
        productCategories.add("Máy phát điện Diesel");
        productCategories.add("Máy phát điện 3 pha");
        productCategories.add("Máy phát điện công nghiệp");
        productCategories.add("Phụ kiện máy phát điện");
    }
    
    // Loại bỏ tất cả ký tự không phải số để dùng cho link Zalo và tel
    String cleanPhone = footerPhone != null ? footerPhone.replaceAll("[^0-9]", "") : "0989888999";

      out.write('\r');
      out.write('\n');
      out.write("\r\n");
      out.write("<style>\r\n");
      out.write("    .footer { background: #2c3e50; color: #ecf0f1; padding: 50px 0 20px; }\r\n");
      out.write("    .footer h5 { color: #e74c3c; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; }\r\n");
      out.write("    .footer p, .footer li { color: #bdc3c7; line-height: 1.8; }\r\n");
      out.write("    .footer a { color: #bdc3c7; text-decoration: none; transition: color 0.3s; }\r\n");
      out.write("    .footer a:hover { color: #e74c3c; }\r\n");
      out.write("    .footer-bottom { border-top: 1px solid #34495e; padding-top: 20px; margin-top: 30px; text-align: center; }\r\n");
      out.write("    .social-icons { display: flex; gap: 15px; margin-top: 15px; }\r\n");
      out.write("    .social-icons a { display: inline-block; width: 40px; height: 40px; background: #34495e; border-radius: 50%; text-align: center; line-height: 40px; transition: background 0.3s; }\r\n");
      out.write("    .social-icons a:hover { background: #e74c3c; }\r\n");
      out.write("\r\n");
      out.write("    /* Floating action buttons (FB, Zalo, Call) */\r\n");
      out.write("    .floating-icons { position: fixed; right: 18px; bottom: 22px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }\r\n");
      out.write("    .floating-icons a { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,.25); transition: transform .15s ease, box-shadow .15s ease; text-decoration: none; }\r\n");
      out.write("    .floating-icons a:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,.3); }\r\n");
      out.write("    .floating-icons .facebook { background: #1877f2; }\r\n");
      out.write("    .floating-icons .zalo { background: #0068ff; font-weight: 700; }\r\n");
      out.write("    .floating-icons .phone { background: #dc3545; }\r\n");
      out.write("    .floating-icons .zalo span { font-size: 14px; letter-spacing: .5px; }\r\n");
      out.write("    @media (max-width: 768px) { .floating-icons a { width: 46px; height: 46px; } }\r\n");
      out.write("</style>\r\n");
      out.write("\r\n");
      out.write("<footer class=\"footer\">\r\n");
      out.write("    <div class=\"container\">\r\n");
      out.write("        <div class=\"row\">\r\n");
      out.write("            <div class=\"col-lg-4 mb-4\">\r\n");
      out.write("                <h5>");
      out.print( pageContext.getAttribute("siteName") != null ? pageContext.getAttribute("siteName") : "HOÀ LẠC ELECTRIC" );
      out.write("</h5>\r\n");
      out.write("                <p>");
      out.print( pageContext.getAttribute("siteDescription") != null ? pageContext.getAttribute("siteDescription") : "Chuyên gia giải pháp máy phát điện công nghiệp với hơn 20 năm kinh nghiệm. Cam kết mang đến sản phẩm chất lượng cao và dịch vụ chuyên nghiệp." );
      out.write("</p>\r\n");
      out.write("                <div class=\"social-icons\">\r\n");
      out.write("                    <a href=\"#\"><i class=\"fab fa-facebook-f\"></i></a>\r\n");
      out.write("                    <a href=\"#\"><i class=\"fab fa-youtube\"></i></a>\r\n");
      out.write("                    <a href=\"#\"><i class=\"fab fa-linkedin-in\"></i></a>\r\n");
      out.write("                    <a href=\"#\"><i class=\"fab fa-instagram\"></i></a>\r\n");
      out.write("                </div>\r\n");
      out.write("            </div>\r\n");
      out.write("            <div class=\"col-lg-2 col-md-6 mb-4\">\r\n");
      out.write("                <h5>Sản phẩm</h5>\r\n");
      out.write("                <ul class=\"list-unstyled\">\r\n");
      out.write("                    ");

                        // Hiển thị danh sách categories từ database
                        for (String category : productCategories) {
                            if (category != null && !category.trim().isEmpty()) {
                                String encodedCategory = URLEncoder.encode(category, "UTF-8");
                                String displayName = category;
                                // Tạo link tìm kiếm theo category
                                String searchUrl = "guest-products?searchTerm=" + encodedCategory;
                    
      out.write("\r\n");
      out.write("                    <li><a href=\"");
      out.print( searchUrl );
      out.write('"');
      out.write('>');
      out.print( displayName );
      out.write("</a></li>\r\n");
      out.write("                    ");

                            }
                        }
                    
      out.write("\r\n");
      out.write("                </ul>\r\n");
      out.write("            </div>\r\n");
      out.write("           \r\n");
      out.write("            <div class=\"col-lg-4 mb-4\">\r\n");
      out.write("                <h5>Liên hệ</h5>\r\n");
      out.write("                <p><i class=\"fas fa-map-marker-alt me-2\"></i> ");
      out.print( pageContext.getAttribute("siteAddress") != null ? pageContext.getAttribute("siteAddress") : "Đại Thanh, Hà Nội" );
      out.write("</p>\r\n");
      out.write("                <p><i class=\"fas fa-phone me-2\"></i> ");
      out.print( pageContext.getAttribute("sitePhone") != null ? pageContext.getAttribute("sitePhone") : "0989 888 999" );
      out.write("</p>\r\n");
      out.write("                <p><i class=\"fas fa-envelope me-2\"></i> ");
      out.print( pageContext.getAttribute("siteEmail") != null ? pageContext.getAttribute("siteEmail") : "contact@example.com" );
      out.write("</p>\r\n");
      out.write("                <p><i class=\"fas fa-clock me-2\"></i> Thứ 2 - Thứ 6: 08:00 - 17:00</p>\r\n");
      out.write("            </div>\r\n");
      out.write("        </div>\r\n");
      out.write("        <div class=\"footer-bottom\">\r\n");
      out.write("            <p>&copy; 2024 ");
      out.print( pageContext.getAttribute("siteName") != null ? pageContext.getAttribute("siteName") : "HOÀ LẠC ELECTRIC" );
      out.write(". Tất cả quyền được bảo lưu.</p>\r\n");
      out.write("        </div>\r\n");
      out.write("    </div>\r\n");
      out.write("</footer>\r\n");
      out.write("\r\n");
      out.write("<div class=\"floating-icons\" aria-label=\"Quick contact actions\">\r\n");
      out.write("    <a class=\"facebook\" href=\"https://www.facebook.com/hoang.huy.439761\" target=\"_blank\" rel=\"noopener\" aria-label=\"Facebook\">\r\n");
      out.write("        <i class=\"fab fa-facebook-f\"></i>\r\n");
      out.write("    </a>\r\n");
      out.write("    <a class=\"zalo\" href=\"https://zalo.me/");
      out.print( cleanPhone );
      out.write("\" target=\"_blank\" rel=\"noopener\" aria-label=\"Zalo\"><span>Z</span></a>\r\n");
      out.write("    <a class=\"phone\" href=\"tel:");
      out.print( cleanPhone );
      out.write("\" aria-label=\"Gọi hotline\">\r\n");
      out.write("        <i class=\"fas fa-phone\"></i>\r\n");
      out.write("    </a>\r\n");
      out.write("    </div>");
      out.write("\n");
      out.write("</body>\n");
      out.write("</html>");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try { out.clearBuffer(); } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }

  private boolean _jspx_meth_c_005fchoose_005f0(javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:choose
    org.apache.taglibs.standard.tag.common.core.ChooseTag _jspx_th_c_005fchoose_005f0 = (org.apache.taglibs.standard.tag.common.core.ChooseTag) _005fjspx_005ftagPool_005fc_005fchoose.get(org.apache.taglibs.standard.tag.common.core.ChooseTag.class);
    _jspx_th_c_005fchoose_005f0.setPageContext(_jspx_page_context);
    _jspx_th_c_005fchoose_005f0.setParent(null);
    int _jspx_eval_c_005fchoose_005f0 = _jspx_th_c_005fchoose_005f0.doStartTag();
    if (_jspx_eval_c_005fchoose_005f0 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                    ");
        if (_jspx_meth_c_005fwhen_005f0(_jspx_th_c_005fchoose_005f0, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                    ");
        if (_jspx_meth_c_005fotherwise_005f0(_jspx_th_c_005fchoose_005f0, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                ");
        int evalDoAfterBody = _jspx_th_c_005fchoose_005f0.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fchoose_005f0.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fchoose.reuse(_jspx_th_c_005fchoose_005f0);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fchoose.reuse(_jspx_th_c_005fchoose_005f0);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f0(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f0, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f0 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f0.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f0.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f0);
    // /header.jsp(126,20) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f0.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.isLoggedIn eq true}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f0 = _jspx_th_c_005fwhen_005f0.doStartTag();
    if (_jspx_eval_c_005fwhen_005f0 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                        ");
        out.write("\r\n");
        out.write("                        ");
        if (_jspx_meth_c_005fchoose_005f1(_jspx_th_c_005fwhen_005f0, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                        \r\n");
        out.write("                        <a href=\"profile.jsp\" class=\"user-info\" style=\"color: #dc3545; font-weight: 600; margin-right: 15px; text-decoration:none;\">\r\n");
        out.write("                            <i class=\"fas fa-user\"></i>\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fout_005f0(_jspx_th_c_005fwhen_005f0, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                        </a>\r\n");
        out.write("                        ");
        if (_jspx_meth_c_005fif_005f0(_jspx_th_c_005fwhen_005f0, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                        <a href=\"logout\" style=\"color: inherit; text-decoration: none;\" title=\"Đăng xuất\">\r\n");
        out.write("                            <i class=\"fas fa-sign-out-alt\"></i>\r\n");
        out.write("                        </a>\r\n");
        out.write("                    ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f0.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f0.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f0);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f0);
    return false;
  }

  private boolean _jspx_meth_c_005fchoose_005f1(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fwhen_005f0, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:choose
    org.apache.taglibs.standard.tag.common.core.ChooseTag _jspx_th_c_005fchoose_005f1 = (org.apache.taglibs.standard.tag.common.core.ChooseTag) _005fjspx_005ftagPool_005fc_005fchoose.get(org.apache.taglibs.standard.tag.common.core.ChooseTag.class);
    _jspx_th_c_005fchoose_005f1.setPageContext(_jspx_page_context);
    _jspx_th_c_005fchoose_005f1.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fwhen_005f0);
    int _jspx_eval_c_005fchoose_005f1 = _jspx_th_c_005fchoose_005f1.doStartTag();
    if (_jspx_eval_c_005fchoose_005f1 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fwhen_005f1(_jspx_th_c_005fchoose_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fwhen_005f2(_jspx_th_c_005fchoose_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fwhen_005f3(_jspx_th_c_005fchoose_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fwhen_005f4(_jspx_th_c_005fchoose_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                            ");
        if (_jspx_meth_c_005fwhen_005f5(_jspx_th_c_005fchoose_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("                        ");
        int evalDoAfterBody = _jspx_th_c_005fchoose_005f1.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fchoose_005f1.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fchoose.reuse(_jspx_th_c_005fchoose_005f1);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fchoose.reuse(_jspx_th_c_005fchoose_005f1);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f1(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f1 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f1.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f1.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f1);
    // /header.jsp(129,28) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f1.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'admin'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f1 = _jspx_th_c_005fwhen_005f1.doStartTag();
    if (_jspx_eval_c_005fwhen_005f1 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                                <a href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/admin\" class=\"management-icon-link\" title=\"Trang quản trị\">\r\n");
        out.write("                                    <i class=\"fas fa-user-cog\"></i>\r\n");
        out.write("                                </a>\r\n");
        out.write("                            ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f1.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f1.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f1);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f1);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f2(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f2 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f2.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f2.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f1);
    // /header.jsp(134,28) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f2.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'customer_support'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f2 = _jspx_th_c_005fwhen_005f2.doStartTag();
    if (_jspx_eval_c_005fwhen_005f2 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                                <a href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/customersupport.jsp\" class=\"management-icon-link\" title=\"Trang quản lý\">\r\n");
        out.write("                                    <i class=\"fas fa-headset\"></i>\r\n");
        out.write("                                </a>\r\n");
        out.write("                            ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f2.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f2.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f2);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f2);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f3(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f3 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f3.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f3.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f1);
    // /header.jsp(139,28) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f3.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'head_technician'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f3 = _jspx_th_c_005fwhen_005f3.doStartTag();
    if (_jspx_eval_c_005fwhen_005f3 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                                <a href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/headtech.jsp\" class=\"management-icon-link\" title=\"Trang quản lý\">\r\n");
        out.write("                                    <i class=\"fas fa-user-tie\"></i>\r\n");
        out.write("                                </a>\r\n");
        out.write("                            ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f3.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f3.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f3);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f3);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f4(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f4 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f4.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f4.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f1);
    // /header.jsp(144,28) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f4.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'technical_staff'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f4 = _jspx_th_c_005fwhen_005f4.doStartTag();
    if (_jspx_eval_c_005fwhen_005f4 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                                <a href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/my_tasks.jsp\" class=\"management-icon-link\" title=\"Trang quản lý\">\r\n");
        out.write("                                    <i class=\"fas fa-tools\"></i>\r\n");
        out.write("                                </a>\r\n");
        out.write("                            ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f4.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f4.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f4);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f4);
    return false;
  }

  private boolean _jspx_meth_c_005fwhen_005f5(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:when
    org.apache.taglibs.standard.tag.rt.core.WhenTag _jspx_th_c_005fwhen_005f5 = (org.apache.taglibs.standard.tag.rt.core.WhenTag) _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.WhenTag.class);
    _jspx_th_c_005fwhen_005f5.setPageContext(_jspx_page_context);
    _jspx_th_c_005fwhen_005f5.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f1);
    // /header.jsp(149,28) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fwhen_005f5.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'storekeeper'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fwhen_005f5 = _jspx_th_c_005fwhen_005f5.doStartTag();
    if (_jspx_eval_c_005fwhen_005f5 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                                <a href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/product\" class=\"management-icon-link\" title=\"Trang quản lý\">\r\n");
        out.write("                                    <i class=\"fas fa-warehouse\"></i>\r\n");
        out.write("                                </a>\r\n");
        out.write("                            ");
        int evalDoAfterBody = _jspx_th_c_005fwhen_005f5.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fwhen_005f5.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f5);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fwhen_0026_005ftest.reuse(_jspx_th_c_005fwhen_005f5);
    return false;
  }

  private boolean _jspx_meth_c_005fout_005f0(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fwhen_005f0, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:out
    org.apache.taglibs.standard.tag.rt.core.OutTag _jspx_th_c_005fout_005f0 = (org.apache.taglibs.standard.tag.rt.core.OutTag) _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody.get(org.apache.taglibs.standard.tag.rt.core.OutTag.class);
    _jspx_th_c_005fout_005f0.setPageContext(_jspx_page_context);
    _jspx_th_c_005fout_005f0.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fwhen_005f0);
    // /header.jsp(158,28) name = value type = null reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fout_005f0.setValue((java.lang.Object) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${empty sessionScope.fullName ? sessionScope.username : sessionScope.fullName}", java.lang.Object.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
    int _jspx_eval_c_005fout_005f0 = _jspx_th_c_005fout_005f0.doStartTag();
    if (_jspx_th_c_005fout_005f0.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody.reuse(_jspx_th_c_005fout_005f0);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fout_0026_005fvalue_005fnobody.reuse(_jspx_th_c_005fout_005f0);
    return false;
  }

  private boolean _jspx_meth_c_005fif_005f0(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fwhen_005f0, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:if
    org.apache.taglibs.standard.tag.rt.core.IfTag _jspx_th_c_005fif_005f0 = (org.apache.taglibs.standard.tag.rt.core.IfTag) _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.IfTag.class);
    _jspx_th_c_005fif_005f0.setPageContext(_jspx_page_context);
    _jspx_th_c_005fif_005f0.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fwhen_005f0);
    // /header.jsp(160,24) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fif_005f0.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'customer'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fif_005f0 = _jspx_th_c_005fif_005f0.doStartTag();
    if (_jspx_eval_c_005fif_005f0 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                            <a href=\"customer_contracts.jsp\" style=\"color: inherit; text-decoration: none; margin-right: 12px;\" title=\"Hợp đồng của tôi\">\r\n");
        out.write("                                <i class=\"fas fa-file-contract\"></i>\r\n");
        out.write("                            </a>\r\n");
        out.write("                        ");
        int evalDoAfterBody = _jspx_th_c_005fif_005f0.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fif_005f0.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f0);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f0);
    return false;
  }

  private boolean _jspx_meth_c_005fotherwise_005f0(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fchoose_005f0, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:otherwise
    org.apache.taglibs.standard.tag.common.core.OtherwiseTag _jspx_th_c_005fotherwise_005f0 = (org.apache.taglibs.standard.tag.common.core.OtherwiseTag) _005fjspx_005ftagPool_005fc_005fotherwise.get(org.apache.taglibs.standard.tag.common.core.OtherwiseTag.class);
    _jspx_th_c_005fotherwise_005f0.setPageContext(_jspx_page_context);
    _jspx_th_c_005fotherwise_005f0.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fchoose_005f0);
    int _jspx_eval_c_005fotherwise_005f0 = _jspx_th_c_005fotherwise_005f0.doStartTag();
    if (_jspx_eval_c_005fotherwise_005f0 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                        <a href=\"login.jsp\" style=\"color: inherit; text-decoration: none;\" title=\"Đăng nhập\">\r\n");
        out.write("                            <i class=\"fas fa-user\"></i>\r\n");
        out.write("                        </a>\r\n");
        out.write("                    ");
        int evalDoAfterBody = _jspx_th_c_005fotherwise_005f0.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fotherwise_005f0.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fotherwise.reuse(_jspx_th_c_005fotherwise_005f0);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fotherwise.reuse(_jspx_th_c_005fotherwise_005f0);
    return false;
  }

  private boolean _jspx_meth_c_005fif_005f1(javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:if
    org.apache.taglibs.standard.tag.rt.core.IfTag _jspx_th_c_005fif_005f1 = (org.apache.taglibs.standard.tag.rt.core.IfTag) _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.IfTag.class);
    _jspx_th_c_005fif_005f1.setPageContext(_jspx_page_context);
    _jspx_th_c_005fif_005f1.setParent(null);
    // /header.jsp(191,12) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fif_005f1.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.isLoggedIn eq true}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fif_005f1 = _jspx_th_c_005fif_005f1.doStartTag();
    if (_jspx_eval_c_005fif_005f1 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                <li class=\"nav-item\"><a class=\"nav-link\" href=\"support.jsp\" id=\"nav-support\">HỖ TRỢ</a></li>\r\n");
        out.write("                ");
        if (_jspx_meth_c_005fif_005f2(_jspx_th_c_005fif_005f1, _jspx_page_context))
          return true;
        out.write("\r\n");
        out.write("            ");
        int evalDoAfterBody = _jspx_th_c_005fif_005f1.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fif_005f1.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f1);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f1);
    return false;
  }

  private boolean _jspx_meth_c_005fif_005f2(javax.servlet.jsp.tagext.JspTag _jspx_th_c_005fif_005f1, javax.servlet.jsp.PageContext _jspx_page_context)
          throws java.lang.Throwable {
    javax.servlet.jsp.PageContext pageContext = _jspx_page_context;
    javax.servlet.jsp.JspWriter out = _jspx_page_context.getOut();
    //  c:if
    org.apache.taglibs.standard.tag.rt.core.IfTag _jspx_th_c_005fif_005f2 = (org.apache.taglibs.standard.tag.rt.core.IfTag) _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.get(org.apache.taglibs.standard.tag.rt.core.IfTag.class);
    _jspx_th_c_005fif_005f2.setPageContext(_jspx_page_context);
    _jspx_th_c_005fif_005f2.setParent((javax.servlet.jsp.tagext.Tag) _jspx_th_c_005fif_005f1);
    // /header.jsp(193,16) name = test type = boolean reqTime = true required = true fragment = false deferredValue = false expectedTypeName = null deferredMethod = false methodSignature = null
    _jspx_th_c_005fif_005f2.setTest(((java.lang.Boolean) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${sessionScope.userRole eq 'customer'}", java.lang.Boolean.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false)).booleanValue());
    int _jspx_eval_c_005fif_005f2 = _jspx_th_c_005fif_005f2.doStartTag();
    if (_jspx_eval_c_005fif_005f2 != javax.servlet.jsp.tagext.Tag.SKIP_BODY) {
      do {
        out.write("\r\n");
        out.write("                    <li class=\"nav-item\"><a class=\"nav-link\" href=\"");
        out.write((java.lang.String) org.apache.jasper.runtime.PageContextImpl.proprietaryEvaluate("${pageContext.request.contextPath}", java.lang.String.class, (javax.servlet.jsp.PageContext)_jspx_page_context, null, false));
        out.write("/customer-contracts\" id=\"nav-contracts\">HỢP ĐỒNG</a></li>\r\n");
        out.write("                ");
        int evalDoAfterBody = _jspx_th_c_005fif_005f2.doAfterBody();
        if (evalDoAfterBody != javax.servlet.jsp.tagext.BodyTag.EVAL_BODY_AGAIN)
          break;
      } while (true);
    }
    if (_jspx_th_c_005fif_005f2.doEndTag() == javax.servlet.jsp.tagext.Tag.SKIP_PAGE) {
      _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f2);
      return true;
    }
    _005fjspx_005ftagPool_005fc_005fif_0026_005ftest.reuse(_jspx_th_c_005fif_005f2);
    return false;
  }
}
